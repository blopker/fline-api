(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,t(e.IJS={}))})(this,function(exports){'use strict';var _NumberPOSITIVE_INFINITY=Number.POSITIVE_INFINITY,_NumberisNaN=Number.isNaN,_Mathsign=Math.sign,_Mathatan=Math.atan2,_Mathsin=Math.sin,_Mathcos=Math.cos,_MathPI=Math.PI,_NumberMIN_VALUE=Number.MIN_VALUE,_Mathlog=Math.log,_NumberMAX_VALUE=Number.MAX_VALUE,_NumberEPSILON=Number.EPSILON,_Mathsqrt=Math.sqrt,_Mathround=Math.round,_Mathexp=Math.exp,_Mathmax=Math.max,_Mathmin=Math.min,_NumberisInteger=Number.isInteger,_Mathabs=Math.abs,_StringfromCharCode=String.fromCharCode,_Mathpow=Math.pow,_Mathceil=Math.ceil,_Mathfloor=Math.floor;function getSlot(e){return e>>3}function getShift(e){return 7-(7&e)}function setBitMethods(e){for(var t in bitMethods)e.prototype[t]=bitMethods[t]}function checkProcessable(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.bitDepth,i=t.alpha,n=t.colorModel,o=t.components,s=t.channels;if("string"!=typeof e||0===e.length)throw new TypeError("processName must be a string");if(a&&(Array.isArray(a)||(a=[a]),!a.includes(this.bitDepth)))throw new TypeError("The process: ".concat(e," can only be applied if bit depth is in: ").concat(a));if(i&&(Array.isArray(i)||(i=[i]),!i.includes(this.alpha)))throw new TypeError("The process: ".concat(e," can only be applied if alpha is in: ").concat(i));if(n&&(Array.isArray(n)||(n=[n]),!n.includes(this.colorModel)))throw new TypeError("The process: ".concat(e," can only be applied if color model is in: ").concat(n));if(o&&(Array.isArray(o)||(o=[o]),!o.includes(this.components))){var l="The process: ".concat(e," can only be applied if the number of components is in: ").concat(o);if(1===o.length&&1===o[0])throw new TypeError("".concat(l,".\rYou should transform your image using \"image.grey()\" before applying the algorithm."));else throw new TypeError(l)}if(s&&(Array.isArray(s)||(s=[s]),!s.includes(this.channels)))throw new TypeError("The process: ".concat(e," can only be applied if the number of channels is in: ").concat(s))}function createBlob(e,t){e=e||[],t=t||{},"string"==typeof t&&(t={type:t});try{return new Blob(e,t)}catch(i){if("TypeError"!==i.name)throw i;for(var a="undefined"==typeof BlobBuilder?"undefined"==typeof MSBlobBuilder?"undefined"==typeof MozBlobBuilder?WebKitBlobBuilder:MozBlobBuilder:MSBlobBuilder:BlobBuilder,n=new a,o=0;o<e.length;o+=1)n.append(e[o]);return n.getBlob(t.type)}}function dataURLToBlob(e){var t=e.match(/data:([^;]+)/)[1],a=e.replace(/^[^,]+,/,""),i=binaryStringToArrayBuffer(atob(a));return createBlob([i],{type:t})}function canvasToBlob(e,t,a){return"function"==typeof e.toBlob?new Promise(function(i){e.toBlob(i,t,a)}):Promise.resolve(dataURLToBlob(e.toDataURL(t,a)))}function binaryStringToArrayBuffer(e){for(var t=e.length,a=new ArrayBuffer(t),n=new Uint8Array(a),o=-1;++o<t;)n[o]=e.charCodeAt(o);return a}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}function writePixelArray(e,t){const a=4*_Mathfloor((t.bitDepth*t.width+31)/32),n=_Mathceil(t.bitDepth*t.width/8),o=t.bitDepth*t.width%8,s=0===o?0:8-o,l=a*t.height;var r,d;const h=new IOBuffer_1(t.data);let g=0,c=0,m=8;e.mark(),d=h.readUint8();for(var p=t.height-1;0<=p;p--){const t=0==p;e.reset(),e.skip(p*a);for(var u=0;u<n;u++){const i=u==n-1;c<=s&&i?(e.writeByte(d<<c),(0===s||s===c)&&!t&&(r=d,d=h.readByte())):0===c?(r=d,d=h.readUint8(),e.writeByte(r)):(r=d,d=h.readUint8(),e.writeByte(r<<c&tableLeft[c]|d>>m)),i?(g+=o||8,e.skip(a-n),c=g%8,m=8-c):g+=8}}a>n&&(e.reset(),e.skip(l-1),e.writeUint8(0))}function writeColorTable(e,t){8<t.bitDepth||e.writeUint32(0).writeUint32(16777215)}function writeBitmapFileHeader(e,t){e.writeChars("BM"),e.writeInt32(e._lastWrittenByte),e.writeUint16(0),e.writeUint16(0),e.writeUint32(t)}function writeBitmapV5Header(e,t){e.writeUint32(124).writeInt32(t.width).writeInt32(t.height).writeUint16(1).writeUint16(t.bitDepth).writeUint32(constants.BITMAPV5HEADER.Compression.BI_RGB).writeUint32(t.width*t.height*t.bitDepth).writeInt32(0).writeInt32(0).writeUint32(_Mathpow(2,t.bitDepth)).writeUint32(_Mathpow(2,t.bitDepth)).writeUint32(4278190080).writeUint32(16711680).writeUint32(65280).writeUint32(255).writeUint32(constants.BITMAPV5HEADER.LogicalColorSpace.LCS_sRGB).skip(36).skip(12).writeUint32(constants.BITMAPV5HEADER.GamutMappingIntent.LCS_GM_IMAGES).skip(12)}function zero(e){for(var t=e.length;0<=--t;)e[t]=0}function StaticTreeDesc(e,t,a,i,n){this.static_tree=e,this.extra_bits=t,this.extra_base=a,this.elems=i,this.max_length=n,this.has_stree=e&&e.length}function TreeDesc(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function d_code(e){return 256>e?_dist_code[e]:_dist_code[256+(e>>>7)]}function put_short(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=255&t>>>8}function send_bits(e,t,a){e.bi_valid>16-a?(e.bi_buf|=65535&t<<e.bi_valid,put_short(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=a-16):(e.bi_buf|=65535&t<<e.bi_valid,e.bi_valid+=a)}function send_code(e,t,a){send_bits(e,a[2*t],a[2*t+1])}function bi_reverse(e,t){var a=0;do a|=1&e,e>>>=1,a<<=1;while(0<--t);return a>>>1}function bi_flush(e){16===e.bi_valid?(put_short(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function gen_bitlen(e,t){var a=t.dyn_tree,i=t.max_code,o=t.stat_desc.static_tree,s=t.stat_desc.has_stree,l=t.stat_desc.extra_bits,r=t.stat_desc.extra_base,d=t.stat_desc.max_length,g=0,c,p,u,b,_,w;for(b=0;b<=15;b++)e.bl_count[b]=0;for(a[2*e.heap[e.heap_max]+1]=0,c=e.heap_max+1;573>c;c++)(p=e.heap[c],b=a[2*a[2*p+1]+1]+1,b>d&&(b=d,g++),a[2*p+1]=b,!(p>i))&&(e.bl_count[b]++,_=0,p>=r&&(_=l[p-r]),w=a[2*p],e.opt_len+=w*(b+_),s&&(e.static_len+=w*(o[2*p+1]+_)));if(0!==g){do{for(b=d-1;0===e.bl_count[b];)b--;e.bl_count[b]--,e.bl_count[b+1]+=2,e.bl_count[d]--,g-=2}while(0<g);for(b=d;0!==b;b--)for(p=e.bl_count[b];0!==p;)(u=e.heap[--c],!(u>i))&&(a[2*u+1]!==b&&(e.opt_len+=(b-a[2*u+1])*a[2*u],a[2*u+1]=b),p--)}}function gen_codes(e,t,a){var i=Array(16),o=0,s,l;for(s=1;s<=15;s++)i[s]=o=o+a[s-1]<<1;for(l=0;l<=t;l++){var r=e[2*l+1];0!==r&&(e[2*l]=bi_reverse(i[r]++,r))}}function tr_static_init(){var e=Array(16),t,a,i,o,s;for(i=0,o=0;o<28;o++)for(base_length[o]=i,t=0;t<1<<extra_lbits[o];t++)_length_code[i++]=o;for(_length_code[i-1]=o,s=0,o=0;16>o;o++)for(base_dist[o]=s,t=0;t<1<<extra_dbits[o];t++)_dist_code[s++]=o;for(s>>=7;o<30;o++)for(base_dist[o]=s<<7,t=0;t<1<<extra_dbits[o]-7;t++)_dist_code[256+s++]=o;for(a=0;a<=15;a++)e[a]=0;for(t=0;143>=t;)static_ltree[2*t+1]=8,t++,e[8]++;for(;255>=t;)static_ltree[2*t+1]=9,t++,e[9]++;for(;279>=t;)static_ltree[2*t+1]=7,t++,e[7]++;for(;287>=t;)static_ltree[2*t+1]=8,t++,e[8]++;for(gen_codes(static_ltree,287,e),t=0;t<30;t++)static_dtree[2*t+1]=5,static_dtree[2*t]=bi_reverse(t,5);static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,257,286,15),static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,30,15),static_bl_desc=new StaticTreeDesc([],extra_blbits,0,19,7)}function init_block(e){var t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function bi_windup(e){8<e.bi_valid?put_short(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function copy_block(e,t,a,i){bi_windup(e),i&&(put_short(e,a),put_short(e,~a)),common.arraySet(e.pending_buf,e.window,t,a,e.pending),e.pending+=a}function smaller(e,t,a,i){var n=2*t,o=2*a;return e[n]<e[o]||e[n]===e[o]&&i[t]<=i[a]}function pqdownheap(e,t,a){for(var i=e.heap[a],n=a<<1;n<=e.heap_len&&(n<e.heap_len&&smaller(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!smaller(t,i,e.heap[n],e.depth));)e.heap[a]=e.heap[n],a=n,n<<=1;e.heap[a]=i}function compress_block(e,t,a){var i=0,n,o,s,l;if(0!==e.last_lit)do n=e.pending_buf[e.d_buf+2*i]<<8|e.pending_buf[e.d_buf+2*i+1],o=e.pending_buf[e.l_buf+i],i++,0===n?send_code(e,o,t):(s=_length_code[o],send_code(e,s+256+1,t),l=extra_lbits[s],0!==l&&(o-=base_length[s],send_bits(e,o,l)),n--,s=d_code(n),send_code(e,s,a),l=extra_dbits[s],0!==l&&(n-=base_dist[s],send_bits(e,n,l)));while(i<e.last_lit);send_code(e,256,t)}function build_tree(e,t){var a=t.dyn_tree,i=t.stat_desc.static_tree,o=t.stat_desc.has_stree,s=t.stat_desc.elems,l=-1,r,d,h;for(e.heap_len=0,e.heap_max=573,r=0;r<s;r++)0===a[2*r]?a[2*r+1]=0:(e.heap[++e.heap_len]=l=r,e.depth[r]=0);for(;2>e.heap_len;)h=e.heap[++e.heap_len]=2>l?++l:0,a[2*h]=1,e.depth[h]=0,e.opt_len--,o&&(e.static_len-=i[2*h+1]);for(t.max_code=l,r=e.heap_len>>1;1<=r;r--)pqdownheap(e,a,r);h=s;do r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap(e,a,1),d=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=d,a[2*h]=a[2*r]+a[2*d],e.depth[h]=(e.depth[r]>=e.depth[d]?e.depth[r]:e.depth[d])+1,a[2*r+1]=a[2*d+1]=h,e.heap[1]=h++,pqdownheap(e,a,1);while(2<=e.heap_len);e.heap[--e.heap_max]=e.heap[1],gen_bitlen(e,t),gen_codes(a,l,e.bl_count)}function scan_tree(e,t,a){var i=-1,o=t[1],s=0,l=7,r=4,d,h;for(0===o&&(l=138,r=3),t[2*(a+1)+1]=65535,d=0;d<=a;d++){if(h=o,o=t[2*(d+1)+1],++s<l&&h===o)continue;else s<r?e.bl_tree[2*h]+=s:0===h?10>=s?e.bl_tree[34]++:e.bl_tree[36]++:(h!==i&&e.bl_tree[2*h]++,e.bl_tree[32]++);s=0,i=h,0===o?(l=138,r=3):h===o?(l=6,r=3):(l=7,r=4)}}function send_tree(e,t,a){var i=-1,o=t[1],s=0,l=7,r=4,d,h;for(0===o&&(l=138,r=3),d=0;d<=a;d++){if(h=o,o=t[2*(d+1)+1],++s<l&&h===o)continue;else if(s<r)do send_code(e,h,e.bl_tree);while(0!=--s);else 0===h?10>=s?(send_code(e,17,e.bl_tree),send_bits(e,s-3,3)):(send_code(e,18,e.bl_tree),send_bits(e,s-11,7)):(h!==i&&(send_code(e,h,e.bl_tree),s--),send_code(e,16,e.bl_tree),send_bits(e,s-3,2));s=0,i=h,0===o?(l=138,r=3):h===o?(l=6,r=3):(l=7,r=4)}}function build_bl_tree(e){var t;for(scan_tree(e,e.dyn_ltree,e.l_desc.max_code),scan_tree(e,e.dyn_dtree,e.d_desc.max_code),build_tree(e,e.bl_desc),t=18;3<=t&&0===e.bl_tree[2*bl_order[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function send_all_trees(e,t,a,i){var n;for(send_bits(e,t-257,5),send_bits(e,a-1,5),send_bits(e,i-4,4),n=0;n<i;n++)send_bits(e,e.bl_tree[2*bl_order[n]+1],3);send_tree(e,e.dyn_ltree,t-1),send_tree(e,e.dyn_dtree,a-1)}function detect_data_type(e){var t=4093624447,a;for(a=0;31>=a;a++,t>>>=1)if(1&t&&0!==e.dyn_ltree[2*a])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(a=32;a<256;a++)if(0!==e.dyn_ltree[2*a])return 1;return 0}function _tr_init(e){static_init_done||(tr_static_init(),static_init_done=!0),e.l_desc=new TreeDesc(e.dyn_ltree,static_l_desc),e.d_desc=new TreeDesc(e.dyn_dtree,static_d_desc),e.bl_desc=new TreeDesc(e.bl_tree,static_bl_desc),e.bi_buf=0,e.bi_valid=0,init_block(e)}function _tr_stored_block(e,t,a,i){send_bits(e,0+(i?1:0),3),copy_block(e,t,a,!0)}function _tr_align(e){send_bits(e,2,3),send_code(e,256,static_ltree),bi_flush(e)}function _tr_flush_block(e,t,a,i){var n=0,o,s;0<e.level?(e.strm.data_type===2&&(e.strm.data_type=detect_data_type(e)),build_tree(e,e.l_desc),build_tree(e,e.d_desc),n=build_bl_tree(e),o=e.opt_len+3+7>>>3,s=e.static_len+3+7>>>3,s<=o&&(o=s)):o=s=a+5,a+4<=o&&-1!==t?_tr_stored_block(e,t,a,i):e.strategy===4||s===o?(send_bits(e,2+(i?1:0),3),compress_block(e,static_ltree,static_dtree)):(send_bits(e,4+(i?1:0),3),send_all_trees(e,e.l_desc.max_code+1,e.d_desc.max_code+1,n+1),compress_block(e,e.dyn_ltree,e.dyn_dtree)),init_block(e),i&&bi_windup(e)}function _tr_tally(e,t,a){return e.pending_buf[e.d_buf+2*e.last_lit]=255&t>>>8,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&a,e.last_lit++,0===t?e.dyn_ltree[2*a]++:(e.matches++,t--,e.dyn_ltree[2*(_length_code[a]+256+1)]++,e.dyn_dtree[2*d_code(t)]++),e.last_lit===e.lit_bufsize-1}function adler32(e,t,a,i){for(var o=0|65535&e,s=0|65535&e>>>16,l=0;0!==a;){l=2e3<a?2e3:a,a-=l;do o=0|o+t[i++],s=0|s+o;while(--l);o%=65521,s%=65521}return 0|(o|s<<16)}function makeTable(){for(var e=[],t=0,a;256>t;t++){a=t;for(var i=0;8>i;i++)a=1&a?3988292384^a>>>1:a>>>1;e[t]=a}return e}function crc32(e,t,a,n){e^=-1;for(var o=n;o<n+a;o++)e=e>>>8^crcTable[255&(e^t[o])];return-1^e}function err(e,t){return e.msg=messages[t],t}function rank(e){return(e<<1)-(4<e?9:0)}function zero$1(e){for(var t=e.length;0<=--t;)e[t]=0}function flush_pending(e){var t=e.state,a=t.pending;a>e.avail_out&&(a=e.avail_out);0===a||(common.arraySet(e.output,t.pending_buf,t.pending_out,a,e.next_out),e.next_out+=a,t.pending_out+=a,e.total_out+=a,e.avail_out-=a,t.pending-=a,0===t.pending&&(t.pending_out=0))}function flush_block_only(e,t){trees._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,flush_pending(e.strm)}function put_byte(e,t){e.pending_buf[e.pending++]=t}function putShortMSB(e,t){e.pending_buf[e.pending++]=255&t>>>8,e.pending_buf[e.pending++]=255&t}function read_buf(e,t,a,i){var n=e.avail_in;return(n>i&&(n=i),0===n)?0:(e.avail_in-=n,common.arraySet(t,e.input,e.next_in,n,a),1===e.state.wrap?e.adler=adler32_1(e.adler,t,n,a):2===e.state.wrap&&(e.adler=crc32_1(e.adler,t,n,a)),e.next_in+=n,e.total_in+=n,n)}function longest_match(e,t){var a=e.max_chain_length,i=e.strstart,n=e.prev_length,o=e.nice_match,s=e.strstart>e.w_size-262?e.strstart-(e.w_size-262):0,l=e.window,r=e.w_mask,d=e.prev,h=e.strstart+258,g=l[i+n-1],c=l[i+n],m,p;e.prev_length>=e.good_match&&(a>>=2),o>e.lookahead&&(o=e.lookahead);do{if(m=t,l[m+n]!==c||l[m+n-1]!==g||l[m]!==l[i]||l[++m]!==l[i+1])continue;i+=2,m++;do;while(l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&l[++i]===l[++m]&&i<h);if(p=258-(h-i),i=h-258,p>n){if(e.match_start=t,n=p,p>=o)break;g=l[i+n-1],c=l[i+n]}}while((t=d[t&r])>s&&0!=--a);return n<=e.lookahead?n:e.lookahead}function fill_window(e){var t=e.w_size,a,i,o,s,l;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-262)){common.arraySet(e.window,e.window,t,t,0),e.match_start-=t,e.strstart-=t,e.block_start-=t,i=e.hash_size,a=i;do o=e.head[--a],e.head[a]=o>=t?o-t:0;while(--i);i=t,a=i;do o=e.prev[--a],e.prev[a]=o>=t?o-t:0;while(--i);s+=t}if(0===e.strm.avail_in)break;if(i=read_buf(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=i,3<=e.lookahead+e.insert)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+3-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(3>e.lookahead+e.insert)););}while(262>e.lookahead&&0!==e.strm.avail_in)}function deflate_stored(e,t){var a=65535;for(a>e.pending_buf_size-5&&(a=e.pending_buf_size-5);;){if(1>=e.lookahead){if(fill_window(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+a;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,flush_block_only(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-262&&(flush_block_only(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(flush_block_only(e,!0),0===e.strm.avail_out?3:4):e.strstart>e.block_start&&(flush_block_only(e,!1),0===e.strm.avail_out)?1:1}function deflate_fast(e,t){for(var a,i;;){if(262>e.lookahead){if(fill_window(e),262>e.lookahead&&0===t)return 1;if(0===e.lookahead)break}if(a=0,3<=e.lookahead&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,a=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==a&&e.strstart-a<=e.w_size-262&&(e.match_length=longest_match(e,a)),!(3<=e.match_length))i=trees._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;else if(i=trees._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&3<=e.lookahead){e.match_length--;do e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,a=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;if(i&&(flush_block_only(e,!1),0===e.strm.avail_out))return 1}return e.insert=2>e.strstart?e.strstart:2,4===t?(flush_block_only(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?1:2}function deflate_slow(e,t){for(var a,i,n;;){if(262>e.lookahead){if(fill_window(e),262>e.lookahead&&0===t)return 1;if(0===e.lookahead)break}if(a=0,3<=e.lookahead&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,a=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==a&&e.prev_length<e.max_lazy_match&&e.strstart-a<=e.w_size-262&&(e.match_length=longest_match(e,a),5>=e.match_length&&(1===e.strategy||3===e.match_length&&4096<e.strstart-e.match_start)&&(e.match_length=2)),3<=e.prev_length&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-3,i=trees._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=n&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,a=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(flush_block_only(e,!1),0===e.strm.avail_out))return 1}else if(!e.match_available)e.match_available=1,e.strstart++,e.lookahead--;else if(i=trees._tr_tally(e,0,e.window[e.strstart-1]),i&&flush_block_only(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}return e.match_available&&(i=trees._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=2>e.strstart?e.strstart:2,4===t?(flush_block_only(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?1:2}function deflate_rle(e,t){for(var a=e.window,i,n,o,s;;){if(258>=e.lookahead){if(fill_window(e),258>=e.lookahead&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,3<=e.lookahead&&0<e.strstart&&(o=e.strstart-1,n=a[o],n===a[++o]&&n===a[++o]&&n===a[++o])){s=e.strstart+258;do;while(n===a[++o]&&n===a[++o]&&n===a[++o]&&n===a[++o]&&n===a[++o]&&n===a[++o]&&n===a[++o]&&n===a[++o]&&o<s);e.match_length=258-(s-o),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(3<=e.match_length?(i=trees._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=trees._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(flush_block_only(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(flush_block_only(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?1:2}function deflate_huff(e,t){for(var a;;){if(0===e.lookahead&&(fill_window(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,a=trees._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,a&&(flush_block_only(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(flush_block_only(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?1:2}function Config(e,t,a,i,n){this.good_length=e,this.max_lazy=t,this.nice_length=a,this.max_chain=i,this.func=n}function lm_init(e){e.window_size=2*e.w_size,zero$1(e.head),e.max_lazy_match=configuration_table[e.level].max_lazy,e.good_match=configuration_table[e.level].good_length,e.nice_match=configuration_table[e.level].nice_length,e.max_chain_length=configuration_table[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new common.Buf16(1146),this.dyn_dtree=new common.Buf16(122),this.bl_tree=new common.Buf16(78),zero$1(this.dyn_ltree),zero$1(this.dyn_dtree),zero$1(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new common.Buf16(16),this.heap=new common.Buf16(573),zero$1(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new common.Buf16(573),zero$1(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,t=e.state,t.pending=0,t.pending_out=0,0>t.wrap&&(t.wrap=-t.wrap),t.status=t.wrap?42:113,e.adler=2===t.wrap?0:1,t.last_flush=0,trees._tr_init(t),0):err(e,-2)}function deflateReset(e){var t=deflateResetKeep(e);return 0===t&&lm_init(e.state),t}function deflateSetHeader(e,t){return e&&e.state?2===e.state.wrap?(e.state.gzhead=t,0):-2:-2}function deflateInit2(e,t,a,i,n,o){if(!e)return-2;var l=1;if(-1===t&&(t=6),0>i?(l=0,i=-i):15<i&&(l=2,i-=16),1>n||9<n||8!==a||8>i||15<i||0>t||9<t||0>o||4<o)return err(e,-2);8===i&&(i=9);var r=new DeflateState;return e.state=r,r.strm=e,r.wrap=l,r.gzhead=null,r.w_bits=i,r.w_size=1<<r.w_bits,r.w_mask=r.w_size-1,r.hash_bits=n+7,r.hash_size=1<<r.hash_bits,r.hash_mask=r.hash_size-1,r.hash_shift=~~((r.hash_bits+3-1)/3),r.window=new common.Buf8(2*r.w_size),r.head=new common.Buf16(r.hash_size),r.prev=new common.Buf16(r.w_size),r.lit_bufsize=1<<n+6,r.pending_buf_size=4*r.lit_bufsize,r.pending_buf=new common.Buf8(r.pending_buf_size),r.d_buf=1*r.lit_bufsize,r.l_buf=3*r.lit_bufsize,r.level=t,r.strategy=o,r.method=a,deflateReset(e)}function deflateInit(e,t){return deflateInit2(e,t,8,15,8,0)}function deflate(e,t){var a,i,n,o;if(!e||!e.state||5<t||0>t)return e?err(e,-2):-2;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||666===i.status&&4!==t)return err(e,0===e.avail_out?-5:-2);if(i.strm=e,a=i.last_flush,i.last_flush=t,42===i.status)if(2===i.wrap)e.adler=0,put_byte(i,31),put_byte(i,139),put_byte(i,8),i.gzhead?(put_byte(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),put_byte(i,255&i.gzhead.time),put_byte(i,255&i.gzhead.time>>8),put_byte(i,255&i.gzhead.time>>16),put_byte(i,255&i.gzhead.time>>24),put_byte(i,9===i.level?2:2<=i.strategy||2>i.level?4:0),put_byte(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(put_byte(i,255&i.gzhead.extra.length),put_byte(i,255&i.gzhead.extra.length>>8)),i.gzhead.hcrc&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,9===i.level?2:2<=i.strategy||2>i.level?4:0),put_byte(i,3),i.status=113);else{var l=8+(i.w_bits-8<<4)<<8,r=-1;r=2<=i.strategy||2>i.level?0:6>i.level?1:6===i.level?2:3,l|=r<<6,0!==i.strstart&&(l|=32),l+=31-l%31,i.status=113,putShortMSB(i,l),0!==i.strstart&&(putShortMSB(i,e.adler>>>16),putShortMSB(i,65535&e.adler)),e.adler=1}if(69===i.status)if(i.gzhead.extra){for(n=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&!(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),flush_pending(e),n=i.pending,i.pending===i.pending_buf_size));)put_byte(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73)}else i.status=73;if(73===i.status)if(i.gzhead.name){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),flush_pending(e),n=i.pending,i.pending===i.pending_buf_size)){o=1;break}o=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,put_byte(i,o)}while(0!==o);i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),0===o&&(i.gzindex=0,i.status=91)}else i.status=91;if(91===i.status)if(i.gzhead.comment){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),flush_pending(e),n=i.pending,i.pending===i.pending_buf_size)){o=1;break}o=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,put_byte(i,o)}while(0!==o);i.gzhead.hcrc&&i.pending>n&&(e.adler=crc32_1(e.adler,i.pending_buf,i.pending-n,n)),0===o&&(i.status=103)}else i.status=103;if(103===i.status&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&flush_pending(e),i.pending+2<=i.pending_buf_size&&(put_byte(i,255&e.adler),put_byte(i,255&e.adler>>8),e.adler=0,i.status=113)):i.status=113),0!==i.pending){if(flush_pending(e),0===e.avail_out)return i.last_flush=-1,0;}else if(0===e.avail_in&&rank(t)<=rank(a)&&4!==t)return err(e,-5);if(666===i.status&&0!==e.avail_in)return err(e,-5);if(0!==e.avail_in||0!==i.lookahead||0!==t&&666!==i.status){var d=2===i.strategy?deflate_huff(i,t):3===i.strategy?deflate_rle(i,t):configuration_table[i.level].func(i,t);if((3===d||4===d)&&(i.status=666),1===d||3===d)return 0===e.avail_out&&(i.last_flush=-1),0;if(2===d&&(1===t?trees._tr_align(i):5!==t&&(trees._tr_stored_block(i,0,0,!1),3===t&&(zero$1(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),flush_pending(e),0===e.avail_out))return i.last_flush=-1,0}return 4===t?0>=i.wrap?1:(2===i.wrap?(put_byte(i,255&e.adler),put_byte(i,255&e.adler>>8),put_byte(i,255&e.adler>>16),put_byte(i,255&e.adler>>24),put_byte(i,255&e.total_in),put_byte(i,255&e.total_in>>8),put_byte(i,255&e.total_in>>16),put_byte(i,255&e.total_in>>24)):(putShortMSB(i,e.adler>>>16),putShortMSB(i,65535&e.adler)),flush_pending(e),0<i.wrap&&(i.wrap=-i.wrap),0===i.pending?1:0):0}function deflateEnd(e){var t;return e&&e.state?(t=e.state.status,42!==t&&69!==t&&73!==t&&91!==t&&103!==t&&113!==t&&666!==t)?err(e,-2):(e.state=null,113===t?err(e,-3):0):-2}function deflateSetDictionary(e,t){var a=t.length,i,o,l,r,d,h,g,c;if(!e||!e.state)return-2;if(i=e.state,r=i.wrap,2===r||1===r&&42!==i.status||i.lookahead)return-2;for(1===r&&(e.adler=adler32_1(e.adler,t,a,0)),i.wrap=0,a>=i.w_size&&(0===r&&(zero$1(i.head),i.strstart=0,i.block_start=0,i.insert=0),c=new common.Buf8(i.w_size),common.arraySet(c,t,a-i.w_size,i.w_size,0),t=c,a=i.w_size),d=e.avail_in,h=e.next_in,g=e.input,e.avail_in=a,e.next_in=0,e.input=t,fill_window(i);3<=i.lookahead;){o=i.strstart,l=i.lookahead-2;do i.ins_h=(i.ins_h<<i.hash_shift^i.window[o+3-1])&i.hash_mask,i.prev[o&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=o,o++;while(--l);i.strstart=o,i.lookahead=2,fill_window(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=h,e.input=g,e.avail_in=d,i.wrap=r,0}function buf2binstring(e,t){if(65537>t&&(e.subarray&&STR_APPLY_UIA_OK||!e.subarray&&STR_APPLY_OK))return _StringfromCharCode.apply(null,common.shrinkBuf(e,t));for(var a="",n=0;n<t;n++)a+=_StringfromCharCode(e[n]);return a}function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function Deflate(e){if(!(this instanceof Deflate))return new Deflate(e);this.options=common.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&16>t.windowBits&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;var a=deflate_1.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(0!==a)throw new Error(messages[a]);if(t.header&&deflate_1.deflateSetHeader(this.strm,t.header),t.dictionary){var i;if(i="string"==typeof t.dictionary?strings.string2buf(t.dictionary):"[object ArrayBuffer]"===toString.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,a=deflate_1.deflateSetDictionary(this.strm,i),0!==a)throw new Error(messages[a]);this._dict_set=!0}}function deflate$1(e,t){var a=new Deflate(t);if(a.push(e,!0),a.err)throw a.msg||messages[a.err];return a.result}function deflateRaw(e,t){return t=t||{},t.raw=!0,deflate$1(e,t)}function gzip(e,t){return t=t||{},t.gzip=!0,deflate$1(e,t)}function zswap32(e){return(255&e>>>24)+(65280&e>>>8)+((65280&e)<<8)+((255&e)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new common.Buf16(320),this.work=new common.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new common.Buf32(852),t.distcode=t.distdyn=new common.Buf32(592),t.sane=1,t.back=-1,0):-2}function inflateReset(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,inflateResetKeep(e)):-2}function inflateReset2(e,t){var a,i;return e&&e.state?(i=e.state,0>t?(a=0,t=-t):(a=(t>>4)+1,48>t&&(t&=15)),t&&(8>t||15<t))?-2:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=a,i.wbits=t,inflateReset(e)):-2}function inflateInit2(e,t){var a,i;return e?(i=new InflateState,e.state=i,i.window=null,a=inflateReset2(e,t),0!==a&&(e.state=null),a):-2}function inflateInit(e){return inflateInit2(e,15)}function fixedtables(e){if(virgin){var t;for(lenfix=new common.Buf32(512),distfix=new common.Buf32(32),t=0;144>t;)e.lens[t++]=8;for(;256>t;)e.lens[t++]=9;for(;280>t;)e.lens[t++]=7;for(;288>t;)e.lens[t++]=8;for(inftrees(1,e.lens,0,288,lenfix,0,e.work,{bits:9}),t=0;32>t;)e.lens[t++]=5;inftrees(2,e.lens,0,32,distfix,0,e.work,{bits:5}),virgin=!1}e.lencode=lenfix,e.lenbits=9,e.distcode=distfix,e.distbits=5}function updatewindow(e,t,a,i){var n=e.state,o;return null===n.window&&(n.wsize=1<<n.wbits,n.wnext=0,n.whave=0,n.window=new common.Buf8(n.wsize)),i>=n.wsize?(common.arraySet(n.window,t,a-n.wsize,n.wsize,0),n.wnext=0,n.whave=n.wsize):(o=n.wsize-n.wnext,o>i&&(o=i),common.arraySet(n.window,t,a-i,o,n.wnext),i-=o,i?(common.arraySet(n.window,t,a-i,i,0),n.wnext=i,n.whave=n.wsize):(n.wnext+=o,n.wnext===n.wsize&&(n.wnext=0),n.whave<n.wsize&&(n.whave+=o))),0}function inflate(e,t){var a=0,i=new common.Buf8(4),o=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],s,l,r,d,h,g,c,m,p,u,f,b,_,w,x,y,k,v,D,S,I,P,M,B;if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;s=e.state,12===s.mode&&(s.mode=13),h=e.next_out,r=e.output,c=e.avail_out,d=e.next_in,l=e.input,g=e.avail_in,m=s.hold,p=s.bits,u=g,f=c,P=0;inf_leave:for(;;)switch(s.mode){case 1:if(0===s.wrap){s.mode=13;break}for(;16>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(2&s.wrap&&35615===m){s.check=0,i[0]=255&m,i[1]=255&m>>>8,s.check=crc32_1(s.check,i,2,0),m=0,p=0,s.mode=2;break}if(s.flags=0,s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&m)<<8)+(m>>8))%31){e.msg="incorrect header check",s.mode=30;break}if(8!==(15&m)){e.msg="unknown compression method",s.mode=30;break}if(m>>>=4,p-=4,I=(15&m)+8,0===s.wbits)s.wbits=I;else if(I>s.wbits){e.msg="invalid window size",s.mode=30;break}s.dmax=1<<I,e.adler=s.check=1,s.mode=512&m?10:12,m=0,p=0;break;case 2:for(;16>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(s.flags=m,8!==(255&s.flags)){e.msg="unknown compression method",s.mode=30;break}if(57344&s.flags){e.msg="unknown header flags set",s.mode=30;break}s.head&&(s.head.text=1&m>>8),512&s.flags&&(i[0]=255&m,i[1]=255&m>>>8,s.check=crc32_1(s.check,i,2,0)),m=0,p=0,s.mode=3;case 3:for(;32>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.head&&(s.head.time=m),512&s.flags&&(i[0]=255&m,i[1]=255&m>>>8,i[2]=255&m>>>16,i[3]=255&m>>>24,s.check=crc32_1(s.check,i,4,0)),m=0,p=0,s.mode=4;case 4:for(;16>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.head&&(s.head.xflags=255&m,s.head.os=m>>8),512&s.flags&&(i[0]=255&m,i[1]=255&m>>>8,s.check=crc32_1(s.check,i,2,0)),m=0,p=0,s.mode=5;case 5:if(1024&s.flags){for(;16>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.length=m,s.head&&(s.head.extra_len=m),512&s.flags&&(i[0]=255&m,i[1]=255&m>>>8,s.check=crc32_1(s.check,i,2,0)),m=0,p=0}else s.head&&(s.head.extra=null);s.mode=6;case 6:if(1024&s.flags&&(b=s.length,b>g&&(b=g),b&&(s.head&&(I=s.head.extra_len-s.length,!s.head.extra&&(s.head.extra=Array(s.head.extra_len)),common.arraySet(s.head.extra,l,d,b,I)),512&s.flags&&(s.check=crc32_1(s.check,l,b,d)),g-=b,d+=b,s.length-=b),s.length))break inf_leave;s.length=0,s.mode=7;case 7:if(2048&s.flags){if(0===g)break inf_leave;b=0;do I=l[d+b++],s.head&&I&&65536>s.length&&(s.head.name+=_StringfromCharCode(I));while(I&&b<g);if(512&s.flags&&(s.check=crc32_1(s.check,l,b,d)),g-=b,d+=b,I)break inf_leave}else s.head&&(s.head.name=null);s.length=0,s.mode=8;case 8:if(4096&s.flags){if(0===g)break inf_leave;b=0;do I=l[d+b++],s.head&&I&&65536>s.length&&(s.head.comment+=_StringfromCharCode(I));while(I&&b<g);if(512&s.flags&&(s.check=crc32_1(s.check,l,b,d)),g-=b,d+=b,I)break inf_leave}else s.head&&(s.head.comment=null);s.mode=9;case 9:if(512&s.flags){for(;16>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(m!==(65535&s.check)){e.msg="header crc mismatch",s.mode=30;break}m=0,p=0}s.head&&(s.head.hcrc=1&s.flags>>9,s.head.done=!0),e.adler=s.check=0,s.mode=12;break;case 10:for(;32>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}e.adler=s.check=zswap32(m),m=0,p=0,s.mode=11;case 11:if(0===s.havedict)return e.next_out=h,e.avail_out=c,e.next_in=d,e.avail_in=g,s.hold=m,s.bits=p,2;e.adler=s.check=1,s.mode=12;case 12:if(5===t||6===t)break inf_leave;case 13:if(s.last){m>>>=7&p,p-=7&p,s.mode=27;break}for(;3>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}switch(s.last=1&m,m>>>=1,p-=1,3&m){case 0:s.mode=14;break;case 1:if(fixedtables(s),s.mode=20,6===t){m>>>=2,p-=2;break inf_leave}break;case 2:s.mode=17;break;case 3:e.msg="invalid block type",s.mode=30;}m>>>=2,p-=2;break;case 14:for(m>>>=7&p,p-=7&p;32>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if((65535&m)!=(65535^m>>>16)){e.msg="invalid stored block lengths",s.mode=30;break}if(s.length=65535&m,m=0,p=0,s.mode=15,6===t)break inf_leave;case 15:s.mode=16;case 16:if(b=s.length,b){if(b>g&&(b=g),b>c&&(b=c),0===b)break inf_leave;common.arraySet(r,l,d,b,h),g-=b,d+=b,c-=b,h+=b,s.length-=b;break}s.mode=12;break;case 17:for(;14>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(s.nlen=(31&m)+257,m>>>=5,p-=5,s.ndist=(31&m)+1,m>>>=5,p-=5,s.ncode=(15&m)+4,m>>>=4,p-=4,286<s.nlen||30<s.ndist){e.msg="too many length or distance symbols",s.mode=30;break}s.have=0,s.mode=18;case 18:for(;s.have<s.ncode;){for(;3>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.lens[o[s.have++]]=7&m,m>>>=3,p-=3}for(;19>s.have;)s.lens[o[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,M={bits:s.lenbits},P=inftrees(0,s.lens,0,19,s.lencode,0,s.work,M),s.lenbits=M.bits,P){e.msg="invalid code lengths set",s.mode=30;break}s.have=0,s.mode=19;case 19:for(;s.have<s.nlen+s.ndist;){for(;;){if(a=s.lencode[m&(1<<s.lenbits)-1],x=a>>>24,y=255&a>>>16,k=65535&a,x<=p)break;if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(16>k)m>>>=x,p-=x,s.lens[s.have++]=k;else{if(16===k){for(B=x+2;p<B;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(m>>>=x,p-=x,0===s.have){e.msg="invalid bit length repeat",s.mode=30;break}I=s.lens[s.have-1],b=3+(3&m),m>>>=2,p-=2}else if(17===k){for(B=x+3;p<B;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}m>>>=x,p-=x,I=0,b=3+(7&m),m>>>=3,p-=3}else{for(B=x+7;p<B;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}m>>>=x,p-=x,I=0,b=11+(127&m),m>>>=7,p-=7}if(s.have+b>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=30;break}for(;b--;)s.lens[s.have++]=I}}if(30===s.mode)break;if(0===s.lens[256]){e.msg="invalid code -- missing end-of-block",s.mode=30;break}if(s.lenbits=9,M={bits:s.lenbits},P=inftrees(1,s.lens,0,s.nlen,s.lencode,0,s.work,M),s.lenbits=M.bits,P){e.msg="invalid literal/lengths set",s.mode=30;break}if(s.distbits=6,s.distcode=s.distdyn,M={bits:s.distbits},P=inftrees(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,M),s.distbits=M.bits,P){e.msg="invalid distances set",s.mode=30;break}if(s.mode=20,6===t)break inf_leave;case 20:s.mode=21;case 21:if(6<=g&&258<=c){e.next_out=h,e.avail_out=c,e.next_in=d,e.avail_in=g,s.hold=m,s.bits=p,inffast(e,f),h=e.next_out,r=e.output,c=e.avail_out,d=e.next_in,l=e.input,g=e.avail_in,m=s.hold,p=s.bits,12===s.mode&&(s.back=-1);break}for(s.back=0;;){if(a=s.lencode[m&(1<<s.lenbits)-1],x=a>>>24,y=255&a>>>16,k=65535&a,x<=p)break;if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(y&&0==(240&y)){for(v=x,D=y,S=k;;){if(a=s.lencode[S+((m&(1<<v+D)-1)>>v)],x=a>>>24,y=255&a>>>16,k=65535&a,v+x<=p)break;if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}m>>>=v,p-=v,s.back+=v}if(m>>>=x,p-=x,s.back+=x,s.length=k,0===y){s.mode=26;break}if(32&y){s.back=-1,s.mode=12;break}if(64&y){e.msg="invalid literal/length code",s.mode=30;break}s.extra=15&y,s.mode=22;case 22:if(s.extra){for(B=s.extra;p<B;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.length+=m&(1<<s.extra)-1,m>>>=s.extra,p-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=23;case 23:for(;;){if(a=s.distcode[m&(1<<s.distbits)-1],x=a>>>24,y=255&a>>>16,k=65535&a,x<=p)break;if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(0==(240&y)){for(v=x,D=y,S=k;;){if(a=s.distcode[S+((m&(1<<v+D)-1)>>v)],x=a>>>24,y=255&a>>>16,k=65535&a,v+x<=p)break;if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}m>>>=v,p-=v,s.back+=v}if(m>>>=x,p-=x,s.back+=x,64&y){e.msg="invalid distance code",s.mode=30;break}s.offset=k,s.extra=15&y,s.mode=24;case 24:if(s.extra){for(B=s.extra;p<B;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}s.offset+=m&(1<<s.extra)-1,m>>>=s.extra,p-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=30;break}s.mode=25;case 25:if(0===c)break inf_leave;if(b=f-c,s.offset>b){if(b=s.offset-b,b>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=30;break}b>s.wnext?(b-=s.wnext,_=s.wsize-b):_=s.wnext-b,b>s.length&&(b=s.length),w=s.window}else w=r,_=h-s.offset,b=s.length;b>c&&(b=c),c-=b,s.length-=b;do r[h++]=w[_++];while(--b);0===s.length&&(s.mode=21);break;case 26:if(0===c)break inf_leave;r[h++]=s.length,c--,s.mode=21;break;case 27:if(s.wrap){for(;32>p;){if(0===g)break inf_leave;g--,m|=l[d++]<<p,p+=8}if(f-=c,e.total_out+=f,s.total+=f,f&&(e.adler=s.check=s.flags?crc32_1(s.check,r,f,h-f):adler32_1(s.check,r,f,h-f)),f=c,(s.flags?m:zswap32(m))!==s.check){e.msg="incorrect data check",s.mode=30;break}m=0,p=0}s.mode=28;case 28:if(s.wrap&&s.flags){for(;32>p;){if(0===g)break inf_leave;g--,m+=l[d++]<<p,p+=8}if(m!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=30;break}m=0,p=0}s.mode=29;case 29:P=1;break inf_leave;case 30:P=-3;break inf_leave;case 31:return-4;case 32:default:return-2;}if(e.next_out=h,e.avail_out=c,e.next_in=d,e.avail_in=g,s.hold=m,s.bits=p,(s.wsize||f!==e.avail_out&&30>s.mode&&(27>s.mode||4!==t))&&updatewindow(e,e.output,e.next_out,f-e.avail_out));return u-=e.avail_in,f-=e.avail_out,e.total_in+=u,e.total_out+=f,s.total+=f,s.wrap&&f&&(e.adler=s.check=s.flags?crc32_1(s.check,r,f,e.next_out-f):adler32_1(s.check,r,f,e.next_out-f)),e.data_type=s.bits+(s.last?64:0)+(12===s.mode?128:0)+(20===s.mode||15===s.mode?256:0),(0===u&&0===f||4===t)&&0===P&&(P=-5),P}function inflateEnd(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0}function inflateGetHeader(e,t){var a;return e&&e.state?(a=e.state,0==(2&a.wrap))?-2:(a.head=t,t.done=!1,0):-2}function inflateSetDictionary(e,t){var a=t.length,i,n,o;return e&&e.state?(i=e.state,0!==i.wrap&&11!==i.mode)?-2:11===i.mode&&(n=1,n=adler32_1(n,t,a,0),n!==i.check)?-3:(o=updatewindow(e,t,a,a),o)?(i.mode=31,-4):(i.havedict=1,0):-2}function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}function Inflate(e){if(!(this instanceof Inflate))return new Inflate(e);this.options=common.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&16>t.windowBits&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),0<=t.windowBits&&16>t.windowBits&&!(e&&e.windowBits)&&(t.windowBits+=32),15<t.windowBits&&48>t.windowBits&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new zstream,this.strm.avail_out=0;var a=inflate_1.inflateInit2(this.strm,t.windowBits);if(a!==constants$1.Z_OK)throw new Error(messages[a]);this.header=new gzheader,inflate_1.inflateGetHeader(this.strm,this.header)}function inflate$1(e,t){var a=new Inflate(t);if(a.push(e,!0),a.err)throw a.msg||messages[a.err];return a.result}function inflateRaw(e,t){return t=t||{},t.raw=!0,inflate$1(e,t)}function updateCrc(e,t,a){for(var i=e,o=0;o<a;o++)i=crcTable$1[255&(i^t[o])]^i>>>8;return i}function crc(e,t){return(updateCrc(initialCrc,e,t)^initialCrc)>>>0}function unfilterNone(e,t,a){for(var n=0;n<a;n++)t[n]=e[n]}function unfilterSub(e,t,a,n){for(var o=0;o<n;o++)t[o]=e[o];for(;o<a;o++)t[o]=255&e[o]+t[o-n]}function unfilterUp(e,t,a,n){var o=0;if(0===a.length)for(;o<n;o++)t[o]=e[o];else for(;o<n;o++)t[o]=255&e[o]+a[o]}function unfilterAverage(e,t,a,n,o){var s=0;if(0===a.length){for(;s<o;s++)t[s]=e[s];for(;s<n;s++)t[s]=255&e[s]+(t[s-o]>>1)}else{for(;s<o;s++)t[s]=255&e[s]+(a[s]>>1);for(;s<n;s++)t[s]=255&e[s]+(t[s-o]+a[s]>>1)}}function unfilterPaeth(e,t,a,n,o){var s=0;if(0===a.length){for(;s<o;s++)t[s]=e[s];for(;s<n;s++)t[s]=255&e[s]+t[s-o]}else{for(;s<o;s++)t[s]=255&e[s]+a[s];for(;s<n;s++)t[s]=255&e[s]+paethPredictor(t[s-o],a[s],a[s-o])}}function paethPredictor(e,t,a){var i=e+t-a,n=_Mathabs(i-e),o=_Mathabs(i-t),s=_Mathabs(i-a);return n<=o&&n<=s?e:o<=s?t:a}function swap16(e){return(255&e)<<8|255&e>>8}function checkInteger(e,t){if(_NumberisInteger(e)&&0<e)return e;throw new TypeError(`${t} must be a positive integer`)}function getColourType(e){const{components:t=3,alpha:a=!0,bitDepth:i=8}=e;if(3!==t&&1!==t)throw new RangeError(`unsupported number of components: ${t}`);if(8!==i&&16!==i)throw new RangeError(`unsupported bit depth: ${i}`);const n=t+ +a,o={channels:n,bitDepth:i};switch(n){case 4:o.colourType=6;break;case 3:o.colourType=2;break;case 1:o.colourType=0;break;case 2:o.colourType=4;break;default:throw new Error(`unsupported number of channels: ${n}`);}return o}function writeDataBytes(e,t,a,i){for(var n=0;n<a;n++)t.writeByte(e[i++]);return i}function writeDataUint16(e,t,a,i){for(var n=0;n<a;n++)t.writeUint16(e[i++]);return i}function decodePNG(e,t={}){const a=new PNGDecoder(e,t);return a.decode()}function encodePNG(e,t={}){const a=new PNGEncoder(e,t);return a.encode()}function JPEGEncoder(e){function t(e){for(var a=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],n=0,o;64>n;n++)o=D((a[n]*e+50)/100),1>o?o=1:255<o&&(o=255),S[X[n]]=o;for(var s=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],l=0,r;64>l;l++)r=D((s[l]*e+50)/100),1>r?r=1:255<r&&(r=255),I[X[l]]=r;for(var d=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],h=0,g=0;8>g;g++)for(var c=0;8>c;c++)P[h]=1/(8*(S[X[h]]*d[g]*d[c])),M[h]=1/(8*(I[X[h]]*d[g]*d[c])),h++}function a(e,t){for(var a=0,i=0,n=[],o=1;16>=o;o++){for(var s=1;s<=e[o];s++)n[t[i]]=[],n[t[i]][0]=a,n[t[i]][1]=o,i++,a++;a*=2}return n}function i(){Z=a(V,U),K=a(N,H),J=a(G,O),Q=a(q,W)}function n(){for(var e=1,t=2,a=1;15>=a;a++){for(var i=e;i<t;i++)C[32767+i]=a,B[32767+i]=[],B[32767+i][1]=a,B[32767+i][0]=i;for(var n=-(t-1);n<=-e;n++)C[32767+n]=a,B[32767+n]=[],B[32767+n][1]=a,B[32767+n][0]=t-1+n;e<<=1,t<<=1}}function o(){for(var e=0;256>e;e++)F[e]=19595*e,F[e+256>>0]=38470*e,F[e+512>>0]=7471*e+32768,F[e+768>>0]=-11059*e,F[e+1024>>0]=-21709*e,F[e+1280>>0]=32768*e+8421375,F[e+1536>>0]=-27439*e,F[e+1792>>0]=-5329*e}function s(e){for(var t=e[0],a=e[1]-1;0<=a;)t&1<<a&&(A|=1<<z),a--,z--,0>z&&(255==A?(r(255),r(0)):r(A),z=7,A=0)}function r(e){l.push(e)}function d(e){r(255&e>>8),r(255&e)}function h(e,t){var a=0,n=8,o,s,l,r,d,h,g,c,m;for(m=0;m<n;++m){o=e[a],s=e[a+1],l=e[a+2],r=e[a+3],d=e[a+4],h=e[a+5],g=e[a+6],c=e[a+7];var p=o+c,u=o-c,f=s+g,b=s-g,_=l+h,w=l-h,x=r+d,y=r-d,k=p+x,v=p-x,D=f+_,S=f-_;e[a]=k+D,e[a+4]=k-D;var I=.707106781*(S+v);e[a+2]=v+I,e[a+6]=v-I,k=y+w,D=w+b,S=b+u;var P=.382683433*(k-S),M=.5411961*k+P,B=1.306562965*S+P,C=.707106781*D,R=u+C,A=u-C;e[a+5]=A+M,e[a+3]=A-M,e[a+1]=R+B,e[a+7]=R-B,a+=8}for(a=0,m=0;m<n;++m){o=e[a],s=e[a+8],l=e[a+16],r=e[a+24],d=e[a+32],h=e[a+40],g=e[a+48],c=e[a+56];var z=o+c,T=o-c,L=s+g,E=s-g,Y=l+h,F=l-h,X=r+d,V=r-d,U=z+X,G=z-X,O=L+Y,N=L-Y;e[a]=U+O,e[a+32]=U-O;var H=.707106781*(N+G);e[a+16]=G+H,e[a+48]=G-H,U=V+F,O=F+E,N=E+T;var q=.382683433*(U-N),W=.5411961*U+q,Z=1.306562965*N+q,K=.707106781*O,J=T+K,Q=T-K;e[a+40]=Q+W,e[a+24]=Q-W,e[a+8]=J+Z,e[a+56]=J-Z,a++}var $;for(m=0;m<64;++m)$=e[m]*t[m],j[m]=0<$?0|$+.5:0|$-.5;return j}function c(){d(65504),d(16),r(74),r(70),r(73),r(70),r(0),r(1),r(1),r(0),d(1),d(1),r(0),r(0)}function m(e,t){d(65472),d(17),r(8),d(t),d(e),r(3),r(1),r(17),r(0),r(2),r(17),r(1),r(3),r(17),r(1)}function u(){d(65499),d(132),r(0);for(var e=0;64>e;e++)r(S[e]);r(1);for(var t=0;64>t;t++)r(I[t])}function f(){d(65476),d(418),r(0);for(var e=0;16>e;e++)r(V[e+1]);for(var t=0;11>=t;t++)r(U[t]);r(16);for(var a=0;16>a;a++)r(G[a+1]);for(var s=0;161>=s;s++)r(O[s]);r(1);for(var h=0;16>h;h++)r(N[h+1]);for(var g=0;11>=g;g++)r(H[g]);r(17);for(var c=0;16>c;c++)r(q[c+1]);for(var u=0;161>=u;u++)r(W[u])}function _(){d(65498),d(12),r(3),r(1),r(0),r(2),r(17),r(3),r(17),r(0),r(63),r(0)}function w(e,t,a,n,o){for(var l=o[0],r=o[240],d=16,g=63,c=h(e,t),m=0,p;m<64;++m)R[X[m]]=c[m];var u=R[0]-a;a=R[0],0==u?s(n[0]):(p=32767+u,s(n[C[p]]),s(B[p]));for(var f=63;0<f&&0==R[f];f--);if(0==f)return s(l),a;for(var b=1,_;b<=f;){for(var w=b;0==R[b]&&b<=f;++b);var x=b-w;if(x>=d){_=x>>4;for(var y=1;y<=_;++y)s(r);x&=15}p=32767+R[b],s(o[(x<<4)+C[p]]),s(B[p]),b++}return f!=g&&s(l),a}function x(){for(var e=0;256>e;e++)Y[e]=_StringfromCharCode(e)}function k(e){if(0>=e&&(e=1),100<e&&(e=100),$!=e){var a=0;a=50>e?_Mathfloor(5e3/e):_Mathfloor(200-2*e),t(a),$=e}}function v(){var t=new Date().getTime();e||(e=50),x(),i(),n(),o(),k(e);new Date().getTime()-t}var D=_Mathfloor,S=Array(64),I=Array(64),P=Array(64),M=Array(64),B=Array(65535),C=Array(65535),j=Array(64),R=Array(64),l=[],A=0,z=7,T=Array(64),L=Array(64),E=Array(64),Y=Array(256),F=Array(2048),X=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],V=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],U=[0,1,2,3,4,5,6,7,8,9,10,11],G=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],O=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],N=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],H=[0,1,2,3,4,5,6,7,8,9,10,11],q=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],W=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250],Z,K,J,Q,$;this.encode=function(e,t){var a=new Date().getTime();t&&k(t),l=[],A=0,z=7,d(65496),c(),u(),m(e.width,e.height),f(),_();var i=0,n=0,o=0;A=0,z=7,this.encode.displayName="_encode_";for(var h=e.data,v=e.width,D=e.height,S=4*v,I=0,B,C,j,R,Y,X,V,U,G;I<D;){for(B=0;B<S;){for(Y=S*I+B,X=Y,V=-1,U=0,G=0;64>G;G++)U=G>>3,V=4*(7&G),X=Y+U*S+V,I+U>=D&&(X-=S*(I+1+U-D)),B+V>=S&&(X-=B+V-S+4),C=h[X++],j=h[X++],R=h[X++],T[G]=(F[C]+F[j+256>>0]+F[R+512>>0]>>16)-128,L[G]=(F[C+768>>0]+F[j+1024>>0]+F[R+1280>>0]>>16)-128,E[G]=(F[C+1280>>0]+F[j+1536>>0]+F[R+1792>>0]>>16)-128;i=w(T,P,i,Z,J),n=w(L,M,n,K,Q),o=w(E,M,o,K,Q),B+=32}I+=8}if(0<=z){var O=[];O[1]=z+1,O[0]=(1<<z+1)-1,s(O)}return d(65497),new Buffer(l);var N="data:image/jpeg;base64,"+btoa(l.join(""))},v()}function encode$2(e,t){"undefined"==typeof t&&(t=50);var a=new JPEGEncoder(t),i=a.encode(e,t);return{data:i,width:e.width,height:e.height}}function decode(e,t){var a=new Uint8Array(e),i=new JpegImage;i.parse(a);var n={width:i.width,height:i.height,data:t?new Uint8Array(4*(i.width*i.height)):new Buffer(4*(i.width*i.height))};return i.copyToImageData(n),n}function encode$3(e){var t=e.length,a="",n;for(n=0;n<t;n+=3)a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[e[n]>>2],a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&e[n])<<4|e[n+1]>>4],a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&e[n+1])<<2|e[n+2]>>6],a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[63&e[n+2]];return 2==t%3?a="".concat(a.substring(0,a.length-1),"="):1==t%3&&(a="".concat(a.substring(0,a.length-2),"==")),a}function decode$1(e){var t=.75*e.length,a=e.length,i=0,n,o,s,l;"="===e[e.length-1]&&(t--,"="===e[e.length-2]&&t--);for(var r=new Uint8Array(t),d=0;d<a;d+=4)n=lookup[e.charCodeAt(d)],o=lookup[e.charCodeAt(d+1)],s=lookup[e.charCodeAt(d+2)],l=lookup[e.charCodeAt(d+3)],r[i++]=n<<2|o>>4,r[i++]=(15&o)<<4|s>>2,r[i++]=(3&s)<<6|63&l;return r}function toBase64URL(e,t){var a=encode$3(e);return"data:".concat(t,";base64,").concat(a)}function createCanvas(e,t){var a=self.document.createElement("canvas");return a.width=e,a.height=t,a}function fetchBinary(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.withCredentials;return new Promise(function(t,i){var n=new self.XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.withCredentials=void 0!==a&&a,n.onload=function(a){200===this.status?t(this.response):i(a)},n.onerror=i,n.send()})}function createWriteStream(){throw new Error("createWriteStream does not exist in the browser")}function writeFile(){throw new Error("writeFile does not exist in the browser")}function getType(e){return e.includes("/")||(e="image/".concat(e)),e}function encodeJpeg(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a={width:e.width,height:e.height,data:e.getRGBAData()};return jpegJs_1(a,t.quality).data}function encodePng(e,t){var a={width:e.width,height:e.height,components:e.components,alpha:e.alpha,bitDepth:e.bitDepth,data:e.data};return(1===a.bitDepth||32===a.bitDepth)&&(a.bitDepth=8,a.components=3,a.alpha=1,a.data=e.getRGBAData()),encodePNG(a,t)}function setExportMethods(e){for(var t in exportMethods)e.prototype[t]=exportMethods[t]}function extendMethod(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=a.inPlace,n=a.returnThis,o=a.partialArgs,s=void 0===o?[]:o;return Image.prototype[e]=void 0!==i&&i?function(){this.computed=null;for(var e=arguments.length,a=Array(e),i=0;i<e;i++)a[i]=arguments[i];var o=t.apply(this,[...s,...a]);return void 0===n||n?this:o}:function(){for(var e=arguments.length,a=Array(e),i=0;i<e;i++)a[i]=arguments[i];return t.apply(this,[...s,...a])},Image}function extendProperty(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=a.partialArgs,n=void 0===i?[]:i;return computedPropertyDescriptor.get=function(){if(null===this.computed)this.computed={};else if(hasOwn(e,this.computed))return this.computed[e];var a=t.apply(this,n);return this.computed[e]=a,a},Object.defineProperty(Image.prototype,e,computedPropertyDescriptor),Image}function getRGBAData(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.clamped;this.checkProcessable("getRGBAData",{components:[1,3],bitDepth:[1,8,16,32]});var a=4*(this.width*this.height),i=t?new Uint8ClampedArray(a):new Uint8Array(a);return 1===this.bitDepth?fillDataFromBinary(this,i):32===this.bitDepth?(this.checkProcessable("getRGBAData",{alpha:0}),1===this.components?fillDataFromGrey32(this,i):3===this.components&&(this.checkProcessable("getRGBAData",{colorModel:["RGB"]}),fillDataFromRGB32(this,i))):1===this.components?fillDataFromGrey(this,i):3===this.components&&(this.checkProcessable("getRGBAData",{colorModel:["RGB"]}),fillDataFromRGB(this,i)),1===this.alpha?(this.checkProcessable("getRGBAData",{bitDepth:[8,16]}),copyAlpha(this,i)):fillAlpha(this,i),i}function fillDataFromBinary(e,t){for(var a=0,n;a<e.size;a++)n=e.getBit(a),t[4*a]=255*n,t[4*a+1]=255*n,t[4*a+2]=255*n}function fillDataFromGrey32(e,t){for(var a=e.min[0],n=e.max[0],o=0,s;o<e.size;o++)s=_Mathfloor(255*(e.data[o]-a)/(n-a)),t[4*o]=s,t[4*o+1]=s,t[4*o+2]=s}function fillDataFromRGB32(e,t){for(var a=_Mathmin(...e.min),n=_Mathmax(...e.max),o=n-a,s=0;s<e.size;s++){var l=_Mathfloor(255*(e.data[3*s]-a)/o),r=_Mathfloor(255*(e.data[3*s+1]-a)/o),d=_Mathfloor(255*(e.data[3*s+2]-a)/o);t[4*s]=l,t[4*s+1]=r,t[4*s+2]=d}}function fillDataFromGrey(e,t){for(var a=0;a<e.size;a++)t[4*a]=e.data[a*e.channels]>>>e.bitDepth-8,t[4*a+1]=e.data[a*e.channels]>>>e.bitDepth-8,t[4*a+2]=e.data[a*e.channels]>>>e.bitDepth-8}function fillDataFromRGB(e,t){for(var a=0;a<e.size;a++)t[4*a]=e.data[a*e.channels]>>>e.bitDepth-8,t[4*a+1]=e.data[a*e.channels+1]>>>e.bitDepth-8,t[4*a+2]=e.data[a*e.channels+2]>>>e.bitDepth-8}function copyAlpha(e,t){for(var a=0;a<e.size;a++)t[4*a+3]=e.data[a*e.channels+e.components]>>e.bitDepth-8}function fillAlpha(e,t){for(var a=0;a<e.size;a++)t[4*a+3]=255}function getKind(e){var t=kinds[e];if(!t)throw new RangeError("invalid image kind: ".concat(e));return t}function verifyKindDefinition(e){var t=e.components,a=e.alpha,i=e.bitDepth,n=e.colorModel;if(!_NumberisInteger(t)||0>=t)throw new RangeError("invalid components: ".concat(t,". Must be a positive integer"));if(0!==a&&1!==a&&"boolean"!=typeof a)throw new TypeError("invalid alpha: ".concat(a,": must be a boolean, 0 or 1"));if(!validBitDepth.includes(i))throw new RangeError("invalid bitDepth: ".concat(i,". Must be one of ").concat(validBitDepth.join(", ")));if(!ColorModel[n])throw new RangeError("invalid colorModel: ".concat(n,". Must be one of ").concat(Object.keys(ColorModel).join(", ")))}function getTheoreticalPixelArraySize(e,t,a){var i=t*e;return 1===a&&(i=_Mathceil(i/8)),i}function createPixelArray(e,t,a,n,o,s){var l=n*e,r;switch(o){case 1:r=new Uint8Array(_Mathceil(l/8));break;case 8:r=new Uint8Array(l);break;case 16:r=new Uint16Array(l);break;case 32:r=new Float32Array(l);break;default:throw new Error("Cannot create pixel array for bit depth ".concat(o));}if(a)for(var d=t;d<r.length;d+=n)r[d]=s;return r}function alwaysArray(e){return"number"==typeof e?[e]:e}function readByte(e,t){if(1===t)return e.readUint8();for(var a=new Uint8Array(t),n=0;n<t;n++)a[n]=e.readUint8();return a}function readASCII(e,t){for(var a=[],n="",o=0,s;o<t;o++)s=_StringfromCharCode(e.readUint8()),"\0"===s?(a.push(n),n=""):n+=s;return 1===a.length?a[0]:a}function readShort(e,t){if(1===t)return e.readUint16();for(var a=new Uint16Array(t),n=0;n<t;n++)a[n]=e.readUint16();return a}function readLong(e,t){if(1===t)return e.readUint32();for(var a=new Uint32Array(t),n=0;n<t;n++)a[n]=e.readUint32();return a}function readRational(e,t){if(1===t)return e.readUint32()/e.readUint32();for(var a=Array(t),n=0;n<t;n++)a[n]=e.readUint32()/e.readUint32();return a}function readSByte(e,t){if(1===t)return e.readInt8();for(var a=new Int8Array(t),n=0;n<t;n++)a[n]=e.readInt8();return a}function readSShort(e,t){if(1===t)return e.readInt16();for(var a=new Int16Array(t),n=0;n<t;n++)a[n]=e.readInt16();return a}function readSLong(e,t){if(1===t)return e.readInt32();for(var a=new Int32Array(t),n=0;n<t;n++)a[n]=e.readInt32();return a}function readSRational(e,t){if(1===t)return e.readInt32()/e.readInt32();for(var a=Array(t),n=0;n<t;n++)a[n]=e.readInt32()/e.readInt32();return a}function readFloat(e,t){if(1===t)return e.readFloat32();for(var a=new Float32Array(t),n=0;n<t;n++)a[n]=e.readFloat32();return a}function readDouble(e,t){if(1===t)return e.readFloat64();for(var a=new Float64Array(t),n=0;n<t;n++)a[n]=e.readFloat64();return a}function getDataArray(e,t,a,i){return 8===a?new Uint8Array(e*t):16===a?new Uint16Array(e*t):32===a&&3===i?new Float32Array(e*t):unsupported("bit depth / sample format",a+" / "+i)}function fill8bit(e,t,a,n){for(var o=0;o<n;o++)e[a++]=t.getUint8(o);return a}function fill16bit(e,t,a,n,o){for(var s=0;s<2*n;s+=2)e[a++]=t.getUint16(s,o);return a}function fillFloat32(e,t,a,n,o){for(var s=0;s<4*n;s+=4)e[a++]=t.getFloat32(s,o);return a}function unsupported(e,t){throw new Error("Unsupported "+e+": "+t)}function validateBitDepth(e){if(e.length){const a=e;e=a[0];for(var t=0;t<a.length;t++)a[t]!==e&&unsupported("bit depth",a)}return e}function decode$4(e){const t=new IOBuffer_1$1(e),a={};t.setBigEndian();const i=t.readUint16();if(65496!==i)throw new Error("SOI marker not found. Not a valid JPEG file");const n=t.readUint16();if(65505===n){const e=t.readUint16(),i=t.readBytes(6);if(69===i[0]&&120===i[1]&&105===i[2]&&102===i[3]&&0===i[4]&&0===i[5]){const e=src.decode(t,{onlyFirst:!0,ignoreImageData:!0,offset:t.offset});a.exif=e}}return a}function alwaysArray$1(e){return"number"==typeof e?[e]:e}function getByteLength$1(e,t){return types$1.get(e)[0]*t}function readData$1(e,t,a){return types$1.get(t)[1](e,a)}function readByte$1(e,t){if(1===t)return e.readUint8();for(var a=new Uint8Array(t),n=0;n<t;n++)a[n]=e.readUint8();return a}function readASCII$1(e,t){for(var a=[],n="",o=0,s;o<t;o++)s=_StringfromCharCode(e.readUint8()),"\0"===s?(a.push(n),n=""):n+=s;return 1===a.length?a[0]:a}function readShort$1(e,t){if(1===t)return e.readUint16();for(var a=new Uint16Array(t),n=0;n<t;n++)a[n]=e.readUint16();return a}function readLong$1(e,t){if(1===t)return e.readUint32();for(var a=new Uint32Array(t),n=0;n<t;n++)a[n]=e.readUint32();return a}function readRational$1(e,t){if(1===t)return e.readUint32()/e.readUint32();for(var a=Array(t),n=0;n<t;n++)a[n]=e.readUint32()/e.readUint32();return a}function readSByte$1(e,t){if(1===t)return e.readInt8();for(var a=new Int8Array(t),n=0;n<t;n++)a[n]=e.readInt8();return a}function readSShort$1(e,t){if(1===t)return e.readInt16();for(var a=new Int16Array(t),n=0;n<t;n++)a[n]=e.readInt16();return a}function readSLong$1(e,t){if(1===t)return e.readInt32();for(var a=new Int32Array(t),n=0;n<t;n++)a[n]=e.readInt32();return a}function readSRational$1(e,t){if(1===t)return e.readInt32()/e.readInt32();for(var a=Array(t),n=0;n<t;n++)a[n]=e.readInt32()/e.readInt32();return a}function readFloat$1(e,t){if(1===t)return e.readFloat32();for(var a=new Float32Array(t),n=0;n<t;n++)a[n]=e.readFloat32();return a}function readDouble$1(e,t){if(1===t)return e.readFloat64();for(var a=new Float64Array(t),n=0;n<t;n++)a[n]=e.readFloat64();return a}function getDataArray$1(e,t,a,i){if(8===a)return new Uint8Array(e*t);if(16===a)return new Uint16Array(e*t);if(32===a&&3===i)return new Float32Array(e*t);throw unsupported$1("bit depth / sample format",`${a} / ${i}`)}function fill8bit$1(e,t,a,n){for(var o=0;o<n;o++)e[a++]=t.getUint8(o);return a}function fill16bit$1(e,t,a,n,o){for(var s=0;s<2*n;s+=2)e[a++]=t.getUint16(s,o);return a}function fillFloat32$1(e,t,a,n,o){for(var s=0;s<4*n;s+=4)e[a++]=t.getFloat32(s,o);return a}function unsupported$1(e,t){return new Error(`Unsupported ${e}: ${t}`)}function validateBitDepth$1(e){if(e.length){const a=e;e=a[0];for(var t=0;t<a.length;t++)if(a[t]!==e)throw unsupported$1("bit depth",a)}return e}function decodeTIFF(e,t={}){const a=new TIFFDecoder$1(e,t);return a.decode(t)}function matchAndCrop(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.algorithm,a=void 0===t?"matchToPrevious":t,n=e.ignoreBorder,o=void 0===n?[0,0]:n;this.checkProcessable("matchAndCrop",{bitDepth:[8,16]});var s=this[0],l=[];l[0]={position:[0,0],image:this[0]};for(var r=[0,0],d=1,h;d<this.length;d++)h=s.getBestMatch(this[d],{border:o}),l[d]={position:[h[0]+r[0],h[1]+r[1]],image:this[d]},"matchToPrevious"===a&&(r[0]+=h[0],r[1]+=h[1],s=this[d]);for(var g=0,c=0,m=0,p=0,u=0,f;u<l.length;u++)f=l[u],f.position[0]>g&&(g=f.position[0]),f.position[0]<c&&(c=f.position[0]),f.position[1]>m&&(m=f.position[1]),f.position[1]<p&&(p=f.position[1]);c=0-c,p=0-p;for(var b=0,_;b<l.length;b++)_=l[b],_.crop=_.image.crop({x:g-_.position[0],y:m-_.position[1],width:s.width-c-g,height:s.height-p-m});for(var w=[],x=0;x<l.length;x++)w[x]=l[x].crop;return new Stack(w)}function min(){this.checkProcessable("min",{bitDepth:[8,16]});for(var e=this[0].min,t=1;t<this.length;t++)for(var a=0;a<e.length;a++)e[a]=_Mathmin(e[a],this[t].min[a]);return e}function max(){this.checkProcessable("min",{bitDepth:[8,16]});for(var e=this[0].max,t=1;t<this.length;t++)for(var a=0;a<e.length;a++)e[a]=_Mathmax(e[a],this[t].max[a]);return e}function median(e){var t=e.reduce((e,t)=>e+t);if(0===t)throw new Error("unreachable");for(var a=0,i=0,n=t/2,o;;){if(0<e[a]){if(void 0!==o)return(o+a)/2;if(i+=e[a],i>n)return a;i===n&&(o=a)}a++}}function mean(e){for(var t=0,a=0,n=0;n<e.length;n++)t+=e[n],a+=e[n]*n;return 0===t?0:a/t}function median$1(){this.checkProcessable("median",{bitDepth:[8,16]});for(var e=this.getHistograms({maxSlots:this[0].maxValue+1}),t=Array(e.length),a=0,i;a<e.length;a++)i=e[a],t[a]=median(i);return t}function histogram(e){this.checkProcessable("min",{bitDepth:[8,16]});for(var t=this[0].getHistogram(e),a=1,n;a<this.length;a++){n=this[a].getHistogram(e);for(var o=0;o<t.length;o++)t[o]+=n[o]}return t}function histograms(e){this.checkProcessable("min",{bitDepth:[8,16]});for(var t=this[0].getHistograms(e),a=t[0].length,n=1,o;n<this.length;n++){o=this[n].getHistograms(e);for(var s=0;s<t.length;s++)for(var l=0;l<a;l++)t[s][l]+=o[s][l]}return t}function average(){this.checkProcessable("average",{bitDepth:[8,16]});for(var e=new Uint32Array(this[0].data.length),t=0,a;t<this.length;t++){a=this[t];for(var n=0;n<this[0].data.length;n++)e[n]+=a.data[n]}for(var o=Image.createFrom(this[0]),s=o.data,l=0;l<this[0].data.length;l++)s[l]=e[l]/this.length;return o}function extend(e){e.extendMethod("matchAndCrop",matchAndCrop),e.extendMethod("getMin",min),e.extendMethod("getMax",max),e.extendMethod("getMedian",median$1),e.extendMethod("getHistogram",histogram),e.extendMethod("getHistograms",histograms),e.extendMethod("getAverage",average)}function load(e,t){if("string"==typeof e)return loadURL(e,t);if(e instanceof ArrayBuffer)return Promise.resolve(loadBinary(new Uint8Array(e)));if(e.buffer)return Promise.resolve(loadBinary(e));throw new Error("argument to \"load\" must be a string or buffer.")}function loadBinary(e,t){function a(a){return t?t:toBase64URL(e,a)}var i=imageType_1(e);if(i)switch(i.mime){case"image/png":return loadPNG(e);case"image/jpeg":return loadJPEG(e);case"image/tiff":return loadTIFF(e);default:return loadGeneric(a(i.mime));}return loadGeneric(a("application/octet-stream"))}function loadURL(e,t){var a=e.slice(0,64).match(isDataURL),i;return i=null===a?fetchBinary(e,t):Promise.resolve(decode$1(e.slice(a[0].length))),i.then(t=>{var i=new Uint8Array(t);return loadBinary(i,a?e:void 0)})}function loadPNG(e){var t=decodePNG(e),a=0,i;switch(t.colourType){case 0:i=1;break;case 2:i=3;break;case 3:return loadPNGFromPalette(t);case 4:i=1,a=1;break;case 6:i=3,a=1;break;default:throw new Error("Unexpected colourType: ".concat(t.colourType));}return new Image(t.width,t.height,t.data,{components:i,alpha:a,bitDepth:t.bitDepth})}function loadPNGFromPalette(e){for(var t=e.width*e.height,a=new Uint8Array(3*t),n=8/e.bitDepth,o=8>e.bitDepth?n:1,s=parseInt("1".repeat(e.bitDepth),2),l=0,r=0;r<t;r++){var d=_Mathfloor(r/o),h=e.data[d];8>e.bitDepth&&(h=h>>>e.bitDepth*(n-1-r%n)&s);var g=e.palette[h];a[l++]=g[0],a[l++]=g[1],a[l++]=g[2]}return new Image(e.width,e.height,a,{components:3,alpha:!1,bitDepth:8})}function loadJPEG(e){var t=decode$5(e),a;t.exif&&(a=getMetadata(t.exif));var i=jpegJs_2(e,!0);return new Image(i.width,i.height,i.data,{meta:a})}function loadTIFF(e){var t=decodeTIFF(e);return 1===t.length?getImageFromIFD(t[0]):new Stack(t.map(getImageFromIFD))}function getMetadata(e){var t={tiff:e};return e.exif&&(t.exif=e.exif),e.gps&&(t.gps=e.gps),t}function getImageFromIFD(e){return new Image(e.width,e.height,e.data,{components:1,alpha:0,colorModel:"GREY",bitDepth:e.bitsPerSample.length?e.bitsPerSample[0]:e.bitsPerSample,meta:getMetadata(e)})}function loadGeneric(e,t){return t=t||{},new Promise(function(a,i){var n=new DOMImage;n.onload=function(){var e=n.width,i=n.height,o=createCanvas(e,i),s=o.getContext("2d");s.drawImage(n,0,0,e,i);var l=s.getImageData(0,0,e,i).data;a(new Image(e,i,l,t))},n.onerror=function(){i(new Error("Could not load ".concat(e)))},n.src=e})}function setValueMethods(e){for(var t in valueMethods)e.prototype[t]=valueMethods[t]}function getImageParameters(e){return{width:e.width,height:e.height,components:e.components,alpha:e.alpha,colorModel:e.colorModel,bitDepth:e.bitDepth}}function getOutputImage(e,t,a){var i=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{},n=t.out;if(n===void 0)return i.copy?e.clone():Image.createFrom(e,a);if(!Image.isImage(n))throw new TypeError("out must be an Image object");var o=Object.assign(getImageParameters(e),a);for(var s in o)if(n[s]!==o[s])throw new RangeError("cannot use out. Its ".concat(s," must be \"").concat(o[s],"\" (found \"").concat(n[s],"\")"));return n}function getOutputImageOrInPlace(e,t,a){if(t.inPlace!==void 0&&"boolean"!=typeof t.inPlace)throw new TypeError("inPlace option must be a boolean");if(t.inPlace){if(void 0!==t.out)throw new TypeError("out option must not be set if inPlace option is true");return e}return getOutputImage(e,t,null,a)}function abs(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.checkProcessable("abs",{bitDepth:[32]});var t=getOutputImageOrInPlace(this,e);return absolute(this,t),t}function absolute(e,t){for(var a=0;a<e.data.length;a++)t.data[a]=_Mathabs(e.data[a])}function copyAlphaChannel(e,t){if(1===e.alpha&&1===t.alpha)for(var a=0;a<e.size;a++)t.data[a*t.channels+t.components]=e.data[a*e.channels+e.components]}function invert(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.checkProcessable("invert",{bitDepth:[1,8,16]});var t=getOutputImageOrInPlace(this,e);return 1===this.bitDepth?invertBinary(this,t):(invertColor(this,t),this!==t&&copyAlphaChannel(this,t)),t}function invertBinary(e,t){for(var a=0;a<e.data.length;a++)t.data[a]=~e.data[a]}function invertColor(e,t){for(var a=0;a<e.data.length;a+=e.channels)for(var i=0;i<e.components;i++)t.data[a+i]=e.maxValue-e.data[a+i]}function flipX(){this.checkProcessable("flipX",{bitDepth:[8,16]});for(var e=0,t;e<this.height;e++){t=e*this.width*this.channels;for(var a=0;a<_Mathfloor(this.width/2);a++)for(var n=a*this.channels+t,o=(this.width-a-1)*this.channels+t,s=0,l;s<this.channels;s++)l=this.data[n+s],this.data[n+s]=this.data[o+s],this.data[o+s]=l}return this}function flipY(){this.checkProcessable("flipY",{bitDepth:[8,16]});for(var e=0;e<_Mathfloor(this.height/2);e++)for(var t=0;t<this.width;t++)for(var a=t*this.channels+e*this.width*this.channels,n=t*this.channels+(this.height-1-e)*this.channels*this.width,o=0,s;o<this.channels;o++)s=this.data[a+o],this.data[a+o]=this.data[n+o],this.data[n+o]=s;return this}function blurFilter(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.radius,a=void 0===t?1:t;if(1>a)throw new Error("radius must be greater than 1");for(var o=2*a+1,n=Array(o),s=0;s<o;s++){n[s]=Array(o);for(var l=0;l<o;l++)n[s][l]=1}for(var r=0;r<n.length;r++)n[r]=1;return this.convolution(n)}function assertNum(e){if("number"!=typeof e||numberIsNan(e))throw new TypeError("Expected a number")}function validateArrayOfChannels(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels,i=t.allowAlpha,n=t.defaultAlpha;return"boolean"!=typeof i&&(i=!0),"undefined"==typeof a?allChannels(e,n):validateChannels(e,a,i)}function allChannels(e,t){for(var a=t?e.channels:e.components,n=Array(a),o=0;o<a;o++)n[o]=o;return n}function validateChannels(e,t,a){Array.isArray(t)||(t=[t]);for(var i=0;i<t.length;i++)t[i]=validateChannel(e,t[i],a);return t}function validateChannel(e,t){var a=!(2<arguments.length&&arguments[2]!==void 0)||arguments[2];if(t===void 0)throw new RangeError("validateChannel : the channel has to be >=0 and <".concat(e.channels));if("string"==typeof t){switch(e.colorModel){case"GREY":break;case"RGB":"rgb".includes(t)&&("r"===t?t=0:"g"===t?t=1:"b"===t?t=2:void 0);break;case"HSL":"hsl".includes(t)&&("h"===t?t=0:"s"===t?t=1:"l"===t?t=2:void 0);break;case"HSV":"hsv".includes(t)&&("h"===t?t=0:"s"===t?t=1:"v"===t?t=2:void 0);break;case"CMYK":"cmyk".includes(t)&&("c"===t?t=0:"m"===t?t=1:"y"===t?t=2:"k"===t?t=3:void 0);break;default:throw new Error("Unexpected color model: ".concat(e.colorModel));}if("a"===t){if(!e.alpha)throw new Error("validateChannel : the image does not contain alpha channel");t=e.components}if("string"==typeof t)throw new Error("validateChannel : undefined channel: ".concat(t))}if(t>=e.channels)throw new RangeError("validateChannel : the channel has to be >=0 and <".concat(e.channels));if(!a&&t>=e.components)throw new RangeError("validateChannel : alpha channel may not be selected");return t}function medianFilter(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.radius,a=void 0===t?1:t,o=e.border,s=void 0===o?"copy":o,l=e.channels;if(this.checkProcessable("medianFilter",{bitDepth:[8,16]}),1>a)throw new Error("radius must be greater than 0");l=validateArrayOfChannels(this,l,!0);for(var r=a,d=a,h=Image.createFrom(this),g=(2*r+1)*(2*d+1),m=_Mathfloor(g/2),p=Array(g),u=0,f;u<l.length;u++){f=l[u];for(var b=d;b<this.height-d;b++)for(var _=r,w;_<this.width-r;_++){w=0;for(var k=-d;k<=d;k++)for(var v=-r,D;v<=r;v++)D=((b+k)*this.width+_+v)*this.channels+f,p[w++]=this.data[D];var S=(b*this.width+_)*this.channels+f,I=p.sort(asc)[m];h.data[S]=I}}if(this.alpha&&!l.includes(this.channels))for(var P=this.components;P<this.data.length;P+=this.channels)h.data[P]=this.data[P];return h.setBorder({size:[r,d],algorithm:s}),h}function gaussianFilter(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.radius,a=void 0===t?1:t,i=e.sigma,n=e.channels,o=e.border,s=void 0===o?"copy":o;this.checkProcessable("gaussian",{bitDepth:[8,16]});var l=getKernel(a,i);return this.convolution([l,l],{border:s,channels:n,algorithm:"separable"})}function getKernel(e,a){for(var o=2*e+1,n=Array(o),s=a?a:.3*(.5*(o-1)-1)+.8,l=0,r=0;r<o;r++){var d=r-e,h=_Mathexp(-.5/(s*s)*d*d);n[r]=h,l+=h}for(var t=0;t<o;t++)n[t]/=l;return n}function convolutionFFT(e,t,a){var n=matrix2Array(e),o=n.data,s=Object.assign({normalize:!1,divisor:1,rows:n.rows,cols:n.cols},a),l,r;if(s.rows&&s.cols)l=s.rows,r=s.cols;else throw new Error("Invalid number of rows or columns "+l+" "+r);var d=s.divisor,h=t.length,g=t[0].length,c,m;if(s.normalize)for(d=0,c=0;c<h;c++)for(m=0;m<g;m++)d+=t[c][m];if(0===d)throw new RangeError("convolution: The divisor is equal to zero");var p=FFTUtils$2.toRadix2(o,l,r),u=FFTUtils$2.convolute(p.data,t,p.rows,p.cols);if(u=FFTUtils$2.crop(u,p.rows,p.cols,l,r),0!=d&&1!=d)for(c=0;c<u.length;c++)u[c]/=d;return u}function convolutionDirect(e,t,a){var n=matrix2Array(e),o=n.data,s=Object.assign({normalize:!1,divisor:1,rows:n.rows,cols:n.cols},a),l,r;if(s.rows&&s.cols)l=s.rows,r=s.cols;else throw new Error("Invalid number of rows or columns "+l+" "+r);var d=s.divisor,h=t.length,g=t[0].length,c,m,p,u,f,b,_,w,k;if(s.normalize)for(d=0,c=0;c<h;c++)for(m=0;m<g;m++)d+=t[c][m];if(0===d)throw new RangeError("convolution: The divisor is equal to zero");var v=Array(l*r),D=_Mathfloor(h/2),S=_Mathfloor(g/2);for(u=0;u<l;u++)for(p=0;p<r;p++){for(b=0,m=0;m<h;m++)for(c=0;c<g;c++)_=t[h-m-1][g-c-1],w=(u+m-D+l)%l,k=(p+c-S+r)%r,f=w*r+k,b+=o[f]*_;f=u*r+p,v[f]=b/d}return v}function LoG(e,t,a){var n=1e3;a&&a.factor&&(n=a.factor);var o=Array(t),s,l,r,d;n*=-1;var h=(t-1)/2;for(s=0;s<t;s++)for(o[s]=Array(t),d=(s-h)*(s-h),l=0;l<t;l++)r=-((l-h)*(l-h)+d)/(2*e*e),o[s][l]=_Mathround(n*(1+r)*_Mathexp(r));return o}function matrix2Array(e){var t=e,a,n;if("number"!=typeof e[0]){a=e.length,n=e[0].length,t=Array(a*n);for(var o=0;o<a;o++)for(var s=0;s<n;s++)t[o*n+s]=e[o][s]}else{var l=_Mathsqrt(e.length);_NumberisInteger(l)&&(a=l,n=l)}return{data:t,rows:a,cols:n}}function validateKernel(e){var t,a;if(!Array.isArray(e))throw new Error("validateKernel: Invalid Kernel: ".concat(e));else if(!Array.isArray(e[0])){var n=_Mathsqrt(e.length);if(isInteger(n))a=t=_Mathfloor(_Mathsqrt(e.length)/2);else throw new RangeError("validateKernel: Kernel array should be a square");for(var o=Array(n),s=0;s<n;s++){o[s]=Array(n);for(var l=0;l<n;l++)o[s][l]=e[s*n+l]}e=o}else if(0==(1&e.length)||0==(1&e[0].length))throw new RangeError("validateKernel: Kernel rows and columns should be odd numbers");else t=_Mathfloor(e.length/2),a=_Mathfloor(e[0].length/2);return{kernel:e,kWidth:a,kHeight:t}}function clamp(e,t){return _Mathround(_Mathmin(_Mathmax(e,0),t.maxValue))}function directConvolution(e,t,a){if(a===void 0){const i=e.length+t.length-1;a=Array(i)}fill(a);for(var n=0;n<e.length;n++)for(var o=0;o<t.length;o++)a[n+o]+=e[n]*t[o];return a}function fill(e){for(var t=0;t<e.length;t++)e[t]=0}function convolutionSeparable(e,t,a,i){var n=Array(e.length),o,s,l,r;r=t[1],l=(r.length-1)/2,s=Array(a+r.length-1),o=Array(a);for(var d=0;d<i;d++){for(var h=0;h<a;h++)o[h]=e[d*a+h];directConvolution(o,r,s);for(var g=0;g<a;g++)n[d*a+g]=s[l+g]}r=t[0],l=(r.length-1)/2,s=Array(i+r.length-1),o=Array(i);for(var c=0;c<a;c++){for(var m=0;m<i;m++)o[m]=n[m*a+c];directConvolution(o,r,s);for(var p=0;p<i;p++)n[p*a+c]=s[l+p]}return n}function isAnyArray(e){return toString$2.call(e).endsWith("Array]")}function max$1(e){if(!src$3(e))throw new TypeError("input must be an array");if(0===e.length)throw new TypeError("input must not be empty");for(var t=e[0],a=1;a<e.length;a++)e[a]>t&&(t=e[a]);return t}function min$1(e){if(!src$3(e))throw new TypeError("input must be an array");if(0===e.length)throw new TypeError("input must not be empty");for(var t=e[0],a=1;a<e.length;a++)e[a]<t&&(t=e[a]);return t}function rescale(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};if(!src$3(e))throw new TypeError("input must be an array");else if(0===e.length)throw new TypeError("input must not be empty");var a;if(t.output!==void 0){if(!src$3(t.output))throw new TypeError("output option must be an array if specified");a=t.output}else a=Array(e.length);var n=min$1(e),o=max$1(e);if(n===o)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var s=t.min,l=void 0===s?t.autoMinMax?n:0:s,r=t.max,d=void 0===r?t.autoMinMax?o:1:r;if(l>=d)throw new RangeError("min option must be smaller than max option");for(var h=0;h<e.length;h++)a[h]=(e[h]-n)*((d-l)/(o-n))+l;return a}function hypotenuse(e,t){var a=0;return _Mathabs(e)>_Mathabs(t)?(a=t/e,_Mathabs(e)*_Mathsqrt(1+a*a)):0===t?0:(a=e/t,_Mathabs(t)*_Mathsqrt(1+a*a))}function getFilled2DArray(e,t,a){for(var n=Array(e),o=0;o<e;o++){n[o]=Array(t);for(var s=0;s<t;s++)n[o][s]=a}return n}function checkRowIndex(e,t,a){var i=a?e.rows:e.rows-1;if(0>t||t>i)throw new RangeError("Row index out of range")}function checkColumnIndex(e,t,a){var i=a?e.columns:e.columns-1;if(0>t||t>i)throw new RangeError("Column index out of range")}function checkRowVector(e,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==e.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function checkColumnVector(e,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==e.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function checkIndices(e,t,a){return{row:checkRowIndices(e,t),column:checkColumnIndices(e,a)}}function checkRowIndices(e,t){if("object"!=typeof t)throw new TypeError("unexpected type for row indices");var a=t.some(t=>0>t||t>=e.rows);if(a)throw new RangeError("row indices are out of range");return Array.isArray(t)||(t=Array.from(t)),t}function checkColumnIndices(e,t){if("object"!=typeof t)throw new TypeError("unexpected type for column indices");var a=t.some(t=>0>t||t>=e.columns);if(a)throw new RangeError("column indices are out of range");return Array.isArray(t)||(t=Array.from(t)),t}function checkRange(e,t,a,i,n){if(5!==arguments.length)throw new RangeError("expected 4 arguments");if(checkNumber("startRow",t),checkNumber("endRow",a),checkNumber("startColumn",i),checkNumber("endColumn",n),t>a||i>n||0>t||t>=e.rows||0>a||a>=e.rows||0>i||i>=e.columns||0>n||n>=e.columns)throw new RangeError("Submatrix indices are out of range")}function sumByRow(e){for(var t=Matrix.zeros(e.rows,1),a=0;a<e.rows;++a)for(var n=0;n<e.columns;++n)t.set(a,0,t.get(a,0)+e.get(a,n));return t}function sumByColumn(e){for(var t=Matrix.zeros(1,e.columns),a=0;a<e.rows;++a)for(var n=0;n<e.columns;++n)t.set(0,n,t.get(0,n)+e.get(a,n));return t}function sumAll(e){for(var t=0,a=0;a<e.rows;a++)for(var n=0;n<e.columns;n++)t+=e.get(a,n);return t}function checkNumber(e,t){if("number"!=typeof t)throw new TypeError(`${e} must be a number`)}function AbstractMatrix(e){function t(e,t){return e-t}function a(e,t){for(var a in t)e=e.replace(new RegExp(`%${a}%`,"g"),t[a]);return e}e===void 0&&(e=Object);class n extends e{static get[Symbol.species](){return this}static from1DArray(e,t,a){if(e*t!==a.length)throw new RangeError("Data length does not match given dimensions");for(var i=new this(e,t),n=0;n<e;n++)for(var o=0;o<t;o++)i.set(n,o,a[n*t+o]);return i}static rowVector(e){for(var t=new this(1,e.length),a=0;a<e.length;a++)t.set(0,a,e[a]);return t}static columnVector(e){for(var t=new this(e.length,1),a=0;a<e.length;a++)t.set(a,0,e[a]);return t}static empty(e,t){return new this(e,t)}static zeros(e,t){return this.empty(e,t).fill(0)}static ones(e,t){return this.empty(e,t).fill(1)}static rand(e,t,a){a===void 0&&(a=Math.random);for(var n=this.empty(e,t),o=0;o<e;o++)for(var s=0;s<t;s++)n.set(o,s,a());return n}static randInt(e,t,a,n){a===void 0&&(a=1e3),n===void 0&&(n=Math.random);for(var o=this.empty(e,t),s=0;s<e;s++)for(var l=0,r;l<t;l++)r=_Mathfloor(n()*a),o.set(s,l,r);return o}static eye(e,t,a){t===void 0&&(t=e),a===void 0&&(a=1);for(var n=_Mathmin(e,t),o=this.zeros(e,t),s=0;s<n;s++)o.set(s,s,a);return o}static diag(e,t,a){var n=e.length;t===void 0&&(t=n),a===void 0&&(a=t);for(var o=_Mathmin(n,t,a),s=this.zeros(t,a),l=0;l<o;l++)s.set(l,l,e[l]);return s}static min(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);for(var a=e.rows,n=e.columns,o=new this(a,n),s=0;s<a;s++)for(var l=0;l<n;l++)o.set(s,l,_Mathmin(e.get(s,l),t.get(s,l)));return o}static max(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);for(var a=e.rows,n=e.columns,o=new this(a,n),s=0;s<a;s++)for(var l=0;l<n;l++)o.set(s,l,_Mathmax(e.get(s,l),t.get(s,l)));return o}static checkMatrix(e){return n.isMatrix(e)?e:new this(e)}static isMatrix(e){return null!=e&&"Matrix"===e.klass}get size(){return this.rows*this.columns}apply(e){if("function"!=typeof e)throw new TypeError("callback must be a function");for(var t=this.rows,a=this.columns,n=0;n<t;n++)for(var o=0;o<a;o++)e.call(this,n,o);return this}to1DArray(){for(var e=Array(this.size),t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)e[t*this.columns+a]=this.get(t,a);return e}to2DArray(){for(var e=Array(this.rows),t=0;t<this.rows;t++){e[t]=Array(this.columns);for(var a=0;a<this.columns;a++)e[t][a]=this.get(t,a)}return e}isRowVector(){return 1===this.rows}isColumnVector(){return 1===this.columns}isVector(){return 1===this.rows||1===this.columns}isSquare(){return this.rows===this.columns}isSymmetric(){if(this.isSquare()){for(var e=0;e<this.rows;e++)for(var t=0;t<=e;t++)if(this.get(e,t)!==this.get(t,e))return!1;return!0}return!1}set(e,t,a){throw new Error("set method is unimplemented")}get(e,t){throw new Error("get method is unimplemented")}repeat(e,t){e=e||1,t=t||1;for(var a=new this.constructor[Symbol.species](this.rows*e,this.columns*t),n=0;n<e;n++)for(var o=0;o<t;o++)a.setSubMatrix(this,this.rows*n,this.columns*o);return a}fill(e){for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,e);return this}neg(){return this.mulS(-1)}getRow(e){checkRowIndex(this,e);for(var t=Array(this.columns),a=0;a<this.columns;a++)t[a]=this.get(e,a);return t}getRowVector(e){return this.constructor.rowVector(this.getRow(e))}setRow(e,t){checkRowIndex(this,e),t=checkRowVector(this,t);for(var a=0;a<this.columns;a++)this.set(e,a,t[a]);return this}swapRows(e,t){checkRowIndex(this,e),checkRowIndex(this,t);for(var a=0,n;a<this.columns;a++)n=this.get(e,a),this.set(e,a,this.get(t,a)),this.set(t,a,n);return this}getColumn(e){checkColumnIndex(this,e);for(var t=Array(this.rows),a=0;a<this.rows;a++)t[a]=this.get(a,e);return t}getColumnVector(e){return this.constructor.columnVector(this.getColumn(e))}setColumn(e,t){checkColumnIndex(this,e),t=checkColumnVector(this,t);for(var a=0;a<this.rows;a++)this.set(a,e,t[a]);return this}swapColumns(e,t){checkColumnIndex(this,e),checkColumnIndex(this,t);for(var a=0,n;a<this.rows;a++)n=this.get(a,e),this.set(a,e,this.get(a,t)),this.set(a,t,n);return this}addRowVector(e){e=checkRowVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)+e[a]);return this}subRowVector(e){e=checkRowVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)-e[a]);return this}mulRowVector(e){e=checkRowVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)*e[a]);return this}divRowVector(e){e=checkRowVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)/e[a]);return this}addColumnVector(e){e=checkColumnVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)+e[t]);return this}subColumnVector(e){e=checkColumnVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)-e[t]);return this}mulColumnVector(e){e=checkColumnVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)*e[t]);return this}divColumnVector(e){e=checkColumnVector(this,e);for(var t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.set(t,a,this.get(t,a)/e[t]);return this}mulRow(e,t){checkRowIndex(this,e);for(var a=0;a<this.columns;a++)this.set(e,a,this.get(e,a)*t);return this}mulColumn(e,t){checkColumnIndex(this,e);for(var a=0;a<this.rows;a++)this.set(a,e,this.get(a,e)*t);return this}max(){for(var e=this.get(0,0),t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.get(t,a)>e&&(e=this.get(t,a));return e}maxIndex(){for(var e=this.get(0,0),t=[0,0],a=0;a<this.rows;a++)for(var n=0;n<this.columns;n++)this.get(a,n)>e&&(e=this.get(a,n),t[0]=a,t[1]=n);return t}min(){for(var e=this.get(0,0),t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)this.get(t,a)<e&&(e=this.get(t,a));return e}minIndex(){for(var e=this.get(0,0),t=[0,0],a=0;a<this.rows;a++)for(var n=0;n<this.columns;n++)this.get(a,n)<e&&(e=this.get(a,n),t[0]=a,t[1]=n);return t}maxRow(e){checkRowIndex(this,e);for(var t=this.get(e,0),a=1;a<this.columns;a++)this.get(e,a)>t&&(t=this.get(e,a));return t}maxRowIndex(e){checkRowIndex(this,e);for(var t=this.get(e,0),a=[e,0],n=1;n<this.columns;n++)this.get(e,n)>t&&(t=this.get(e,n),a[1]=n);return a}minRow(e){checkRowIndex(this,e);for(var t=this.get(e,0),a=1;a<this.columns;a++)this.get(e,a)<t&&(t=this.get(e,a));return t}minRowIndex(e){checkRowIndex(this,e);for(var t=this.get(e,0),a=[e,0],n=1;n<this.columns;n++)this.get(e,n)<t&&(t=this.get(e,n),a[1]=n);return a}maxColumn(e){checkColumnIndex(this,e);for(var t=this.get(0,e),a=1;a<this.rows;a++)this.get(a,e)>t&&(t=this.get(a,e));return t}maxColumnIndex(e){checkColumnIndex(this,e);for(var t=this.get(0,e),a=[0,e],n=1;n<this.rows;n++)this.get(n,e)>t&&(t=this.get(n,e),a[0]=n);return a}minColumn(e){checkColumnIndex(this,e);for(var t=this.get(0,e),a=1;a<this.rows;a++)this.get(a,e)<t&&(t=this.get(a,e));return t}minColumnIndex(e){checkColumnIndex(this,e);for(var t=this.get(0,e),a=[0,e],n=1;n<this.rows;n++)this.get(n,e)<t&&(t=this.get(n,e),a[0]=n);return a}diag(){for(var e=_Mathmin(this.rows,this.columns),t=Array(e),a=0;a<e;a++)t[a]=this.get(a,a);return t}sum(e){return"row"===e?sumByRow(this):"column"===e?sumByColumn(this):sumAll(this)}mean(){return this.sum()/this.size}prod(){for(var e=1,t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)e*=this.get(t,a);return e}norm(e="frobenius"){var t=0;if("max"===e)return this.max();if("frobenius"===e){for(var a=0;a<this.rows;a++)for(var n=0;n<this.columns;n++)t+=this.get(a,n)*this.get(a,n);return _Mathsqrt(t)}throw new RangeError(`unknown norm type: ${e}`)}cumulativeSum(){for(var e=0,t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)e+=this.get(t,a),this.set(t,a,e);return this}dot(e){n.isMatrix(e)&&(e=e.to1DArray());var t=this.to1DArray();if(t.length!==e.length)throw new RangeError("vectors do not have the same size");for(var a=0,o=0;o<t.length;o++)a+=t[o]*e[o];return a}mmul(e){e=this.constructor.checkMatrix(e),this.columns!==e.rows&&console.warn("Number of columns of left matrix are not equal to number of rows of right matrix.");for(var t=this.rows,a=this.columns,n=e.columns,o=new this.constructor[Symbol.species](t,n),l=Array(a),r=0;r<n;r++){for(var d=0;d<a;d++)l[d]=e.get(d,r);for(var h=0,g;h<t;h++){for(g=0,d=0;d<a;d++)g+=this.get(h,d)*l[d];o.set(h,r,g)}}return o}strassen2x2(e){var t=new this.constructor[Symbol.species](2,2);const a=this.get(0,0),i=e.get(0,0),n=this.get(0,1),o=e.get(0,1),s=this.get(1,0),l=e.get(1,0),r=this.get(1,1),d=e.get(1,1),h=(a+r)*(i+d),g=(s+r)*i,c=a*(o-d),m=r*(l-i),p=(a+n)*d;return t.set(0,0,h+m-p+(n-r)*(l+d)),t.set(0,1,c+p),t.set(1,0,g+m),t.set(1,1,h-g+c+(s-a)*(i+o)),t}strassen3x3(e){var t=new this.constructor[Symbol.species](3,3);const a=this.get(0,0),i=this.get(0,1),n=this.get(0,2),o=this.get(1,0),s=this.get(1,1),l=this.get(1,2),r=this.get(2,0),d=this.get(2,1),h=this.get(2,2),g=e.get(0,0),c=e.get(0,1),m=e.get(0,2),p=e.get(1,0),u=e.get(1,1),f=e.get(1,2),b=e.get(2,0),_=e.get(2,1),w=e.get(2,2),x=(a-o)*(-c+u),y=(-a+o+s)*(g-c+u),k=(o+s)*(-g+c),v=a*g,D=(-a+r+d)*(g-m+f),S=(-a+r)*(m-f),I=(r+d)*(-g+m),P=(-n+d+h)*(u+b-_),M=(n-h)*(u-_),B=n*b,C=(d+h)*(-b+_),j=(-n+s+l)*(f+b-w),R=(n-l)*(f-w),A=(s+l)*(-b+w);return t.set(0,0,v+B+i*p),t.set(0,1,(a+i+n-o-s-d-h)*u+y+k+v+P+B+C),t.set(0,2,v+D+I+(a+i+n-s-l-r-d)*f+B+j+A),t.set(1,0,x+s*(-g+c+p-u-f-b+w)+y+v+B+j+R),t.set(1,1,x+y+k+v+l*_),t.set(1,2,B+j+R+A+o*m),t.set(2,0,v+D+S+d*(-g+m+p-u-f-b+_)+P+M+B),t.set(2,1,P+M+B+C+r*c),t.set(2,2,v+D+S+I+h*w),t}mmulStrassen(e){function t(e,t,a){var i=e.rows,o=e.columns;if(i===t&&o===a)return e;var s=n.zeros(t,a);return s=s.setSubMatrix(e,0,0),s}function i(e,o,s,l){if(512>=s||512>=l)return e.mmul(o);1==s%2&&1==l%2?(e=t(e,s+1,l+1),o=t(o,s+1,l+1)):1==s%2?(e=t(e,s+1,l),o=t(o,s+1,l)):1==l%2&&(e=t(e,s,l+1),o=t(o,s,l+1));var r=parseInt(e.rows/2,10),d=parseInt(e.columns/2,10),h=e.subMatrix(0,r-1,0,d-1),g=o.subMatrix(0,r-1,0,d-1),c=e.subMatrix(0,r-1,d,e.columns-1),m=o.subMatrix(0,r-1,d,o.columns-1),p=e.subMatrix(r,e.rows-1,0,d-1),u=o.subMatrix(r,o.rows-1,0,d-1),f=e.subMatrix(r,e.rows-1,d,e.columns-1),_=o.subMatrix(r,o.rows-1,d,o.columns-1),w=i(n.add(h,f),n.add(g,_),r,d),x=i(n.add(p,f),g,r,d),y=i(h,n.sub(m,_),r,d),k=i(f,n.sub(u,g),r,d),v=i(n.add(h,c),_,r,d),D=i(n.sub(p,h),n.add(g,m),r,d),S=i(n.sub(c,f),n.add(u,_),r,d),I=n.add(w,k);I.sub(v),I.add(S);var P=n.add(y,v),M=n.add(x,k),B=n.sub(w,x);B.add(y),B.add(D);var C=n.zeros(2*I.rows,2*I.columns);return C=C.setSubMatrix(I,0,0),C=C.setSubMatrix(P,I.rows,0),C=C.setSubMatrix(M,0,I.columns),C=C.setSubMatrix(B,I.rows,I.columns),C.subMatrix(0,s-1,0,l-1)}var o=this.clone(),a=o.rows,s=o.columns,l=e.rows,d=e.columns;s!==l&&console.warn(`Multiplying ${a} x ${s} and ${l} x ${d} matrix: dimensions do not match.`);var h=_Mathmax(a,l),r=_Mathmax(s,d);return o=t(o,h,r),e=t(e,h,r),i(o,e,h,r)}scaleRows(e,t){if(e=void 0===e?0:e,t=void 0===t?1:t,e>=t)throw new RangeError("min should be strictly smaller than max");for(var a=this.constructor.empty(this.rows,this.columns),n=0,o;n<this.rows;n++)o=rescale(this.getRow(n),{min:e,max:t}),a.setRow(n,o);return a}scaleColumns(e,t){if(e=void 0===e?0:e,t=void 0===t?1:t,e>=t)throw new RangeError("min should be strictly smaller than max");for(var a=this.constructor.empty(this.rows,this.columns),n=0,o;n<this.columns;n++)o=rescale(this.getColumn(n),{min:e,max:t}),a.setColumn(n,o);return a}kroneckerProduct(e){e=this.constructor.checkMatrix(e);for(var t=this.rows,a=this.columns,n=e.rows,o=e.columns,s=new this.constructor[Symbol.species](t*n,a*o),r=0;r<t;r++)for(var d=0;d<a;d++)for(var h=0;h<n;h++)for(var g=0;g<o;g++)s[n*r+h][o*d+g]=this.get(r,d)*e.get(h,g);return s}transpose(){for(var e=new this.constructor[Symbol.species](this.columns,this.rows),t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)e.set(a,t,this.get(t,a));return e}sortRows(e){e===void 0&&(e=t);for(var a=0;a<this.rows;a++)this.setRow(a,this.getRow(a).sort(e));return this}sortColumns(e){e===void 0&&(e=t);for(var a=0;a<this.columns;a++)this.setColumn(a,this.getColumn(a).sort(e));return this}subMatrix(e,t,a,n){checkRange(this,e,t,a,n);for(var o=new this.constructor[Symbol.species](t-e+1,n-a+1),s=e;s<=t;s++)for(var l=a;l<=n;l++)o[s-e][l-a]=this.get(s,l);return o}subMatrixRow(e,t,a){if(void 0===t&&(t=0),void 0===a&&(a=this.columns-1),t>a||0>t||t>=this.columns||0>a||a>=this.columns)throw new RangeError("Argument out of range");for(var n=new this.constructor[Symbol.species](e.length,a-t+1),o=0;o<e.length;o++)for(var s=t;s<=a;s++){if(0>e[o]||e[o]>=this.rows)throw new RangeError(`Row index out of range: ${e[o]}`);n.set(o,s-t,this.get(e[o],s))}return n}subMatrixColumn(e,t,a){if(void 0===t&&(t=0),void 0===a&&(a=this.rows-1),t>a||0>t||t>=this.rows||0>a||a>=this.rows)throw new RangeError("Argument out of range");for(var n=new this.constructor[Symbol.species](a-t+1,e.length),o=0;o<e.length;o++)for(var s=t;s<=a;s++){if(0>e[o]||e[o]>=this.columns)throw new RangeError(`Column index out of range: ${e[o]}`);n.set(s-t,o,this.get(s,e[o]))}return n}setSubMatrix(e,t,a){e=this.constructor.checkMatrix(e);var n=t+e.rows-1,o=a+e.columns-1;checkRange(this,t,n,a,o);for(var s=0;s<e.rows;s++)for(var l=0;l<e.columns;l++)this[t+s][a+l]=e.get(s,l);return this}selection(e,t){for(var a=checkIndices(this,e,t),n=new this.constructor[Symbol.species](e.length,t.length),o=0,s;o<a.row.length;o++){s=a.row[o];for(var l=0,r;l<a.column.length;l++)r=a.column[l],n[o][l]=this.get(s,r)}return n}trace(){for(var e=_Mathmin(this.rows,this.columns),t=0,a=0;a<e;a++)t+=this.get(a,a);return t}transposeView(){return new MatrixTransposeView(this)}rowView(e){return checkRowIndex(this,e),new MatrixRowView(this,e)}columnView(e){return checkColumnIndex(this,e),new MatrixColumnView(this,e)}flipRowView(){return new MatrixFlipRowView(this)}flipColumnView(){return new MatrixFlipColumnView(this)}subMatrixView(e,t,a,i){return new MatrixSubView(this,e,t,a,i)}selectionView(e,t){return new MatrixSelectionView(this,e,t)}rowSelectionView(e){return new MatrixRowSelectionView(this,e)}columnSelectionView(e){return new MatrixColumnSelectionView(this,e)}det(){if(this.isSquare()){var e,t,i,n;if(2===this.columns)return e=this.get(0,0),t=this.get(0,1),i=this.get(1,0),n=this.get(1,1),e*n-t*i;if(3===this.columns){var o,s,l;return o=this.selectionView([1,2],[1,2]),s=this.selectionView([1,2],[0,2]),l=this.selectionView([1,2],[0,1]),e=this.get(0,0),t=this.get(0,1),i=this.get(0,2),e*o.det()-t*s.det()+i*l.det()}return new LuDecomposition(this).determinant}throw Error("Determinant can only be calculated for a square matrix.")}pseudoInverse(e){void 0===e&&(e=_NumberEPSILON);for(var t=new SingularValueDecomposition(this,{autoTranspose:!0}),a=t.leftSingularVectors,n=t.rightSingularVectors,o=t.diagonal,l=0;l<o.length;l++)o[l]=_Mathabs(o[l])>e?1/o[l]:0;return o=this.constructor[Symbol.species].diag(o),n.mmul(o.mmul(a.transposeView()))}clone(){for(var e=new this.constructor[Symbol.species](this.rows,this.columns),t=0;t<this.rows;t++)for(var a=0;a<this.columns;a++)e.set(t,a,this.get(t,a));return e}}n.prototype.klass="Matrix",n.random=n.rand,n.diagonal=n.diag,n.prototype.diagonal=n.prototype.diag,n.identity=n.eye,n.prototype.negate=n.prototype.neg,n.prototype.tensorProduct=n.prototype.kroneckerProduct,n.prototype.determinant=n.prototype.det;var o=`
(function %name%(matrix, %args%) {
    var newMatrix = new this[Symbol.species](matrix);
    return newMatrix.%name%(%args%);
})
`,s=[["+","add"],["-","sub","subtract"],["*","mul","multiply"],["/","div","divide"],["%","mod","modulus"],["&","and"],["|","or"],["^","xor"],["<<","leftShift"],[">>","signPropagatingRightShift"],[">>>","rightShift","zeroFillRightShift"]],l=eval,r;for(var d of s){var h=l(a("\n(function %name%(value) {\n    if (typeof value === 'number') return this.%name%S(value);\n    return this.%name%M(value);\n})\n",{name:d[1],op:d[0]})),g=l(a(`
(function %name%S(value) {
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, this.get(i, j) %op% value);
        }
    }
    return this;
})
`,{name:`${d[1]}S`,op:d[0]})),c=l(a(`
(function %name%M(matrix) {
    matrix = this.constructor.checkMatrix(matrix);
    if (this.rows !== matrix.rows ||
        this.columns !== matrix.columns) {
        throw new RangeError('Matrices dimensions must be equal');
    }
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, this.get(i, j) %op% matrix.get(i, j));
        }
    }
    return this;
})
`,{name:`${d[1]}M`,op:d[0]})),m=l(a(`
(function %name%(matrix, value) {
    var newMatrix = new this[Symbol.species](matrix);
    return newMatrix.%name%(value);
})
`,{name:d[1]}));for(r=1;r<d.length;r++)n.prototype[d[r]]=h,n.prototype[`${d[r]}S`]=g,n.prototype[`${d[r]}M`]=c,n[d[r]]=m}var p=[["~","not"]];["abs","acos","acosh","asin","asinh","atan","atanh","cbrt","ceil","clz32","cos","cosh","exp","expm1","floor","fround","log","log1p","log10","log2","round","sign","sin","sinh","sqrt","tan","tanh","trunc"].forEach(function(e){p.push([`Math.${e}`,e])});for(var u of p){var f=l(a(`
(function %name%() {
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, %method%(this.get(i, j)));
        }
    }
    return this;
})
`,{name:u[1],method:u[0]})),b=l(a(`
(function %name%(matrix) {
    var newMatrix = new this[Symbol.species](matrix);
    return newMatrix.%name%();
})
`,{name:u[1]}));for(r=1;r<u.length;r++)n.prototype[u[r]]=f,n[u[r]]=b}var _=[["Math.pow",1,"pow"]];for(var w of _){var x="arg0";for(r=1;r<w[1];r++)x+=`, arg${r}`;if(1!==w[1]){var y=l(a(`
(function %name%(%args%) {
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, %method%(this.get(i, j), %args%));
        }
    }
    return this;
})
`,{name:w[2],method:w[0],args:x})),k=l(a(o,{name:w[2],args:x}));for(r=2;r<w.length;r++)n.prototype[w[r]]=y,n[w[r]]=k}else{var v={name:w[2],args:x,method:w[0]},D=l(a(`
(function %name%(value) {
    if (typeof value === 'number') return this.%name%S(value);
    return this.%name%M(value);
})
`,v)),S=l(a(`
(function %name%S(value) {
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, %method%(this.get(i, j), value));
        }
    }
    return this;
})
`,v)),I=l(a(`
(function %name%M(matrix) {
    matrix = this.constructor.checkMatrix(matrix);
    if (this.rows !== matrix.rows ||
        this.columns !== matrix.columns) {
        throw new RangeError('Matrices dimensions must be equal');
    }
    for (var i = 0; i < this.rows; i++) {
        for (var j = 0; j < this.columns; j++) {
            this.set(i, j, %method%(this.get(i, j), matrix.get(i, j)));
        }
    }
    return this;
})
`,v)),P=l(a(o,v));for(r=2;r<w.length;r++)n.prototype[w[r]]=D,n.prototype[`${w[r]}M`]=I,n.prototype[`${w[r]}S`]=S,n[w[r]]=P}}return n}function inverse(e,t=!1){return e=WrapperMatrix2D.checkMatrix(e),t?new SingularValueDecomposition(e).inverse():solve(e,Matrix.eye(e.rows))}function solve(e,t,a=!1){return e=WrapperMatrix2D.checkMatrix(e),t=WrapperMatrix2D.checkMatrix(t),a?new SingularValueDecomposition(e).solve(t):e.isSquare()?new LuDecomposition(e).solve(t):new QrDecomposition(e).solve(t)}function getSeparatedKernel(e){var t=new SingularValueDecomposition(e,{autoTranspose:!0});if(1!==t.rank)return null;var a=_Mathsqrt(t.s[0]),i=t.U.map(e=>e[0]*a),n=t.V.map(e=>e[0]*a);return[i,n]}function convolution(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels,n=t.bitDepth,o=t.normalize,s=void 0!==o&&o,l=t.divisor,r=void 0===l?1:l,d=t.border,h=void 0===d?"copy":d,g=t.algorithm,m=void 0===g?"auto":g,p=Image.createFrom(this,{bitDepth:n});if(a=validateArrayOfChannels(this,a,!0),"separable"!==m){var u=validateKernel(e);e=u.kernel}else if(!Array.isArray(e)||2!==e.length)throw new RangeError("separable convolution requires two arrays of numbers to represent the kernel");if("auto"===m){var f=getSeparatedKernel(e);null===f?(9<e.length||9<e[0].length)&&4096>=this.width&&4096>=this.height?m="fft":m="direct":(m="separable",e=f)}var b,_;"separable"===m?(b=_Mathfloor(e[0].length/2),_=_Mathfloor(e[1].length/2)):(b=_Mathfloor(e.length/2),_=_Mathfloor(e[0].length/2));var w=p.isClamped,k=Array(this.height*this.width),v,D,S,I,P,M;for(I=0;I<a.length;I++){for(P=a[I],S=0;S<this.height;S++)for(D=0;D<this.width;D++)v=S*this.width+D,k[v]=this.data[v*this.channels+P];if("direct"===m)M=src_2(k,e,{rows:this.height,cols:this.width,normalize:s,divisor:r});else if("separable"===m){if(M=convolutionSeparable(k,e,this.width,this.height),s){r=0;for(var B=0;B<e[0].length;B++)for(var C=0;C<e[1].length;C++)r+=e[0][B]*e[1][C]}if(1!==r)for(var R=0;R<M.length;R++)M[R]/=r}else M=src_1(k,e,{rows:this.height,cols:this.width,normalize:s,divisor:r});for(S=0;S<this.height;S++)for(D=0;D<this.width;D++)v=S*this.width+D,p.data[v*this.channels+P]=w?clamp(M[v],p):M[v]}if(this.alpha&&!a.includes(this.channels))for(D=this.components;D<this.data.length;D+=this.channels)p.data[D]=this.data[D];return"periodic"!==h&&p.setBorder({size:[_,b],algorithm:h}),p}function gradientFilter(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.direction,a=void 0===t?"xy":t,i=e.border,n=void 0===i?"copy":i,o=e.kernelX,s=e.kernelY,l=e.channels,r=e.bitDepth,d=void 0===r?this.bitDepth:r;switch(this.checkProcessable("gradientFilter",{bitDepth:[8,16]}),a){case"x":if(!o)throw new Error("kernelX option is missing");return convolution.call(this,o,{channels:l,border:n,bitDepth:d});case"y":if(!s)throw new Error("kernelY option is missing");return convolution.call(this,s,{channels:l,border:n,bitDepth:d});case"xy":{if(!o)throw new Error("kernelX option is missing");if(!s)throw new Error("kernelY option is missing");var h=convolution.call(this,o,{channels:l,border:n,bitDepth:32}),g=convolution.call(this,s,{channels:l,border:n,bitDepth:32});return h.hypotenuse(g,{bitDepth:d,channels:l})}default:throw new Error("Unknown parameter direction: ".concat(a));}}function sobelFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SOBEL_X,kernelY:SOBEL_Y}))}function scharrFilter(e){return gradientFilter.call(this,Object.assign({},e,{kernelX:SCHARR_X,kernelY:SCHARR_Y}))}function newArray(e,t){e=e||0;for(var a=Array(e),o=0;o<e;o++)a[o]=t;return a}function level(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.algorithm,a=void 0===t?"range":t,i=e.channels,n=e.min,o=void 0===n?this.min:n,s=e.max,l=void 0===s?this.max:s;switch(this.checkProcessable("level",{bitDepth:[8,16,32]}),i=validateArrayOfChannels(this,{channels:i}),i.length!==this.channel&&(Array.isArray(o)&&o.length===this.channels&&(o=o.filter((e,t)=>i.includes(t))),Array.isArray(l)&&l.length===this.channels&&(l=l.filter((e,t)=>i.includes(t)))),a){case"range":0>o&&(o=0),l>this.maxValue&&(l=this.maxValue),Array.isArray(o)||(o=newArray_1(i.length,o)),Array.isArray(l)||(l=newArray_1(i.length,l)),processImage(this,o,l,i);break;default:throw new Error("level: algorithm not implement: ".concat(a));}return this}function processImage(e,t,a,n){for(var o=1e-5,s=Array(n.length),l=0;l<n.length;l++)s[l]=0===t[l]&&a[l]===e.maxValue?0:a[l]===t[l]?0:(e.maxValue+1-o)/(a[l]-t[l]),t[l]+=(.5-o/2)/s[l];for(var r=0,d;r<n.length;r++)if(d=n[r],0!==s[r])for(var h=0;h<e.data.length;h+=e.channels)e.data[h+d]=_Mathmin(_Mathmax(0,0|(e.data[h+d]-t[r])*s[r]+.5),e.maxValue)}function checkNumberArray(e){if(!isNaN(e)){if(0>=e)throw new Error("checkNumberArray: the value must be greater than 0");return e}if(e instanceof Image)return e.data;if(!isArrayType(e))throw new Error("checkNumberArray: the value should be either a number, array or Image");return e}function add(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels;if(this.checkProcessable("add",{bitDepth:[8,16]}),a=validateArrayOfChannels(this,{channels:a}),e=checkNumberArray(e),!isNaN(e))for(var n=0,o;n<a.length;n++){o=a[n];for(var s=0;s<this.data.length;s+=this.channels)this.data[s+o]=_Mathmin(this.maxValue,this.data[s+o]+e>>0)}else{if(this.data.length!==e.length)throw new Error("add: the data size is different");for(var l=0,r;l<a.length;l++){r=a[l];for(var d=0;d<this.data.length;d+=this.channels)this.data[d+r]=_Mathmax(0,_Mathmin(this.maxValue,this.data[d+r]+e[d+r]>>0))}}return this}function subtract(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels;if(this.checkProcessable("subtract",{bitDepth:[8,16]}),a=validateArrayOfChannels(this,{channels:a}),e=checkNumberArray(e),!isNaN(e))for(var n=0,o;n<a.length;n++){o=a[n];for(var s=0;s<this.data.length;s+=this.channels)this.data[s+o]=_Mathmax(0,this.data[s+o]-e>>0)}else{if(this.data.length!==e.length)throw new Error("subtract: the data size is different");for(var l=0,r;l<a.length;l++){r=a[l];for(var d=0;d<this.data.length;d+=this.channels)this.data[d+r]=_Mathmax(0,_Mathmin(this.maxValue,this.data[d+r]-e[d+r]>>0))}}return this}function subtractImage(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.bitDepth,n=void 0===a?this.bitDepth:a,o=t.channels,s=t.absolute;if(this.checkProcessable("subtractImage",{bitDepth:[8,16]}),this.width!==e.width||this.height!==e.height)throw new Error("subtractImage: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("subtractImage: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("subtractImage: both images must have the same number of channels");var l=Image.createFrom(this,{bitDepth:n});o=validateArrayOfChannels(this,{channels:o});for(var r=0,d;r<o.length;r++){d=o[r];for(var h=d,g;h<this.data.length;h+=this.channels)g=this.data[h]-e.data[h],l.data[h]=void 0!==s&&s?_Mathabs(g):_Mathmax(g,0)}return l}function hypotenuse$1(e){var t=Math.hypot,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=a.bitDepth,o=void 0===n?this.bitDepth:n,s=a.channels;if(this.checkProcessable("hypotenuse",{bitDepth:[8,16,32]}),this.width!==e.width||this.height!==e.height)throw new Error("hypotenuse: both images must have the same size");if(this.alpha!==e.alpha||this.bitDepth!==e.bitDepth)throw new Error("hypotenuse: both images must have the same alpha and bitDepth");if(this.channels!==e.channels)throw new Error("hypotenuse: both images must have the same number of channels");var l=Image.createFrom(this,{bitDepth:o});s=validateArrayOfChannels(this,{channels:s});for(var r=l.isClamped,d=0,h;d<s.length;d++){h=s[d];for(var g=h,m;g<this.data.length;g+=this.channels)m=t(this.data[g],e.data[g]),l.data[g]=r?_Mathmin(_Mathmax(_Mathround(m),0),l.maxValue):m}return l}function multiply(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels;if(this.checkProcessable("multiply",{bitDepth:[8,16]}),0>=e)throw new Error("multiply: the value must be greater than 0");if(a=validateArrayOfChannels(this,{channels:a}),e=checkNumberArray(e),!isNaN(e))for(var n=0,o;n<a.length;n++){o=a[n];for(var s=0;s<this.data.length;s+=this.channels)this.data[s+o]=_Mathmin(this.maxValue,this.data[s+o]*e>>0)}else{if(this.data.length!==e.length)throw new Error("multiply: the data size is different");for(var l=0,r;l<a.length;l++){r=a[l];for(var d=0;d<this.data.length;d+=this.channels)this.data[d+r]=_Mathmax(0,_Mathmin(this.maxValue,this.data[d+r]*e[d+r]>>0))}}return this}function divide(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channels;if(this.checkProcessable("divide",{bitDepth:[8,16]}),a=validateArrayOfChannels(this,{channels:a}),e=checkNumberArray(e),!isNaN(e))for(var n=0,o;n<a.length;n++){o=a[n];for(var s=0;s<this.data.length;s+=this.channels)this.data[s+o]=_Mathmin(this.maxValue,this.data[s+o]/e>>0)}else{if(this.data.length!==e.length)throw new Error("divide: the: the data size is different");for(var l=0,r;l<a.length;l++){r=a[l];for(var d=0;d<this.data.length;d+=this.channels)this.data[d+r]=_Mathmax(0,_Mathmin(this.maxValue,this.data[d+r]/e[d+r]>>0))}}return this}function squaredEuclidean(e,t){for(var a=0,n=0;n<e.length;n++)a+=(e[n]-t[n])*(e[n]-t[n]);return a}function euclidean(e,t){return _Mathsqrt(squaredEuclidean(e,t))}function background(e,t,a){for(var n=new KernelRidgeRegression(e,t,a),o=Array(this.size),s=0;s<this.width;s++)for(var l=0;l<this.height;l++)o[l*this.width+s]=[s,l];for(var r=n.predict(o),d=Image.createFrom(this),h=0;h<this.size;h++)d.data[h]=_Mathmin(this.maxValue,_Mathmax(0,r[h][0]));return d}function dilate(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("dilate",{bitDepth:[1,8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("dilate: The number of rows and columns of the kernel must be odd");var s=!0;outer:for(var l of a)for(var r of l)if(1!==r){s=!1;break outer}for(var d=this,h=0;h<o;h++)if(1===this.bitDepth){if(s){var g=d.clone();d=dilateOnceBinaryOnlyOnes(d,g,a.length,a[0].length)}else{var c=Image.createFrom(d);d=dilateOnceBinary(d,c,a)}}else if(s){var m=Image.createFrom(d);d=dilateOnceGreyOnlyOnes(d,m,a.length,a[0].length)}else{var p=Image.createFrom(d);d=dilateOnceGrey(d,p,a)}return d}function dilateOnceGrey(e,t,a){for(var n=a.length,o=a[0].length,s=0;s<e.height;s++)for(var l=0,r;l<e.width;l++){r=0;for(var d=0;d<o;d++)for(var h=0;h<n;h++)if(1===a[h][d]){var g=h-(n-1)/2+l,i=d-(o-1)/2+s;if(!(0>g||0>i||g>=e.width||i>=e.height)){var c=e.getValueXY(g,i,0);c>r&&(r=c)}}t.setValueXY(l,s,0,r)}return t}function dilateOnceGreyOnlyOnes(e,t,a,n){for(var o=(a-1)/2,s=(n-1)/2,l=[],r=0;r<e.width;r++)l.push(0);for(var d=0;d<e.height;d++){for(var g=0,c;g<e.width;g++){c=0;for(var m=_Mathmax(0,d-s),p;m<_Mathmin(e.height,d+s+1);m++)p=e.getValueXY(g,m,0),p>c&&(c=p);l[g]=c}for(var u=0,f;u<e.width;u++){f=0;for(var b=_Mathmax(0,u-o);b<_Mathmin(e.width,u+o+1);b++)l[b]>f&&(f=l[b]);t.setValueXY(u,d,0,f)}}return t}function dilateOnceBinary(e,t,a){for(var n=a.length,o=a[0].length,s=0;s<e.height;s++)for(var l=0,r;l<e.width;l++){r=0;intLoop:for(var d=0;d<o;d++)for(var h=0;h<n;h++)if(1===a[h][d]){var g=h-(n-1)/2+l,i=d-(o-1)/2+s;if(!(0>i||0>g||g>=e.width||i>=e.height)){var c=e.getBitXY(g,i);if(1===c){r=1;break intLoop}}}1==r&&t.setBitXY(l,s)}return t}function dilateOnceBinaryOnlyOnes(e,t,a,n){for(var o=(a-1)/2,s=(n-1)/2,l=[],r=0;r<e.width;r++)l.push(1);for(var d=0;d<e.height;d++){for(var g=0;g<e.width;g++){l[g]=0;for(var c=_Mathmax(0,d-s);c<_Mathmin(e.height,d+s+1);c++)if(1===e.getBitXY(g,c)){l[g]=1;break}}for(var m=0;m<e.width;m++)if(1!==t.getBitXY(m,d))for(var p=_Mathmax(0,m-o);p<_Mathmin(e.width,m+o+1);p++)if(1===l[p]){t.setBitXY(m,d);break}}return t}function erode(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("erode",{bitDepth:[1,8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("erode: The number of rows and columns of the kernel must be odd");var s=!0;outer:for(var l of a)for(var r of l)if(1!==r){s=!1;break outer}for(var d=this,h=0;h<o;h++)if(1===this.bitDepth){if(s){var g=d.clone();d=erodeOnceBinaryOnlyOnes(d,g,a.length,a[0].length)}else{var c=Image.createFrom(d);d=erodeOnceBinary(d,c,a)}}else if(s){var m=Image.createFrom(d);d=erodeOnceGreyOnlyOnes(d,m,a.length,a[0].length)}else{var p=Image.createFrom(d);d=erodeOnceGrey(d,p,a)}return d}function erodeOnceGrey(e,t,a){for(var n=a.length,o=a[0].length,s=0;s<e.height;s++)for(var l=0,r;l<e.width;l++){r=e.maxValue;for(var d=0;d<o;d++)for(var h=0;h<n;h++)if(1===a[h][d]){var g=h-(n-1)/2+l,i=d-(o-1)/2+s;if(!(0>g||0>i||g>=e.width||i>=e.height)){var c=e.getValueXY(g,i,0);c<r&&(r=c)}}t.setValueXY(l,s,0,r)}return t}function erodeOnceGreyOnlyOnes(e,t,a,n){for(var o=(a-1)/2,s=(n-1)/2,l=[],r=0;r<e.width;r++)l.push(0);for(var d=0;d<e.height;d++){for(var g=0,c;g<e.width;g++){c=e.maxValue;for(var m=_Mathmax(0,d-s),p;m<_Mathmin(e.height,d+s+1);m++)p=e.getValueXY(g,m,0),p<c&&(c=p);l[g]=c}for(var u=0,f;u<e.width;u++){f=e.maxValue;for(var b=_Mathmax(0,u-o);b<_Mathmin(e.width,u+o+1);b++)l[b]<f&&(f=l[b]);t.setValueXY(u,d,0,f)}}return t}function erodeOnceBinary(e,t,a){for(var n=a.length,o=a[0].length,s=0;s<e.height;s++)for(var l=0,r;l<e.width;l++){r=1;intLoop:for(var d=0;d<o;d++)for(var h=0;h<n;h++)if(1===a[h][d]){var g=h-(n-1)/2+l,i=d-(o-1)/2+s;if(!(0>i||0>g||g>=e.width||i>=e.height)){var c=e.getBitXY(g,i);if(0===c){r=0;break intLoop}}}1==r&&t.setBitXY(l,s)}return t}function erodeOnceBinaryOnlyOnes(e,t,a,n){for(var o=(a-1)/2,s=(n-1)/2,l=[],r=0;r<e.width;r++)l.push(0);for(var d=0;d<e.height;d++){for(var g=0;g<e.width;g++){l[g]=1;for(var c=_Mathmax(0,d-s);c<_Mathmin(e.height,d+s+1);c++)if(0===e.getBitXY(g,c)){l[g]=0;break}}for(var m=0;m<e.width;m++)if(0!==t.getBitXY(m,d))for(var p=_Mathmax(0,m-o);p<_Mathmin(e.width,m+o+1);p++)if(0===l[p]){t.clearBitXY(m,d);break}}return t}function open(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("open",{bitDepth:[8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("open: The number of rows and columns of the kernel must be odd");for(var s=this,l=0;l<o;l++)s=s.erode({kernel:a}),s=s.dilate({kernel:a});return s}function close(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("close",{bitDepth:[1,8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("close: The number of rows and columns of the kernel must be odd");for(var s=this,l=0;l<o;l++)s=s.dilate({kernel:a}).erode({kernel:a});return s}function topHat(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("topHat",{bitDepth:[8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("topHat: The number of rows and columns of the kernel must be odd");for(var s=this,l=0,r;l<o;l++)r=s.open({kernel:a}),s=r.subtractImage(s,{absolute:!0});return s}function blackHat(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("blackHat",{bitDepth:[8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("blackHat: The number of rows and columns of the kernel must be odd");for(var s=this,l=0,r;l<o;l++)r=s.close({kernel:a}),s=r.subtractImage(s,{absolute:!0});return s}function morphologicalGradient(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kernel,a=void 0===t?[[1,1,1],[1,1,1],[1,1,1]]:t,n=e.iterations,o=void 0===n?1:n;if(this.checkProcessable("morphologicalGradient",{bitDepth:[8,16],components:1,alpha:0}),0==a.columns%2||0==a.rows%2)throw new TypeError("morphologicalGradient: The number of rows and columns of the kernel must be odd");for(var s=this,l=0;l<o;l++){var r=s.dilate({kernel:a}),d=s.erode({kernel:a});s=r.subtractImage(d,{absolute:!0})}return s}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var a=[],i=!0,n=!1,o=void 0;try{for(var s=e[Symbol.iterator](),l;!(i=(l=s.next()).done)&&(a.push(l.value),!(t&&a.length===t));i=!0);}catch(e){n=!0,o=e}finally{try{i||null==s["return"]||s["return"]()}finally{if(n)throw o}}return a}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function order4Points(e){for(var t=0,a=0,n=0,o=0,s=e[0][0],l=0,r=1;r<e.length;r++)e[r][0]<s&&(s=e[r][0],l=r);for(var d=e[(l+1)%e.length][0],h=(l+1)%e.length,g=1;g<e.length;g++)e[g][0]<d&&g!==l&&(d=e[g][0],h=g);return e[h][1]<e[l][1]?(t=e[h],o=e[l],l===(h+1)%4?(a=e[(h+2)%4],n=e[(h+3)%4]):(a=e[(h+1)%4],n=e[(h+2)%4])):(o=e[h],t=e[l],h===(l+1)%4?(a=e[(l+2)%4],n=e[(l+3)%4]):(a=e[(l+1)%4],n=e[(l+2)%4])),[t,a,n,o]}function distance2Points(e,t){return _Mathsqrt(_Mathpow(e[0]-t[0],2)+_Mathpow(e[1]-t[1],2))}function crossVect(e,t){var a=[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]];return a}function dotVect(e,t){var a=e[0]*t[0]+e[1]*t[1]+e[2]*t[2];return a}function computeWidthAndHeigth(e,t,a,i,n,o){var s=_Mathmax(distance2Points(e,t),distance2Points(i,a)),l=_Mathmax(distance2Points(e,i),distance2Points(t,a)),r=0,d=0,h=_Mathceil(n/2),g=_Mathceil(o/2),c=s/l,m=[e[0],e[1],1],p=[t[0],t[1],1],u=[i[0],i[1],1],b=[a[0],a[1],1],_=dotVect(crossVect(m,b),u)/dotVect(crossVect(p,b),u),w=dotVect(crossVect(m,b),p)/dotVect(crossVect(u,b),p),x=[_*p[0]-m[0],_*p[1]-m[1],_*p[2]-m[2]],y=[w*u[0]-m[0],w*u[1]-m[1],w*u[2]-m[2]],k=x[0],v=x[1],D=x[2],S=y[0],I=y[1],P=y[2],M=1/(D*P)*(k*S-(k*P+D*S)*h+D*P*h*h+(v*I-(v*P+D*I)*g+D*P*g*g));M=0<=M?_Mathsqrt(M):_Mathsqrt(-M);var B=new Matrix([[M,0,h],[0,M,g],[0,0,1]]),C=B.transpose(),j=inverse(C),R=inverse(B),A=Matrix.rowVector(x),z=Matrix.rowVector(y),T=_Mathsqrt(dotVect(A.mmul(j).mmul(R).to1DArray(),x)/dotVect(z.mmul(j).mmul(R).to1DArray(),y));return 0===T||0===c?(r=_Mathceil(s),d=_Mathceil(l)):T<c?(r=_Mathceil(s),d=_Mathceil(r/T)):(d=_Mathceil(l),r=_Mathceil(T*d)),[r,d]}function projectionPoint(t,i,n,a,o,s,l,e,r,d,h,g){return h.getValueXY(_Mathfloor((n*t+a*i+o)/(r*t+d*i+1)),_Mathfloor((s*t+l*i+e)/(r*t+d*i+1)),g)}function warpingFourPoints(t){var n=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},o=n.calculateRatio;if(4!==t.length)throw new Error("The array pts must have four elements, which are the four corners. Currently, pts have ".concat(t.length," elements"));var s=_slicedToArray(t,4),l=s[0],r=s[1],m=s[2],p=s[3],u=order4Points([l,r,m,p]),_=_slicedToArray(u,4),w=_[0],x=_[1],y=_[2],k=_[3],v,I;if(!(void 0!==o)||o){var P=computeWidthAndHeigth(w,x,y,k,this.width,this.height),M=_slicedToArray(P,2);v=M[0],I=M[1]}else v=_Mathceil(_Mathmax(distance2Points(w,x),distance2Points(k,y))),I=_Mathceil(_Mathmax(distance2Points(w,k),distance2Points(x,y)));for(var B=Image.createFrom(this,{width:v,height:I}),C=_slicedToArray(w,2),R=C[0],A=C[1],z=_slicedToArray(x,2),L=z[0],E=z[1],Y=_slicedToArray(y,2),F=Y[0],X=Y[1],V=_slicedToArray(k,2),U=V[0],G=V[1],O=0,N=0,H=0,q=v-1,W=I-1,Z=v-1,K=I-1,J=0,Q=new Matrix([[O,N,1,0,0,0,-O*R,-N*R],[H,q,1,0,0,0,-H*L,-q*L],[W,Z,1,0,0,0,-W*F,-N*F],[K,J,1,0,0,0,-K*U,-J*U],[0,0,0,O,N,1,-O*A,-N*A],[0,0,0,H,q,1,-H*E,-q*E],[0,0,0,W,Z,1,-W*X,-Z*X],[0,0,0,K,J,1,-K*G,-J*G]]),S=Matrix.columnVector([R,L,F,U,A,E,X,G]),D=new SingularValueDecomposition(Q),$=D.solve(S),T=$.to1DArray(),ee=_slicedToArray(T,8),te=ee[0],a=ee[1],b=ee[2],c=ee[3],d=ee[4],e=ee[5],f=ee[6],g=ee[7],h=new Matrix(I,v),ae=0;ae<this.channels;ae++){for(var ie=0;ie<I;ie++)for(var ne=0;ne<v;ne++)h.set(ie,ne,projectionPoint(ie,ne,te,a,b,c,d,e,f,g,this,ae));B.setMatrix(h,{channel:ae})}return B}function crop(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.x,a=void 0===t?0:t,n=e.y,o=void 0===n?0:n,s=e.width,l=void 0===s?this.width-a:s,r=e.height,d=void 0===r?this.height-o:r;if(this.checkProcessable("max",{bitDepth:[8,16]}),a=_Mathround(a),o=_Mathround(o),l=_Mathround(l),d=_Mathround(d),a>this.width-1||o>this.height-1)throw new RangeError("crop: origin (x:".concat(a,", y:").concat(o,") out of range (").concat(this.width-1,"; ").concat(this.height-1,")"));if(0>=l||0>=d)throw new RangeError("crop: width and height (width:".concat(l,"; height:").concat(d,") must be positive numbers"));if(0>a||0>o)throw new RangeError("crop: x and y (x:".concat(a,", y:").concat(o,") must be positive numbers"));if(l>this.width-a||d>this.height-o)throw new RangeError("crop: (x: ".concat(a,", y:").concat(o,", width:").concat(l,", height:").concat(d,") size is out of range"));for(var h=Image.createFrom(this,{width:l,height:d,position:[a,o]}),g=l*this.channels,c=o+d,m=0,p=a*this.channels,u=o;u<c;u++)for(var f=u*this.width*this.channels+p,b=f+g;f<b;f++)h.data[m++]=this.data[f];return h}function cropAlpha(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};this.checkProcessable("cropAlpha",{alpha:1});var t=e.threshold,a=void 0===t?this.maxValue:t,i=findLeft(this,a,this.components);if(-1===i)throw new Error("Could not find new dimensions. Threshold may be too high.");var n=findTop(this,a,this.components,i),o=findBottom(this,a,this.components,i),s=findRight(this,a,this.components,i,n,o);return this.crop({x:i,y:n,width:s-i+1,height:o-n+1})}function findLeft(e,t,a){for(var i=0;i<e.width;i++)for(var n=0;n<e.height;n++)if(e.getValueXY(i,n,a)>=t)return i;return-1}function findTop(e,t,a,i){for(var n=0;n<e.height;n++)for(var o=i;o<e.width;o++)if(e.getValueXY(o,n,a)>=t)return n;return-1}function findBottom(e,t,a,i){for(var n=e.height-1;0<=n;n--)for(var o=i;o<e.width;o++)if(e.getValueXY(o,n,a)>=t)return n;return-1}function findRight(e,t,a,i,n,o){for(var s=e.width-1;s>=i;s--)for(var l=n;l<=o;l++)if(e.getValueXY(s,l,a)>=t)return s;return-1}function getFactor(e){if("string"==typeof e){var t=e[e.length-1];e=parseFloat(e),"%"===t&&(e/=100)}return e}function getThreshold(e,t){if(!t)throw Error("getThreshold : the maxValue should be specified");if("string"==typeof e){var a=e[e.length-1];if("%"!==a)throw Error("getThreshold : if the value is a string it must finish by %");return parseFloat(e)/100*t}if("number"==typeof e)return 1>e?e*t:e;throw Error("getThreshold : the value is not valid")}function factorDimensions(e,t,a){e=getFactor(e);var i=_Mathround(e*t),n=_Mathround(e*a);return 0>=i&&(i=1),0>=n&&(n=1),{width:i,height:n}}function checkRow(e,t){if(0>t||t>=e.height)throw new RangeError("row must be included between 0 and ".concat(e.height-1,". Current value: ").concat(t))}function checkColumn(e,t){if(0>t||t>=e.width)throw new RangeError("column must be included between 0 and ".concat(e.width-1,". Current value: ").concat(t))}function checkChannel(e,t){if(0>t||t>=e.channels)throw new RangeError("channel must be included between 0 and ".concat(e.channels-1,". Current value: ").concat(t))}function checkInterpolation(e){if("string"!=typeof e)throw new TypeError("interpolation must be a string");if(e=e.toLowerCase(),!validInterpolations[e])throw new RangeError("invalid interpolation algorithm: ".concat(e));return validInterpolations[e]}function nearestNeighbor(e,t,a){var n=this.width/t,o=this.height/a;if(1<this.bitDepth)for(var s=0,l;s<t;s++){l=_Mathfloor((s+.5)*n);for(var r=0,d;r<a;r++){d=_Mathfloor((r+.5)*o);for(var g=0;g<this.channels;g++)e.setValueXY(s,r,g,this.getValueXY(l,d,g))}}else for(var m=0,p;m<t;m++){p=_Mathfloor((m+.5)*n);for(var u=0,f;u<a;u++)f=_Mathfloor((u+.5)*o),this.getBitXY(p,f)&&e.setBitXY(m,u)}}function resize(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.factor,a=void 0===t?1:t,i=e.interpolation,n=void 0===i?validInterpolations.nearestneighbor:i,o=e.preserveAspectRatio,s=void 0===o||o,l=checkInterpolation(n),r=e.width,d=e.height;r||(d&&s?r=_Mathround(d*(this.width/this.height)):r=this.width),d||(s?d=_Mathround(r*(this.height/this.width)):d=this.height);var h=factorDimensions(a,r,d);if(r=h.width,d=h.height,r===this.width&&d===this.height){var g=this.clone();return g.position=[0,0],g}var c=_Mathround((this.width-r)/2),m=_Mathround((this.height-d)/2),p=Image.createFrom(this,{width:r,height:d,position:[c,m]});switch(l){case validInterpolations.nearestneighbor:nearestNeighbor.call(this,p,r,d);break;default:throw new Error("unsupported resize interpolation: ".concat(l));}return p}function hsv(){this.checkProcessable("hsv",{bitDepth:[8,16],alpha:[0,1],colorModel:["RGB"]});for(var e=Image.createFrom(this,{colorModel:"HSV"}),t=0,a=this.data,n=0;n<a.length;n+=this.channels){var o=a[n],s=a[n+1],l=a[n+2],r=_Mathmin(o,s,l),d=_Mathmax(o,s,l),h=d-r,g=0,c=0===d?0:h/d;if(d!==r){switch(d){case o:g=(s-l)/h+(s<l?6:0);break;case s:g=(l-o)/h+2;break;case l:g=(o-s)/h+4;break;default:throw new Error("unreachable");}g/=6}e.data[t++]=g*this.maxValue,e.data[t++]=c*this.maxValue,e.data[t++]=d,this.alpha&&(e.data[t++]=a[n+3])}return e}function hsl(){this.checkProcessable("hsl",{bitDepth:[8,16],alpha:[0,1],colorModel:["RGB"]});for(var e=Image.createFrom(this,{colorModel:"HSL"}),t=_Mathfloor(this.maxValue/2),a=0,n=this.data,o=0;o<n.length;o+=this.channels){var s=n[o],l=n[o+1],r=n[o+2],d=_Mathmax(s,l,r),h=_Mathmin(s,l,r),g=0,c=0,m=(d+h)/2;if(d!==h){var p=d-h;switch(c=m>t?p/(2-d-h):p/(d+h),d){case s:g=(l-r)/p+(l<r?6:0);break;case l:g=(r-s)/p+2;break;case r:g=(s-l)/p+4;break;default:throw new Error("unreachable");}g/=6}e.data[a++]=g*this.maxValue,e.data[a++]=c*this.maxValue,e.data[a++]=m,this.alpha&&(e.data[a++]=n[o+3])}return e}function cmyk(){this.checkProcessable("cmyk",{bitDepth:[8,16],alpha:[0,1],colorModel:["RGB"]});for(var e=Image.createFrom(this,{components:4,colorModel:"CMYK"}),t=0,a=this.data,n=0;n<a.length;n+=this.channels){var o=a[n],s=a[n+1],l=a[n+2],r=_Mathmin(this.maxValue-o,this.maxValue-s,this.maxValue-l),d=(this.maxValue-o-r)/(1-r/this.maxValue),h=(this.maxValue-s-r)/(1-r/this.maxValue),g=(this.maxValue-l-r)/(1-r/this.maxValue);e.data[t++]=_Mathround(d),e.data[t++]=_Mathround(h),e.data[t++]=_Mathround(g),e.data[t++]=_Mathround(r),this.alpha&&(e.data[t++]=a[n+3])}return e}function rgba8(){return new Image(this.width,this.height,this.getRGBAData(),{kind:"RGBA",parent:this})}function grey(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.algorithm,a=void 0===t?"luma709":t,n=e.keepAlpha,o=void 0!==n&&n,s=e.mergeAlpha,l=!(void 0!==s)||s;if("string"!=typeof a&&"function"!=typeof a)throw new TypeError("algorithm must be a string or a function");this.checkProcessable("grey",{bitDepth:[8,16],alpha:[0,1]}),1===this.components&&(a="red"),o&=this.alpha,l&=this.alpha,o&&(l=!1);var r=getOutputImage(this,e,{components:1,alpha:o,colorModel:"GREY"}),d;if("function"==typeof a)d=a;else if(d=methods[a.toLowerCase()],!d)throw new Error("unsupported grey algorithm: ".concat(a));for(var h=0,g=0;g<this.data.length;g+=this.channels)l?r.data[h++]=clamp(d(this.data[g],this.data[g+1],this.data[g+2],this)*this.data[g+this.components]/this.maxValue,this):(r.data[h++]=clamp(d(this.data[g],this.data[g+1],this.data[g+2],this),this),r.alpha&&(r.data[h++]=this.data[g+this.components]));return r}function huang(e){for(var t=0,a=0;a<e.length;a++)if(0!==e[a]){t=a;break}for(var i=e.length-1,n=e.length-1;n>=t;n--)if(0!==e[n]){i=n;break}for(var o=1/(i-t),s=Array(e.length),l=0,r=0,d=t;d<e.length;d++)l+=d*e[d],r+=e[d],s[d]=l/r;var h=Array(e.length);l=r=0;for(var g=i;0<g;g--)l+=g*e[g],r+=e[g],h[g-1]=l/r;for(var c=-1,m=_NumberMAX_VALUE,p=0;p<e.length;p++){for(var u=0,f=void 0,b=0;b<=p;b++)f=1/(1+o*_Mathabs(b-s[p])),1e-6>f||.999999<f||(u+=e[b]*(-f*_Mathlog(f)-(1-f)*_Mathlog(1-f)));for(var _=p+1;_<e.length;_++)f=1/(1+o*_Mathabs(_-h[p])),1e-6>f||.999999<f||(u+=e[_]*(-f*_Mathlog(f)-(1-f)*_Mathlog(1-f)));u<m&&(m=u,c=p)}return c}function intermodes(e){for(var t=e.slice(),a=0;!bimodalTest(t);){for(var n=0,o=0,s=t[0],l=0;l<e.length-1;l++)n=o,o=s,s=t[l+1],t[l]=(n+o+s)/3;if(t[e.length-1]=(o+s)/3,a++,1e4<a)throw new Error("Intermodes Threshold not found after 10000 iterations")}for(var r=0,d=1;d<e.length-1;d++)t[d-1]<t[d]&&t[d+1]<t[d]&&(r+=d);return _Mathfloor(r/2)}function bimodalTest(e){for(var t=!1,a=0,i=1;i<e.length-1;i++)if(e[i-1]<e[i]&&e[i+1]<e[i]&&(a++,2<a))return!1;return 2===a&&(t=!0),t}function isodata(e){for(var t=0,a=1,n,o,s,r;a<e.length;a++)if(0<e[a]){t=a+1;break}for(;;){n=0,s=0;for(var d=0;d<t;d++)s+=e[d],n+=e[d]*d;r=0,o=0;for(var c=t+1;c<e.length;c++)o+=e[c],r+=e[c]*c;if(0<s&&0<o&&(n/=s,r/=o,t===_Mathround((n+r)/2)))break;if(t++,t>e.length-2)throw new Error("Threshold not found")}return t}function li(e,t){var a,i,n,o,s,l,r,d,h,g,c,m;c=.5,g=0;for(var p=0;p<e.length;p++)g+=p*e[p];g/=t,r=g;do{l=r,a=0|l+.5,i=0,o=0;for(var u=0;u<=a;u++)i+=u*e[u],o+=e[u];d=0===o?0:i/o,n=0,s=0;for(var f=a+1;f<e.length;f++)n+=f*e[f],s+=e[f];h=0===s?0:n/s,m=(d-h)/(_Mathlog(d)-_Mathlog(h)),r=m<-_NumberEPSILON?0|m-.5:0|m+.5}while(_Mathabs(r-l)>c);return a}function maxEntropy(e,t){for(var a=Array(e.length),i=0;i<e.length;i++)a[i]=e[i]/t;var n=Array(e.length),o=Array(e.length);n[0]=a[0],o[0]=1-n[0];for(var s=1;s<e.length;s++)n[s]=n[s-1]+a[s],o[s]=1-n[s];for(var l=0,r=0;r<e.length;r++)if(_Mathabs(n[r])>=_NumberEPSILON){l=r;break}for(var d=e.length-1,h=e.length-1;h>=l;h--)if(_Mathabs(o[h])>=_NumberEPSILON){d=h;break}for(var g=-1,c=_NumberMIN_VALUE,m=l,p,u,f;m<=d;m++){u=0;for(var b=0;b<=m;b++)0!==e[b]&&(u-=a[b]/n[m]*_Mathlog(a[b]/n[m]));f=0;for(var _=m+1;_<e.length;_++)0!==e[_]&&(f-=a[_]/o[m]*_Mathlog(a[_]/o[m]));p=u+f,c<p&&(c=p,g=m)}return g}function mean$1(e,t){for(var a=0,n=0;n<e.length;n++)a+=n*e[n];return _Mathfloor(a/t)}function minError(e,t){for(var a=Math.log10,i=-2,n=0,o=0,s,l,r,d,h,g,c,m,u,f,b,_;o<e.length;o++)n+=o*e[o];for(n/=t,s=n;s!==i;){var w=sumA(e,s),x=sumA(e,e.length-1),y=sumB(e,s),k=sumB(e,e.length-1),v=sumC(e,s),D=sumC(e,e.length-1);if(l=y/w,r=(k-y)/(x-w),d=w/x,h=(x-w)/x,g=v/w-l*l,c=(D-v)/(x-w)-r*r,m=1/g-1/c,u=l/g-r/c,f=l*l/g-r*r/c+a(g*(h*h)/(c*(d*d))),b=u*u-m*f,0>b)return s;i=s,_=(u+_Mathsqrt(b))/m,s=isNaN(_)?i:_Mathfloor(_)}return s}function sumA(e,t){for(var a=0,n=0;n<=t;n++)a+=e[n];return a}function sumB(e,t){for(var a=0,n=0;n<=t;n++)a+=n*e[n];return a}function sumC(e,t){for(var a=0,n=0;n<=t;n++)a+=n*n*e[n];return a}function minimum(e){if(2>e.length)return 0;for(var t=0,a=-1,n=-1,o=Array(e.length),s=0;s<e.length;s++)o[s]=e[s],0<e[s]&&(n=s);for(;!bimodalTest$1(o);)if(o=smoothed(o),t++,1e4<t)return a;return a=minimumBetweenPeeks(o,n),a}function smoothed(e){for(var t=Array(e.length),a=1;a<e.length-1;a++)t[a]=(e[a-1]+e[a]+e[a+1])/3;return t[0]=(e[0]+e[1])/3,t[e.length-1]=(e[e.length-2]+e[e.length-1])/3,t}function minimumBetweenPeeks(e,t){for(var a=1,n;a<t;a++)if(e[a-1]>e[a]&&e[a+1]>=e[a]){n=a;break}return n}function bimodalTest$1(e){for(var t=e.length,a=!1,i=0,n=1;n<t-1;n++)if(e[n-1]<e[n]&&e[n+1]<e[n]&&(i++,2<i))return!1;return 2===i&&(a=!0),a}function moments(e,t){for(var a=1,n=0,o=0,s=0,l=0,r=-1,d=e.length,h=Array(d),g=0,c,m,p,u,f,b;g<d;g++)h[g]=e[g]/t;for(var _=0;_<d;_++)n+=_*h[_],o+=_*_*h[_],s+=_*_*_*h[_];m=a*o-n*n,p=(-o*o+n*s)/m,u=(a*-s+o*n)/m,f=.5*(-u-_Mathsqrt(u*u-4*p)),b=.5*(-u+_Mathsqrt(u*u-4*p)),c=(b-n)/(b-f);for(var w=0;w<d;w++)if(l+=h[w],l>c){r=w;break}return r}function otsu(e,t){for(var a=0,n=0,o=0,s=0,l=0,r=0;r<e.length;r++)l+=r*e[r];for(var d=0;d<e.length;d++){n+=e[d];var h=t-n;if(0!==n&&0!=h){a+=d*e[d];var g=(l-a)/h,c=n*h*(a/n-g)*(a/n-g);c>=o&&(s=d,o=c)}}return s}function percentile(e){for(var t=-1,a=Array(e.length),n=partialSum(e,e.length-1),o=1,s=0;s<e.length;s++)a[s]=_Mathabs(partialSum(e,s)/n-.5),a[s]<o&&(o=a[s],t=s);return t}function partialSum(e,t){for(var a=0,n=0;n<=t;n++)a+=e[n];return a}function renyiEntropy(e,t){for(var a=Array(e.length),i=Array(e.length),n=Array(e.length),o=0,s=0,l=0,r=0,d=0,h=0,g=1/(1-.5),c=1/(1-2),m=0,p,u,f;m<e.length;m++)a[m]=e[m]/t;i[0]=a[0],n[0]=1-i[0];for(var b=1;b<e.length;b++)i[b]=i[b-1]+a[b],n[b]=1-i[b];u=0;for(var _=0;_<e.length;_++)if(_Mathabs(i[_])>=_NumberEPSILON){u=_;break}f=e.length-1;for(var w=e.length-1;w>=u;w--)if(_Mathabs(n[w])>=_NumberEPSILON){f=w;break}for(var x=u;x<=f;x++){for(var y=0,k=0,v=0,D=0;D<=x;D++)0!==e[D]&&(y-=a[D]/i[x]*_Mathlog(a[D]/i[x])),k+=_Mathsqrt(a[D]/i[x]),v+=a[D]*a[D]/(i[x]*i[x]);for(var S=0,I=0,P=0,M=x+1;M<e.length;M++)0!==e[M]&&(S-=a[M]/n[x]*_Mathlog(a[M]/n[x])),I+=_Mathsqrt(a[M]/n[x]),P+=a[M]*a[M]/(n[x]*n[x]);var B=y+S,C=g*(0<k*I?_Mathlog(k*I):0),j=c*(0<v*P?_Mathlog(v*P):0);B>r&&(r=B,o=x),C>d&&(d=C,s=x),j>h&&(h=j,l=x)}var R=[o,s,l];R.sort(asc);var A=5>=_Mathabs(R[0]-R[1])?5>=_Mathabs(R[1]-R[2])?[1,2,1]:[0,1,3]:5>=_Mathabs(R[1]-R[2])?[3,1,0]:[1,2,1];var z=i[R[2]]-i[R[0]];return p=_Mathround(R[0]*(i[R[0]]+.25*z*A[0])+.25*R[1]*z*A[1]+R[2]*(n[R[2]]+.25*z*A[2])),p}function shanbhag(e,t){for(var a=Array(e.length),i=0;i<e.length;i++)a[i]=e[i]/t;var n=Array(e.length),o=Array(e.length);n[0]=a[0],o[0]=1-n[0];for(var s=1;s<e.length;s++)n[s]=n[s-1]+a[s],o[s]=1-n[s];for(var l=0,r=0;r<e.length;r++)if(_Mathabs(n[r])>=_NumberEPSILON){l=r;break}for(var d=e.length-1,h=e.length-1;h>=l;h--)if(_Mathabs(o[h])>=_NumberEPSILON){d=h;break}for(var g=-1,c=_NumberMAX_VALUE,m=l,p,u,f,b;m<=d;m++){f=0,p=.5/n[m];for(var _=1;_<=m;_++)f-=a[_]*_Mathlog(1-p*n[_-1]);f*=p,b=0,p=.5/o[m];for(var w=m+1;w<e.length;w++)b-=a[w]*_Mathlog(1-p*o[w]);b*=p,u=_Mathabs(f-b),u<c&&(c=u,g=m)}return g}function triangle(e){for(var t=0,a=0,n=0,o=0,s=0;s<e.length;s++)if(0<e[s]){t=s;break}0<t&&t--;for(var l=e.length-1;0<l;l--)if(0<e[l]){o=l;break}o<e.length-1&&o++;for(var r=0;r<e.length;r++)e[r]>a&&(n=r,a=e[r]);var h=!1;if(n-t<o-n){h=!0;for(var g=0,c=e.length-1,m;g<c;)m=e[g],e[g]=e[c],e[c]=m,g++,c--;t=e.length-1-o,n=e.length-1-n}if(t===n)return t;var p,u,f;p=e[n],u=t-n,f=_Mathsqrt(p*p+u*u),p/=f,u/=f,f=p*t+u*e[t];for(var b=t,_=0,w=t+1,x;w<=n;w++)x=p*w+u*e[w]-f,x>_&&(b=w,_=x);if(b--,h){for(var y=0,k=e.length-1,v;y<k;)v=e[y],e[y]=e[k],e[k]=v,y++,k--;return e.length-1-b}return b}function yen(e,t){for(var a=Array(e.length),i=0;i<e.length;i++)a[i]=e[i]/t;var n=Array(e.length);n[0]=a[0];for(var o=1;o<e.length;o++)n[o]=n[o-1]+a[o];var s=Array(e.length);s[0]=a[0]*a[0];for(var l=1;l<e.length;l++)s[l]=s[l-1]+a[l]*a[l];var r=Array(e.length);r[e.length-1]=0;for(var d=e.length-2;0<=d;d--)r[d]=r[d+1]+a[d+1]*a[d+1];for(var h=-1,g=_NumberMIN_VALUE,c=0,m;c<e.length;c++)m=-1*(0<s[c]*r[c]?_Mathlog(s[c]*r[c]):0)+2*(0<n[c]*(1-n[c])?_Mathlog(n[c]*(1-n[c])):0),m>g&&(g=m,h=c);return h}function getThreshold$1(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.algorithm,a=void 0===t?names$1.otsu:t;this.checkProcessable("getThreshold",{components:1,bitDepth:[8,16]});var i=methods$1[a.toLowerCase()];if(i){var n=this.getHistogram();return i(n,this.size)}throw new Error("unknown thresholding algorithm: ".concat(a))}function mask(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.algorithm,a=void 0===t?"threshold":t,n=e.threshold,o=void 0===n?.5:n,s=e.useAlpha,l=e.invert,r=void 0!==l&&l;this.checkProcessable("mask",{components:1,bitDepth:[8,16]}),o="threshold"===a?getThreshold(o,this.maxValue):getThreshold$1.call(this,e);var d=new Image(this.width,this.height,{kind:"BINARY",parent:this}),h=0;if(this.alpha&&(!(void 0!==s)||s))for(var g=0,c;g<this.data.length;g+=this.channels)c=this.data[g]+(this.maxValue-this.data[g])*(this.maxValue-this.data[g+1])/this.maxValue,(r&&c<=o||!r&&c>=o)&&d.setBit(h),h++;else for(var m=0;m<this.data.length;m+=this.channels)(r&&this.data[m]<=o||!r&&this.data[m]>=o)&&d.setBit(h),h++;return d}function copyImage(e,t,a,n){for(var o=e.width,s=e.height,l=t.width,r=e.channels,d=0;d<o;d++)for(var h=0;h<s;h++)for(var g=0;g<r;g++){var c=(h*o+d)*r+g,m=((n+h)*l+a+d)*r+g;t.data[m]=e.data[c]}}function pad(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.size,a=void 0===t?0:t,n=e.algorithm,o=void 0===n?"copy":n,s=e.color;if(this.checkProcessable("pad",{bitDepth:[8,16]}),"set"===o){if(s.length!==this.channels)throw new Error("pad: the color array must have the same length as the number of channels. Here: ".concat(this.channels));for(var l=0;l<s.length;l++)0===s[l]&&(s[l]=.001)}else s=newArray_1(this.channels,null);Array.isArray(a)||(a=[a,a]);var r=this.width+2*a[0],d=this.height+2*a[1],h=this.channels,g=Image.createFrom(this,{width:r,height:d});copyImage(this,g,a[0],a[1]);for(var c=a[0];c<r-a[0];c++)for(var m=0,p;m<h;m++){p=s[m]||g.data[(a[1]*r+c)*h+m];for(var u=0;u<a[1];u++)g.data[(u*r+c)*h+m]=p;p=s[m]||g.data[((d-a[1]-1)*r+c)*h+m];for(var f=d-a[1];f<d;f++)g.data[(f*r+c)*h+m]=p}for(var b=0;b<d;b++)for(var _=0,w;_<h;_++){w=s[_]||g.data[(b*r+a[0])*h+_];for(var x=0;x<a[0];x++)g.data[(b*r+x)*h+_]=w;w=s[_]||g.data[(b*r+r-a[0]-1)*h+_];for(var y=r-a[0];y<r;y++)g.data[(b*r+y)*h+_]=w}return g}function colorDepth(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:8;if(this.checkProcessable("colorDepth",{bitDepth:[1,8,16]}),![8,16].includes(e))throw Error("You need to specify the new colorDepth as 8 or 16");if(this.bitDepth===e)return this.clone();var t=Image.createFrom(this,{bitDepth:e});switch(e){case 8:if(1===this.bitDepth)for(var a=0;a<this.size;a++)this.getBit(a)&&(t.data[a]=255);else for(var n=0;n<this.data.length;n++)t.data[n]=this.data[n]>>8;break;case 16:if(1===this.bitDepth)for(var o=0;o<this.size;o++)this.getBit(o)&&(t.data[o]=65535);else for(var s=0;s<this.data.length;s++)t.data[s]=this.data[s]<<8|this.data[s];break;default:throw new Error("colorDepth conversion unexpected case");}return t}function rotateFree(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.interpolation,i=void 0===a?validInterpolations.nearestneighbor:a,n=t.width,o=void 0===n?this.width:n,s=t.height,l=void 0===s?this.height:s;if("number"!=typeof e)throw new TypeError("degrees must be a number");var r=checkInterpolation(i),d=e*_MathPI/180,h=_Mathfloor(_Mathabs(o*_Mathcos(d))+_Mathabs(l*_Mathsin(d))),g=_Mathfloor(_Mathabs(l*_Mathcos(d))+_Mathabs(o*_Mathsin(d))),c=Image.createFrom(this,{width:h,height:g}),m=_Mathcos(-d),p=_Mathsin(-d),u=h/2,f=g/2;0==h%2?(u-=.5,0==g%2?f-=.5:f=_Mathfloor(f)):(u=_Mathfloor(u),0==g%2?f-=.5:f=_Mathfloor(f));var b=_Mathfloor(o/2-u),_=_Mathfloor(l/2-f);switch(r){case validInterpolations.nearestneighbor:return rotateNearestNeighbor(this,c,b,_,u,f,m,p);case validInterpolations.bilinear:return rotateBilinear(this,c,b,_,u,f,m,p);default:throw new Error("unsupported rotate interpolation: ".concat(r));}}function rotateNearestNeighbor(e,t,a,n,o,s,l,r){for(var d=0;d<t.width;d+=1)for(var h=0;h<t.height;h+=1)for(var g=0;g<e.channels;g++){var m=_Mathround((d-o)*l-(h-s)*r+o)+a,p=_Mathround((h-s)*l+(d-o)*r+s)+n;0>m||m>=e.width||0>p||p>=e.height?1===e.alpha&&g==e.channels-1?t.setValueXY(d,h,g,0):t.setValueXY(d,h,g,e.maxValue):t.setValueXY(d,h,g,e.getValueXY(m,p,g))}return t}function rotateBilinear(e,t,a,n,o,s,l,r){for(var d=e.width*e.channels,h=0;h<t.height;h++)for(var g=0;g<t.width;g++)for(var m=(g-o)*l-(h-s)*r+o+a,p=(h-s)*l+(g-o)*r+s+n,u=0|m,f=0|p,b=m-u,_=p-f,w=0;w<e.channels;w++)if(0>m||m>=e.width||0>p||p>=e.height)1===e.alpha&&w==e.channels-1?t.setValueXY(g,h,w,0):t.setValueXY(g,h,w,e.maxValue);else{var x=(f*e.width+u)*e.channels+w,y=e.data[x],k=e.data[x+e.channels],v=e.data[x+d],S=e.data[x+d+e.channels];t.setValueXY(g,h,w,0|y+b*(k-y)+_*(v-y)+b*_*(y-k-v+S))}return t}function rotate(e,t){if("number"!=typeof e)throw new TypeError("angle must be a number");switch(0>e&&(e=360*_Mathceil(-e/360)+e),e%360){case 0:return this.clone();case 90:return rotateRight.call(this);case 180:return rotate180.call(this);case 270:return rotateLeft.call(this);default:return rotateFree.call(this,e,t);}}function rotateLeft(){for(var e=Image.createFrom(this,{width:this.height,height:this.width}),t=e.height-1,a=0;a<this.height;a++)for(var n=0;n<this.width;n++)for(var o=0;o<this.channels;o++)e.setValueXY(a,t-n,o,this.getValueXY(n,a,o));return e}function rotateRight(){for(var e=Image.createFrom(this,{width:this.height,height:this.width}),t=e.width-1,a=0;a<this.height;a++)for(var n=0;n<this.width;n++)for(var o=0;o<this.channels;o++)e.setValueXY(t-a,n,o,this.getValueXY(n,a,o));return e}function rotate180(){for(var e=Image.createFrom(this),t=e.width-1,a=e.height-1,n=0;n<this.height;n++)for(var o=0;o<this.width;o++)for(var s=0;s<this.channels;s++)e.setValueXY(t-o,a-n,s,this.getValueXY(o,n,s));return e}function insert(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=getImageParameters(e);this.checkProcessable("insert",a);var n=t.x,o=void 0===n?0:n,s=t.y,l=void 0===s?0:s,r=getOutputImageOrInPlace(this,t,{copy:!0}),d=_Mathmin(r.height,l+e.height),h=_Mathmin(r.width,o+e.width);if(1===r.bitDepth)for(var g=l;g<d;g++)for(var c=o,m;c<h;c++)m=e.getBitXY(c-o,g-l),m?r.setBitXY(c,g):r.clearBitXY(c,g);else for(var p=l;p<d;p++)for(var u=o;u<h;u++)r.setPixelXY(u,p,e.getPixelXY(u-o,p-l));return r}function setBorder(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.size,a=void 0===t?0:t,n=e.algorithm,o=void 0===n?"copy":n,s=e.color;if(this.checkProcessable("setBorder",{bitDepth:[8,16,32,64]}),"set"===o){if(s.length!==this.channels)throw new Error("setBorder: the color array must have the same length as the number of channels. Here: ".concat(this.channels));for(var l=0;l<s.length;l++)0===s[l]&&(s[l]=.001)}else s=newArray_1(this.channels,null);Array.isArray(a)||(a=[a,a]);for(var r=a[0],d=a[1],h=this.channels,g=r;g<this.width-r;g++)for(var c=0,m;c<h;c++){m=s[c]||this.data[(g+this.width*d)*h+c];for(var p=0;p<d;p++)this.data[(p*this.width+g)*h+c]=m;m=s[c]||this.data[(g+this.width*(this.height-d-1))*h+c];for(var u=this.height-d;u<this.height;u++)this.data[(u*this.width+g)*h+c]=m}for(var f=0;f<this.height;f++)for(var b=0,_;b<h;b++){_=s[b]||this.data[(f*this.width+r)*h+b];for(var w=0;w<r;w++)this.data[(f*this.width+w)*h+b]=_;_=s[b]||this.data[(f*this.width+this.width-r-1)*h+b];for(var x=this.width-r;x<this.width;x++)this.data[(f*this.width+x)*h+b]=_}return this}function split(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.preserveAlpha;if(this.checkProcessable("split",{bitDepth:[8,16]}),1===this.components)return new Stack([this.clone()]);var a=new Stack,n=this.data;if(this.alpha&&(void 0===t||t))for(var o=0;o<this.components;o++){for(var s=Image.createFrom(this,{components:1,alpha:!0,colorModel:"GREY"}),l=0,r=0;r<n.length;r+=this.channels)s.data[l++]=n[r+o],s.data[l++]=n[r+this.components];a.push(s)}else for(var d=0;d<this.channels;d++){for(var h=Image.createFrom(this,{components:1,alpha:!1,colorModel:"GREY"}),g=0,c=0;c<n.length;c+=this.channels)h.data[g++]=n[c+d];a.push(h)}return a}function getChannel(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.keepAlpha,i=void 0!==a&&a,n=t.mergeAlpha,o=void 0!==n&&n;i&=this.alpha,o&=this.alpha,this.checkProcessable("getChannel",{bitDepth:[8,16]}),e=validateChannel(this,e);for(var s=Image.createFrom(this,{components:1,alpha:i,colorModel:"GREY"}),l=0,r=0;r<this.data.length;r+=this.channels)o?s.data[l++]=this.data[r+e]*this.data[r+this.components]/this.maxValue:(s.data[l++]=this.data[r+e],i&&(s.data[l++]=this.data[r+this.components]));return s}function combineChannels(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:defaultCombineMethod,t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.mergeAlpha,n=void 0!==a&&a,o=t.keepAlpha,s=void 0!==o&&o;n&=this.alpha,s&=this.alpha,this.checkProcessable("combineChannels",{bitDepth:[8,16]});for(var l=Image.createFrom(this,{components:1,alpha:s,colorModel:"GREY"}),r=0,d=0,h;d<this.size;d++)h=e(this.getPixel(d)),n?l.data[r++]=h*this.data[d*this.channels+this.components]/this.maxValue:(l.data[r++]=h,s&&(l.data[r++]=this.data[d*this.channels+this.components]));return l}function defaultCombineMethod(e){return(e[0]+e[1]+e[2])/3}function setChannel(e,t){if(this.checkProcessable("setChannel",{bitDepth:[8,16]}),t.checkProcessable("setChannel (image parameter check)",{bitDepth:[this.bitDepth],alpha:[0],components:[1]}),t.width!==this.width||t.height!==this.height)throw new Error("Images must have exactly the same width and height");e=validateChannel(this,e);for(var a=e,n=0;n<t.data.length;n++)this.data[a]=t.data[n],a+=this.channels;return this}function getSimilarity(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.shift,n=void 0===a?[0,0]:a,o=t.average,s=t.channels,l=t.defaultAlpha,r=t.normalize,d=t.border,h=void 0===d?[0,0]:d;if(this.checkProcessable("getSimilarity",{bitDepth:[8,16]}),Array.isArray(h)||(h=[h,h]),s=validateArrayOfChannels(this,{channels:s,defaultAlpha:l}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");"undefined"==typeof o&&(o=!0);for(var g=_Mathmax(h[0],-n[0]),m=_Mathmin(this.width-h[0],this.width-n[0]),p=_Mathmax(h[1],-n[1]),u=_Mathmin(this.height-h[1],this.height-n[1]),f=newArray_1(s.length,0),b=0;b<s.length;b++){var _=s[b],c=r?this.sum[_]:_Mathmax(this.sum[_],e.sum[_]),w=r?e.sum[_]:_Mathmax(this.sum[_],e.sum[_]);if(0!==c&&0!==w)for(var k=g;k<m;k++)for(var v=p;v<u;v++){var D=k*this.multiplierX+v*this.multiplierY+_,S=D+n[0]*this.multiplierX+n[1]*this.multiplierY;f[b]+=_Mathmin(this.data[D]/c,e.data[S]/w)}}return o?f.reduce((e,t)=>e+t)/f.length:f}function getPixelsGrid(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.sampling,a=void 0===t?[10,10]:t,n=e.painted,o=e.mask;this.checkProcessable("getPixelsGrid",{bitDepth:[8,16],channels:1}),Array.isArray(a)||(a=[a,a]);for(var s=a[0],l=a[1],r=[],d=[],h=this.width/s,g=this.height/l,c=_Mathfloor(h/2),m=0,p;m<s;m++){p=_Mathfloor(g/2);for(var u=0;u<l;u++){var f=_Mathround(c),b=_Mathround(p);(!o||o.getBitXY(f,b))&&(r.push([f,b]),d.push(this.getPixelXY(f,b))),p+=g}c+=h}var _={xyS:r,zS:d};return void 0!==n&&n&&(_.painted=this.rgba8().paintPoints(r)),_}function Matrix$2(e,t,a){for(var i=Array(e),n=0;n<e;n++)i[n]=Array(t);if(a)for(var o=0;o<e;o++)for(var s=0;s<t;s++)i[o][s]=a;return i.width=e,i.height=t,Object.setPrototypeOf(i,Matrix$2.prototype),i}function match(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.border;if(this.checkProcessable("getChannel",{bitDepth:[8,16]}),this.bitDepth!==e.bitDepth)throw new Error("Both images must have the same bitDepth");if(this.channels!==e.channels)throw new Error("Both images must have the same number of channels");if(this.colorModel!==e.colorModel)throw new Error("Both images must have the same colorModel");for(var n=new Matrix$2(e.width,e.height,-Infinity),o=_Mathfloor(e.width/2),s=_Mathfloor(e.height/2),l=o,r=s,d=!1;!d;){for(var h=n.localSearch(o,s,-Infinity),g=0;g<h.length;g++){var c=h[g],m=this.getSimilarity(e,{border:a,shift:[l-c[0],r-c[1]]});n[c[0]][c[1]]=m}var p=n.localMax(o,s);p.position[0]!==o||p.position[1]!==s?(o=p.position[0],s=p.position[1]):d=!0}return[o-l,s-r]}function getRow(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;this.checkProcessable("getRow",{bitDepth:[8,16]}),checkRow(this,e),checkChannel(this,t);for(var a=Array(this.width),i=0,n=e*this.width*this.channels+t,o=n+this.width*this.channels,s=n;s<o;s+=this.channels)a[i++]=this.data[s];return a}function getColumn(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;this.checkProcessable("getColumn",{bitDepth:[8,16]}),checkColumn(this,e),checkChannel(this,t);for(var a=Array(this.height),i=0,n=this.width*this.channels,o=t+e*this.channels;o<this.data.length;o+=n)a[i++]=this.data[o];return a}function getMatrix(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.channel;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),void 0===t){if(1<this.components)throw new RangeError("You need to define the channel for an image that contains more than one channel");t=0}for(var a=new Matrix(this.height,this.width),i=0;i<this.height;i++)for(var n=0;n<this.width;n++)a.set(i,n,this.getValueXY(n,i,t));return a}function setMatrix(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.channel;if(this.checkProcessable("getMatrix",{bitDepth:[8,16]}),void 0===a){if(1<this.components)throw new RangeError("You need to define the channel for an image that contains more than one channel");a=0}if(!e.length||!e[0].length||this.width!==e.columns||this.height!==e.rows)throw new RangeError("The size of the matrix must be equal to the size of the image");for(var i=0;i<this.height;i++)for(var n=0;n<this.width;n++)this.setValueXY(n,i,a,e.get(i,n))}function getPixelsArray(){this.checkProcessable("getPixelsArray",{bitDepth:[8,16,32]});for(var e=Array(this.size),t=0,a=0,n;a<this.data.length;a+=this.channels){n=Array(this.components);for(var o=0;o<this.components;o++)n[o]=this.data[a+o];e[t++]=n}return e}function getIntersection(e){for(var t=this,a=t.getClosestCommonParent(e),n=t.getRelativePosition(a,{defaultFurther:!0}),o=getRelativePositionForAllPixels(t,n),s=e.getRelativePosition(a,{defaultFurther:!0}),l=getRelativePositionForAllPixels(e,s),r=getCommonSurface(o,l),d={whitePixelsMask1:[],whitePixelsMask2:[],commonWhitePixels:[]},h=0;h<r.length;h++){var g=r[h],c=[g[0]-n[0],g[1]-n[1]],m=[g[0]-s[0],g[1]-s[1]],p=t.getBitXY(c[0],c[1]),u=e.getBitXY(m[0],m[1]);1===p&&1===u&&d.commonWhitePixels.push(g)}for(var f=0;f<o.length;f++){var b=void 0,_=void 0;0!=f&&(b=_Mathfloor(f/(t.width-1)),_=f%(t.width-1)),1===t.getBitXY(b,_)&&d.whitePixelsMask1.push(o[f])}for(var w=0;w<l.length;w++){var x=0,y=0;0!=w&&(x=_Mathfloor(w/(e.width-1)),y=w%(e.width-1)),1===e.getBitXY(x,y)&&d.whitePixelsMask2.push(l[w])}return d}function getRelativePositionForAllPixels(e,t){for(var a=[],n=0;n<e.height;n++)for(var o=0,s;o<e.width;o++)s=[n,o],a.push([s[0]+t[0],s[1]+t[1]]);return a}function getCommonSurface(e,t){for(var a=0,n=0,o=[];a<e.length&&n<t.length;)e[a][0]===t[n][0]&&e[a][1]===t[n][1]?(o.push(e[a]),a++,n++):e[a][0]<t[n][0]||e[a][0]===t[n][0]&&e[a][1]<t[n][1]?a++:n++;return o}function getClosestCommonParent(e){var t=getDepth(this),a=getDepth(e),i;if(i=t>=a?getFurthestParent(this,t):getFurthestParent(e,a),0===t||0===a)return i;for(var n=this,o=e;t!==a;)if(t>a){if(n=n.parent,null===n)return i;--t}else{if(o=o.parent,null===o)return i;--a}for(;n!==o&&null!==n&&null!==o;)if(n=n.parent,o=o.parent,null===n||null===o)return i;return n===o?n:i}function getDepth(e){for(var t=0,a=e;null!=a.parent;)a=a.parent,t++;return t}function getFurthestParent(e,t){for(var a=e;0<t;)a=a.parent,--t;return a}function cannyEdgeDetector(e,t){e.checkProcessable("Canny edge detector",{bitDepth:8,channels:1,components:1}),t=Object.assign({},defaultOptions$c,t);const a=e.width,n=e.height,o=e.maxValue,s={sigma:t.gaussianBlur,radius:3},r=e.gaussianFilter(s),d=r.convolution(Gy,convOptions),h=r.convolution(Gx,convOptions),g=h.hypotenuse(d),c=e.constructor,m=new c(a,n,{kind:"GREY",bitDepth:32}),p=new c(a,n,{kind:"GREY",bitDepth:32}),u=new c(a,n,{kind:"GREY"});for(var f=1;f<a-1;f++)for(var b=1,_;b<n-1;b++)_=(_Mathround(_Mathatan(h.getValueXY(f,b,0),d.getValueXY(f,b,0))*(5/_MathPI))+5)%5,0===_&&(g.getValueXY(f,b,0)<=g.getValueXY(f,b-1,0)||g.getValueXY(f,b,0)<=g.getValueXY(f,b+1,0))||1===_&&(g.getValueXY(f,b,0)<=g.getValueXY(f-1,b+1,0)||g.getValueXY(f,b,0)<=g.getValueXY(f+1,b-1,0))||2===_&&(g.getValueXY(f,b,0)<=g.getValueXY(f-1,b,0)||g.getValueXY(f,b,0)<=g.getValueXY(f+1,b,0))||3===_&&(g.getValueXY(f,b,0)<=g.getValueXY(f-1,b-1,0)||g.getValueXY(f,b,0)<=g.getValueXY(f+1,b+1,0))||m.setValueXY(f,b,0,g.getValueXY(f,b,0));for(f=0;f<a*n;++f){var w=m.data[f],x=0;w>t.highThreshold&&(x++,u.data[f]=o),w>t.lowThreshold&&x++,p.data[f]=x}var y=[];for(f=1;f<a-1;++f)for(b=1;b<n-1;++b)if(1===p.getValueXY(f,b,0))outer:for(var v=f-1;v<f+2;++v)for(var D=b-1;D<b+2;++D)if(2===p.getValueXY(v,D,0)){y.push([f,b]),u.setValueXY(f,b,0,o);break outer}for(;0<y.length;){var S=[];for(f=0;f<y.length;++f)for(b=-1;2>b;++b)for(v=-1;2>v;++v)if(0!=b||0!=v){var I=y[f][0]+b,P=y[f][1]+v;1===p.getValueXY(I,P,0)&&0===u.getValueXY(I,P,0)&&(S.push([I,P]),u.setValueXY(I,P,0,o))}y=S}return u}function cannyEdge(e){return cannyEdgeDetector(this,e)}function extract(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=t.position;if(this.checkProcessable("extract",{bitDepth:[1,8,16]}),!a&&(a=e.getRelativePosition(this),!a))throw new Error("extract : can not extract an image because the relative position can not be determined, try to specify manually the position as an array of 2 elements [x,y].");if(1<this.bitDepth){for(var i=Image.createFrom(this,{width:e.width,height:e.height,alpha:1,position:a,parent:this}),n=0;n<e.width;n++)for(var o=0;o<e.height;o++){for(var s=0,l;s<this.channels;s++)l=this.getValueXY(n+a[0],o+a[1],s),i.setValueXY(n,o,s,l);e.getBitXY(n,o)||i.setValueXY(n,o,this.components,0)}return i}for(var r=Image.createFrom(this,{width:e.width,height:e.height,position:a,parent:this}),d=0;d<e.height;d++)for(var h=0;h<e.width;h++)e.getBitXY(h,d)&&this.getBitXY(h+a[0],d+a[1])&&r.setBitXY(h,d);return r}function floodFill(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.x,a=void 0===t?0:t,n=e.y,o=void 0===n?0:n,s=e.inPlace,l=void 0===s||s?this:Image.createFrom(this);if(this.checkProcessable("floodFill",{bitDepth:1}),1===this.bitDepth){var r=this.getBitXY(a,o);if(r)return l;var d=new fastList;for(d.push(new Node(a,o));0<d.length;){var h=d.shift();l.setBitXY(h.x,h.y);for(var g=h.x+1;g<this.width&&!l.getBitXY(g,h.y)&&!this.getBitXY(g,h.y);g++)l.setBitXY(g,h.y),h.y+1<this.height&&!this.getBitXY(g,h.y+1)&&d.push(new Node(g,h.y+1)),0<=h.y-1&&!this.getBitXY(g,h.y-1)&&d.push(new Node(g,h.y-1));for(var c=h.x-1;0<=c&&!l.getBitXY(c,h.y)&&!this.getBitXY(c,h.y);c++)l.setBitXY(c,h.y),h.y+1<this.height&&!this.getBitXY(c,h.y+1)&&d.push(new Node(c,h.y+1)),0<=h.y-1&&!this.getBitXY(c,h.y-1)&&d.push(new Node(c,h.y-1))}}return l}function Node(e,t){this.x=e,this.y=t}function hsv2rgb(e,t,a){t/=100,a/=100;var i=[],n=a*t,o=e/60,l=n*(1-_Mathabs(o%2-1)),r=a-n;switch(parseInt(o,10)){case 0:i=[n,l,0];break;case 1:i=[l,n,0];break;case 2:i=[0,n,l];break;case 3:i=[0,l,n];break;case 4:i=[l,0,n];break;case 5:i=[n,0,l];}return{r:_Mathround(255*(i[0]+r)),g:_Mathround(255*(i[1]+r)),b:_Mathround(255*(i[2]+r))}}function hsl2hsv(e,t,a){return t*=(50>a?a:100-a)/100,{h:e,s:100*(2*t/(a+t)),v:a+t}}function hsl2rgb(e,t,a){var i=hsl2hsv(e,t,a);return hsv2rgb(i.h,i.s,i.v)}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null==arguments[t]?{}:arguments[t],n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),n.forEach(function(t){_defineProperty(e,t,a[t])})}return e}function parse(e){return named(e)||hex3(e)||hex6(e)||rgb(e)||rgba$1(e)||hsl$1(e)||hsla(e)}function named(e){var t=colors[e.toLowerCase()];return t?{r:t[0],g:t[1],b:t[2],a:100}:void 0}function rgb(e){var t=e.match(/rgb\(([^)]+)\)/);if(t){var a=t[1].split(/ *, */).map(Number);return{r:a[0],g:a[1],b:a[2],a:100}}}function rgba$1(e){var t=e.match(/rgba\(([^)]+)\)/);if(t){var a=t[1].split(/ *, */).map(Number);return{r:a[0],g:a[1],b:a[2],a:100*a[3]}}}function hex6(e){if("#"===e[0]&&7===e.length)return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16),a:100}}function hex3(e){if("#"===e[0]&&4===e.length)return{r:parseInt(e[1]+e[1],16),g:parseInt(e[2]+e[2],16),b:parseInt(e[3]+e[3],16),a:100}}function hsl$1(e){var t=e.match(/hsl\(([^)]+)\)/);if(t){var a=t[1].split(/ *, */),i=parseInt(a[0],10),n=parseInt(a[1],10),o=parseInt(a[2],10),s=hsl2rgb(i,n,o);return _objectSpread({},s,{a:100})}}function hsla(e){var t=e.match(/hsla\(([^)]+)\)/);if(t){var i=t[1].split(/ *, */),n=parseInt(i[0],10),o=parseInt(i[1],10),s=parseInt(i[2],10),l=parseInt(100*parseFloat(i[3]),10),a=hsl2rgb(n,o,s);return _objectSpread({},a,{a:l})}}function css2array(e){var t=parse(e);return[t.r,t.g,t.b,_Mathround(255*t.a/100)]}function hue2rgb(e,a,i){return 0>i&&(i+=1),1<i&&(i-=1),i<1/6?e+6*(a-e)*i:i<1/2?a:i<2/3?e+6*((a-e)*(2/3-i)):e}function hsl2rgb$1(e,t,a){var i,n,o,d,h,c;return t/=100,a/=100,0===t?d=h=c=255*a:(n=.5>=a?a*(t+1):a+t-a*t,i=2*a-n,o=e/360,d=hue2rgb(i,n,o+1/3),h=hue2rgb(i,n,o),c=hue2rgb(i,n,o-1/3)),{r:d,g:h,b:c}}function getDistinctColors(e){for(var t=Array(e),a=0,n=0;360>n;n+=360/e){a++;var o=hsl2rgb$1(n,100,30+15*(a%4));t[a-1]=[_Mathround(255*o.r),_Mathround(255*o.g),_Mathround(255*o.b)]}return t}function getRandomColor(){return[_Mathfloor(256*Math.random()),_Mathfloor(256*Math.random()),_Mathfloor(256*Math.random())]}function getColors(e){var t=e.color,a=e.colors,n=e.randomColors,o=e.numberColors,s=void 0===o?50:o;if(t&&!Array.isArray(t)&&(t=css2array(t)),t)return[t];if(a)return a=a.map(function(e){return Array.isArray(e)?e:css2array(e)}),a;if(n){a=Array(s);for(var l=0;l<s;l++)a[l]=getRandomColor()}return getDistinctColors(s)}function paintLabels(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=a.color,o=void 0===n?"blue":n,s=a.colors,l=a.font,r=void 0===l?"12px Helvetica":l,d=a.rotate,h=void 0===d?0:d;if(this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:"RGB"}),!Array.isArray(e))throw Error("paintLabels: labels must be an array");if(!Array.isArray(t))throw Error("paintLabels: positions must be an array");if(o&&!Array.isArray(o)&&(o=css2array(o)),s=s?s.map(function(e){return Array.isArray(e)?e:css2array(e)}):[o],e.length!==t.length)throw Error("paintLabels: positions and labels must be arrays from the same size");Array.isArray(r)||(r=[r]),Array.isArray(h)||(h=[h]);for(var g=this.getCanvas(),c=g.getContext("2d"),m=0;m<e.length;m++){c.save();var p=s[m%s.length];c.fillStyle="rgba(".concat(p[0],",").concat(p[1],",").concat(p[2],",").concat(p[3]/this.maxValue,")"),c.font=r[m%r.length];var u=t[m];c.translate(u[0],u[1]),c.rotate(h[m%h.length]/180*_MathPI),c.fillText(e[m],0,0),c.restore()}return this.data=Uint8Array.from(c.getImageData(0,0,this.width,this.height).data),this}function paintMasks(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.alpha,n=void 0===a?255:a,o=t.labels,s=void 0===o?[]:o,l=t.labelsPosition,r=void 0===l?[]:l,d=t.labelColor,h=void 0===d?"blue":d,g=t.labelFont,c=void 0===g?"12px Helvetica":g;this.checkProcessable("paintMasks",{channels:[3,4],bitDepth:[8,16],colorModel:"RGB"});var m=getColors(Object.assign({},t,{numberColors:e.length}));Array.isArray(e)||(e=[e]);for(var p=0;p<e.length;p++)for(var u=e[p],f=m[p%m.length],b=0;b<u.width;b++)for(var _=0;_<u.height;_++)if(u.getBitXY(b,_))for(var w=0;w<_Mathmin(this.components,f.length);w++)if(255===n)this.setValueXY(b+u.position[0],_+u.position[1],w,f[w]);else{var k=this.getValueXY(b+u.position[0],_+u.position[1],w);k=_Mathround((k*(255-n)+f[w]*n)/255),this.setValueXY(b+u.position[0],_+u.position[1],w,k)}if(Array.isArray(s)&&0<s.length){var v=this.getCanvas(),D=v.getContext("2d");D.fillStyle=h,D.font=c;for(var S=0,I;S<_Mathmin(e.length,s.length);S++)I=r[S]?r[S]:e[S].position,D.fillText(s[S],I[0],I[1]);this.data=Uint8Array.from(D.getImageData(0,0,this.width,this.height).data)}return this}function rectangle(e,t,a){var i=Matrix.zeros(t,e);if(a.filled)for(var n=0;n<t;n++)for(var o=0;o<e;o++)i.set(n,o,1);else{for(var s of[0,t-1])for(var l=0;l<e;l++)i.set(s,l,1);for(var r=0;r<t;r++)for(var d of[0,e-1])i.set(r,d,1)}return i}function ellipse(e,t,i){var n=Matrix.zeros(t,e,i),o=1-t%2,s=1-e%2,l=_Mathfloor((e-1)/2),a=_Mathfloor((t-1)/2),r=l*l,d=a*a;if(i.filled)for(var h=0,g;h<=a;h++){g=_Mathfloor(_Mathsqrt(r-r*h*h/d));for(var c=l-g;c<=l;c++)n.set(a-h,c,1),n.set(a+h+o,c,1),n.set(a-h,e-c-1,1),n.set(a+h+o,e-c-1,1)}else{for(var m=0;m<=a;m++){var p=_Mathfloor(_Mathsqrt(r-r*m*m/d)),u=l-p;n.set(a-m,u,1),n.set(a+m+o,u,1),n.set(a-m,e-u-1,1),n.set(a+m+o,e-u-1,1)}for(var f=0;f<=l;f++){var b=_Mathfloor(_Mathsqrt(d-d*f*f/r)),_=a-b;n.set(_,l-f,1),n.set(_,l+f+s,1),n.set(t-_-1,l-f,1),n.set(t-_-1,l+f+s,1)}}return n}function triangle$1(e,t,a){if(!a.filled)throw new Error("Non filled triangle is not implemented");for(var i=Matrix.zeros(t,e,a),n=0,o;n<t;n++){o=_Mathfloor((1-n/t)*e/2);for(var s=o;s<e-o;s++)i.set(n,s,1)}return i}function paintPoints(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.shape;this.checkProcessable("paintPoints",{bitDepth:[8,16]});for(var n=getColors(Object.assign({},t,{numberColors:e.length})),o=new Shape(a).getPoints(),s=_Mathmin(this.channels,n[0].length),l=0;l<e.length;l++)for(var r=n[l%n.length],d=e[l][0],h=e[l][1],g=0;g<o.length;g++){var c=o[g][0],m=o[g][1];if(0<=d+c&&0<=h+m&&d+c<this.width&&h+m<this.height)for(var p=(d+c+(h+m)*this.width)*this.channels,u=0;u<s;u++)this.data[p+u]=r[u]}return this}function paintPolyline(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.color,n=void 0===a?[this.maxValue,0,0]:a,o=t.closed;this.checkProcessable("paintPoints",{bitDepth:[8,16]});for(var s=_Mathmin(this.channels,n.length),l=0;l<e.length-1+(void 0!==o&&o);l++)for(var r=e[l],d=e[(l+1)%e.length],h=d[0]-r[0],g=d[1]-r[1],c=_Mathmax(_Mathabs(h),_Mathabs(g)),m=r[0],p=r[1],u=0;u<=c;u++){var f=_Mathround(m),b=_Mathround(p);if(0<=f&&0<=b&&f<this.width&&b<this.height)for(var _=(f+b*this.width)*this.channels,w=0;w<s;w++)this.data[_+w]=n[w];m+=h/c,p+=g/c}return this}function paintPolylines(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=Object.assign({},t);this.checkProcessable("paintPolylines",{bitDepth:[8,16]});for(var n=getColors(Object.assign({},t,{numberColors:e.length})),o=0;o<e.length;o++)a.color=n[o%n.length],this.paintPolyline(e[o],a);return this}function deleteDouble(e){for(var t=[],a=0;a<e.length;a++)if(e[a][0]===e[(a+1)%e.length][0]&&e[a][1]===e[(a+1)%e.length][1])continue;else if(e[a][0]===e[(a-1+e.length)%e.length][0]&&e[a][1]===e[(a-1+e.length)%e.length][1])continue;else if(e[(a+1)%e.length][0]===e[(a-1+e.length)%e.length][0]&&e[(a-1+e.length)%e.length][1]===e[(a+1)%e.length][1])continue;else t.push(e[a]);return t}function lineBetweenTwoPoints(e,t){if(e[0]===t[0])return{a:0,b:e[0],vertical:!0};var a=(t[1]-e[1])/(t[0]-e[0]),i=e[1]-a*e[0];return{a:a,b:i,vertical:!1}}function isAtTheRightOfTheLine(e,t,a,i){if(!0===a.vertical)return a.b<=e;if(0===a.a)return!1;var n=(t-a.b)/a.a;return n<e&&0<=n&&n<=i}function paintPolygon(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.color,n=void 0===a?[this.maxValue,0,0]:a,o=t.filled;this.checkProcessable("paintPoints",{bitDepth:[8,16]}),t.closed=!0;var s=deleteDouble(e);if(!1===(void 0!==o&&o))return this.paintPolyline(e,t);for(var l=Array(this.height),r=0;r<this.height;r++){l[r]=[];for(var d=0;d<this.width;d++)l[r].push(0)}for(var h=0,g;h<s.length;h++){g=lineBetweenTwoPoints(s[h],s[(h+1)%s.length]);for(var c=0;c<this.height;c++)for(var m=0;m<this.width;m++)isAtTheRightOfTheLine(m,c,g,this.height)&&(l[c][m]=0===l[c][m]?1:0)}for(var u=0;u<this.height;u++)for(var f=0;f<this.width;f++)if(1===l[u][f])for(var b=_Mathmin(this.channels,n.length),_=(f+u*this.width)*this.channels,w=0;w<b;w++)this.data[_+w]=n[w];return this.paintPolyline(e,t)}function paintPolygons(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=Object.assign({},t);this.checkProcessable("paintPolygons",{bitDepth:[8,16]});for(var n=getColors(Object.assign({},t,{numberColors:e.length})),o=0;o<e.length;o++)a.color=n[o%n.length],this.paintPolygon(e[o],a);return this}function getHistogram(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.maxSlots,a=void 0===t?256:t,i=e.channel,n=e.useAlpha;if(this.checkProcessable("getHistogram",{bitDepth:[1,8,16]}),void 0===i){if(1<this.components)throw new RangeError("You need to define the channel for an image that contains more than one channel");i=0}return getChannelHistogram.call(this,i,{useAlpha:void 0===n||n,maxSlots:a})}function getHistograms(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.maxSlots,a=void 0===t?256:t,n=e.useAlpha,o=!(void 0!==n)||n;this.checkProcessable("getHistograms",{bitDepth:[8,16]});for(var s=Array(o?this.components:this.channels),l=0;l<s.length;l++)s[l]=getChannelHistogram.call(this,l,{useAlpha:o,maxSlots:a});return s}function getChannelHistogram(e,t){var a=t.useAlpha,n=t.maxSlots;if(1===this.bitDepth){for(var o=[0,0],s=0;s<this.height;s++)for(var l=0,r;l<this.width;l++)r=this.getBitXY(s,l),0===r?o[0]+=1:1===r&&(o[1]+=1);return o}var d=Math.log2(n);if(!isInteger(d))throw new RangeError("maxSlots must be a power of 2, for example: 64, 256, 1024");var h=0;this.bitDepth>d&&(h=this.bitDepth-d);var g=this.data,c=newArray_1(_Mathpow(2,_Mathmin(this.bitDepth,d)),0);if(a&&this.alpha)for(var m=this.channels-e-1,p=e;p<g.length;p+=this.channels)c[g[p]>>h]+=g[p+m]/this.maxValue;else for(var u=e;u<g.length;u+=this.channels)c[g[u]>>h]++;return c}function getColorHistogram(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.useAlpha,a=e.nbSlots,n=void 0===a?512:a;this.checkProcessable("getColorHistogram",{bitDepth:[8,16],components:[3]});var o=_Mathlog(n)/_Mathlog(8);if(o!==_Mathfloor(o))throw new RangeError("nbSlots must be a power of 8. Usually 8, 64, 512 or 4096");for(var s=this.bitDepth-o,l=this.data,r=newArray_1(_Mathpow(8,o),0),d=_Mathpow(2,2*o),h=_Mathpow(2,o),g=0,c;g<l.length;g+=this.channels)c=(l[g]>>s)*d+(l[g+1]>>s)*h+(l[g+2]>>s),(!(void 0!==t)||t)&&this.alpha?r[c]+=l[g+this.channels-1]/this.maxValue:r[c]++;return r}function min$2(){this.checkProcessable("min",{bitDepth:[8,16,32]});for(var e=newArray_1(this.channels,+Infinity),t=0;t<this.data.length;t+=this.channels)for(var a=0;a<this.channels;a++)this.data[t+a]<e[a]&&(e[a]=this.data[t+a]);return e}function max$2(){this.checkProcessable("max",{bitDepth:[8,16,32]});for(var e=newArray_1(this.channels,-Infinity),t=0;t<this.data.length;t+=this.channels)for(var a=0;a<this.channels;a++)this.data[t+a]>e[a]&&(e[a]=this.data[t+a]);return e}function sum(){this.checkProcessable("sum",{bitDepth:[8,16]});for(var e=newArray_1(this.channels,0),t=0;t<this.data.length;t+=this.channels)for(var a=0;a<this.channels;a++)e[a]+=this.data[t+a];return e}function getMoment(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0,t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;this.checkProcessable("getMoment",{bitDepth:[1]});for(var a=0,i=0;i<this.width;i++)for(var n=0;n<this.height;n++)1===this.getBitXY(i,n)&&(a+=_Mathpow(i,e)*_Mathpow(n,t));return a}function localMaxima(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.mask,a=e.region,n=void 0===a?3:a,o=e.removeClosePoints,s=void 0===o?0:o,l=e.invert,r=void 0!==l&&l,d=e.maxEquals,h=void 0===d?2:d,g=this;this.checkProcessable("localMaxima",{bitDepth:[8,16],components:1}),n*=4;for(var c=r?0:1,m=[1,0,-1,0,1,1,-1,-1,2,0,-2,0,2,2,-2,-2],p=[0,1,0,-1,1,-1,1,-1,0,2,0,-2,2,-2,2,-2],u=8>=n?1:2,f=[],b=u;b<g.height-u;b++)for(var _=u;_<g.width-u;_++)if(!(t&&t.getBitXY(_,b)!==c)){for(var w=0,x=0,y=g.data[_+b*g.width],k=0;k<n;k++)r?g.data[_+m[k]+(b+p[k])*g.width]>y&&w++:g.data[_+m[k]+(b+p[k])*g.width]<y&&w++,g.data[_+m[k]+(b+p[k])*g.width]===y&&x++;w+x===n&&x<=h&&f.push([_,b])}if(0<s)for(var v=0;v<f.length;v++)for(var D=v+1;D<f.length;D++)_Mathsqrt(_Mathpow(f[v][0]-f[D][0],2)+_Mathpow(f[v][1]-f[D][1],2))<s&&(f[v][0]=f[v][0]+f[D][0]>>1,f[v][1]=f[v][1]+f[D][1]>>1,f.splice(D,1),D--);return f}function mean$2(){for(var e=this.getHistograms({maxSlots:this.maxValue+1}),t=Array(e.length),a=0,i;a<e.length;a++)i=e[a],t[a]=mean(i);return t}function median$3(){for(var e=this.getHistograms({maxSlots:this.maxValue+1}),t=Array(e.length),a=0,i;a<e.length;a++)i=e[a],t[a]=median(i);return t}function points(){this.checkProcessable("points",{bitDepth:[1]});for(var e=[],t=0;t<this.width;t++)for(var a=0;a<this.height;a++)1===this.getBitXY(t,a)&&e.push([t,a]);return e}function getRelativePosition(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};if(this===e)return[0,0];for(var a=[0,0],i=this;i;){if(i===e)return a;i.position&&(a[0]+=i.position[0],a[1]+=i.position[1]),i=i.parent}return!!t.defaultFurther&&a}function countAlphaPixels(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.alpha,a=void 0===t?1:t;this.checkProcessable("countAlphaPixels",{bitDepth:[8,16],alpha:1});var n=0;if(a!==void 0){for(var o=this.components;o<this.data.length;o+=this.channels)this.data[o]===a&&n++;return n}return this.size}function monotoneChainConvexHull(e,a={}){a.sorted||e.sort(byXThenY);const o=e.length,n=Array(2*o);for(var s=0,l=0;l<o;l++){const t=e[l];for(;2<=s&&0>=cw(n[s-2],n[s-1],t);)s--;n[s++]=t}const r=s+1;for(l=o-2;0<=l;l--){const t=e[l];for(;s>=r&&0>=cw(n[s-2],n[s-1],t);)s--;n[s++]=t}return n.slice(0,s-1)}function cw(e,t,a){return(t[1]-e[1])*(a[0]-e[0])-(t[0]-e[0])*(a[1]-e[1])}function byXThenY(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}function monotoneChainConvexHull$1(){var e=this;e.checkProcessable("monotoneChainConvexHull",{bitDepth:1});var t=e.getPoints();return monotoneChainConvexHull(t,{sorted:!0})}function difference(e,t){return[e[0]-t[0],e[1]-t[1]]}function normalize(e){var t=_Mathsqrt(_Mathpow(e[0],2)+_Mathpow(e[1],2));return[e[0]/t,e[1]/t]}function rotate$1(e,t,a){a===void 0&&(a=Array(t.length));for(var n=_Mathcos(e),o=_Mathsin(e),s=0;s<a.length;++s)a[s]=[n*t[s][0]-o*t[s][1],o*t[s][0]+n*t[s][1]];return a}function minimalBoundingRectangle(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=e.originalPoints,n=void 0===a?monotoneChainConvexHull$1.call(this):a;if(0===n.length)return[];if(1===n.length)return[n[0],n[0],n[0],n[0]];for(var o=Array(n.length),s=+Infinity,l=0,r=0,d,h;r<o.length;r++){h=getAngle(n[r],n[(r+1)%o.length]),rotate$1(-h,n,o);for(var g=o[r][0],c=o[r][1],m=o[(r+1)%o.length][0],p=o[(r+1)%o.length][1],u=!0,f=0,b=0,_=0,w=0;w<o.length;w++){var x=o[w][0],y=o[w][1],k=(x-g)/(m-g);!0===u?(u=!1,f=k,b=k):(k<f&&(f=k),k>b&&(b=k));var t=(-(m-g)*y+m*c-p*g)/(m-g);_Mathabs(t)>_Mathabs(_)&&(_=t)}var v=[g+f*(m-g),c],D=[g+b*(m-g),c],S=_Mathabs(_*(f-b)*(m-g));S<s&&(l=h,s=S,d=[v,D,[D[0],D[1]-_],[v[0],v[1]-_]])}return rotate$1(l,d,d),d}function getAngle(e,t){var a=difference(t,e),i=normalize(a),n=Math.acos(i[0]);return 0>i[1]?-n:n}function extend$1(e){var t={inPlace:!0};e.extendMethod("invert",invert),e.extendMethod("abs",abs),e.extendMethod("level",level,t),e.extendMethod("add",add,t),e.extendMethod("subtract",subtract,t),e.extendMethod("subtractImage",subtractImage),e.extendMethod("multiply",multiply,t),e.extendMethod("divide",divide,t),e.extendMethod("hypotenuse",hypotenuse$1),e.extendMethod("background",background),e.extendMethod("flipX",flipX),e.extendMethod("flipY",flipY),e.extendMethod("blurFilter",blurFilter),e.extendMethod("medianFilter",medianFilter),e.extendMethod("gaussianFilter",gaussianFilter),e.extendMethod("sobelFilter",sobelFilter),e.extendMethod("gradientFilter",gradientFilter),e.extendMethod("scharrFilter",scharrFilter),e.extendMethod("dilate",dilate),e.extendMethod("erode",erode),e.extendMethod("open",open),e.extendMethod("close",close),e.extendMethod("topHat",topHat),e.extendMethod("blackHat",blackHat),e.extendMethod("morphologicalGradient",morphologicalGradient),e.extendMethod("warpingFourPoints",warpingFourPoints),e.extendMethod("crop",crop),e.extendMethod("cropAlpha",cropAlpha),e.extendMethod("resize",resize).extendMethod("scale",resize),e.extendMethod("hsv",hsv),e.extendMethod("hsl",hsl),e.extendMethod("cmyk",cmyk),e.extendMethod("rgba8",rgba8),e.extendMethod("grey",grey).extendMethod("gray",grey),e.extendMethod("mask",mask),e.extendMethod("pad",pad),e.extendMethod("colorDepth",colorDepth),e.extendMethod("setBorder",setBorder,t),e.extendMethod("rotate",rotate),e.extendMethod("rotateLeft",rotateLeft),e.extendMethod("rotateRight",rotateRight),e.extendMethod("insert",insert),e.extendMethod("getRow",getRow),e.extendMethod("getColumn",getColumn),e.extendMethod("getMatrix",getMatrix),e.extendMethod("setMatrix",setMatrix),e.extendMethod("getPixelsArray",getPixelsArray),e.extendMethod("getIntersection",getIntersection),e.extendMethod("getClosestCommonParent",getClosestCommonParent),e.extendMethod("getThreshold",getThreshold$1),e.extendMethod("split",split),e.extendMethod("getChannel",getChannel),e.extendMethod("combineChannels",combineChannels),e.extendMethod("setChannel",setChannel),e.extendMethod("getSimilarity",getSimilarity),e.extendMethod("getPixelsGrid",getPixelsGrid),e.extendMethod("getBestMatch",match),e.extendMethod("cannyEdge",cannyEdge),e.extendMethod("convolution",convolution),e.extendMethod("extract",extract),e.extendMethod("floodFill",floodFill),e.extendMethod("paintLabels",paintLabels,t),e.extendMethod("paintMasks",paintMasks,t),e.extendMethod("paintPoints",paintPoints,t),e.extendMethod("paintPolyline",paintPolyline,t),e.extendMethod("paintPolylines",paintPolylines,t),e.extendMethod("paintPolygon",paintPolygon,t),e.extendMethod("paintPolygons",paintPolygons,t),e.extendMethod("countAlphaPixels",countAlphaPixels),e.extendMethod("monotoneChainConvexHull",monotoneChainConvexHull$1),e.extendMethod("minimalBoundingRectangle",minimalBoundingRectangle),e.extendMethod("getHistogram",getHistogram).extendProperty("histogram",getHistogram),e.extendMethod("getHistograms",getHistograms).extendProperty("histograms",getHistograms),e.extendMethod("getColorHistogram",getColorHistogram).extendProperty("colorHistogram",getColorHistogram),e.extendMethod("getMin",min$2).extendProperty("min",min$2),e.extendMethod("getMax",max$2).extendProperty("max",max$2),e.extendMethod("getSum",sum).extendProperty("sum",sum),e.extendMethod("getMoment",getMoment).extendProperty("moment",getMoment),e.extendMethod("getLocalMaxima",localMaxima),e.extendMethod("getMedian",median$3).extendProperty("median",median$3),e.extendMethod("getMean",mean$2).extendProperty("mean",mean$2),e.extendMethod("getPoints",points).extendProperty("points",points),e.extendMethod("getRelativePosition",getRelativePosition)}function commonBorderLength(e){for(var t=e.data,a=[1,0,-1,0],n=[0,1,0,-1],o=e.minMax,s=-o.min,l=o.max+s,r=[],d=0;d<=l;d++)r.push(Object.create(null));for(var h=0;h<e.width;h++)for(var g=0;g<e.height;g++){var c=h+g*e.width,m=t[c];if(0!==m){for(var p=Object.create(null),u=!1,f=0;4>f;f++){var b=h+a[f],_=g+n[f];if(0<=b&&0<=_&&b<e.width&&_<e.height){var w=t[b+_*e.width];m!==w&&(u=!0,0!==w&&p[w]===void 0&&(p[w]=!0,r[w+s][m]?r[w+s][m]++:r[w+s][m]=1))}else u=!0}u&&(r[m+s][m]?r[m+s][m]++:r[m+s][m]=1)}}for(var k={},v=0;v<r.length;v++)0<Object.keys(r[v]).length&&(k[v-s]=r[v]);return k}function mergeRoi(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.algorithm,a=void 0===t?"commonBorderLength":t,n=e.minCommonBorderLength,o=void 0===n?5:n,s=e.maxCommonBorderLength,l=void 0===s?100:s,r=e.minCommonBorderRatio,d=void 0===r?.3:r,h=e.maxCommonBorderRatio,g=void 0===h?1:h,c=function(e,t,a){return e[a]>=o&&e[a]<=l};"function"==typeof a&&(c=a),"commonborderratio"===a.toLowerCase()&&(c=function(e,t,a){var i=_Mathmin(e[a]/e[t],1);return i>=d&&i<=g});var m=this,p=m.commonBorderLength,u={},f={};for(var b of Object.keys(p)){var _=p[b],w=Object.keys(_);for(var x of w)if(x!==b&&c(_,b,x)){var y=x;f[x]&&(y=f[x]);var k=b;if(f[b]&&(k=f[b]),+y!==k){var v=_Mathmin(y,k),D=_Mathmax(y,k);if(u[v]||(u[v]={}),u[v][D]=!0,f[D]=v,u[D]){for(var S of Object.keys(u[D]))u[v][S]=!0,f[S]=v;delete u[D]}}}}var I=m.minMax,P=-I.min,M=I.max+P,B=Array(M+1).fill(0);for(var C of Object.keys(f))B[+C+P]=f[C];for(var j=m.data,R=0,A;R<j.length;R++)if(A=j[R],0!==A){var z=B[A+P];0!==z&&(j[R]=z)}return m.computed={},m}function fromMask(e){function t(t,a){var i=0,o=0,g=e.getBitXY(t,a),c=g?++l:--r;if(32767<l||-32768>r)throw new Error("Too many regions of interest");for(d[0]=t,h[0]=a;i<=o;){var m=d[65535&i],p=h[65535&i];if(s[p*e.width+m]=c,0<m&&0===s[p*e.width+m-1]&&e.getBitXY(m-1,p)===g&&(o++,d[65535&o]=m-1,h[65535&o]=p,s[p*e.width+m-1]=-32768),0<p&&0===s[(p-1)*e.width+m]&&e.getBitXY(m,p-1)===g&&(o++,d[65535&o]=m,h[65535&o]=p-1,s[(p-1)*e.width+m]=-32768),m<e.width-1&&0===s[p*e.width+m+1]&&e.getBitXY(m+1,p)===g&&(o++,d[65535&o]=m+1,h[65535&o]=p,s[p*e.width+m+1]=-32768),p<e.height-1&&0===s[(p+1)*e.width+m]&&e.getBitXY(m,p+1)===g&&(o++,d[65535&o]=m,h[65535&o]=p+1,s[(p+1)*e.width+m]=-32768),n&&(0<m&&0<p&&0===s[(p-1)*e.width+m-1]&&e.getBitXY(m-1,p-1)===g&&(o++,d[65535&o]=m-1,h[65535&o]=p-1,s[(p-1)*e.width+m-1]=-32768),m<e.width-1&&0<p&&0===s[(p-1)*e.width+m+1]&&e.getBitXY(m+1,p-1)===g&&(o++,d[65535&o]=m+1,h[65535&o]=p-1,s[(p-1)*e.width+m+1]=-32768),0<m&&p<e.height-1&&0===s[(p+1)*e.width+m-1]&&e.getBitXY(m-1,p+1)===g&&(o++,d[65535&o]=m-1,h[65535&o]=p+1,s[(p+1)*e.width+m-1]=-32768),m<e.width-1&&p<e.height-1&&0===s[(p+1)*e.width+m+1]&&e.getBitXY(m+1,p+1)===g&&(o++,d[65535&o]=m+1,h[65535&o]=p+1,s[(p+1)*e.width+m+1]=-32768)),i++,65535<o-i)throw new Error("analyseMask can not finish, the array to manage internal data is not big enough.You could improve mask by changing MAX_ARRAY")}}for(var a=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},i=a.allowCorners,n=void 0!==i&&i,o=65535,s=new Int16Array(e.size),l=0,r=0,d=new Uint16Array(o+1),h=new Uint16Array(o+1),g=0;g<e.width;g++)for(var c=0;c<e.height;c++)0===s[c*e.width+g]&&t(g,c);return new RoiMap(e,s)}function DisjointSetNode(e){this.value=e,this.parent=null,this.rank=0}function fromMaskConnectedComponentLabelingAlgorithm(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.allowCorners,n=4;void 0!==a&&a&&(n=8);var o,s,l;if(8===n)o=direction8X,s=direction8Y,l=neighbours8;else if(4===n)o=direction4X,s=direction4Y,l=neighbours4;else throw new RangeError("unsupported neighbours count: ".concat(n));for(var r=e.size,d=e.width,h=e.height,g=Array(r),c=new Uint32Array(r),m=new DisjointSet_1,p=1,u=0;u<h;u++)for(var f=0,b;f<d;f++)if(b=f+u*d,e.getBit(b)){for(var _=null,w=0;w<l.length;w++){var x=f+o[w],y=u+s[w];if(0<=x&&0<=y&&x<d&&y<h){var v=g[x+y*d];v?(l[w]=v,(!_||l[w].value<_.value)&&(_=l[w])):l[w]=null}}if(!_)g[b]=m.add(p++);else{g[b]=_;for(var D=0;D<l.length;D++)l[D]&&l[D]!==_&&m.union(_,l[D])}}for(var S=0;S<h;S++)for(var I=0,P;I<d;I++)P=I+S*d,e.getBit(P)&&(c[P]=m.find(g[P]).value);return new RoiMap(e,c)}function fromMaxima(){function e(e){for(var a=e.maxima,i=!(void 0!==a)||a,n=1;n<d.height-1;n++)for(var s=1,l;s<d.width-1;s++)if(l=s+n*d.width,0===m[l]){var r=i?d.data[l]:-d.data[s+n*d.width];if(d.data[n*d.width+s-1]>r)continue;if(d.data[n*d.width+s+1]>r)continue;if(d.data[(n-1)*d.width+s]>r)continue;if(d.data[(n+1)*d.width+s]>r)continue;if(o){if(d.data[(n-1)*d.width+s-1]>r)continue;if(d.data[(n-1)*d.width+s+1]>r)continue;if(d.data[(n+1)*d.width+s-1]>r)continue;if(d.data[(n+1)*d.width+s+1]>r)continue}c[l]=i?++h:--g;var p=t(s,n,1);p||(i?--h:++g)}}function t(e,t){var n=w;D=0,S=1,k[0]=e,v[0]=t;for(var o=!0;D<S;){var s=k[D&1048575],l=v[D&1048575];o&=a(s,l,1),D++}if(!o){for(var r=0;r<S;r++){var h=k[r&1048575],g=v[r&1048575],m=g*d.width+h;c[m]=0}w=n}return o}function a(e,t,a){for(var i=c[t*d.width+e],n=d.data[t*d.width+e],o=t-1;o<=t+1;o++)for(var s=e-1,r;s<=e+1;s++)if(r=o*d.width+s,0===m[r])switch(m[r]=1,p[r]=d.data[r]-n,a){case 1:if(0===p[r]){if(0==s||0==o||s==d.width-1||o==d.height-1)return!1;c[r]=i,k[1048575&S]=s,v[1048575&S]=o,S++}else{if(0<p[r])return!1;l||(c[r]=i,f[1048575&w]=s,b[1048575&w]=o,w++)}break;case 2:0>=p[r]&&(c[r]=i,f[1048575&w]=s,b[1048575&w]=o,w++);break;default:throw new Error("unreachable");}return!0}var i=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},n=i.allowCorner,o=!(void 0!==n)||n,s=i.onlyTop,l=void 0!==s&&s,r=i.invert,d=this;d.checkProcessable("fromMaxima",{components:[1]});var h=0,g=0,c=new Int16Array(d.size),m=new Int8Array(d.size),p=new Float32Array(d.size),u=1048575,f=new Uint16Array(u+1),b=new Uint16Array(u+1),_=0,w=0,k=new Uint16Array(u+1),v=new Uint16Array(u+1),D=0,S=0;for(e(d,{maxima:!(void 0!==r&&r)});_<w;){var I=f[_&u],P=b[_&u];a(I,P,2),_++}return new RoiMap(d,c)}function fromWaterShed(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.points,a=e.mask,n=e.image,o=e.fillMaxValue,s=void 0===o?this.maxValue:o,l=e.invert,r=void 0!==l&&l,d=n||this;d.checkProcessable("fromWaterShed",{bitDepth:[8,16],components:1}),r=!r,t||(t=d.getLocalMaxima({invert:r,mask:a}));for(var h=r?0:1,g=new Int16Array(d.size),c=d.width,m=d.height,p=new priorityQueue({comparator:(e,t)=>e[2]-t[2],strategy:priorityQueue.BinaryHeapStrategy}),u=0,f;u<t.length;u++){f=t[u][0]+t[u][1]*c,g[f]=u+1;var b=d.data[f];(r&&b<=s||!r&&b>=s)&&p.queue([t[u][0],t[u][1],b])}for(;0<p.length;)for(var _=p.dequeue(),w=_[0]+_[1]*c,x=0;4>x;x++){var y=_[0]+dxs[x],k=_[1]+dys[x];if(0<=y&&0<=k&&y<c&&k<m){var v=y+k*c;if(!a||a.getBit(v)===h){var D=d.data[v];(r&&D<=s||!r&&D>=s)&&0===g[v]&&(g[v]=g[w],p.queue([_[0]+dxs[x],_[1]+dys[x],D]))}}}return new RoiMap(d,g)}function fromPoints(e){for(var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=new Shape(t),n=new Int16Array(this.size),o=0,s=a.getPoints(),l=0;l<e.length;l++){o++;for(var r=e[l][0],d=e[l][1],h=0;h<s.length;h++){var g=s[h][0],c=s[h][1];0<=r+g&&0<=d+c&&r+g<this.width&&d+c<this.height&&(n[r+g+(d+c)*this.width]=o)}}return new RoiMap(this,n)}function twoProduct(e,t,a){var i=e*t,n=134217729*e,o=n-(n-e),s=e-o,l=134217729*t,r=l-(l-t),d=t-r,h=s*d-(i-o*r-s*r-o*d);return a?(a[0]=h,a[1]=i,a):[h,i]}function scalarScalar(e,t){var a=e+t,i=a-e,n=e-(a-i)+(t-i);return n?[n,a]:[a]}function linearExpansionSum(t,e){var i=0|t.length,n=0|e.length;if(1==i&&1===n)return scalarScalar(t[0],e[0]);var o=Array(i+n),s=0,l=0,r=0,d=_Mathabs,h=t[l],g=d(h),c=e[r],m=d(c),p,u;g<m?(u=h,l+=1,l<i&&(h=t[l],g=d(h))):(u=c,r+=1,r<n&&(c=e[r],m=d(c))),l<i&&g<m||r>=n?(p=h,l+=1,l<i&&(h=t[l],g=d(h))):(p=c,r+=1,r<n&&(c=e[r],m=d(c)));for(var f=p+u,_=f-p,w=u-_,k=w,v=f,D,S,I,P,M;l<i&&r<n;)g<m?(p=h,l+=1,l<i&&(h=t[l],g=d(h))):(p=c,r+=1,r<n&&(c=e[r],m=d(c))),u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D;for(;l<i;)p=h,u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D,l+=1,l<i&&(h=t[l]);for(;r<n;)p=c,u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D,r+=1,r<n&&(c=e[r]);return k&&(o[s++]=k),v&&(o[s++]=v),s||(o[s++]=0),o.length=s,o}function fastTwoSum(e,t,a){var i=e+t,n=i-e,o=t-n,s=e-(i-n);return a?(a[0]=s+o,a[1]=i,a):[s+o,i]}function scaleLinearExpansion(o,e){var s=o.length;if(1===s){var n=twoProduct_1(o[0],e);return n[0]?n:[n[1]]}var l=Array(2*s),r=[.1,.1],d=[.1,.1],t=0;twoProduct_1(o[0],e,r),r[0]&&(l[t++]=r[0]);for(var h=1;h<s;++h){twoProduct_1(o[h],e,d);var g=r[1];twoSum(g,d[0],r),r[0]&&(l[t++]=r[0]);var c=d[1],a=r[1],m=c+a,p=a-(m-c);r[1]=m,p&&(l[t++]=p)}return r[1]&&(l[t++]=r[1]),0===t&&(l[t++]=0),l.length=t,l}function scalarScalar$1(e,t){var a=e+t,i=a-e,n=e-(a-i)+(t-i);return n?[n,a]:[a]}function robustSubtract(t,e){var i=0|t.length,n=0|e.length;if(1==i&&1===n)return scalarScalar$1(t[0],-e[0]);var o=Array(i+n),s=0,l=0,r=0,d=_Mathabs,h=t[l],g=d(h),c=-e[r],m=d(c),p,u;g<m?(u=h,l+=1,l<i&&(h=t[l],g=d(h))):(u=c,r+=1,r<n&&(c=-e[r],m=d(c))),l<i&&g<m||r>=n?(p=h,l+=1,l<i&&(h=t[l],g=d(h))):(p=c,r+=1,r<n&&(c=-e[r],m=d(c)));for(var f=p+u,_=f-p,w=u-_,k=w,v=f,D,S,I,P,M;l<i&&r<n;)g<m?(p=h,l+=1,l<i&&(h=t[l],g=d(h))):(p=c,r+=1,r<n&&(c=-e[r],m=d(c))),u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D;for(;l<i;)p=h,u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D,l+=1,l<i&&(h=t[l]);for(;r<n;)p=c,u=k,f=p+u,_=f-p,w=u-_,w&&(o[s++]=w),D=v+f,S=D-v,I=D-S,P=f-S,M=v-I,k=M+P,v=D,r+=1,r<n&&(c=-e[r]);return k&&(o[s++]=k),v&&(o[s++]=v),s||(o[s++]=0),o.length=s,o}function robustPointInPolygon(e,t){for(var o=t[0],l=t[1],r=e.length,n=1,d=r,h=0,g=r-1;h<d;g=h++){var m=e[h],a=e[g],u=m[1],f=a[1];if(f<u){if(f<l&&l<u){var b=orientation_1(m,a,t);if(0===b)return 0;n^=0|0<b}else if(l===u){var _=e[(h+1)%r],w=_[1];if(u<w){var b=orientation_1(m,a,t);if(0===b)return 0;n^=0|0<b}}}else if(u<f){if(u<l&&l<f){var b=orientation_1(m,a,t);if(0===b)return 0;n^=0|0>b}else if(l===u){var _=e[(h+1)%r],w=_[1];if(w<u){var b=orientation_1(m,a,t);if(0===b)return 0;n^=0|0>b}}}else if(l===u){var x=_Mathmin(m[0],a[0]),y=_Mathmax(m[0],a[0]);if(0==h){for(;0<g;){var v=(g+r-1)%r,k=e[v];if(k[1]!==l)break;var D=k[0];x=_Mathmin(x,D),y=_Mathmax(y,D),g=v}if(0===g)return x<=o&&o<=y?0:1;d=g+1}for(var S=e[(g+r-1)%r][1];h+1<d;){var k=e[h+1];if(k[1]!==l)break;var D=k[0];x=_Mathmin(x,D),y=_Mathmax(y,D),h+=1}if(x<=o&&o<=y)return 0;var I=e[(h+1)%r][1];o<x&&S<l!=I<l&&(n^=1)}}return 2*n-1}function getBorders(e){for(var t=e.map,a=t.data,i=new Set,n=new Map,o=new Set,s=[1,0,-1,0],l=[0,1,0,-1],r=e.minX;r<=e.maxX;r++)for(var d=e.minY,h;d<=e.maxY;d++)if(h=r+d*t.width,a[h]===e.id)for(var g=0;4>g;g++){var c=r+s[g],m=d+l[g];if(0<=c&&0<=m&&c<t.width&&m<t.height){var p=c+m*t.width;if(a[p]!==e.id&&!o.has(p)){o.add(p),i.add(a[p]);var u=n.get(a[p]);u?n.set(a[p],++u):n.set(a[p],1)}}}var f=Array.from(i),b=f.map(function(e){return n.get(e)});return{ids:f,lengths:b}}function getBoxIDs(e){var t=new Set,a=e.map,i=a.data;for(var n of[0,e.height-1])for(var o=0,s;o<e.width;o++){if(s=(n+e.minY)*a.width+o+e.minX,0<o-e.minX&&i[s]===e.id&&i[s-1]!==e.id){var l=i[s-1];t.add(l)}if(1<a.width-o-e.minX&&i[s]===e.id&&i[s+1]!==e.id){var r=i[s+1];t.add(r)}}for(var d of[0,e.width-1])for(var h=0,g;h<e.height;h++){if(g=(h+e.minY)*a.width+d+e.minX,0<h-e.minY&&i[g]===e.id&&i[g-a.width]!==e.id){var c=i[g-a.width];t.add(c)}if(1<a.height-h-e.minY&&i[g]===e.id&&i[g+a.width]!==e.id){var m=i[g+a.width];t.add(m)}}return Array.from(t)}function getBox(e){var t=0,a=e.map,i=a.data,n=[0];1<e.height&&(n[1]=e.height-1);for(var o of n)for(var s=1,l;s<e.width-1;s++)l=(o+e.minY)*a.width+s+e.minX,i[l]===e.id&&t++;var r=[0];1<e.width&&(r[1]=e.width-1);for(var d of r)for(var h=0,g;h<e.height;h++)g=(h+e.minY)*a.width+d+e.minX,i[g]===e.id&&t++;return t}function getBorder(e){for(var t=0,a=e.map,i=a.data,n=1;n<e.width-1;n++)for(var o=1,s;o<e.height-1;o++)s=(o+e.minY)*a.width+n+e.minX,i[s]===e.id&&(i[s-1]!==e.id||i[s+1]!==e.id||i[s-a.width]!==e.id||i[s+a.width]!==e.id)&&t++;return t+e.box}function getExternal(e){for(var t=0,a=e.map,i=a.data,n=1;n<e.width-1;n++)for(var o=1,s;o<e.height-1;o++)s=(o+e.minY)*a.width+n+e.minX,i[s]===e.id&&(e.externalIDs.includes(i[s-1])||e.externalIDs.includes(i[s+1])||e.externalIDs.includes(i[s-a.width])||e.externalIDs.includes(i[s+a.width]))&&t++;return t+e.box}function getInternalIDs(e){var t=[e.id],a=e.map,n=a.data;if(2<e.height)for(var o=0,s;o<e.width;o++)if(s=e.minY*a.width+o+e.minX,t.includes(n[s])){var l=n[s+a.width];t.includes(l)||e.boxIDs.includes(l)||t.push(l)}for(var r=[,,,,],d=1;d<e.width-1;d++)for(var h=1,g;h<e.height-1;h++)if(g=(h+e.minY)*a.width+d+e.minX,t.includes(n[g])){r[0]=n[g-1],r[1]=n[g+1],r[2]=n[g-a.width],r[3]=n[g+a.width];for(var c=0,m;4>c;c++)m=r[c],t.includes(m)||e.boxIDs.includes(m)||t.push(m)}return t}function correspondingRoisInformation(e,t,a,n,o){for(var s={id:[],surface:[],roiSurfaceCovered:[],same:0,opposite:0,total:0},l=0;l<a.length;l++){var r=a[l],d=r[0],h=r[1],g=d+e+(h+t)*n.width,c=n.data[g];(0<c||0>c)&&(s.id.includes(c)?s.surface[s.id.indexOf(c)]+=1:(s.id.push(c),s.surface.push(1)))}for(var m=0,p;m<s.id.length;m++)p=_Mathsign(s.id[m]),p===o?s.same+=s.surface[m]:s.opposite+=s.surface[m],s.roiSurfaceCovered[m]=s.surface[m]/a.length;return s.total=s.opposite+s.same,s}function laplacianOfGaussian(e,t,a){var n=Array(t),o,s,l,r;a||(a=100),a*=-1;var d=(t-1)/2,h=2*e*e;for(o=0;o<t;o++)for(n[o]=Array(t),r=(o-d)*(o-d),s=0;s<t;s++)l=(s-d)*(s-d),n[o][s]=_Mathround(a*(1-(l+r)/h)*_Mathexp(-(l+r)/h));return n}function WorkerManager(e,t){if("string"!=typeof e&&"function"!=typeof e)throw new TypeError("func argument must be a function");if(void 0===t&&(t={}),"object"!=typeof t||null===t)throw new TypeError("options argument must be an object");this._workerCode=e.toString(),this._numWorkers=void 0===t.maxWorkers||"auto"===t.maxWorkers?_Mathmin(CORES-1,1):0<t.maxWorkers?_Mathmin(t.maxWorkers,CORES):CORES,this._workers=new Map,this._timeout=t.timeout||0,this._terminateOnError=!!t.terminateOnError;var a=t.deps;"string"==typeof a&&(a=[a]),Array.isArray(a)||(a=void 0),this._id=0,this._terminated=!1,this._working=0,this._waiting=[],this._init(a)}function run(e,t,a){t=Object.assign({},defaultOptions$d,t);var i=this.manager;return Array.isArray(e)?Promise.all(e.map(function(e){var n=runOnce(i,e,t);return"function"==typeof a&&n.then(a),n})):runOnce(i,e,t)}function runOnce(e,t,a){return e.post("data",[t,a]).then(function(e){for(var t in e)e[t]=new Image(e[t]);return e})}function work(){worker.on("data",function(e,t,a){function i(e,t){a.include.includes(e)&&(n[e]=t,o.push(t.data.buffer))}t=new IJS(t);var n={},o=[],s=t.grey(),l=s.sobelFilter();i("sobel",l);var r=l.level().mask({threshold:a.threshold});i("mask",r);var d=l.getRoiManager();d.fromMask(r);var h=d.getMask(a.roi);i("realMask",h);var g=s.getPixelsGrid({sampling:a.sampling,mask:h}),c=t.getBackground(g.xyS,g.zS,a.regression);i("background",c);var m=t.subtract(c);n.result=m,o.push(m.data.buffer),e(n,o)})}function extend$2(e){e.extendMethod("background",background$1)}var bitMethods={getBit(e){return this.data[getSlot(e)]&1<<getShift(e)?1:0},setBit(e){this.data[getSlot(e)]|=1<<getShift(e)},clearBit(e){this.data[getSlot(e)]&=~(1<<getShift(e))},toggleBit(e){this.data[getSlot(e)]^=1<<getShift(e)},getBitXY(e,t){return this.getBit(t*this.width+e)},setBitXY(e,t){this.setBit(t*this.width+e)},clearBitXY(e,t){this.clearBit(t*this.width+e)},toggleBitXY(e,t){this.toggleBit(t*this.width+e)}},commonjsGlobal="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window,utf8=createCommonjsModule(function(e,t){(function(a){function i(e){for(var t=[],a=0,i=e.length,n,o;a<i;)n=e.charCodeAt(a++),55296<=n&&56319>=n&&a<i?(o=e.charCodeAt(a++),56320==(64512&o)?t.push(((1023&n)<<10)+(1023&o)+65536):(t.push(n),a--)):t.push(n);return t}function n(e){for(var t=e.length,a=-1,i="",n;++a<t;)n=e[a],65535<n&&(n-=65536,i+=p(55296|1023&n>>>10),n=56320|1023&n),i+=p(n);return i}function o(e){if(55296<=e&&57343>=e)throw Error("Lone surrogate U+"+e.toString(16).toUpperCase()+" is not a scalar value")}function s(e,t){return p(128|63&e>>t)}function l(e){if(0==(4294967168&e))return p(e);var t="";return 0==(4294965248&e)?t=p(192|31&e>>6):0==(4294901760&e)?(o(e),t=p(224|15&e>>12),t+=s(e,6)):0==(4292870144&e)&&(t=p(240|7&e>>18),t+=s(e,12),t+=s(e,6)),t+=p(128|63&e),t}function r(){if(_>=b)throw Error("Invalid byte index");var e=255&f[_];if(_++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function d(){var e,t,a,i,n;if(_>b)throw Error("Invalid byte index");if(_==b)return!1;if(e=255&f[_],_++,0==(128&e))return e;if(192==(224&e)){if(t=r(),n=(31&e)<<6|t,128<=n)return n;throw Error("Invalid continuation byte")}if(224==(240&e)){if(t=r(),a=r(),n=(15&e)<<12|t<<6|a,2048<=n)return o(n),n;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=r(),a=r(),i=r(),n=(7&e)<<18|t<<12|a<<6|i,65536<=n&&1114111>=n))return n;throw Error("Invalid UTF-8 detected")}function h(e){f=i(e),b=f.length,_=0;for(var t=[],a;!1!==(a=d());)t.push(a);return n(t)}var g=t,c=e&&e.exports==g&&e,m="object"==typeof commonjsGlobal&&commonjsGlobal;(m.global===m||m.window===m)&&(a=m);var p=_StringfromCharCode,u={version:"2.1.2",encode:function(e){for(var t=i(e),a=t.length,n=-1,o="",s;++n<a;)s=t[n],o+=l(s);return o},decode:h},f,b,_;if(!(g&&!g.nodeType))a.utf8=u;else if(c)c.exports=u;else{var w={}.hasOwnProperty;for(var x in u)w.call(u,x)&&(g[x]=u[x])}})(commonjsGlobal)});const defaultByteLength=8192,charArray=[];class IOBuffer{constructor(e,t){t=t||{};var a=!1;e===void 0&&(e=defaultByteLength),"number"==typeof e?e=new ArrayBuffer(e):(a=!0,this._lastWrittenByte=e.byteLength);const i=t.offset?t.offset>>>0:0;let n=e.byteLength-i,o=i;e.buffer&&(e.byteLength!==e.buffer.byteLength&&(o=e.byteOffset+i),e=e.buffer),this._lastWrittenByte=a?n:0,this.buffer=e,this.length=n,this.byteLength=n,this.byteOffset=o,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,o,n),this._mark=0,this._marks=[]}available(e){return void 0===e&&(e=1),this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e){return void 0===e&&(e=1),this.offset+=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const e=this._marks.pop();if(void 0===e)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e){if(void 0===e&&(e=1),!this.available(e)){const t=this.offset+e,a=2*t,i=new Uint8Array(a);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=a,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){e===void 0&&(e=1);for(var t=new Uint8Array(e),a=0;a<e;a++)t[a]=this.readByte();return t}readInt16(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return _StringfromCharCode(this.readInt8())}readChars(e){e===void 0&&(e=1),charArray.length=e;for(var t=0;t<e;t++)charArray[t]=this.readChar();return charArray.join("")}readUtf8(e){e===void 0&&(e=1);const t=this.readChars(e);return utf8.decode(t)}writeBoolean(e){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(var t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(var t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));return this}writeUtf8(e){const t=utf8.encode(e);return this.writeChars(t)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}getBuffer(){return"undefined"==typeof Buffer?this.toArray():Buffer.from(this.toArray())}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}var IOBuffer_1=IOBuffer,constants={BITMAPV5HEADER:{LogicalColorSpace:{LCS_CALIBRATED_RGB:0,LCS_sRGB:1934772034,LCS_WINDOWS_COLOR_SPACE:1466527264},Compression:{BI_RGB:0,BI_RLE8:1,BI_RLE4:2,BI_BITFIELDS:3,BI_JPEG:4,BI_PNG:5,BI_CMYK:11,BI_CMYKRLE8:12,BI_CMYKRLE4:13},GamutMappingIntent:{LCS_GM_ABS_COLORIMETRIC:8,LCS_GM_BUSINESS:1,LCS_GM_GRAPHICS:2,LCS_GM_IMAGES:4}}};const tableLeft=[];for(var i=0;8>=i;i++)tableLeft.push(255<<i);var encode=function(e){if(1!==e.bitDepth)throw new Error("Only bitDepth of 1 is supported");if(!e.height||!e.width)throw new Error("ImageData width and height are required");if(1!==e.components)throw new Error("Only 1 component is supported");if(1!==e.channels)throw new Error("Only 1 channel is supported");var t=new IOBuffer_1;t.skip(14),writeBitmapV5Header(t,e),writeColorTable(t,e);const a=t.offset;return writePixelArray(t,e),t.rewind(),writeBitmapFileHeader(t,a),t.getBuffer()},encode$1=encode,common=createCommonjsModule(function(e,t){function a(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)a(i,n)&&(e[n]=i[n])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,a,n,o){if(t.subarray&&e.subarray)return void e.set(t.subarray(a,a+n),o);for(var s=0;s<n;s++)e[o+s]=t[a+s]},flattenChunks:function(e){var t,a,n,o,s,r;for(n=0,t=0,a=e.length;t<a;t++)n+=e[t].length;for(r=new Uint8Array(n),o=0,(t=0,a=e.length);t<a;t++)s=e[t],r.set(s,o),o+=s.length;return r}},o={arraySet:function(e,t,a,n,o){for(var s=0;s<n;s++)e[o+s]=t[a+s]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,n)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,o))},t.setTyped(i)}),common_1=common.assign,common_2=common.shrinkBuf,common_3=common.setTyped,common_4=common.Buf8,common_5=common.Buf16,common_6=common.Buf32,Z_FIXED=4,Z_BINARY=0,Z_TEXT=1,Z_UNKNOWN=2,STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,MIN_MATCH=3,MAX_MATCH=258,LENGTH_CODES=29,LITERALS=256,L_CODES=LITERALS+1+LENGTH_CODES,D_CODES=30,BL_CODES=19,HEAP_SIZE=2*L_CODES+1,MAX_BITS=15,Buf_size=16,MAX_BL_BITS=7,END_BLOCK=256,REP_3_6=16,REPZ_3_10=17,REPZ_11_138=18,extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],DIST_CODE_LEN=512,static_ltree=Array(2*(L_CODES+2));zero(static_ltree);var static_dtree=Array(2*D_CODES);zero(static_dtree);var _dist_code=Array(DIST_CODE_LEN);zero(_dist_code);var _length_code=Array(MAX_MATCH-MIN_MATCH+1);zero(_length_code);var base_length=Array(LENGTH_CODES);zero(base_length);var base_dist=Array(D_CODES);zero(base_dist);var static_init_done=!1,_tr_init_1=_tr_init,_tr_stored_block_1=_tr_stored_block,_tr_flush_block_1=_tr_flush_block,_tr_tally_1=_tr_tally,_tr_align_1=_tr_align,trees={_tr_init:_tr_init_1,_tr_stored_block:_tr_stored_block_1,_tr_flush_block:_tr_flush_block_1,_tr_tally:_tr_tally_1,_tr_align:_tr_align_1},adler32_1=adler32,crcTable=makeTable(),crc32_1=crc32,messages={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Z_NO_FLUSH=0,Z_PARTIAL_FLUSH=1,Z_FULL_FLUSH=3,Z_FINISH=4,Z_BLOCK=5,Z_OK=0,Z_STREAM_END=1,Z_STREAM_ERROR=-2,Z_DATA_ERROR=-3,Z_BUF_ERROR=-5,Z_DEFAULT_COMPRESSION=-1,Z_FILTERED=1,Z_HUFFMAN_ONLY=2,Z_RLE=3,Z_FIXED$1=4,Z_DEFAULT_STRATEGY=0,Z_UNKNOWN$1=2,Z_DEFLATED=8,MAX_MEM_LEVEL=9,MAX_WBITS=15,DEF_MEM_LEVEL=8,LENGTH_CODES$1=29,LITERALS$1=256,L_CODES$1=LITERALS$1+1+LENGTH_CODES$1,D_CODES$1=30,BL_CODES$1=19,HEAP_SIZE$1=2*L_CODES$1+1,MAX_BITS$1=15,MIN_MATCH$1=3,MAX_MATCH$1=258,MIN_LOOKAHEAD=MAX_MATCH$1+MIN_MATCH$1+1,PRESET_DICT=32,INIT_STATE=42,EXTRA_STATE=69,NAME_STATE=73,COMMENT_STATE=91,HCRC_STATE=103,BUSY_STATE=113,FINISH_STATE=666,BS_NEED_MORE=1,BS_BLOCK_DONE=2,BS_FINISH_STARTED=3,BS_FINISH_DONE=4,OS_CODE=3,static_l_desc,static_d_desc,static_bl_desc,configuration_table;configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];var deflateInit_1=deflateInit,deflateInit2_1=deflateInit2,deflateReset_1=deflateReset,deflateResetKeep_1=deflateResetKeep,deflateSetHeader_1=deflateSetHeader,deflate_2=deflate,deflateEnd_1=deflateEnd,deflateSetDictionary_1=deflateSetDictionary,deflateInfo="pako deflate (from Nodeca project)",deflate_1={deflateInit:deflateInit_1,deflateInit2:deflateInit2_1,deflateReset:deflateReset_1,deflateResetKeep:deflateResetKeep_1,deflateSetHeader:deflateSetHeader_1,deflate:deflate_2,deflateEnd:deflateEnd_1,deflateSetDictionary:deflateSetDictionary_1,deflateInfo:deflateInfo},STR_APPLY_OK=!0,STR_APPLY_UIA_OK=!0;try{_StringfromCharCode.apply(null,[0])}catch(e){STR_APPLY_OK=!1}try{_StringfromCharCode.apply(null,new Uint8Array(1))}catch(e){STR_APPLY_UIA_OK=!1}for(var _utf8len=new common.Buf8(256),q=0;256>q;q++)_utf8len[q]=252<=q?6:248<=q?5:240<=q?4:224<=q?3:192<=q?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=function(e){var t=e.length,a=0,n,o,s,l,r;for(l=0;l<t;l++)o=e.charCodeAt(l),55296==(64512&o)&&l+1<t&&(s=e.charCodeAt(l+1),56320==(64512&s)&&(o=65536+(o-55296<<10)+(s-56320),l++)),a+=128>o?1:2048>o?2:65536>o?3:4;for(n=new common.Buf8(a),r=0,l=0;r<a;l++)o=e.charCodeAt(l),55296==(64512&o)&&l+1<t&&(s=e.charCodeAt(l+1),56320==(64512&s)&&(o=65536+(o-55296<<10)+(s-56320),l++)),128>o?n[r++]=o:2048>o?(n[r++]=192|o>>>6,n[r++]=128|63&o):65536>o?(n[r++]=224|o>>>12,n[r++]=128|63&o>>>6,n[r++]=128|63&o):(n[r++]=240|o>>>18,n[r++]=128|63&o>>>12,n[r++]=128|63&o>>>6,n[r++]=128|63&o);return n},buf2binstring_1=function(e){return buf2binstring(e,e.length)},binstring2buf=function(e){for(var t=new common.Buf8(e.length),a=0,n=t.length;a<n;a++)t[a]=e.charCodeAt(a);return t},buf2string=function(e,t){var a=t||e.length,n=Array(2*a),o,s,l,r;for(s=0,o=0;o<a;){if(l=e[o++],128>l){n[s++]=l;continue}if(r=_utf8len[l],4<r){n[s++]=65533,o+=r-1;continue}for(l&=2===r?31:3===r?15:7;1<r&&o<a;)l=l<<6|63&e[o++],r--;if(1<r){n[s++]=65533;continue}65536>l?n[s++]=l:(l-=65536,n[s++]=55296|1023&l>>10,n[s++]=56320|1023&l)}return buf2binstring(n,s)},utf8border=function(e,t){var a;for(t=t||e.length,t>e.length&&(t=e.length),a=t-1;0<=a&&128==(192&e[a]);)a--;return 0>a?t:0===a?t:a+_utf8len[e[a]]>t?a:t},strings={string2buf:string2buf,buf2binstring:buf2binstring_1,binstring2buf:binstring2buf,buf2string:buf2string,utf8border:utf8border},zstream=ZStream,toString=Object.prototype.toString,Z_NO_FLUSH$1=0,Z_FINISH$1=4,Z_OK$1=0,Z_STREAM_END$1=1,Z_SYNC_FLUSH=2,Z_DEFAULT_COMPRESSION$1=-1,Z_DEFAULT_STRATEGY$1=0,Z_DEFLATED$1=8;Deflate.prototype.push=function(e,t){var a=this.strm,i=this.options.chunkSize,n,o;if(this.ended)return!1;o=t===~~t?t:!0===t?Z_FINISH$1:Z_NO_FLUSH$1,a.input="string"==typeof e?strings.string2buf(e):"[object ArrayBuffer]"===toString.call(e)?new Uint8Array(e):e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new common.Buf8(i),a.next_out=0,a.avail_out=i),n=deflate_1.deflate(a,o),n!==Z_STREAM_END$1&&n!==Z_OK$1)return this.onEnd(n),this.ended=!0,!1;(0===a.avail_out||0===a.avail_in&&(o===Z_FINISH$1||o===Z_SYNC_FLUSH))&&("string"===this.options.to?this.onData(strings.buf2binstring(common.shrinkBuf(a.output,a.next_out))):this.onData(common.shrinkBuf(a.output,a.next_out)))}while((0<a.avail_in||0===a.avail_out)&&n!==Z_STREAM_END$1);return o===Z_FINISH$1?(n=deflate_1.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Z_OK$1):o!==Z_SYNC_FLUSH||(this.onEnd(Z_OK$1),a.avail_out=0,!0)},Deflate.prototype.onData=function(e){this.chunks.push(e)},Deflate.prototype.onEnd=function(e){e===Z_OK$1&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Deflate_1=Deflate,deflate_2$1=deflate$1,deflateRaw_1=deflateRaw,gzip_1=gzip,deflate_1$1={Deflate:Deflate_1,deflate:deflate_2$1,deflateRaw:deflateRaw_1,gzip:gzip_1},BAD=30,TYPE=12,inffast=function(e,t){var a,i,n,o,s,l,r,d,h,g,c,m,p,u,f,b,_,w,x,y,k,v,D,S,I;a=e.state,i=e.next_in,S=e.input,n=i+(e.avail_in-5),o=e.next_out,I=e.output,s=o-(t-e.avail_out),l=o+(e.avail_out-257),r=a.dmax,d=a.wsize,h=a.whave,g=a.wnext,c=a.window,m=a.hold,p=a.bits,u=a.lencode,f=a.distcode,b=(1<<a.lenbits)-1,_=(1<<a.distbits)-1;top:do{15>p&&(m+=S[i++]<<p,p+=8,m+=S[i++]<<p,p+=8),w=u[m&b];dolen:for(;;){if(x=w>>>24,m>>>=x,p-=x,x=255&w>>>16,0===x)I[o++]=65535&w;else if(16&x){y=65535&w,x&=15,x&&(p<x&&(m+=S[i++]<<p,p+=8),y+=m&(1<<x)-1,m>>>=x,p-=x),15>p&&(m+=S[i++]<<p,p+=8,m+=S[i++]<<p,p+=8),w=f[m&_];dodist:for(;;){if(x=w>>>24,m>>>=x,p-=x,x=255&w>>>16,16&x){if(k=65535&w,x&=15,p<x&&(m+=S[i++]<<p,p+=8,p<x&&(m+=S[i++]<<p,p+=8)),k+=m&(1<<x)-1,k>r){e.msg="invalid distance too far back",a.mode=BAD;break top}if(m>>>=x,p-=x,x=o-s,k>x){if(x=k-x,x>h&&a.sane){e.msg="invalid distance too far back",a.mode=BAD;break top}if(v=0,D=c,0===g){if(v+=d-x,x<y){y-=x;do I[o++]=c[v++];while(--x);v=o-k,D=I}}else if(g<x){if(v+=d+g-x,x-=g,x<y){y-=x;do I[o++]=c[v++];while(--x);if(v=0,g<y){x=g,y-=x;do I[o++]=c[v++];while(--x);v=o-k,D=I}}}else if(v+=g-x,x<y){y-=x;do I[o++]=c[v++];while(--x);v=o-k,D=I}for(;2<y;)I[o++]=D[v++],I[o++]=D[v++],I[o++]=D[v++],y-=3;y&&(I[o++]=D[v++],1<y&&(I[o++]=D[v++]))}else{v=o-k;do I[o++]=I[v++],I[o++]=I[v++],I[o++]=I[v++],y-=3;while(2<y);y&&(I[o++]=I[v++],1<y&&(I[o++]=I[v++]))}}else if(0==(64&x)){w=f[(65535&w)+(m&(1<<x)-1)];continue dodist}else{e.msg="invalid distance code",a.mode=BAD;break top}break}}else if(0==(64&x)){w=u[(65535&w)+(m&(1<<x)-1)];continue dolen}else if(32&x){a.mode=TYPE;break top}else{e.msg="invalid literal/length code",a.mode=BAD;break top}break}}while(i<n&&o<l);return y=p>>3,i-=y,p-=y<<3,m&=(1<<p)-1,e.next_in=i,e.next_out=o,e.avail_in=i<n?5+(n-i):5-(i-n),e.avail_out=o<l?257+(l-o):257-(o-l),a.hold=m,void(a.bits=p)},MAXBITS=15,ENOUGH_LENS=852,ENOUGH_DISTS=592,CODES=0,LENS=1,DISTS=2,lbase=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],lext=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],dbase=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],dext=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],inftrees=function(e,t,a,i,n,o,s,l){var r=l.bits,d=0,h=0,g=0,c=0,m=0,p=0,u=0,f=0,b=0,_=0,w=null,x=0,y=new common.Buf16(MAXBITS+1),k=new common.Buf16(MAXBITS+1),v=null,D=0,S,I,P,M,B,C,j,R,A;for(d=0;d<=MAXBITS;d++)y[d]=0;for(h=0;h<i;h++)y[t[a+h]]++;for(m=r,c=MAXBITS;1<=c&&0===y[c];c--);if(m>c&&(m=c),0===c)return n[o++]=20971520,n[o++]=20971520,l.bits=1,0;for(g=1;g<c&&0===y[g];g++);for(m<g&&(m=g),f=1,d=1;d<=MAXBITS;d++)if(f<<=1,f-=y[d],0>f)return-1;if(0<f&&(e===CODES||1!==c))return-1;for(k[1]=0,d=1;d<MAXBITS;d++)k[d+1]=k[d]+y[d];for(h=0;h<i;h++)0!==t[a+h]&&(s[k[t[a+h]]++]=h);if(e===CODES?(w=v=s,C=19):e===LENS?(w=lbase,x-=257,v=lext,D-=257,C=256):(w=dbase,v=dext,C=-1),_=0,h=0,d=g,B=o,p=m,u=0,P=-1,b=1<<m,M=b-1,e===LENS&&b>ENOUGH_LENS||e===DISTS&&b>ENOUGH_DISTS)return 1;for(;;){j=d-u,s[h]<C?(R=0,A=s[h]):s[h]>C?(R=v[D+s[h]],A=w[x+s[h]]):(R=96,A=0),S=1<<d-u,I=1<<p,g=I;do I-=S,n[B+(_>>u)+I]=0|(j<<24|R<<16|A);while(0!==I);for(S=1<<d-1;_&S;)S>>=1;if(0===S?_=0:(_&=S-1,_+=S),h++,0==--y[d]){if(d===c)break;d=t[a+s[h]]}if(d>m&&(_&M)!==P){for(0===u&&(u=m),B+=g,p=d-u,f=1<<p;p+u<c&&(f-=y[p+u],!(0>=f));)p++,f<<=1;if(b+=1<<p,e===LENS&&b>ENOUGH_LENS||e===DISTS&&b>ENOUGH_DISTS)return 1;P=_&M,n[P]=0|(m<<24|p<<16|B-o)}}return 0!==_&&(n[B+_]=0|(4194304|d-u<<24)),l.bits=m,0},CODES$1=0,LENS$1=1,DISTS$1=2,Z_FINISH$2=4,Z_BLOCK$1=5,Z_TREES=6,Z_OK$2=0,Z_STREAM_END$2=1,Z_NEED_DICT=2,Z_STREAM_ERROR$1=-2,Z_DATA_ERROR$1=-3,Z_MEM_ERROR=-4,Z_BUF_ERROR$1=-5,Z_DEFLATED$2=8,HEAD=1,FLAGS=2,TIME=3,OS=4,EXLEN=5,EXTRA=6,NAME=7,COMMENT=8,HCRC=9,DICTID=10,DICT=11,TYPE$1=12,TYPEDO=13,STORED=14,COPY_=15,COPY=16,TABLE=17,LENLENS=18,CODELENS=19,LEN_=20,LEN=21,LENEXT=22,DIST=23,DISTEXT=24,MATCH=25,LIT=26,CHECK=27,LENGTH=28,DONE=29,BAD$1=30,MEM=31,SYNC=32,ENOUGH_LENS$1=852,ENOUGH_DISTS$1=592,MAX_WBITS$1=15,DEF_WBITS=MAX_WBITS$1,virgin=!0,inflateReset_1=inflateReset,inflateReset2_1=inflateReset2,inflateResetKeep_1=inflateResetKeep,inflateInit_1=inflateInit,inflateInit2_1=inflateInit2,inflate_2=inflate,inflateEnd_1=inflateEnd,inflateGetHeader_1=inflateGetHeader,inflateSetDictionary_1=inflateSetDictionary,inflateInfo="pako inflate (from Nodeca project)",inflate_1={inflateReset:inflateReset_1,inflateReset2:inflateReset2_1,inflateResetKeep:inflateResetKeep_1,inflateInit:inflateInit_1,inflateInit2:inflateInit2_1,inflate:inflate_2,inflateEnd:inflateEnd_1,inflateGetHeader:inflateGetHeader_1,inflateSetDictionary:inflateSetDictionary_1,inflateInfo:inflateInfo},constants$1={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},gzheader=GZheader,toString$1=Object.prototype.toString,lenfix,distfix;Inflate.prototype.push=function(e,t){var a=this.strm,i=this.options.chunkSize,n=this.options.dictionary,o=!1,s,l,r,d,h,g;if(this.ended)return!1;l=t===~~t?t:!0===t?constants$1.Z_FINISH:constants$1.Z_NO_FLUSH,a.input="string"==typeof e?strings.binstring2buf(e):"[object ArrayBuffer]"===toString$1.call(e)?new Uint8Array(e):e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new common.Buf8(i),a.next_out=0,a.avail_out=i),s=inflate_1.inflate(a,constants$1.Z_NO_FLUSH),s===constants$1.Z_NEED_DICT&&n&&(g="string"==typeof n?strings.string2buf(n):"[object ArrayBuffer]"===toString$1.call(n)?new Uint8Array(n):n,s=inflate_1.inflateSetDictionary(this.strm,g)),s===constants$1.Z_BUF_ERROR&&!0===o&&(s=constants$1.Z_OK,o=!1),s!==constants$1.Z_STREAM_END&&s!==constants$1.Z_OK)return this.onEnd(s),this.ended=!0,!1;a.next_out&&(0===a.avail_out||s===constants$1.Z_STREAM_END||0===a.avail_in&&(l===constants$1.Z_FINISH||l===constants$1.Z_SYNC_FLUSH))&&("string"===this.options.to?(r=strings.utf8border(a.output,a.next_out),d=a.next_out-r,h=strings.buf2string(a.output,r),a.next_out=d,a.avail_out=i-d,d&&common.arraySet(a.output,a.output,r,d,0),this.onData(h)):this.onData(common.shrinkBuf(a.output,a.next_out))),0===a.avail_in&&0===a.avail_out&&(o=!0)}while((0<a.avail_in||0===a.avail_out)&&s!==constants$1.Z_STREAM_END);return s===constants$1.Z_STREAM_END&&(l=constants$1.Z_FINISH),l===constants$1.Z_FINISH?(s=inflate_1.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===constants$1.Z_OK):l!==constants$1.Z_SYNC_FLUSH||(this.onEnd(constants$1.Z_OK),a.avail_out=0,!0)},Inflate.prototype.onData=function(e){this.chunks.push(e)},Inflate.prototype.onEnd=function(e){e===constants$1.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=common.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Inflate_1=Inflate,inflate_2$1=inflate$1,inflateRaw_1=inflateRaw,ungzip=inflate$1,inflate_1$1={Inflate:Inflate_1,inflate:inflate_2$1,inflateRaw:inflateRaw_1,ungzip:ungzip},assign=common.assign,pako={};assign(pako,deflate_1$1,inflate_1$1,constants$1);var pako_1=pako,pako_2=pako_1.Inflate,pako_3=pako_1.deflate;const pngSignature=[137,80,78,71,13,10,26,10],crcTable$1=[];for(let e=0;256>e;e++){var c=e;for(let e=0;8>e;e++)1&c?c=3988292384^c>>>1:c>>>=1;crcTable$1[e]=c}const initialCrc=4294967295,empty=new Uint8Array(0),NULL="\0",uint16=new Uint16Array([255]),uint8=new Uint8Array(uint16.buffer),osIsLittleEndian=255===uint8[0];class PNGDecoder extends IOBuffer_1{constructor(e,t){super(e);const{checkCrc:a=!1}=t;this._checkCrc=a,this._inflator=new pako_2,this._png=null,this._end=!1,this.setBigEndian()}decode(){for(this._png={text:{}},this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(var e=0;e<pngSignature.length;e++)if(this.readUint8()!==pngSignature[e])throw new Error(`wrong PNG signature. Byte at ${e} should be ${pngSignature[e]}.`)}decodeChunk(){const e=this.readUint32(),t=this.readChars(4),a=this.offset;switch(t){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(e);break;case"IDAT":this.decodeIDAT(e);break;case"IEND":this._end=!0;break;case"tEXt":this.decodetEXt(e);break;case"pHYs":this.decodepHYs();break;default:this.skip(e);}if(this.offset-a!==e)throw new Error(`Length mismatch while decoding chunk ${t}`);if(this._checkCrc){const a=this.readUint32(),i=e+4,n=crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-i-4,i),i);if(n!==a)throw new Error(`CRC mismatch for chunk ${t}. Expected ${a}, found ${n}`)}else this.skip(4)}decodeIHDR(){var e=this._png;if(e.width=this.readUint32(),e.height=this.readUint32(),e.bitDepth=this.readUint8(),e.colourType=this.readUint8(),e.compressionMethod=this.readUint8(),e.filterMethod=this.readUint8(),e.interlaceMethod=this.readUint8(),0!==this._png.compressionMethod)throw new Error("Unsupported compression method: "+e.compressionMethod)}decodePLTE(e){if(0!=e%3)throw new RangeError("PLTE field length must be a multiple of 3. Got "+e);var t=e/3;this._hasPalette=!0;for(var a=this._palette=Array(t),n=0;n<t;n++)a[n]=[this.readUint8(),this.readUint8(),this.readUint8()]}decodeIDAT(e){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,e),!1),this.skip(e)}decodetEXt(e){for(var t="",a;(a=this.readChar())!==NULL;)t+=a;this._png.text[t]=this.readChars(e-t.length-1)}decodepHYs(){const e=this.readUint32(),t=this.readUint32(),a=this.readByte();this._png.resolution=[e,t],this._png.unitSpecifier=a}decodeImage(){if(this._inflator.push(empty,!0),this._inflator.err)throw new Error("Error while decompressing the data: "+this._inflator.err);var e=this._inflator.result;if(this._inflator=null,0!==this._png.filterMethod)throw new Error("Filter method "+this._png.filterMethod+" not supported");if(0===this._png.interlaceMethod)this.decodeInterlaceNull(e);else throw new Error("Interlace method "+this._png.interlaceMethod+" not supported")}decodeInterlaceNull(e){var t;switch(this._png.colourType){case 0:t=1;break;case 2:t=3;break;case 3:if(!this._hasPalette)throw new Error("Missing palette");t=1;break;case 4:t=2;break;case 6:t=4;break;default:throw new Error("Unknown colour type: "+this._png.colourType);}const a=this._png.height,n=t*this._png.bitDepth/8,o=this._png.width*n,s=new Uint8Array(this._png.height*o);for(var l=empty,r=0,d=0,h,g;d<a;d++){switch(h=e.subarray(r+1,r+1+o),g=s.subarray(d*o,(d+1)*o),e[r]){case 0:unfilterNone(h,g,o);break;case 1:unfilterSub(h,g,o,n);break;case 2:unfilterUp(h,g,l,o);break;case 3:unfilterAverage(h,g,l,o,n);break;case 4:unfilterPaeth(h,g,l,o,n);break;default:throw new Error("Unsupported filter: "+e[r]);}l=g,r+=o+1}if(this._hasPalette&&(this._png.palette=this._palette),16===this._png.bitDepth){const e=new Uint16Array(s.buffer);if(osIsLittleEndian)for(var c=0;c<e.length;c++)e[c]=swap16(e[c]);this._png.data=e}else this._png.data=s}}const defaultZlibOptions={level:3};class PNGEncoder extends IOBuffer_1{constructor(e,t){super(),this._checkData(e),this._zlibOptions=Object.assign({},defaultZlibOptions,t.zlib),this.setBigEndian()}encode(){return this.encodeSignature(),this.encodeIHDR(),this.encodeData(),this.encodeIEND(),this.toArray()}encodeSignature(){this.writeBytes(pngSignature)}encodeIHDR(){this.writeUint32(13),this.writeChars("IHDR"),this.writeUint32(this._png.width),this.writeUint32(this._png.height),this.writeByte(this._png.bitDepth),this.writeByte(this._png.colourType),this.writeByte(0),this.writeByte(0),this.writeByte(0),this.writeCrc(17)}encodeIEND(){this.writeUint32(0),this.writeChars("IEND"),this.writeCrc(4)}encodeIDAT(e){this.writeUint32(e.length),this.writeChars("IDAT"),this.writeBytes(e),this.writeCrc(e.length+4)}encodeData(){const{width:e,height:t,channels:a,bitDepth:n,data:o}=this._png,s=a*e,l=new IOBuffer_1().setBigEndian();for(var r=0,d=0;d<t;d++)if(l.writeByte(0),8===n)r=writeDataBytes(o,l,s,r);else if(16===n)r=writeDataUint16(o,l,s,r);else throw new Error("unreachable");const h=l.getBuffer(),g=pako_3(h,this._zlibOptions);this.encodeIDAT(g)}_checkData(e){this._png={width:checkInteger(e.width,"width"),height:checkInteger(e.height,"height"),data:e.data};const{colourType:t,channels:a,bitDepth:i}=getColourType(e);this._png.colourType=t,this._png.channels=a,this._png.bitDepth=i;const n=this._png.width*this._png.height*a;if(this._png.data.length!==n)throw new RangeError(`wrong data size. Found ${this._png.data.length}, expected ${n}`)}writeCrc(e){this.writeUint32(crc(new Uint8Array(this.buffer,this.byteOffset+this.offset-e,e),e))}}for(var btoa=btoa||function(e){return new Buffer(e).toString("base64")},encoder=encode$2,JpegImage=function(){function e(){}function t(e,t){for(var a=0,n=[],o=16,s,l;0<o&&!e[o-1];)o--;n.push({children:[],index:0});var r=n[0],d;for(s=0;s<o;s++){for(l=0;l<e[s];l++){for(r=n.pop(),r.children[r.index]=t[a];0<r.index;)r=n.pop();for(r.index++,n.push(r);n.length<=s;)n.push(d={children:[],index:0}),r.children[r.index]=d.children,r=d;a++}s+1<o&&(n.push(d={children:[],index:0}),r.children[r.index]=d.children,r=d)}return n[0].children}function a(e,t,a,o,s,d,g,c,m){function p(){if(0<L)return L--,1&T>>L;if(T=e[t++],255==T){var a=e[t++];if(a)throw new Error("unexpected marker: "+(T<<8|a).toString(16))}return L=7,T>>>7}function u(e){for(var t=e,a;null!==(a=p());){if(t=t[a],"number"==typeof t)return t;if("object"!=typeof t)throw new Error("invalid huffman sequence")}return null}function f(e){for(var t=0,a;0<e;){if(a=p(),null===a)return;t=t<<1|a,e--}return t}function b(e){var t=f(e);return t>=1<<e-1?t:t+(-1<<e)+1}function _(e,a){var i=u(e.huffmanTableDC),t=0===i?0:b(i);a[0]=e.pred+=t;for(var n=1;64>n;){var o=u(e.huffmanTableAC),d=15&o,s=o>>4;if(0===d){if(15>s)break;n+=16;continue}n+=s;var r=l[n];a[r]=b(d),n++}}function w(e,a){var i=u(e.huffmanTableDC),t=0===i?0:b(i)<<m;a[0]=e.pred+=t}function x(e,t){if(0<E)return void E--;for(var a=d;a<=g;){var i=u(e.huffmanTableAC),n=15&i,o=i>>4;if(0===n){if(15>o){E=f(o)+(1<<o)-1;break}a+=16;continue}a+=o;var s=l[a];t[s]=b(n)*(1<<m),a++}}function y(e,t){for(var a=d,i=0;a<=g;){var n=l[a],o=0>t[n]?-1:1;switch(Y){case 0:var h=u(e.huffmanTableAC),c=15&h,i=h>>4;if(0===c)15>i?(E=f(i)+(1<<i),Y=4):(i=16,Y=1);else{if(1!==c)throw new Error("invalid ACn encoding");X=b(c),Y=i?2:3}continue;case 1:case 2:t[n]?t[n]+=(p()<<m)*o:(i--,0===i&&(Y=2==Y?3:0));break;case 3:t[n]?t[n]+=(p()<<m)*o:(t[n]=X<<m,Y=0);break;case 4:t[n]&&(t[n]+=(p()<<m)*o);}a++}4==Y&&(E--,0===E&&(Y=0))}function D(e,t,a,i,n){var o=(0|a/B)*e.v+i,s=a%B*e.h+n;t(e,e.blocks[o][s])}function S(e,t,a){var i=0|a/e.blocksPerLine,n=a%e.blocksPerLine;t(e,e.blocks[i][n])}var I=a.precision,P=a.samplesPerLine,M=a.scanLines,B=a.mcusPerLine,C=a.progressive,R=a.maxH,A=a.maxV,z=t,T=0,L=0,E=0,Y=0,F=o.length,X,V,U,r,G,O,N;N=C?0===d?0===c?w:function(e,t){t[0]|=p()<<m}:0===c?x:y:_;var H=0,q,W;W=1==F?o[0].blocksPerLine*o[0].blocksPerColumn:B*a.mcusPerColumn,s||(s=W);for(var Z,K;H<W;){for(U=0;U<F;U++)o[U].pred=0;if(E=0,1==F)for(V=o[0],O=0;O<s;O++)S(V,N,H),H++;else for(O=0;O<s;O++){for(U=0;U<F;U++)for(V=o[U],Z=V.h,K=V.v,r=0;r<K;r++)for(G=0;G<Z;G++)D(V,N,H,r,G);if(H++,H===W)break}if(L=0,q=e[t]<<8|e[t+1],65280>q)throw new Error("marker was not found");if(65488<=q&&65495>=q)t+=2;else break}return t-z}function n(e,a){function n(e,n,o){var s=a.quantizationTable,l=o,r,d,h,g,c,m,p,u,f,b;for(b=0;64>b;b++)l[b]=e[b]*s[b];for(b=0;8>b;++b){var _=8*b;if(0==l[1+_]&&0==l[2+_]&&0==l[3+_]&&0==l[4+_]&&0==l[5+_]&&0==l[6+_]&&0==l[7+_]){f=5793*l[0+_]+512>>10,l[0+_]=f,l[1+_]=f,l[2+_]=f,l[3+_]=f,l[4+_]=f,l[5+_]=f,l[6+_]=f,l[7+_]=f;continue}r=5793*l[0+_]+128>>8,d=5793*l[4+_]+128>>8,h=l[2+_],g=l[6+_],c=2896*(l[1+_]-l[7+_])+128>>8,u=2896*(l[1+_]+l[7+_])+128>>8,m=l[3+_]<<4,p=l[5+_]<<4,f=r-d+1>>1,r=r+d+1>>1,d=f,f=3784*h+1567*g+128>>8,h=1567*h-3784*g+128>>8,g=f,f=c-p+1>>1,c=c+p+1>>1,p=f,f=u+m+1>>1,m=u-m+1>>1,u=f,f=r-g+1>>1,r=r+g+1>>1,g=f,f=d-h+1>>1,d=d+h+1>>1,h=f,f=2276*c+3406*u+2048>>12,c=3406*c-2276*u+2048>>12,u=f,f=799*m+4017*p+2048>>12,m=4017*m-799*p+2048>>12,p=f,l[0+_]=r+u,l[7+_]=r-u,l[1+_]=d+p,l[6+_]=d-p,l[2+_]=h+m,l[5+_]=h-m,l[3+_]=g+c,l[4+_]=g-c}for(b=0;8>b;++b){var w=b;if(0==l[8+w]&&0==l[16+w]&&0==l[24+w]&&0==l[32+w]&&0==l[40+w]&&0==l[48+w]&&0==l[56+w]){f=5793*o[b+0]+8192>>14,l[0+w]=f,l[8+w]=f,l[16+w]=f,l[24+w]=f,l[32+w]=f,l[40+w]=f,l[48+w]=f,l[56+w]=f;continue}r=5793*l[0+w]+2048>>12,d=5793*l[32+w]+2048>>12,h=l[16+w],g=l[48+w],c=2896*(l[8+w]-l[56+w])+2048>>12,u=2896*(l[8+w]+l[56+w])+2048>>12,m=l[24+w],p=l[40+w],f=r-d+1>>1,r=r+d+1>>1,d=f,f=3784*h+1567*g+2048>>12,h=1567*h-3784*g+2048>>12,g=f,f=c-p+1>>1,c=c+p+1>>1,p=f,f=u+m+1>>1,m=u-m+1>>1,u=f,f=r-g+1>>1,r=r+g+1>>1,g=f,f=d-h+1>>1,d=d+h+1>>1,h=f,f=2276*c+3406*u+2048>>12,c=3406*c-2276*u+2048>>12,u=f,f=799*m+4017*p+2048>>12,m=4017*m-799*p+2048>>12,p=f,l[0+w]=r+u,l[56+w]=r-u,l[8+w]=d+p,l[48+w]=d-p,l[16+w]=h+m,l[40+w]=h-m,l[24+w]=g+c,l[32+w]=g-c}for(b=0;64>b;++b){var x=128+(l[b]+8>>4);n[b]=0>x?0:255<x?255:x}}for(var o=[],s=a.blocksPerLine,l=a.blocksPerColumn,d=new Int32Array(64),t=new Uint8Array(64),r=0,h,g,c;r<l;r++){for(c=r<<3,h=0;8>h;h++)o.push(new Uint8Array(s<<3));for(var m=0;m<s;m++){n(a.blocks[r][m],t,d);var p=0,u=m<<3;for(g=0;8>g;g++){var f=o[c+g];for(h=0;8>h;h++)f[u+h]=t[p++]}}}return o}function o(e){return 0>e?0:255<e?255:e}var l=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]);return e.prototype={load:function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(){var e=new Uint8Array(t.response||t.mozResponseArrayBuffer);this.parse(e),this.onload&&this.onload()}.bind(this),t.send(null)},parse:function(e){function o(){var t=e[d]<<8|e[d+1];return d+=2,t}function s(){var t=o(),a=e.subarray(d,d+t-2);return d+=a.length,a}function r(e){var t=0,a=0,n,o;for(o in e.components)e.components.hasOwnProperty(o)&&(n=e.components[o],t<n.h&&(t=n.h),a<n.v&&(a=n.v));var s=_Mathceil(e.samplesPerLine/8/t),l=_Mathceil(e.scanLines/8/a);for(o in e.components)if(e.components.hasOwnProperty(o)){n=e.components[o];for(var r=_Mathceil(_Mathceil(e.samplesPerLine/8)*n.h/t),d=_Mathceil(_Mathceil(e.scanLines/8)*n.v/a),h=s*n.h,g=l*n.v,c=[],m=0,p;m<g;m++){p=[];for(var u=0;u<h;u++)p.push(new Int32Array(64));c.push(p)}n.blocksPerLine=r,n.blocksPerColumn=d,n.blocks=c}e.maxH=t,e.maxV=a,e.mcusPerLine=s,e.mcusPerColumn=l}var d=0,g=e.length,c=null,m=null,p=[],u=[],f=[],b=[],_=o(),w,x;if(65496!=_)throw new Error("SOI not found");for(_=o();65497!=_;){var y,k;switch(_){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var D=s();65504===_&&74===D[0]&&70===D[1]&&73===D[2]&&70===D[3]&&0===D[4]&&(c={version:{major:D[5],minor:D[6]},densityUnits:D[7],xDensity:D[8]<<8|D[9],yDensity:D[10]<<8|D[11],thumbWidth:D[12],thumbHeight:D[13],thumbData:D.subarray(14,14+3*D[12]*D[13])}),65518===_&&65===D[0]&&100===D[1]&&111===D[2]&&98===D[3]&&101===D[4]&&0===D[5]&&(m={version:D[6],flags0:D[7]<<8|D[8],flags1:D[9]<<8|D[10],transformCode:D[11]});break;case 65499:for(var S=o(),I=S+d-2;d<I;){var P=e[d++],M=new Int32Array(64);if(0==P>>4)for(k=0;64>k;k++){var B=l[k];M[B]=e[d++]}else if(1==P>>4)for(k=0;64>k;k++){var B=l[k];M[B]=o()}else throw new Error("DQT: invalid table spec");p[15&P]=M}break;case 65472:case 65473:case 65474:o(),w={},w.extended=65473===_,w.progressive=65474===_,w.precision=e[d++],w.scanLines=o(),w.samplesPerLine=o(),w.components={},w.componentsOrder=[];var C=e[d++],R;for(y=0;y<C;y++){R=e[d];var A=e[d+1]>>4,h=15&e[d+1],v=e[d+2];w.componentsOrder.push(R),w.components[R]={h:A,v:h,quantizationIdx:v},d+=3}r(w),u.push(w);break;case 65476:var T=o();for(y=2;y<T;){var L=e[d++],E=new Uint8Array(16),Y=0;for(k=0;16>k;k++,d++)Y+=E[k]=e[d];var F=new Uint8Array(Y);for(k=0;k<Y;k++,d++)F[k]=e[d];y+=17+Y,(0==L>>4?b:f)[15&L]=t(E,F)}break;case 65501:o(),x=o();break;case 65498:var X=o(),V=e[d++],U=[],G;for(y=0;y<V;y++){G=w.components[e[d++]];var O=e[d++];G.huffmanTableDC=b[O>>4],G.huffmanTableAC=f[15&O],U.push(G)}var N=e[d++],H=e[d++],q=e[d++],W=a(e,d,w,U,x,N,H,q>>4,15&q);d+=W;break;case 65535:255!==e[d]&&d--;break;default:if(255==e[d-3]&&192<=e[d-2]&&254>=e[d-2]){d-=3;break}throw new Error("unknown JPEG marker "+_.toString(16));}_=o()}if(1!=u.length)throw new Error("only single frame JPEGs supported");for(var y=0,Z;y<u.length;y++)for(var k in Z=u[y].components,Z)Z[k].quantizationTable=p[Z[k].quantizationIdx],delete Z[k].quantizationIdx;this.width=w.samplesPerLine,this.height=w.scanLines,this.jfif=c,this.adobe=m,this.components=[];for(var y=0,G;y<w.componentsOrder.length;y++)G=w.components[w.componentsOrder[y]],this.components.push({lines:n(w,G),scaleX:G.h/w.maxH,scaleY:G.v/w.maxV})},getData:function(e,t){var a=this.width/e,i=this.height/t,n=0,s=e*t*this.components.length,l=new Uint8Array(s),r,d,h,g,c,m,p,u,f,b,_,w,k,v,D,S,I,P,j,A,z;switch(this.components.length){case 1:for(r=this.components[0],b=0;b<t;b++)for(c=r.lines[0|b*r.scaleY*i],f=0;f<e;f++)_=c[0|f*r.scaleX*a],l[n++]=_;break;case 2:for(r=this.components[0],d=this.components[1],b=0;b<t;b++)for(c=r.lines[0|b*r.scaleY*i],m=d.lines[0|b*d.scaleY*i],f=0;f<e;f++)_=c[0|f*r.scaleX*a],l[n++]=_,_=m[0|f*d.scaleX*a],l[n++]=_;break;case 3:for(z=!0,this.adobe&&this.adobe.transformCode?z=!0:"undefined"!=typeof this.colorTransform&&(z=!!this.colorTransform),r=this.components[0],d=this.components[1],h=this.components[2],b=0;b<t;b++)for(c=r.lines[0|b*r.scaleY*i],m=d.lines[0|b*d.scaleY*i],p=h.lines[0|b*h.scaleY*i],f=0;f<e;f++)z?(_=c[0|f*r.scaleX*a],w=m[0|f*d.scaleX*a],k=p[0|f*h.scaleX*a],P=o(_+1.402*(k-128)),j=o(_-.3441363*(w-128)-.71413636*(k-128)),A=o(_+1.772*(w-128))):(P=c[0|f*r.scaleX*a],j=m[0|f*d.scaleX*a],A=p[0|f*h.scaleX*a]),l[n++]=P,l[n++]=j,l[n++]=A;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";for(z=!1,this.adobe&&this.adobe.transformCode?z=!0:"undefined"!=typeof this.colorTransform&&(z=!!this.colorTransform),r=this.components[0],d=this.components[1],h=this.components[2],g=this.components[3],b=0;b<t;b++)for(c=r.lines[0|b*r.scaleY*i],m=d.lines[0|b*d.scaleY*i],p=h.lines[0|b*h.scaleY*i],u=g.lines[0|b*g.scaleY*i],f=0;f<e;f++)z?(_=c[0|f*r.scaleX*a],w=m[0|f*d.scaleX*a],k=p[0|f*h.scaleX*a],v=u[0|f*g.scaleX*a],D=255-o(_+1.402*(k-128)),S=255-o(_-.3441363*(w-128)-.71413636*(k-128)),I=255-o(_+1.772*(w-128))):(D=c[0|f*r.scaleX*a],S=m[0|f*d.scaleX*a],I=p[0|f*h.scaleX*a],v=u[0|f*g.scaleX*a]),l[n++]=255-D,l[n++]=255-S,l[n++]=255-I,l[n++]=255-v;break;default:throw"Unsupported color mode";}return l},copyToImageData:function(e){var t=e.width,a=e.height,n=e.data,s=this.getData(t,a),l=0,r=0,d,h,g,c,m,p,u,f,b;switch(this.components.length){case 1:for(h=0;h<a;h++)for(d=0;d<t;d++)g=s[l++],n[r++]=g,n[r++]=g,n[r++]=g,n[r++]=255;break;case 3:for(h=0;h<a;h++)for(d=0;d<t;d++)u=s[l++],f=s[l++],b=s[l++],n[r++]=u,n[r++]=f,n[r++]=b,n[r++]=255;break;case 4:for(h=0;h<a;h++)for(d=0;d<t;d++)m=s[l++],p=s[l++],g=s[l++],c=s[l++],u=255-o(m*(1-c/255)+c),f=255-o(p*(1-c/255)+c),b=255-o(g*(1-c/255)+c),n[r++]=u,n[r++]=f,n[r++]=b,n[r++]=255;break;default:throw"Unsupported color mode";}}},e}(),decoder=decode,jpegJs={encode:encoder,decode:decoder},jpegJs_1=jpegJs.encode,jpegJs_2=jpegJs.decode,chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256),i$1=0;i$1<chars.length;i$1++)lookup[chars.charCodeAt(i$1)]=i$1;var ImageData=self.ImageData,DOMImage=self.Image,exportMethods={save(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.useCanvas,i=void 0!==a&&a,n=t.encoder,o=void 0===n?void 0:n,s=t.format;if(!s){var l=/\.([a-zA-Z]+)$/.exec(e);l&&(s=l[1].toLowerCase())}if(!s)throw new Error("file format not provided");return new Promise((t,a)=>{var n,l;switch(s.toLowerCase()){case"png":{i?n=this.getCanvas().pngStream():l=encodePng(this,o);break}case"jpg":case"jpeg":i?n=this.getCanvas().jpegStream():l=encodeJpeg(this,o);break;case"bmp":l=encode$1(this,o);break;default:throw new RangeError("invalid output format: ".concat(s));}if(n){var r=createWriteStream(e);r.on("finish",t),r.on("error",a),n.pipe(r)}else l&&writeFile(e,l,e=>e?void a(e):void t())})},toDataURL(){function e(e,a){var i=e(a,l);return toBase64URL(i,t)}var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"image/png",a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};"object"==typeof t&&(a=t,t="image/png");var i=a,n=i.useCanvas,o=void 0!==n&&n,s=i.encoder,l=void 0===s?void 0:s;return t=getType(t),"image/bmp"===t?e(encode$1,this):"image/png"!==t||o?"image/jpeg"!==t||o?this.getCanvas().toDataURL(t):e(encodeJpeg,this):e(encodePng,this)},toBuffer(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.format,a=void 0===t?"png":t,i=e.encoder,n=void 0===i?void 0:i;switch(a.toLowerCase()){case"png":return encodePng(this,n);case"jpeg":case"jpg":return encodeJpeg(this,n);case"bmp":return encode$1(this,n);default:throw new RangeError("invalid output format: ".concat(a));}},toBase64(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"image/png",t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};if(t.async)return this.toDataURL(e,t).then(function(e){return e.substring(e.indexOf(",")+1)});var a=this.toDataURL(e,t);return a.substring(a.indexOf(",")+1)},toBlob(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"image/png",t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:.8;return canvasToBlob(this.getCanvas(),e,t)},getCanvas(){var e=new ImageData(this.getRGBAData({clamped:!0}),this.width,this.height),t=createCanvas(this.width,this.height),a=t.getContext("2d");return a.putImageData(e,0,0),t}},_args=[["has-own@1.0.0","/usr/local/www/sites/www.lactame.com/node/grm-data/git/image-js/image-js"]],_from="has-own@1.0.0",_id="has-own@1.0.0",_inBundle=!1,_integrity="sha1-MGIkbjHP2Iepph7m04ylcok3jNE=",_location="/has-own",_phantomChildren={},_requested={type:"version",registry:!0,raw:"has-own@1.0.0",name:"has-own",escapedName:"has-own",rawSpec:"1.0.0",saveSpec:null,fetchSpec:"1.0.0"},_requiredBy=["/"],_resolved="https://registry.npmjs.org/has-own/-/has-own-1.0.0.tgz",_spec="1.0.0",_where="/usr/local/www/sites/www.lactame.com/node/grm-data/git/image-js/image-js",author={name:"Aaron Heckmann",email:"aaron.heckmann+github@gmail.com"},bugs={url:"https://github.com/pebble/has-own/issues"},description="A safer .hasOwnProperty() - hasOwn(name, obj)",devDependencies={mocha:"^1.21.0"},homepage="https://github.com/pebble/has-own/",license="MIT",main="index.js",name="has-own",repository={type:"git",url:"git://github.com/pebble/has-own.git"},scripts={test:"make test"},version="1.0.0",_package={_args:_args,_from:_from,_id:_id,_inBundle:_inBundle,_integrity:_integrity,_location:_location,_phantomChildren:_phantomChildren,_requested:_requested,_requiredBy:_requiredBy,_resolved:_resolved,_spec:_spec,_where:_where,author:author,bugs:bugs,description:description,devDependencies:devDependencies,homepage:homepage,license:license,main:main,name:name,repository:repository,scripts:scripts,version:version},_package$1=Object.freeze({_args:_args,_from:_from,_id:_id,_inBundle:_inBundle,_integrity:_integrity,_location:_location,_phantomChildren:_phantomChildren,_requested:_requested,_requiredBy:_requiredBy,_resolved:_resolved,_spec:_spec,_where:_where,author:author,bugs:bugs,description:description,devDependencies:devDependencies,homepage:homepage,license:license,main:main,name:name,repository:repository,scripts:scripts,version:version,default:_package}),require$$0=getCjsExportFromNamespace(_package$1),hasOwn=createCommonjsModule(function(e,t){var a=Object.prototype.hasOwnProperty;e.exports=t=function(e,t){return a.call(t,e)},t.version=require$$0.version}),hasOwn_1=hasOwn.version,computedPropertyDescriptor={configurable:!0,enumerable:!1,get:void 0},GREY="GREY",RGB="RGB",HSL="HSL",HSV="HSV",CMYK="CMYK",ColorModel=Object.freeze({GREY:GREY,RGB:RGB,HSL:HSL,HSV:HSV,CMYK:CMYK}),BINARY="BINARY",GREY$1="GREY",GREYA="GREYA",RGB$1="RGB",RGBA="RGBA",CMYK$1="CMYK",CMYKA="CMYKA",kinds={};kinds[BINARY]={components:1,alpha:0,bitDepth:1,colorModel:GREY},kinds[GREYA]={components:1,alpha:1,bitDepth:8,colorModel:GREY},kinds[GREY$1]={components:1,alpha:0,bitDepth:8,colorModel:GREY},kinds[RGBA]={components:3,alpha:1,bitDepth:8,colorModel:RGB},kinds[RGB$1]={components:3,alpha:0,bitDepth:8,colorModel:RGB},kinds[CMYK$1]={components:4,alpha:0,bitDepth:8,colorModel:CMYK},kinds[CMYKA]={components:4,alpha:1,bitDepth:8,colorModel:CMYK};var validBitDepth=[1,8,16,32];const defaultByteLength$1=8192,charArray$1=[];class IOBuffer$1{constructor(e,t){t=t||{},e===void 0&&(e=defaultByteLength$1),"number"==typeof e&&(e=new ArrayBuffer(e));let a=e.byteLength;const i=t.offset?t.offset>>>0:0;e.buffer&&(a=e.byteLength-i,e=e.byteLength===e.buffer.byteLength?i?e.buffer.slice(i):e.buffer:e.buffer.slice(e.byteOffset+i,e.byteOffset+e.byteLength)),this.buffer=e,this.length=a,this.byteLength=a,this.byteOffset=0,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer),this._increment=a||defaultByteLength$1,this._mark=0}available(e){return void 0===e&&(e=1),this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){this.littleEndian=!0}isBigEndian(){return!this.littleEndian}setBigEndian(){this.littleEndian=!1}skip(e){e===void 0&&(e=1),this.offset+=e}seek(e){this.offset=e}mark(){this._mark=this.offset}reset(){this.offset=this._mark}rewind(){this.offset=0}ensureAvailable(e){if(void 0===e&&(e=1),!this.available(e)){const e=this._increment+this._increment;this._increment=e;const t=this.length+e,a=new Uint8Array(t);a.set(new Uint8Array(this.buffer)),this.buffer=a.buffer,this.length=t,this._data=new DataView(this.buffer)}}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){e===void 0&&(e=1);for(var t=new Uint8Array(e),a=0;a<e;a++)t[a]=this.readByte();return t}readInt16(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return _StringfromCharCode(this.readInt8())}readChars(e){e===void 0&&(e=1),charArray$1.length=e;for(var t=0;t<e;t++)charArray$1[t]=this.readChar();return charArray$1.join("")}writeBoolean(e){this.writeUint8(e?255:0)}writeInt8(e){this.ensureAvailable(1),this._data.setInt8(this.offset++,e)}writeUint8(e){this.ensureAvailable(1),this._data.setUint8(this.offset++,e)}writeByte(e){this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(var t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t])}writeInt16(e){this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2}writeUint16(e){this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2}writeInt32(e){this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeFloat32(e){this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeFloat64(e){this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8}writeChar(e){this.writeUint8(e.charCodeAt(0))}writeChars(e){for(var t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t))}toArray(){return new Uint8Array(this.buffer,0,this.offset)}}var IOBuffer_1$1=IOBuffer$1;const tagsById={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName={};for(var i$2 in tagsById)tagsByName[tagsById[i$2]]=i$2;var standard={tagsById,tagsByName};const tagsById$1={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$1={};for(var i$3 in tagsById$1)tagsByName$1[tagsById$1[i$3]]=i$3;var exif={tagsById:tagsById$1,tagsByName:tagsByName$1};const tagsById$2={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$2={};for(var i$4 in tagsById$2)tagsByName$2[tagsById$2[i$4]]=i$4;var gps={tagsById:tagsById$2,tagsByName:tagsByName$2};const tags={standard:standard,exif:exif,gps:gps};class IFD{constructor(e){if(!e)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=e,this._map=null}get(e){if("number"==typeof e)return this.fields.get(e);if("string"==typeof e)return this.fields.get(tags[this.kind].tagsByName[e]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const t=tags[this.kind].tagsById;for(var e of this.fields.keys())t[e]&&(this._map[t[e]]=this.fields.get(e))}return this._map}}var ifd=IFD;const dateTimeRegex=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd extends ifd{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var e=new Date,t=dateTimeRegex.exec(this.dateTime);return e.setFullYear(t[1],t[2]-1,t[3]),e.setHours(t[4],t[5],t[6]),e}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||_Mathpow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}var tiffIfd=TiffIfd,types=new Map([[1,[1,readByte]],[2,[1,readASCII]],[3,[2,readShort]],[4,[4,readLong]],[5,[8,readRational]],[6,[1,readSByte]],[7,[1,readByte]],[8,[2,readSShort]],[9,[4,readSLong]],[10,[8,readSRational]],[11,[4,readFloat]],[12,[8,readDouble]]]),getByteLength=function(e,t){return types.get(e)[0]*t},readData=function(e,t,a){return types.get(t)[1](e,a)},ifdValue={getByteLength:getByteLength,readData:readData};const defaultOptions={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder extends IOBuffer_1$1{constructor(e,t){super(e,t),this._nextIFD=0}decode(e){e=Object.assign({},defaultOptions,e);const t=[];for(this.decodeHeader();this._nextIFD;)if(t.push(this.decodeIFD(e)),e.onlyFirst)return t[0];return t}decodeHeader(){let e=this.readUint16();if(18761===e)this.setLittleEndian();else if(19789===e)this.setBigEndian();else throw new Error("invalid byte order: 0x"+e.toString(16));if(e=this.readUint16(),42!==e)throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(e){this.seek(this._nextIFD);var t=e.kind?new ifd(e.kind):new tiffIfd;const a=this.readUint16();for(var n=0;n<a;n++)this.decodeIFDEntry(t);return e.ignoreImageData||this.decodeImageData(t),this._nextIFD=this.readUint32(),t}decodeIFDEntry(e){const t=this.offset,a=this.readUint16(),i=this.readUint16(),n=this.readUint32();if(1>i||12<i)return void this.skip(4);const o=ifdValue.getByteLength(i,n);4<o&&this.seek(this.readUint32());const s=ifdValue.readData(this,i,n);if(e.fields.set(a,s),34665===a||34853===a){let t=this.offset,i;34665===a?i="exif":34853===a&&(i="gps"),this._nextIFD=s,e[i]=this.decodeIFD({kind:i,ignoreImageData:!0}),this.offset=t}this.seek(t),this.skip(12)}decodeImageData(e){const t=e.orientation;switch(t&&1!==t&&unsupported("orientation",t),e.type){case 1:case 2:this.readStripData(e);break;default:unsupported("image type",e.type);}}readStripData(e){const t=e.width,a=e.height,n=validateBitDepth(e.bitsPerSample),o=e.sampleFormat;let s=t*a;const l=getDataArray(s,1,n,o),r=e.compression,d=e.rowsPerStrip,h=d*t,g=e.stripOffsets,c=e.stripByteCounts;for(var m=0,p=0;p<g.length;p++){var u=this.getStripData(r,g[p],c[p]),f=s>h?h:s;s-=f,8===n?m=fill8bit(l,u,m,f):16===n?m=fill16bit(l,u,m,f,this.isLittleEndian()):32===n&&3===o?m=fillFloat32(l,u,m,f,this.isLittleEndian()):unsupported("bitDepth",n)}e.data=l}getStripData(e,t,a){switch(e){case 1:return new DataView(this.buffer,t,a);case 2:case 32773:return unsupported("Compression",e);default:throw new Error("invalid compression: "+e);}}}var tiffDecoder=TIFFDecoder,decode$2=function(e,t){const a=new tiffDecoder(e,t);return a.decode(t)},decode$3=decode$2,src={decode:decode$3},decode_1=decode$4,decode$5=decode_1,utf8$1=createCommonjsModule(function(e,t){(function(e){function t(e){for(var t=[],a=0,i=e.length,n,o;a<i;)n=e.charCodeAt(a++),55296<=n&&56319>=n&&a<i?(o=e.charCodeAt(a++),56320==(64512&o)?t.push(((1023&n)<<10)+(1023&o)+65536):(t.push(n),a--)):t.push(n);return t}function a(e){for(var t=e.length,a=-1,i="",n;++a<t;)n=e[a],65535<n&&(n-=65536,i+=d(55296|1023&n>>>10),n=56320|1023&n),i+=d(n);return i}function i(e){if(55296<=e&&57343>=e)throw Error("Lone surrogate U+"+e.toString(16).toUpperCase()+" is not a scalar value")}function n(e,t){return d(128|63&e>>t)}function o(e){if(0==(4294967168&e))return d(e);var t="";return 0==(4294965248&e)?t=d(192|31&e>>6):0==(4294901760&e)?(i(e),t=d(224|15&e>>12),t+=n(e,6)):0==(4292870144&e)&&(t=d(240|7&e>>18),t+=n(e,12),t+=n(e,6)),t+=d(128|63&e),t}function s(){if(c>=g)throw Error("Invalid byte index");var e=255&h[c];if(c++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function l(){var e,t,a,n,o;if(c>g)throw Error("Invalid byte index");if(c==g)return!1;if(e=255&h[c],c++,0==(128&e))return e;if(192==(224&e)){if(t=s(),o=(31&e)<<6|t,128<=o)return o;throw Error("Invalid continuation byte")}if(224==(240&e)){if(t=s(),a=s(),o=(15&e)<<12|t<<6|a,2048<=o)return i(o),o;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=s(),a=s(),n=s(),o=(7&e)<<18|t<<12|a<<6|n,65536<=o&&1114111>=o))return o;throw Error("Invalid UTF-8 detected")}function r(e){h=t(e),g=h.length,c=0;for(var i=[],n;!1!==(n=l());)i.push(n);return a(i)}var d=_StringfromCharCode,h,g,c;e.version="3.0.0",e.encode=function(e){for(var a=t(e),i=a.length,n=-1,s="",l;++n<i;)l=a[n],s+=o(l);return s},e.decode=r})(t)}),utf8_1=utf8$1.decode,utf8_2=utf8$1.encode;const defaultByteLength$2=8192,charArray$2=[];class IOBuffer$2{constructor(e=defaultByteLength$2,t={}){let a=!1;"number"==typeof e?e=new ArrayBuffer(e):(a=!0,this.lastWrittenByte=e.byteLength);const i=t.offset?t.offset>>>0:0,n=e.byteLength-i;let o=i;(ArrayBuffer.isView(e)||e instanceof IOBuffer$2)&&(e.byteLength!==e.buffer.byteLength&&(o=e.byteOffset+i),e=e.buffer),this.lastWrittenByte=a?n:0,this.buffer=e,this.length=n,this.byteLength=n,this.byteOffset=o,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,o,n),this._mark=0,this._marks=[]}available(e=1){return this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e=1){return this.offset+=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const e=this._marks.pop();if(void 0===e)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e=1){if(!this.available(e)){const t=this.offset+e,a=2*t,i=new Uint8Array(a);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=a,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e=1){const t=new Uint8Array(e);for(let a=0;a<e;a++)t[a]=this.readByte();return t}readInt16(){const e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){const e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){const e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){const e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){const e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){const e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return _StringfromCharCode(this.readInt8())}readChars(e=1){charArray$2.length=e;for(let t=0;t<e;t++)charArray$2[t]=this.readChar();return charArray$2.join("")}readUtf8(e=1){const t=this.readChars(e);return utf8_1(t)}writeBoolean(e){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(let t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(let t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));return this}writeUtf8(e){const t=utf8_2(e);return this.writeChars(t)}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}const tagsById$3={254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Threshholding",264:"CellWidth",265:"CellLength",266:"FillOrder",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",296:"ResolutionUnit",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",320:"ColorMap",338:"ExtraSamples",33432:"Copyright",269:"DocumentName",285:"PageName",286:"XPosition",287:"YPosition",292:"T4Options",293:"T6Options",297:"PageNumber",301:"TransferFunction",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"XMP",32781:"ImageID",34732:"ImageLayer",32932:"WangAnnotatio",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"ModelPixelScaleTag",33723:"IPTC",33918:"INGRPacketDataTag",33919:"INGRFlagRegisters",33920:"IrasBTransformationMatrix",33922:"ModelTiepointTag",34264:"ModelTransformationTag",34377:"Photoshop",34665:"ExifIFD",34675:"ICCProfile",34735:"GeoKeyDirectoryTag",34736:"GeoDoubleParamsTag",34737:"GeoAsciiParamsTag",34853:"GPSIFD",34908:"HylaFAXFaxRecvParams",34909:"HylaFAXFaxSubAddress",34910:"HylaFAXFaxRecvTime",37724:"ImageSourceData",40965:"InteroperabilityIFD",42112:"GDAL_METADATA",42113:"GDAL_NODATA",50215:"OceScanjobDescription",50216:"OceApplicationSelector",50217:"OceIdentificationNumber",50218:"OceImageLogicCharacteristics",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50784:"AliasLayerMetadata"},tagsByName$3={};for(var i$5 in tagsById$3)tagsByName$3[tagsById$3[i$5]]=i$5;var standard$1=Object.freeze({tagsById:tagsById$3,tagsByName:tagsByName$3});const tagsById$4={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42240:"Gamma"},tagsByName$4={};for(var i$6 in tagsById$4)tagsByName$4[tagsById$4[i$6]]=i$6;var exif$1=Object.freeze({tagsById:tagsById$4,tagsByName:tagsByName$4});const tagsById$5={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"},tagsByName$5={};for(var i$7 in tagsById$5)tagsByName$5[tagsById$5[i$7]]=i$7;var gps$1=Object.freeze({tagsById:tagsById$5,tagsByName:tagsByName$5});const tags$1={standard:standard$1,exif:exif$1,gps:gps$1};class IFD$1{constructor(e){if(!e)throw new Error("missing kind");this.data=null,this.fields=new Map,this.kind=e,this._map=null}get(e){if("number"==typeof e)return this.fields.get(e);if("string"==typeof e)return this.fields.get(tags$1[this.kind].tagsByName[e]);throw new Error("expected a number or string")}get map(){if(!this._map){this._map={};const t=tags$1[this.kind].tagsById;for(var e of this.fields.keys())t[e]&&(this._map[t[e]]=this.fields.get(e))}return this._map}}const dateTimeRegex$1=/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/;class TiffIfd$1 extends IFD$1{constructor(){super("standard")}get size(){return this.width*this.height}get width(){return this.imageWidth}get height(){return this.imageLength}get components(){return this.samplesPerPixel}get date(){var e=new Date,t=dateTimeRegex$1.exec(this.dateTime);return e.setFullYear(t[1],t[2]-1,t[3]),e.setHours(t[4],t[5],t[6]),e}get newSubfileType(){return this.get(254)}get imageWidth(){return this.get(256)}get imageLength(){return this.get(257)}get bitsPerSample(){return this.get(258)}get compression(){return this.get(259)||1}get type(){return this.get(262)}get fillOrder(){return this.get(266)||1}get documentName(){return this.get(269)}get imageDescription(){return this.get(270)}get stripOffsets(){return alwaysArray$1(this.get(273))}get orientation(){return this.get(274)}get samplesPerPixel(){return this.get(277)}get rowsPerStrip(){return this.get(278)}get stripByteCounts(){return alwaysArray$1(this.get(279))}get minSampleValue(){return this.get(280)||0}get maxSampleValue(){return this.get(281)||_Mathpow(2,this.bitsPerSample)-1}get xResolution(){return this.get(282)}get yResolution(){return this.get(283)}get planarConfiguration(){return this.get(284)||1}get resolutionUnit(){return this.get(296)||2}get dateTime(){return this.get(306)}get predictor(){return this.get(317)||1}get sampleFormat(){return this.get(339)||1}get sMinSampleValue(){return this.get(340)||this.minSampleValue}get sMaxSampleValue(){return this.get(341)||this.maxSampleValue}}var types$1=new Map([[1,[1,readByte$1]],[2,[1,readASCII$1]],[3,[2,readShort$1]],[4,[4,readLong$1]],[5,[8,readRational$1]],[6,[1,readSByte$1]],[7,[1,readByte$1]],[8,[2,readSShort$1]],[9,[4,readSLong$1]],[10,[8,readSRational$1]],[11,[4,readFloat$1]],[12,[8,readDouble$1]]]);const defaultOptions$1={ignoreImageData:!1,onlyFirst:!1};class TIFFDecoder$1 extends IOBuffer$2{constructor(e,t){super(e,t),this._nextIFD=0}get isMultiPage(){let e=0;for(this.decodeHeader();this._nextIFD;)if(e++,this.decodeIFD({ignoreImageData:!0}),2==e)return!0;if(1==e)return!1;throw unsupported$1("ifdCount",e)}get pageCount(){let e=0;for(this.decodeHeader();this._nextIFD;)e++,this.decodeIFD({ignoreImageData:!0});if(0<e)return e;throw unsupported$1("ifdCount",e)}decode(e){e=Object.assign({},defaultOptions$1,e);const t=[];for(this.decodeHeader();this._nextIFD;)if(t.push(this.decodeIFD(e)),e.onlyFirst)return t[0];return t}decodeHeader(){const e=this.readUint16();if(18761===e)this.setLittleEndian();else if(19789===e)this.setBigEndian();else throw new Error(`invalid byte order: 0x${e.toString(16)}`);if(42!==this.readUint16())throw new Error("not a TIFF file");this._nextIFD=this.readUint32()}decodeIFD(e){this.seek(this._nextIFD);var t=e.kind?new IFD$1(e.kind):new TiffIfd$1;const a=this.readUint16();for(var n=0;n<a;n++)this.decodeIFDEntry(t);return e.ignoreImageData||this.decodeImageData(t),this._nextIFD=this.readUint32(),t}decodeIFDEntry(e){const t=this.offset,a=this.readUint16(),i=this.readUint16(),n=this.readUint32();if(1>i||12<i)return void this.skip(4);const o=getByteLength$1(i,n);4<o&&this.seek(this.readUint32());const s=readData$1(this,i,n);if(e.fields.set(a,s),34665===a||34853===a){let t=this.offset,i;34665===a?i="exif":34853===a&&(i="gps"),this._nextIFD=s,e[i]=this.decodeIFD({kind:i,ignoreImageData:!0}),this.offset=t}this.seek(t),this.skip(12)}decodeImageData(e){const t=e.orientation;if(t&&1!==t)throw unsupported$1("orientation",t);switch(e.type){case 0:case 1:case 2:this.readStripData(e);break;default:throw unsupported$1("image type",e.type);}if(0===e.type){const t=validateBitDepth$1(e.bitsPerSample),i=_Mathpow(2,t)-1;for(var a=0;a<e.data.length;a++)e.data[a]=i-e.data[a]}}readStripData(e){const t=e.width,a=e.height,n=validateBitDepth$1(e.bitsPerSample),o=e.sampleFormat,s=t*a,l=getDataArray$1(s,1,n,o),r=e.compression,d=e.rowsPerStrip,h=d*t,g=e.stripOffsets,c=e.stripByteCounts;for(var m=s,p=0,u=0;u<g.length;u++){var f=new DataView(this.buffer,g[u],c[u]),b=m>h?h:m;switch(m-=b,r){case 1:p=this.fillUncompressed(n,o,l,f,p,b);break;case 5:throw unsupported$1("lzw");case 2:case 32773:throw unsupported$1("Compression",r);default:throw new Error(`invalid compression: ${r}`);}}e.data=l}fillUncompressed(e,t,a,i,n,o){if(8===e)return fill8bit$1(a,i,n,o);if(16===e)return fill16bit$1(a,i,n,o,this.isLittleEndian());if(32===e&&3===t)return fillFloat32$1(a,i,n,o,this.isLittleEndian());throw unsupported$1("bitDepth",e)}}var fileType_1=createCommonjsModule(function(module){function readUInt64LE(e,t=0){let a=e[t],o=1,s=0;for(;8>++s;)o*=256,a+=e[t+s]*o;return a}const toBytes=e=>[...e].map(e=>e.charCodeAt(0)),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels"),fileType=e=>{if(!(e instanceof Uint8Array||Buffer.isBuffer(e)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\`, got \`${typeof e}\``);const t=e instanceof Uint8Array?e:new Uint8Array(e);if(!(t&&1<t.length))return null;const a=(e,a)=>{a=Object.assign({offset:0},a);for(let n=0;n<e.length;n++)if(a.mask){if(e[n]!==(a.mask[n]&t[n+a.offset]))return!1;}else if(e[n]!==t[n+a.offset])return!1;return!0},i=(e,t)=>a(toBytes(e),t);if(a([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(a([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(a([71,73,70]))return{ext:"gif",mime:"image/gif"};if(a([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(a([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((a([73,73,42,0])||a([77,77,0,42]))&&a([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(a([73,73,42,0])||a([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(a([66,77]))return{ext:"bmp",mime:"image/bmp"};if(a([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(a([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(a([80,75,3,4])){if(a([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(a(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(i("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(i("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(i("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const e=(e,t=0)=>e.findIndex((e,a,i)=>a>=t&&80===i[a]&&75===i[a+1]&&3===i[a+2]&&4===i[a+3]);let n=0,o=!1,s=null;do{const l=n+30;if(o||(o=a(oxmlContentTypes,{offset:l})||a(oxmlRels,{offset:l})),s||(i("word/",{offset:l})?s={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:i("ppt/",{offset:l})?s={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:i("xl/",{offset:l})&&(s={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),o&&s)return s;n=e(t,l)}while(0<=n);if(s)return s}if(a([80,75])&&(3===t[2]||5===t[2]||7===t[2])&&(4===t[3]||6===t[3]||8===t[3]))return{ext:"zip",mime:"application/zip"};if(a([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(a([82,97,114,33,26,7])&&(0===t[6]||1===t[6]))return{ext:"rar",mime:"application/x-rar-compressed"};if(a([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(a([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(a([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(a([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(a([51,103,112,53])||a([0,0,0])&&a([102,116,121,112],{offset:4})&&(a([109,112,52,49],{offset:8})||a([109,112,52,50],{offset:8})||a([105,115,111,109],{offset:8})||a([105,115,111,50],{offset:8})||a([109,109,112,52],{offset:8})||a([77,52,86],{offset:8})||a([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(a([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(a([26,69,223,163])){const e=t.subarray(4,4100),a=e.findIndex((e,t,a)=>66===a[t]&&130===a[t+1]);if(-1!==a){const t=t=>[...t].every((t,n)=>e[a+3+n]===t.charCodeAt(0));if(t("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(t("webm"))return{ext:"webm",mime:"video/webm"}}}if(a([0,0,0,20,102,116,121,112,113,116,32,32])||a([102,114,101,101],{offset:4})||a([102,116,121,112,113,116,32,32],{offset:4})||a([109,100,97,116],{offset:4})||a([109,111,111,118],{offset:4})||a([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(a([82,73,70,70])){if(a([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(a([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(a([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(a([48,38,178,117,142,102,207,17,166,217])){let e=30;do{const i=readUInt64LE(t,e+16);if(a([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:e})){if(a([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:e+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(a([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:e+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}e+=i}while(e+24<=t.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(a([0,0,1,186])||a([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(a([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let i=0;2>i&&i<t.length-16;i++){if(a([73,68,51],{offset:i})||a([255,226],{offset:i,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(a([255,228],{offset:i,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(a([255,248],{offset:i,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(a([255,240],{offset:i,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(a([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(a([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(a([79,103,103,83]))return a([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:a([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:a([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:a([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:a([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(a([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(a([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(a([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(a([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(a([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(a([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((67===t[0]||70===t[0])&&a([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(a([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(a([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(a([119,79,70,70])&&(a([0,1,0,0],{offset:4})||a([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(a([119,79,70,50])&&(a([0,1,0,0],{offset:4})||a([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(a([76,80],{offset:34})&&(a([0,0,1],{offset:8})||a([1,0,2],{offset:8})||a([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(a([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(a([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(a([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(a([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(a([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(a([37,33]))return{ext:"ps",mime:"application/postscript"};if(a([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(a([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(a([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(a([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(a([77,83,67,70])||a([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(a([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(a([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(a([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(a([31,160])||a([31,157]))return{ext:"Z",mime:"application/x-compress"};if(a([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(a([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(a([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(a([71],{offset:4})&&(a([71],{offset:192})||a([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(a([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(a([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(a([0,0,0,12,106,80,32,32,13,10,135,10])){if(a([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(a([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(a([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(a([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(a([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(i("<?xml "))return{ext:"xml",mime:"application/xml"};if(a([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(a([102,116,121,112],{offset:4})){if(a([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(a([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(a([104,101,105,99],{offset:8})||a([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(a([104,101,118,99],{offset:8})||a([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return a([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:a([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:a([77,80,43])?{ext:"mpc",mime:"audio/x-musepack"}:a([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:a([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:a([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:a([212,195,178,161])||a([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise(resolve=>{const stream=eval("require")("stream");readableStream.once("readable",()=>{const e=new stream.PassThrough,t=readableStream.read(module.exports.minimumBytes)||readableStream.read();e.fileType=fileType(t),readableStream.unshift(t),stream.pipeline?resolve(stream.pipeline(readableStream,e)):resolve(readableStream.pipe(e))})})}),fileType_2=fileType_1.stream;const imageExts=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),imageType=e=>{const t=fileType_1(e);return imageExts.has(t&&t.ext)?t:null};var imageType_1=imageType,default_1=imageType;Object.defineProperty(imageType,"minimumBytes",{value:fileType_1.minimumBytes}),imageType_1.default=default_1;var computedPropertyDescriptor$1={configurable:!0,enumerable:!1,get:void 0};class Stack extends Array{constructor(e){if(Array.isArray(e)){super(e.length);for(var t=0;t<e.length;t++)this[t]=e[t]}else"number"==typeof e?super(e):super();this.computed=null}static load(e){return Promise.all(e.map(Image.load)).then(e=>new Stack(e))}static extendMethod(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=a.inPlace,n=a.returnThis,o=a.partialArgs,s=void 0===o?[]:o;return Stack.prototype[e]=void 0!==i&&i?function(){this.computed=null;for(var e=arguments.length,a=Array(e),i=0;i<e;i++)a[i]=arguments[i];var o=t.apply(this,[...s,...a]);return void 0===n||n?this:o}:function(){for(var e=arguments.length,a=Array(e),i=0;i<e;i++)a[i]=arguments[i];return t.apply(this,[...s,...a])},Stack}static extendProperty(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=a.partialArgs,n=void 0===i?[]:i;return computedPropertyDescriptor$1.get=function(){if(null===this.computed)this.computed={};else if(hasOwn(e,this.computed))return this.computed[e];var a=t.apply(this,n);return this.computed[e]=a,a},Object.defineProperty(Stack.prototype,e,computedPropertyDescriptor$1),Stack}checkProcessable(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};if("string"!=typeof e)throw new TypeError("checkProcessable requires as first parameter the processName (a string)");if(0===this.size)throw new TypeError("The process: ".concat(e," can not be applied on an empty stack"));this[0].checkProcessable(e,t);for(var a=1;a<this.length;a++){if((t.sameSize===void 0||t.sameSize)&&this[0].width!==this[a].width)throw new TypeError("The process: ".concat(e," can not be applied if width is not identical in all images"));if((void 0===t.sameSize||t.sameSize)&&this[0].height!==this[a].height)throw new TypeError("The process: ".concat(e," can not be applied if height is not identical in all images"));if((void 0===t.sameAlpha||t.sameAlpha)&&this[0].alpha!==this[a].alpha)throw new TypeError("The process: ".concat(e," can not be applied if alpha is not identical in all images"));if((void 0===t.sameBitDepth||t.sameBitDepth)&&this[0].bitDepth!==this[a].bitDepth)throw new TypeError("The process: ".concat(e," can not be applied if bitDepth is not identical in all images"));if((void 0===t.sameColorModel||t.sameColorModel)&&this[0].colorModel!==this[a].colorModel)throw new TypeError("The process: ".concat(e," can not be applied if colorModel is not identical in all images"));if((void 0===t.sameNumberChannels||t.sameNumberChannels)&&this[0].channels!==this[a].channels)throw new TypeError("The process: ".concat(e," can not be applied if channels is not identical in all images"))}}}Array[Symbol.species]||(Stack.prototype.map=function(e,t){if("function"!=typeof e)throw new TypeError("".concat(e," is not a function"));for(var a=new Stack(this.length),n=0;n<this.length;n++)a[n]=e.call(t,this[n],n,this);return a}),extend(Stack);var isDataURL=/^data:[a-z]+\/([a-z]+);base64,/,valueMethods={getValueXY(e,t,a){return this.data[(t*this.width+e)*this.channels+a]},setValueXY(e,t,a,i){return this.data[(t*this.width+e)*this.channels+a]=i,this.computed=null,this},getValue(e,t){return this.data[e*this.channels+t]},setValue(e,t,a){return this.data[e*this.channels+t]=a,this.computed=null,this},getPixelXY(e,t){return this.getPixel(t*this.width+e)},setPixelXY(e,t,a){return this.setPixel(t*this.width+e,a)},getPixel(e){for(var t=Array(this.channels),a=e*this.channels,n=0;n<this.channels;n++)t[n]=this.data[a+n];return t},setPixel(e,t){for(var a=e*this.channels,n=0;n<t.length;n++)this.data[a+n]=t[n];return this.computed=null,this}},numberIsNan=_NumberisNaN||function(e){return e!==e},asc=function(e,t){return assertNum(e),assertNum(t),e-t},DISCRETE_LAPLACE_4=[[0,1,0],[1,-4,1],[0,1,0]],DISCRETE_LAPLACE_8=[[1,1,1],[1,-8,1],[1,1,1]],SOBEL_X=[[-1,0,1],[-2,0,2],[-1,0,1]],SOBEL_Y=[[-1,-2,-1],[0,0,0],[1,2,1]],SCHARR_X=[[3,0,-3],[10,0,-10],[3,0,-3]],SCHARR_Y=[[3,10,3],[0,0,0],[-3,-10,-3]],SECOND_DERIVATIVE=[[-1,-2,0,2,1],[-2,-4,0,4,2],[0,0,0,0,0],[1,2,0,-2,-1],[2,4,0,-4,-2]],SECOND_DERIVATIVE_INV=[[1,2,0,-2,-1],[2,4,0,-4,-2],[0,0,0,0,0],[-2,-4,0,4,2],[-1,-2,0,2,1]],fftlib=createCommonjsModule(function(e,t){(function(){var e=t;var a={release:"0.3.0",date:"2013-03"};e.toString=function(){return"version "+a.release+", released "+a.date};for(var o=0,n=null,l=null,r={init:function(e){if(0!==e&&0==(e&e-1))o=e,r._initArray(),r._makeBitReversalTable(),r._makeCosSinTable();else throw new Error("init: radix-2 required")},fft1d:function(e,t){r.fft(e,t,1)},ifft1d:function(e,t){var a=1/o;r.fft(e,t,-1);for(var n=0;n<o;n++)e[n]*=a,t[n]*=a},bt1d:function(e,t){r.fft(e,t,-1)},fft2d:function(e,t){for(var a=[],n=[],s=0,l=0;l<o;l++){s=l*o;for(var d=0;d<o;d++)a[d]=e[d+s],n[d]=t[d+s];r.fft1d(a,n);for(var h=0;h<o;h++)e[h+s]=a[h],t[h+s]=n[h]}for(var g=0;g<o;g++){for(var c=0;c<o;c++)s=g+c*o,a[c]=e[s],n[c]=t[s];r.fft1d(a,n);for(var m=0;m<o;m++)s=g+m*o,e[s]=a[m],t[s]=n[m]}},ifft2d:function(e,t){for(var a=[],n=[],s=0,l=0;l<o;l++){s=l*o;for(var d=0;d<o;d++)a[d]=e[d+s],n[d]=t[d+s];r.ifft1d(a,n);for(var h=0;h<o;h++)e[h+s]=a[h],t[h+s]=n[h]}for(var g=0;g<o;g++){for(var c=0;c<o;c++)s=g+c*o,a[c]=e[s],n[c]=t[s];r.ifft1d(a,n);for(var m=0;m<o;m++)s=g+m*o,e[s]=a[m],t[s]=n[m]}},fft:function(e,t,a){for(var s=o>>2,r=0,g,c,p,u,f,b,_,w,x;r<o;r++)u=n[r],r<u&&(f=e[r],e[r]=e[u],e[u]=f,f=t[r],t[r]=t[u],t[u]=f);for(var y=1;y<o;y<<=1){c=0,g=o/(y<<1);for(var v=0;v<y;v++){b=l[c+s],_=a*l[c];for(var D=v;D<o;D+=y<<1)p=D+y,w=b*e[p]+_*t[p],x=b*t[p]-_*e[p],e[p]=e[D]-w,e[D]+=w,t[p]=t[D]-x,t[D]+=x;c+=g}}},_initArray:function(){n="undefined"==typeof Uint32Array?[]:new Uint32Array(o),l="undefined"==typeof Float64Array?[]:new Float64Array(1.25*o)},_paddingZero:function(){},_makeBitReversalTable:function(){var e=0,t=0,a=0;for(n[0]=0;++e<o;){for(a=o>>1;a<=t;)t-=a,a>>=1;t+=a,n[e]=t}},_makeCosSinTable:function(){var e=o>>1,a=o>>2,n=o>>3,r=_Mathsin(_MathPI/o),d=2*r*r,h=_Mathsqrt(d*(2-d)),g=l[a]=1,m=l[0]=0;r=2*d;for(var p=1;p<n;p++)g-=d,d+=r*g,m+=h,h-=r*m,l[p]=m,l[a-p]=g;0!=n&&(l[n]=_Mathsqrt(.5));for(var u=0;u<a;u++)l[e-u]=l[u];for(var f=0;f<e+a;f++)l[f+e]=-l[f]}},d=["init","fft1d","ifft1d","fft2d","ifft2d"],h=0;h<d.length;h++)e[d[h]]=r[d[h]];return e.bt=r.bt1d,e.fft=r.fft1d,e.ifft=r.ifft1d,e}).call(commonjsGlobal)}),FFTUtils={DEBUG:!1,ifft2DArray:function(e,t,a){var i=Array(t*a),n=t/2,o=2*(a-1);fftlib.init(n);for(var s={re:Array(n),im:Array(n)},l=0;l<a;l++){for(var r=n-1;0<=r;r--)s.re[r]=e[2*r*a+l],s.im[r]=e[(2*r+1)*a+l];fftlib.bt(s.re,s.im);for(var r=n-1;0<=r;r--)i[2*r*a+l]=s.re[r],i[(2*r+1)*a+l]=s.im[r]}var d=Array(n*o);fftlib.init(o);for(var h={re:Array(o),im:Array(o)},r=0;r<t;r+=2){h.re[0]=i[r*a],h.im[0]=i[(r+1)*a];for(var l=1;l<a;l++)h.re[l]=i[r*a+l],h.im[l]=i[(r+1)*a+l],h.re[o-l]=i[r*a+l],h.im[o-l]=-i[(r+1)*a+l];fftlib.bt(h.re,h.im);for(var g=r/2*o,l=o-1;0<=l;l--)d[g+l]=h.re[l]/(o*n)}return d},fft2DArray:function(e,t,a){var i=Object.assign({},{inplace:!0}),n=a/2+1,o=2*t,s=Array(o*n);fftlib.init(a);for(var l={re:Array(a),im:Array(a)},r={re:Array(a),im:Array(a)},d={re:Array(a),im:Array(a)},h=0,g,c,m,p,u;h<t/2;h++){g=2*h*a,l.re=e.slice(g,g+a),g=(2*h+1)*a,l.im=e.slice(g,g+a),fftlib.fft1d(l.re,l.im),this.reconstructTwoRealFFT(l,r,d),c=4*h*n,m=(4*h+1)*n,p=(4*h+2)*n,u=(4*h+3)*n;for(var f=n-1;0<=f;f--)s[c+f]=r.re[f],s[m+f]=r.im[f],s[p+f]=d.re[f],s[u+f]=d.im[f]}r=null,d=null;var b=Array(o*n);fftlib.init(t);for(var _={re:Array(t),im:Array(t)},w=n-1;0<=w;w--){for(var h=t-1;0<=h;h--)_.re[h]=s[2*h*n+w],_.im[h]=s[(2*h+1)*n+w],isNaN(_.re[h])&&(_.re[h]=0),isNaN(_.im[h])&&(_.im[h]=0);fftlib.fft1d(_.re,_.im);for(var h=t-1;0<=h;h--)b[2*h*n+w]=_.re[h],b[(2*h+1)*n+w]=_.im[h]}return b},reconstructTwoRealFFT:function(e,t,a){var n=e.re.length;t.re[0]=e.re[0],t.im[0]=0,a.re[0]=e.im[0],a.im[0]=0;for(var o=n/2,s,l,r,d,h;0<o;o--)h=n-o,s=.5*(e.re[o]-e.re[h]),l=.5*(e.re[o]+e.re[h]),r=.5*(e.im[o]-e.im[h]),d=.5*(e.im[o]+e.im[h]),t.re[o]=l,t.im[o]=r,t.re[h]=l,t.im[h]=-r,a.re[o]=d,a.im[o]=-s,a.re[h]=d,a.im[h]=s},convolute2DI:function(e,t,a,i){for(var n=0,o,s;n<a/2;n++)for(var l=0;l<i;l++)o=e[2*n*i+l]*t[2*n*i+l]-e[(2*n+1)*i+l]*t[(2*n+1)*i+l],s=e[2*n*i+l]*t[(2*n+1)*i+l]+e[(2*n+1)*i+l]*t[2*n*i+l],e[2*n*i+l]=o,e[(2*n+1)*i+l]=s},convolute:function(e,t,a,n){for(var o=Array(n*a),s=0;s<a*n;s++)o[s]=e[s];o=this.fft2DArray(o,a,n);for(var l=t.length,r=t[0].length,d=Array(n*a),s=0;s<n*a;s++)d[s]=0;for(var h=_Mathfloor((l-1)/2),g=_Mathfloor((r-1)/2),c=0,m,p;c<l;c++){m=(c-h+a)%a;for(var u=0;u<r;u++)p=(u-g+n)%n,d[m*n+p]=t[c][u]}d=this.fft2DArray(d,a,n);var f=2*a,b=n/2+1;return this.convolute2DI(o,d,f,b),this.ifft2DArray(o,f,b)},toRadix2:function(e,t,a){var n=a,o=t,s,l,r,d;if(0===a||0!=(a&a-1)){for(n=0;0!=a>>++n;);n=1<<n}if(0===t||0!=(t&t-1)){for(o=0;0!=t>>++o;);o=1<<o}if(o==t&&n==a)return{data:e,rows:t,cols:a};var h=Array(o*n),g=_Mathfloor((o-t)/2)-t,c=_Mathfloor((n-a)/2)-a;for(s=0;s<o;s++)for(r=s*n,d=(s-g)%t*a,l=0;l<n;l++)h[r+l]=e[d+(l-c)%a];return{data:h,rows:o,cols:n}},crop:function(e,t,a,n,o,s){if(t==n&&a==o)return e;var l=Object.assign({},s),r=Array(o*n),d=_Mathfloor((t-n)/2),h=_Mathfloor((a-o)/2),g,c,m,p;for(m=0;m<n;m++)for(g=m*o,c=(m+d)*a,p=0;p<o;p++)r[g+p]=e[c+(p+h)];return r}},FFTUtils_1=FFTUtils,FFTUtils$1=FFTUtils_1,FFT=fftlib,src$1={FFTUtils:FFTUtils$1,FFT:FFT},FFTUtils$2=src$1.FFTUtils,src$2={fft:convolutionFFT,direct:convolutionDirect,kernelFactory:{LoG:LoG},matrix2Array:matrix2Array},src_1=src$2.fft,src_2=src$2.direct,_isFinite=Number.isFinite||function(e){return!("number"!=typeof e||numberIsNan(e)||e===1/0||e===-Infinity)},isInteger=_NumberisInteger||function(e){return"number"==typeof e&&_isFinite(e)&&_Mathfloor(e)===e};const toString$2=Object.prototype.toString;var src$3=isAnyArray;class LuDecomposition{constructor(e){e=WrapperMatrix2D.checkMatrix(e);var a=e.clone(),n=a.rows,o=a.columns,l=Array(n),r=1,d,h,g,c,m,u,f,b,_;for(d=0;d<n;d++)l[d]=d;for(b=Array(n),h=0;h<o;h++){for(d=0;d<n;d++)b[d]=a.get(d,h);for(d=0;d<n;d++){for(_=_Mathmin(d,h),m=0,g=0;g<_;g++)m+=a.get(d,g)*b[g];b[d]-=m,a.set(d,h,b[d])}for(c=h,d=h+1;d<n;d++)_Mathabs(b[d])>_Mathabs(b[c])&&(c=d);if(c!==h){for(g=0;g<o;g++)u=a.get(c,g),a.set(c,g,a.get(h,g)),a.set(h,g,u);f=l[c],l[c]=l[h],l[h]=f,r=-r}if(h<n&&0!==a.get(h,h))for(d=h+1;d<n;d++)a.set(d,h,a.get(d,h)/a.get(h,h))}this.LU=a,this.pivotVector=l,this.pivotSign=r}isSingular(){for(var e=this.LU,t=e.columns,a=0;a<t;a++)if(0===e[a][a])return!0;return!1}solve(e){e=Matrix.checkMatrix(e);var t=this.LU,a=t.rows;if(a!==e.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");var n=e.columns,o=e.subMatrixRow(this.pivotVector,0,n-1),s=t.columns,l,r,d;for(d=0;d<s;d++)for(l=d+1;l<s;l++)for(r=0;r<n;r++)o[l][r]-=o[d][r]*t[l][d];for(d=s-1;0<=d;d--){for(r=0;r<n;r++)o[d][r]/=t[d][d];for(l=0;l<d;l++)for(r=0;r<n;r++)o[l][r]-=o[d][r]*t[l][d]}return o}get determinant(){var e=this.LU;if(!e.isSquare())throw new Error("Matrix must be square");for(var t=this.pivotSign,a=e.columns,i=0;i<a;i++)t*=e[i][i];return t}get lowerTriangularMatrix(){for(var e=this.LU,t=e.rows,a=e.columns,n=new Matrix(t,a),o=0;o<t;o++)for(var s=0;s<a;s++)n[o][s]=o>s?e[o][s]:o==s?1:0;return n}get upperTriangularMatrix(){for(var e=this.LU,t=e.rows,a=e.columns,n=new Matrix(t,a),o=0;o<t;o++)for(var s=0;s<a;s++)n[o][s]=o<=s?e[o][s]:0;return n}get pivotPermutationVector(){return this.pivotVector.slice()}}class SingularValueDecomposition{constructor(t,i={}){t=WrapperMatrix2D.checkMatrix(t);var o=t.rows,l=t.columns;const{computeLeftSingularVectors:r=!0,computeRightSingularVectors:d=!0,autoTranspose:h=!1}=i;var c=!!r,u=!!d,f=!1,b;if(!(o<l))b=t.clone();else if(!h)b=t.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{b=t.transpose(),o=b.rows,l=b.columns,f=!0;var g=c;c=u,u=g}var _=_Mathmin(o,l),w=_Mathmin(o+1,l),x=Array(w),s=getFilled2DArray(o,_,0),y=getFilled2DArray(l,l,0),v=Array(l),e=Array(o),k=Array(w);for(let e=0;e<w;e++)k[e]=e;var D=_Mathmin(o-1,l),S=_Mathmax(0,_Mathmin(l-2,o)),I=_Mathmax(D,S);for(let a=0;a<I;a++){if(a<D){x[a]=0;for(let e=a;e<o;e++)x[a]=hypotenuse(x[a],b[e][a]);if(0!==x[a]){0>b[a][a]&&(x[a]=-x[a]);for(let e=a;e<o;e++)b[e][a]/=x[a];b[a][a]+=1}x[a]=-x[a]}for(let e=a+1;e<l;e++){if(a<D&&0!==x[a]){let n=0;for(let t=a;t<o;t++)n+=b[t][a]*b[t][e];n=-n/b[a][a];for(let t=a;t<o;t++)b[t][e]+=n*b[t][a]}v[e]=b[a][e]}if(c&&a<D)for(let e=a;e<o;e++)s[e][a]=b[e][a];if(a<S){v[a]=0;for(let e=a+1;e<l;e++)v[a]=hypotenuse(v[a],v[e]);if(0!==v[a]){0>v[a+1]&&(v[a]=0-v[a]);for(let e=a+1;e<l;e++)v[e]/=v[a];v[a+1]+=1}if(v[a]=-v[a],a+1<o&&0!==v[a]){for(let t=a+1;t<o;t++)e[t]=0;for(let t=a+1;t<o;t++)for(let i=a+1;i<l;i++)e[t]+=v[i]*b[t][i];for(let n=a+1,s;n<l;n++){s=-v[n]/v[a+1];for(let t=a+1;t<o;t++)b[t][n]+=s*e[t]}}if(u)for(let e=a+1;e<l;e++)y[e][a]=v[e]}}let P=_Mathmin(l,o+1);if(D<l&&(x[D]=b[D][D]),o<P&&(x[P-1]=0),S+1<P&&(v[S]=b[S][P-1]),v[P-1]=0,c){for(let e=D;e<_;e++){for(let t=0;t<o;t++)s[t][e]=0;s[e][e]=1}for(let e=D-1;0<=e;e--)if(0!==x[e]){for(let a=e+1,n;a<_;a++){n=0;for(let t=e;t<o;t++)n+=s[t][e]*s[t][a];n=-n/s[e][e];for(let t=e;t<o;t++)s[t][a]+=n*s[t][e]}for(let t=e;t<o;t++)s[t][e]=-s[t][e];s[e][e]=1+s[e][e];for(let t=0;t<e-1;t++)s[t][e]=0}else{for(let t=0;t<o;t++)s[t][e]=0;s[e][e]=1}}if(u)for(let e=l-1;0<=e;e--){if(e<S&&0!==v[e])for(let a=e+1,n;a<l;a++){n=0;for(let t=e+1;t<l;t++)n+=y[t][e]*y[t][a];n=-n/y[e+1][e];for(let t=e+1;t<l;t++)y[t][a]+=n*y[t][e]}for(let t=0;t<l;t++)y[t][e]=0;y[e][e]=1}for(var M=P-1,B=_NumberEPSILON;0<P;){let e,t;for(e=P-2;-1<=e&&-1!==e;e--){const t=_NumberMIN_VALUE+B*_Mathabs(x[e]+_Mathabs(x[e+1]));if(_Mathabs(v[e])<=t||_NumberisNaN(v[e])){v[e]=0;break}}if(e===P-2)t=4;else{let a;for(a=P-1;a>=e&&a!==e;a--){let i=(a===P?0:_Mathabs(v[a]))+(a===e+1?0:_Mathabs(v[a-1]));if(_Mathabs(x[a])<=B*i){x[a]=0;break}}a===e?t=3:a===P-1?t=1:(t=2,e=a)}switch(e++,t){case 1:{let a=v[P-2];v[P-2]=0;for(let n=P-2;n>=e;n--){let o=hypotenuse(x[n],a),t=x[n]/o,s=a/o;if(x[n]=o,n!==e&&(a=-s*v[n-1],v[n-1]=t*v[n-1]),u)for(let e=0;e<l;e++)o=t*y[e][n]+s*y[e][P-1],y[e][P-1]=-s*y[e][n]+t*y[e][P-1],y[e][n]=o}break}case 2:{let a=v[e-1];v[e-1]=0;for(let n=e;n<P;n++){let l=hypotenuse(x[n],a),t=x[n]/l,r=a/l;if(x[n]=l,a=-r*v[n],v[n]=t*v[n],c)for(let a=0;a<o;a++)l=t*s[a][n]+r*s[a][e-1],s[a][e-1]=-r*s[a][n]+t*s[a][e-1],s[a][n]=l}break}case 3:{const t=_Mathmax(_Mathabs(x[P-1]),_Mathabs(x[P-2]),_Mathabs(v[P-2]),_Mathabs(x[e]),_Mathabs(v[e])),a=x[P-1]/t,i=x[P-2]/t,n=v[P-2]/t,r=x[e]/t,d=v[e]/t,h=((i+a)*(i-a)+n*n)/2,m=a*n*(a*n);let p=0;(0!==h||0!==m)&&(p=0>h?0-_Mathsqrt(h*h+m):_Mathsqrt(h*h+m),p=m/(h+p));let b=(r+a)*(r-a)+p,f=r*d;for(let a=e,n;a<P-1;a++){n=hypotenuse(b,f),0===n&&(n=_NumberMIN_VALUE);let t=b/n,r=f/n;if(a!==e&&(v[a-1]=n),b=t*x[a]+r*v[a],v[a]=t*v[a]-r*x[a],f=r*x[a+1],x[a+1]=t*x[a+1],u)for(let e=0;e<l;e++)n=t*y[e][a]+r*y[e][a+1],y[e][a+1]=-r*y[e][a]+t*y[e][a+1],y[e][a]=n;if(n=hypotenuse(b,f),0===n&&(n=_NumberMIN_VALUE),t=b/n,r=f/n,x[a]=n,b=t*v[a]+r*x[a+1],x[a+1]=-r*v[a]+t*x[a+1],f=r*v[a+1],v[a+1]=t*v[a+1],c&&a<o-1)for(let e=0;e<o;e++)n=t*s[e][a]+r*s[e][a+1],s[e][a+1]=-r*s[e][a]+t*s[e][a+1],s[e][a]=n}v[P-2]=b;break}case 4:{if(0>=x[e]&&(x[e]=0>x[e]?-x[e]:0,u))for(let t=0;t<=M;t++)y[t][e]=-y[t][e];for(;e<M&&!(x[e]>=x[e+1]);){let a=x[e];if(x[e]=x[e+1],x[e+1]=a,u&&e<l-1)for(let t=0;t<l;t++)a=y[t][e+1],y[t][e+1]=y[t][e],y[t][e]=a;if(c&&e<o-1)for(let t=0;t<o;t++)a=s[t][e+1],s[t][e+1]=s[t][e],s[t][e]=a;e++}P--;break}}}if(f){var C=y;y=s,s=C}this.m=o,this.n=l,this.s=x,this.U=s,this.V=y}solve(t){var a=this.threshold,e=this.s.length,n=Matrix.zeros(e,e);for(let o=0;o<e;o++)n[o][o]=_Mathabs(this.s[o])<=a?0:1/this.s[o];var o=this.U,i=this.rightSingularVectors,s=i.mmul(n),l=i.rows,r=o.length,d=Matrix.zeros(l,r);for(let a=0;a<l;a++)for(let t=0,i;t<r;t++){i=0;for(let n=0;n<e;n++)i+=s[a][n]*o[t][n];d[a][t]=i}return d.mmul(t)}solveForDiagonal(e){return this.solve(Matrix.diag(e))}inverse(){var t=this.V,a=this.threshold,e=t.length,n=t[0].length,o=new Matrix(e,this.s.length);for(let s=0;s<e;s++)for(let e=0;e<n;e++)o[s][e]=_Mathabs(this.s[e])>a?t[s][e]/this.s[e]:0;var s=this.U,l=s.length,r=s[0].length,d=new Matrix(e,l);for(let t=0;t<e;t++)for(let e=0,a;e<l;e++){a=0;for(let i=0;i<r;i++)a+=o[t][i]*s[e][i];d[t][e]=a}return d}get condition(){return this.s[0]/this.s[_Mathmin(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){for(var e=_Mathmax(this.m,this.n)*this.s[0]*_NumberEPSILON,t=0,a=this.s,n=0,o=a.length;n<o;n++)a[n]>e&&t++;return t}get diagonal(){return this.s}get threshold(){return _NumberEPSILON/2*_Mathmax(this.m,this.n)*this.s[0]}get leftSingularVectors(){return Matrix.isMatrix(this.U)||(this.U=new Matrix(this.U)),this.U}get rightSingularVectors(){return Matrix.isMatrix(this.V)||(this.V=new Matrix(this.V)),this.V}get diagonalMatrix(){return Matrix.diag(this.s)}}class BaseView extends AbstractMatrix(){constructor(e,t,a){super(),this.matrix=e,this.rows=t,this.columns=a}static get[Symbol.species](){return Matrix}}class MatrixTransposeView extends BaseView{constructor(e){super(e,e.columns,e.rows)}set(e,t,a){return this.matrix.set(t,e,a),this}get(e,t){return this.matrix.get(t,e)}}class MatrixRowView extends BaseView{constructor(e,t){super(e,1,e.columns),this.row=t}set(e,t,a){return this.matrix.set(this.row,t,a),this}get(e,t){return this.matrix.get(this.row,t)}}class MatrixSubView extends BaseView{constructor(e,t,a,i,n){checkRange(e,t,a,i,n),super(e,a-t+1,n-i+1),this.startRow=t,this.startColumn=i}set(e,t,a){return this.matrix.set(this.startRow+e,this.startColumn+t,a),this}get(e,t){return this.matrix.get(this.startRow+e,this.startColumn+t)}}class MatrixSelectionView extends BaseView{constructor(e,t,a){var i=checkIndices(e,t,a);super(e,i.row.length,i.column.length),this.rowIndices=i.row,this.columnIndices=i.column}set(e,t,a){return this.matrix.set(this.rowIndices[e],this.columnIndices[t],a),this}get(e,t){return this.matrix.get(this.rowIndices[e],this.columnIndices[t])}}class MatrixRowSelectionView extends BaseView{constructor(e,t){t=checkRowIndices(e,t),super(e,t.length,e.columns),this.rowIndices=t}set(e,t,a){return this.matrix.set(this.rowIndices[e],t,a),this}get(e,t){return this.matrix.get(this.rowIndices[e],t)}}class MatrixColumnSelectionView extends BaseView{constructor(e,t){t=checkColumnIndices(e,t),super(e,e.rows,t.length),this.columnIndices=t}set(e,t,a){return this.matrix.set(e,this.columnIndices[t],a),this}get(e,t){return this.matrix.get(e,this.columnIndices[t])}}class MatrixColumnView extends BaseView{constructor(e,t){super(e,e.rows,1),this.column=t}set(e,t,a){return this.matrix.set(e,this.column,a),this}get(e){return this.matrix.get(e,this.column)}}class MatrixFlipRowView extends BaseView{constructor(e){super(e,e.rows,e.columns)}set(e,t,a){return this.matrix.set(this.rows-e-1,t,a),this}get(e,t){return this.matrix.get(this.rows-e-1,t)}}class MatrixFlipColumnView extends BaseView{constructor(e){super(e,e.rows,e.columns)}set(e,t,a){return this.matrix.set(e,this.columns-t-1,a),this}get(e,t){return this.matrix.get(e,this.columns-t-1)}}class Matrix extends AbstractMatrix(Array){constructor(e,t){var a;if(1===arguments.length&&"number"==typeof e)return Array(e);if(Matrix.isMatrix(e))return e.clone();if(_NumberisInteger(e)&&0<e){if(super(e),_NumberisInteger(t)&&0<t)for(a=0;a<e;a++)this[a]=Array(t);else throw new TypeError("nColumns must be a positive integer");}else if(Array.isArray(e)){const i=e;if(e=i.length,t=i[0].length,"number"!=typeof t||0===t)throw new TypeError("Data must be a 2D array with at least one element");for(super(e),a=0;a<e;a++){if(i[a].length!==t)throw new RangeError("Inconsistent array dimensions");this[a]=[].concat(i[a])}}else throw new TypeError("First argument must be a positive number or an array");return this.rows=e,this.columns=t,this}set(e,t,a){return this[e][t]=a,this}get(e,t){return this[e][t]}removeRow(e){if(checkRowIndex(this,e),1===this.rows)throw new RangeError("A matrix cannot have less than one row");return this.splice(e,1),this.rows-=1,this}addRow(e,t){return void 0===t&&(t=e,e=this.rows),checkRowIndex(this,e,!0),t=checkRowVector(this,t,!0),this.splice(e,0,t),this.rows+=1,this}removeColumn(e){if(checkColumnIndex(this,e),1===this.columns)throw new RangeError("A matrix cannot have less than one column");for(var t=0;t<this.rows;t++)this[t].splice(e,1);return this.columns-=1,this}addColumn(e,t){"undefined"==typeof t&&(t=e,e=this.columns),checkColumnIndex(this,e,!0),t=checkColumnVector(this,t);for(var a=0;a<this.rows;a++)this[a].splice(e,0,t[a]);return this.columns+=1,this}}class WrapperMatrix1D extends AbstractMatrix(){constructor(e,t={}){const{rows:a=1}=t;if(0!=e.length%a)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=a,this.columns=e.length/a,this.data=e}set(e,t,a){var i=this._calculateIndex(e,t);return this.data[i]=a,this}get(e,t){var a=this._calculateIndex(e,t);return this.data[a]}_calculateIndex(e,t){return e*this.columns+t}static get[Symbol.species](){return Matrix}}class WrapperMatrix2D extends AbstractMatrix(){constructor(e){super(),this.data=e,this.rows=e.length,this.columns=e[0].length}set(e,t,a){return this.data[e][t]=a,this}get(e,t){return this.data[e][t]}static get[Symbol.species](){return Matrix}}class QrDecomposition{constructor(e){e=WrapperMatrix2D.checkMatrix(e);var t=e.clone(),a=e.rows,o=e.columns,n=Array(o),l,r,d,h;for(d=0;d<o;d++){var g=0;for(l=d;l<a;l++)g=hypotenuse(g,t.get(l,d));if(0!==g){for(0>t.get(d,d)&&(g=-g),l=d;l<a;l++)t.set(l,d,t.get(l,d)/g);for(t.set(d,d,t.get(d,d)+1),r=d+1;r<o;r++){for(h=0,l=d;l<a;l++)h+=t.get(l,d)*t.get(l,r);for(h=-h/t.get(d,d),l=d;l<a;l++)t.set(l,r,t.get(l,r)+h*t.get(l,d))}}n[d]=-g}this.QR=t,this.Rdiag=n}solve(e){e=Matrix.checkMatrix(e);var t=this.QR,a=t.rows;if(e.rows!==a)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");var o=e.columns,l=e.clone(),r=t.columns,n,d,h,g;for(h=0;h<r;h++)for(d=0;d<o;d++){for(g=0,n=h;n<a;n++)g+=t[n][h]*l[n][d];for(g=-g/t[h][h],n=h;n<a;n++)l[n][d]+=g*t[n][h]}for(h=r-1;0<=h;h--){for(d=0;d<o;d++)l[h][d]/=this.Rdiag[h];for(n=0;n<h;n++)for(d=0;d<o;d++)l[n][d]-=l[h][d]*t[n][h]}return l.subMatrix(0,r-1,0,o-1)}isFullRank(){for(var e=this.QR.columns,t=0;t<e;t++)if(0===this.Rdiag[t])return!1;return!0}get upperTriangularMatrix(){var e=this.QR,t=e.columns,a=new Matrix(t,t),n,o;for(n=0;n<t;n++)for(o=0;o<t;o++)a[n][o]=n<o?e[n][o]:n===o?this.Rdiag[n]:0;return a}get orthogonalMatrix(){var e=this.QR,t=e.rows,a=e.columns,n=new Matrix(t,a),o,l,r,d;for(r=a-1;0<=r;r--){for(o=0;o<t;o++)n[o][r]=0;for(n[r][r]=1,l=r;l<a;l++)if(0!==e[r][r]){for(d=0,o=r;o<t;o++)d+=e[o][r]*n[o][l];for(d=-d/e[r][r],o=r;o<t;o++)n[o][l]+=d*e[o][r]}}return n}}var newArray_1=newArray,toString$3=Object.prototype.toString,isArrayType=function(e){return"Array"===toString$3.call(e).substr(-6,5)};class BaseRegression{constructor(){if(new.target===BaseRegression)throw new Error("BaseRegression must be subclassed")}predict(e){if("number"==typeof e)return this._predict(e);if(Array.isArray(e)){const t=Array(e.length);for(let a=0;a<e.length;a++)t[a]=this._predict(e[a]);return t}throw new TypeError("x must be a number or array")}_predict(){throw new Error("_predict must be implemented")}train(){}toString(){return""}toLaTeX(){return""}score(e,t){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)throw new Error("x and y must be arrays of the same length");const a=e.length,n=Array(a);for(let o=0;o<a;o++)n[o]=this._predict(e[o]);let o=0,s=0,l=0,d=0,h=0,g=0,c=0;for(let r=0;r<a;r++)o+=n[r],s+=t[r],h+=n[r]*n[r],g+=t[r]*t[r],c+=n[r]*t[r],0!==t[r]&&(l+=(t[r]-n[r])*(t[r]-n[r])/t[r]),d=(t[r]-n[r])*(t[r]-n[r]);const i=(a*c-o*s)/_Mathsqrt((a*h-o*o)*(a*g-s*s));return{r:i,r2:i*i,chi2:l,rmsd:d*d/a}}}var euclidean_1=euclidean;euclidean.squared=squaredEuclidean;const squaredEuclidean$1=euclidean_1.squared,defaultOptions$2={sigma:1};class GaussianKernel{constructor(e){e=Object.assign({},defaultOptions$2,e),this.sigma=e.sigma,this.divisor=2*e.sigma*e.sigma}compute(e,t){const a=squaredEuclidean$1(e,t);return _Mathexp(-a/this.divisor)}}var gaussianKernel=GaussianKernel;const defaultOptions$3={degree:1,constant:1,scale:1};class PolynomialKernel{constructor(e){e=Object.assign({},defaultOptions$3,e),this.degree=e.degree,this.constant=e.constant,this.scale=e.scale}compute(e,t){for(var a=0,n=0;n<e.length;n++)a+=e[n]*t[n];return _Mathpow(this.scale*a+this.constant,this.degree)}}var polynomialKernel=PolynomialKernel;const defaultOptions$4={sigma:1,degree:1};class ANOVAKernel{constructor(e){e=Object.assign({},defaultOptions$4,e),this.sigma=e.sigma,this.degree=e.degree}compute(e,t){for(var a=0,n=_Mathmin(e.length,t.length),o=1;o<=n;++o)a+=_Mathpow(_Mathexp(-this.sigma*_Mathpow(_Mathpow(e[o-1],o)-_Mathpow(t[o-1],o),2)),this.degree);return a}}var anovaKernel=ANOVAKernel;const squaredEuclidean$2=euclidean_1.squared,defaultOptions$5={sigma:1};class CauchyKernel{constructor(e){e=Object.assign({},defaultOptions$5,e),this.sigma=e.sigma}compute(e,t){return 1/(1+squaredEuclidean$2(e,t)/(this.sigma*this.sigma))}}var cauchyKernel=CauchyKernel;const defaultOptions$6={sigma:1};class ExponentialKernel{constructor(e){e=Object.assign({},defaultOptions$6,e),this.sigma=e.sigma,this.divisor=2*e.sigma*e.sigma}compute(e,t){const a=euclidean_1(e,t);return _Mathexp(-a/this.divisor)}}var exponentialKernel=ExponentialKernel;class HistogramIntersectionKernel{compute(e,t){for(var a=_Mathmin(e.length,t.length),n=0,o=0;o<a;++o)n+=_Mathmin(e[o],t[o]);return n}}var histogramIntersectionKernel=HistogramIntersectionKernel;const defaultOptions$7={sigma:1};class LaplacianKernel{constructor(e){e=Object.assign({},defaultOptions$7,e),this.sigma=e.sigma}compute(e,t){const a=euclidean_1(e,t);return _Mathexp(-a/this.sigma)}}var laplacianKernel=LaplacianKernel;const squaredEuclidean$3=euclidean_1.squared,defaultOptions$8={constant:1};class MultiquadraticKernel{constructor(e){e=Object.assign({},defaultOptions$8,e),this.constant=e.constant}compute(e,t){return _Mathsqrt(squaredEuclidean$3(e,t)+this.constant*this.constant)}}var multiquadraticKernel=MultiquadraticKernel;const squaredEuclidean$4=euclidean_1.squared,defaultOptions$9={constant:1};class RationalQuadraticKernel{constructor(e){e=Object.assign({},defaultOptions$9,e),this.constant=e.constant}compute(e,t){const a=squaredEuclidean$4(e,t);return 1-a/(a+this.constant)}}var rationalQuadraticKernel=RationalQuadraticKernel;const defaultOptions$a={alpha:.01,constant:-Math.E};class SigmoidKernel{constructor(e){e=Object.assign({},defaultOptions$a,e),this.alpha=e.alpha,this.constant=e.constant}compute(e,t){for(var a=0,n=0;n<e.length;n++)a+=e[n]*t[n];return Math.tanh(this.alpha*a+this.constant)}}var sigmoidKernel=SigmoidKernel;const Matrix$1=Matrix.Matrix,kernelType={gaussian:gaussianKernel,rbf:gaussianKernel,polynomial:polynomialKernel,poly:polynomialKernel,anova:anovaKernel,cauchy:cauchyKernel,exponential:exponentialKernel,histogram:histogramIntersectionKernel,min:histogramIntersectionKernel,laplacian:laplacianKernel,multiquadratic:multiquadraticKernel,rational:rationalQuadraticKernel,sigmoid:sigmoidKernel,mlp:sigmoidKernel};class Kernel{constructor(e,t){if(this.kernelType=e,"linear"!==e)if("string"==typeof e){e=e.toLowerCase();var a=kernelType[e];if(a)this.kernelFunction=new a(t);else throw new Error("unsupported kernel type: "+e)}else if("object"==typeof e&&"function"==typeof e.compute)this.kernelFunction=e;else throw new TypeError("first argument must be a valid kernel type or instance")}compute(e,t){if(void 0===t&&(t=e),"linear"===this.kernelType){var a=new Matrix$1(e);return a.mmul(new Matrix$1(t).transposeView())}const n=new Matrix$1(e.length,t.length);var o,s;if(e===t)for(o=0;o<e.length;o++)for(s=o;s<e.length;s++)n[o][s]=n[s][o]=this.kernelFunction.compute(e[o],e[s]);else for(o=0;o<e.length;o++)for(s=0;s<t.length;s++)n[o][s]=this.kernelFunction.compute(e[o],t[s]);return n}}var kernel=Kernel;const defaultOptions$b={lambda:.1,kernelType:"gaussian",kernelOptions:{},computeCoefficient:!1};class KernelRidgeRegression extends BaseRegression{constructor(e,t,a){if(super(),!0===e)this.alpha=t.alpha,this.inputs=t.inputs,this.kernelType=t.kernelType,this.kernelOptions=t.kernelOptions,this.kernel=new kernel(t.kernelType,t.kernelOptions);else{a=Object.assign({},defaultOptions$b,a);const i=new kernel(a.kernelType,a.kernelOptions),o=i.compute(e),s=e.length;o.add(Matrix.eye(s,s).mul(a.lambda)),this.alpha=solve(o,t),this.inputs=e,this.kernelType=a.kernelType,this.kernelOptions=a.kernelOptions,this.kernel=i}}_predict(e){return this.kernel.compute([e],this.inputs).mmul(this.alpha)[0]}toJSON(){return{name:"kernelRidgeRegression",alpha:this.alpha,inputs:this.inputs,kernelType:this.kernelType,kernelOptions:this.kernelOptions}}static load(e){if("kernelRidgeRegression"!==e.name)throw new TypeError("not a KRR model");return new KernelRidgeRegression(!0,e)}}var array=createCommonjsModule(function(e,t){function a(e,t){return e-t}t.sum=function e(t){for(var e=0,a=0;a<t.length;a++)e+=t[a];return e},t.max=function e(t){for(var e=t[0],a=t.length,n=1;n<a;n++)t[n]>e&&(e=t[n]);return e},t.min=function e(t){for(var e=t[0],a=t.length,n=1;n<a;n++)t[n]<e&&(e=t[n]);return e},t.minMax=function(e){for(var t=e[0],a=e[0],n=e.length,o=1;o<n;o++)e[o]<t&&(t=e[o]),e[o]>a&&(a=e[o]);return{min:t,max:a}},t.arithmeticMean=function(e){for(var t=0,a=e.length,n=0;n<a;n++)t+=e[n];return t/a},t.mean=t.arithmeticMean,t.geometricMean=function(e){for(var t=1,a=e.length,n=0;n<a;n++)t*=e[n];return _Mathpow(t,1/a)},t.logMean=function(e){for(var t=0,a=e.length,n=0;n<a;n++)t+=_Mathlog(e[n]);return t/a},t.grandMean=function(e,t){for(var a=0,o=0,s=e.length,l=0;l<s;l++)a+=t[l]*e[l],o+=t[l];return a/o},t.truncatedMean=function(e,t,n){n===void 0&&(n=!1),n||(e=[].concat(e).sort(a));for(var o=e.length,s=_Mathfloor(o*t),l=0,r=s;r<o-s;r++)l+=e[r];return l/(o-2*s)},t.harmonicMean=function(e){for(var t=0,a=e.length,n=0;n<a;n++){if(0===e[n])throw new RangeError("value at index "+n+"is zero");t+=1/e[n]}return a/t},t.contraHarmonicMean=function(e){for(var t=0,a=0,n=e.length,o=0;o<n;o++)t+=e[o]*e[o],a+=e[o];if(0>a)throw new RangeError("sum of values is negative");return t/a},t.median=function(e,t){t===void 0&&(t=!1),t||(e=[].concat(e).sort(a));var i=e.length,n=_Mathfloor(i/2);return 0==i%2?.5*(e[n-1]+e[n]):e[n]},t.variance=function(e,a){a===void 0&&(a=!0);for(var n=t.mean(e),o=0,s=e.length,l=0,r;l<s;l++)r=e[l]-n,o+=r*r;return a?o/(s-1):o/s},t.standardDeviation=function(e,a){return _Mathsqrt(t.variance(e,a))},t.standardError=function(e){return t.standardDeviation(e)/_Mathsqrt(e.length)},t.robustMeanAndStdev=function(e){var t=0,n=0,o=e.length,s=0;for(s=0;s<o;s++)t+=e[s];t/=o;var l=Array(o);for(s=0;s<o;s++)l[s]=_Mathabs(e[s]-t);return l.sort(a),n=1==o%2?l[(o-1)/2]/.6745:.5*(l[o/2]+l[o/2-1])/.6745,{mean:t,stdev:n}},t.quartiles=function(e,i){"undefined"==typeof i&&(i=!1),i||(e=[].concat(e).sort(a));var n=e.length/4,o=e[_Mathceil(n)-1],s=t.median(e,!0),l=e[_Mathceil(3*n)-1];return{q1:o,q2:s,q3:l}},t.pooledStandardDeviation=function(e,a){return _Mathsqrt(t.pooledVariance(e,a))},t.pooledVariance=function(e,a){"undefined"==typeof a&&(a=!0);for(var n=0,o=0,s=e.length,l=0;l<s;l++){var r=e[l],d=t.variance(r);n+=(r.length-1)*d,o+=a?r.length-1:r.length}return n/o},t.mode=function(e){var t=e.length,a=Array(t),n;for(n=0;n<t;n++)a[n]=0;var o=Array(t),s=0;for(n=0;n<t;n++){var l=o.indexOf(e[n]);0<=l?a[l]++:(o[s]=e[n],a[s]=1,s++)}var r=0,d=0;for(n=0;n<s;n++)a[n]>r&&(r=a[n],d=n);return o[d]},t.covariance=function(e,a,n){"undefined"==typeof n&&(n=!0);var o=t.mean(e),s=t.mean(a);if(e.length!==a.length)throw"Vectors do not have the same dimensions";for(var r=0,d=e.length,l=0;l<d;l++){var h=e[l]-o,g=a[l]-s;r+=h*g}return n?r/(d-1):r/d},t.skewness=function(e,n){"undefined"==typeof n&&(n=!0);for(var o=t.mean(e),s=0,r=0,d=e.length,l=0,h;l<d;l++)h=e[l]-o,s+=h*h,r+=h*h*h;var c=s/d,m=r/d,p=m/_Mathpow(c,3/2);if(n){var g=_Mathsqrt(d*(d-1));return g/(d-2)*p}return p},t.kurtosis=function(e,a){"undefined"==typeof a&&(a=!0);for(var o=t.mean(e),s=e.length,n=0,l=0,r=0,d;r<s;r++)d=e[r]-o,n+=d*d,l+=d*d*d*d;var h=n/s,g=l/s;if(a){var c=n/(s-1),m=l/(c*c);return s*(s+1)/((s-1)*(s-2)*(s-3))*m-3*((s-1)*(s-1)/((s-2)*(s-3)))}return g/(h*h)-3},t.entropy=function(e,t){"undefined"==typeof t&&(t=0);for(var a=0,n=e.length,o=0;o<n;o++)a+=e[o]*_Mathlog(e[o]+t);return-a},t.weightedMean=function(e,t){for(var a=0,n=e.length,o=0;o<n;o++)a+=e[o]*t[o];return a},t.weightedStandardDeviation=function(e,a){return _Mathsqrt(t.weightedVariance(e,a))},t.weightedVariance=function(e,n){for(var o=t.weightedMean(e,n),s=0,r=e.length,l=0,d=0,h=0;h<r;h++){var g=e[h]-o,c=n[h];s+=c*(g*g),d+=c,l+=c*c}return s*(d/(d*d-l))},t.center=function(e,a){"undefined"==typeof a&&(a=!1);var n=e;a||(n=[].concat(e));for(var o=t.mean(n),s=n.length,l=0;l<s;l++)n[l]-=o},t.standardize=function(e,a,n){"undefined"==typeof a&&(a=t.standardDeviation(e)),"undefined"==typeof n&&(n=!1);for(var o=e.length,s=n?e:Array(o),l=0;l<o;l++)s[l]=e[l]/a;return s},t.cumulativeSum=function(e){var t=e.length,a=Array(t);a[0]=e[0];for(var n=1;n<t;n++)a[n]=a[n-1]+e[n];return a}}),array_1=array.sum,array_2=array.max,array_3=array.min,array_4=array.minMax,array_5=array.arithmeticMean,array_6=array.mean,array_7=array.geometricMean,array_8=array.logMean,array_9=array.grandMean,array_10=array.truncatedMean,array_11=array.harmonicMean,array_12=array.contraHarmonicMean,array_13=array.median,array_14=array.variance,array_15=array.standardDeviation,array_16=array.standardError,array_17=array.robustMeanAndStdev,array_18=array.quartiles,array_19=array.pooledStandardDeviation,array_20=array.pooledVariance,array_21=array.mode,array_22=array.covariance,array_23=array.skewness,array_24=array.kurtosis,array_25=array.entropy,array_26=array.weightedMean,array_27=array.weightedStandardDeviation,array_28=array.weightedVariance,array_29=array.center,array_30=array.standardize,array_31=array.cumulativeSum,matrix=createCommonjsModule(function(e,t){function a(e,t){return e-t}t.max=function e(t){for(var e=-Infinity,a=0;a<t.length;a++)for(var n=0;n<t[a].length;n++)t[a][n]>e&&(e=t[a][n]);return e},t.min=function e(t){for(var e=1/0,a=0;a<t.length;a++)for(var n=0;n<t[a].length;n++)t[a][n]<e&&(e=t[a][n]);return e},t.minMax=function(e){for(var t=1/0,a=-Infinity,n=0;n<e.length;n++)for(var o=0;o<e[n].length;o++)e[n][o]<t&&(t=e[n][o]),e[n][o]>a&&(a=e[n][o]);return{min:t,max:a}},t.entropy=function(e,t){"undefined"==typeof t&&(t=0);for(var a=0,n=e.length,o=e[0].length,s=0;s<n;s++)for(var l=0;l<o;l++)a+=e[s][l]*_Mathlog(e[s][l]+t);return-a},t.mean=function(e,t){"undefined"==typeof t&&(t=0);var a=e.length,n=e[0].length,o,s,l,r;if(-1===t){for(o=[0],s=a*n,l=0;l<a;l++)for(r=0;r<n;r++)o[0]+=e[l][r];o[0]/=s}else if(0===t)for(o=Array(n),s=a,r=0;r<n;r++){for(o[r]=0,l=0;l<a;l++)o[r]+=e[l][r];o[r]/=s}else if(1===t)for(o=Array(a),s=n,r=0;r<a;r++){for(o[r]=0,l=0;l<n;l++)o[r]+=e[r][l];o[r]/=s}else throw new Error("Invalid dimension");return o},t.sum=function(e,t){"undefined"==typeof t&&(t=0);var a=e.length,n=e[0].length,o,s,l;if(-1===t)for(o=[0],s=0;s<a;s++)for(l=0;l<n;l++)o[0]+=e[s][l];else if(0===t)for(o=Array(n),l=0;l<n;l++)for(o[l]=0,s=0;s<a;s++)o[l]+=e[s][l];else if(1===t)for(o=Array(a),l=0;l<a;l++)for(o[l]=0,s=0;s<n;s++)o[l]+=e[l][s];else throw new Error("Invalid dimension");return o},t.product=function(e,t){"undefined"==typeof t&&(t=0);var a=e.length,n=e[0].length,o,s,l;if(-1===t)for(o=[1],s=0;s<a;s++)for(l=0;l<n;l++)o[0]*=e[s][l];else if(0===t)for(o=Array(n),l=0;l<n;l++)for(o[l]=1,s=0;s<a;s++)o[l]*=e[s][l];else if(1===t)for(o=Array(a),l=0;l<a;l++)for(o[l]=1,s=0;s<n;s++)o[l]*=e[l][s];else throw new Error("Invalid dimension");return o},t.standardDeviation=function(e,a,n){for(var o=t.variance(e,a,n),s=o.length,l=0;l<s;l++)o[l]=_Mathsqrt(o[l]);return o},t.variance=function(e,a,n){"undefined"==typeof n&&(n=!0),a=a||t.mean(e);var o=e.length;if(0===o)return[];for(var s=e[0].length,l=Array(s),r=0;r<s;r++){for(var d=0,h=0,g=0,c=0;c<o;c++)g=e[c][r]-a[r],d+=g,h+=g*g;l[r]=n?(h-d*d/o)/(o-1):(h-d*d/o)/o}return l},t.median=function(e){for(var t=e.length,n=e[0].length,o=Array(n),s=0,l;s<n;s++){l=Array(t);for(var r=0;r<t;r++)l[r]=e[r][s];l.sort(a);var d=l.length;o[s]=0==d%2?.5*(l[d/2]+l[d/2-1]):l[_Mathfloor(d/2)]}return o},t.mode=function(e){var t=e.length,a=e[0].length,n=Array(a),o,s;for(o=0;o<a;o++){for(var l=Array(t),r=0;r<t;r++)l[r]=0;var d=Array(t),h=0;for(s=0;s<t;s++){var g=d.indexOf(e[s][o]);0<=g?l[g]++:(d[h]=e[s][o],l[h]=1,h++)}var c=0,m=0;for(s=0;s<h;s++)l[s]>c&&(c=l[s],m=s);n[o]=d[m]}return n},t.skewness=function(e,o){"undefined"==typeof o&&(o=!0);for(var s=t.mean(e),r=e.length,n=s.length,l=Array(n),d=0;d<n;d++){for(var h=0,c=0,m=0,p;m<r;m++)p=e[m][d]-s[d],h+=p*p,c+=p*p*p;var u=h/r,f=c/r,b=f/_Mathpow(u,3/2);if(o){var g=_Mathsqrt(r*(r-1));l[d]=g/(r-2)*b}else l[d]=b}return l},t.kurtosis=function(e,a){"undefined"==typeof a&&(a=!0);for(var o=t.mean(e),s=e.length,n=e[0].length,l=Array(n),r=0;r<n;r++){for(var d=0,h=0,g=0,c;g<s;g++)c=e[g][r]-o[r],d+=c*c,h+=c*c*c*c;var m=d/s,p=h/s;if(a){var u=d/(s-1),f=h/(u*u);l[r]=s*(s+1)/((s-1)*(s-2)*(s-3))*f-3*((s-1)*(s-1)/((s-2)*(s-3)))}else l[r]=p/(m*m)-3}return l},t.standardError=function(e){for(var a=e.length,n=t.standardDeviation(e),o=n.length,s=Array(o),l=_Mathsqrt(a),r=0;r<o;r++)s[r]=n[r]/l;return s},t.covariance=function(e,a){return t.scatter(e,void 0,a)},t.scatter=function(e,a,n){"undefined"==typeof n&&(n=0),"undefined"==typeof a&&(0===n?a=e.length-1:1==n&&(a=e[0].length-1));var o=t.mean(e,n),l=e.length;if(0===l)return[[]];var r=e[0].length,d,h,g,c,m;if(0===n){for(d=Array(r),h=0;h<r;h++)d[h]=Array(r);for(h=0;h<r;h++)for(g=h;g<r;g++){for(c=0,m=0;m<l;m++)c+=(e[m][g]-o[g])*(e[m][h]-o[h]);c/=a,d[h][g]=c,d[g][h]=c}}else if(1===n){for(d=Array(l),h=0;h<l;h++)d[h]=Array(l);for(h=0;h<l;h++)for(g=h;g<l;g++){for(c=0,m=0;m<r;m++)c+=(e[g][m]-o[g])*(e[h][m]-o[h]);c/=a,d[h][g]=c,d[g][h]=c}}else throw new Error("Invalid dimension");return d},t.correlation=function(e){var a=t.mean(e),n=t.standardDeviation(e,!0,a),o=t.zScores(e,a,n),s=e.length,r=e[0].length,d=Array(r),h,g;for(h=0;h<r;h++)d[h]=Array(r);for(h=0;h<r;h++)for(g=h;g<r;g++){for(var m=0,p=0,u=o.length;p<u;p++)m+=o[p][g]*o[p][h];m/=s-1,d[h][g]=m,d[g][h]=m}return d},t.zScores=function(e,a,i){return a=a||t.mean(e),"undefined"==typeof i&&(i=t.standardDeviation(e,!0,a)),t.standardize(t.center(e,a,!1),i,!0)},t.center=function(e,a,n){a=a||t.mean(e);var o=e,s=e.length,l,r,d;if(!n)for(o=Array(s),l=0;l<s;l++)o[l]=Array(e[l].length);for(l=0;l<s;l++){var h=o[l];for(r=0,d=h.length;r<d;r++)h[r]=e[l][r]-a[r]}return o},t.standardize=function(e,a,n){"undefined"==typeof a&&(a=t.standardDeviation(e));var o=e,s=e.length,l,r,d;if(!n)for(o=Array(s),l=0;l<s;l++)o[l]=Array(e[l].length);for(l=0;l<s;l++){var h=o[l],g=e[l];for(r=0,d=h.length;r<d;r++)0===a[r]||isNaN(a[r])||(h[r]=g[r]/a[r])}return o},t.weightedVariance=function(e,n){var o=t.mean(e),s=e.length;if(0===s)return[];for(var l=e[0].length,r=Array(l),d=0;d<l;d++){for(var h=0,g=0,c=0,m=0;m<s;m++){var p=e[m][d]-o[d],u=n[m];h+=u*(p*p),c+=u,g+=u*u}r[d]=h*(c/(c*c-g))}return r},t.weightedMean=function(e,t,a){"undefined"==typeof a&&(a=0);var n=e.length;if(0===n)return[];var o=e[0].length,s,l,r,d,h,g;if(0===a){for(s=Array(o),l=0;l<o;l++)s[l]=0;for(l=0;l<n;l++)for(g=e[l],h=t[l],d=0;d<o;d++)s[d]+=g[d]*h}else if(1===a){for(s=Array(n),l=0;l<n;l++)s[l]=0;for(d=0;d<n;d++)for(g=e[d],h=t[d],l=0;l<o;l++)s[d]+=g[l]*h}else throw new Error("Invalid dimension");var c=array.sum(t);if(0!==c)for(l=0,r=s.length;l<r;l++)s[l]/=c;return s},t.weightedCovariance=function(e,a,n,o){o=o||0,n=n||t.weightedMean(e,a,o);for(var s=0,l=0,r=0,d=a.length;r<d;r++)s+=a[r],l+=a[r]*a[r];var h=s/(s*s-l);return t.weightedScatter(e,a,n,h,o)},t.weightedScatter=function(e,a,n,o,l){l=l||0,n=n||t.weightedMean(e,a,l),"undefined"==typeof o&&(o=1);var r=e.length;if(0===r)return[[]];var d=e[0].length,h,g,c,m,p;if(0===l){for(h=Array(d),g=0;g<d;g++)h[g]=Array(d);for(g=0;g<d;g++)for(c=g;c<d;c++){for(p=0,m=0;m<r;m++)p+=a[m]*(e[m][c]-n[c])*(e[m][g]-n[g]);h[g][c]=p*o,h[c][g]=p*o}}else if(1===l){for(h=Array(r),g=0;g<r;g++)h[g]=Array(r);for(g=0;g<r;g++)for(c=g;c<r;c++){for(p=0,m=0;m<d;m++)p+=a[m]*(e[c][m]-n[c])*(e[g][m]-n[g]);h[g][c]=p*o,h[c][g]=p*o}}else throw new Error("Invalid dimension");return h}}),matrix_1=matrix.max,matrix_2=matrix.min,matrix_3=matrix.minMax,matrix_4=matrix.entropy,matrix_5=matrix.mean,matrix_6=matrix.sum,matrix_7=matrix.product,matrix_8=matrix.standardDeviation,matrix_9=matrix.variance,matrix_10=matrix.median,matrix_11=matrix.mode,matrix_12=matrix.skewness,matrix_13=matrix.kurtosis,matrix_14=matrix.standardError,matrix_15=matrix.covariance,matrix_16=matrix.scatter,matrix_17=matrix.correlation,matrix_18=matrix.zScores,matrix_19=matrix.center,matrix_20=matrix.standardize,matrix_21=matrix.weightedVariance,matrix_22=matrix.weightedMean,matrix_23=matrix.weightedCovariance,matrix_24=matrix.weightedScatter,array$1=array;const median$2=array$1.median;var validInterpolations={nearestneighbor:"nearestNeighbor",nearestneighbour:"nearestNeighbor",bilinear:"bilinear"},methods={luma709(e,t,a){return 6966*e+23436*t+2366*a>>15},luma601(e,t,a){return 9798*e+19235*t+3735*a>>15},maximum(e,t,a){return _Mathmax(e,t,a)},minimum(e,t,a){return _Mathmin(e,t,a)},average(e,t,a){return(e+t+a)/3>>0},minmax(e,t,a){return(_Mathmax(e,t,a)+_Mathmin(e,t,a))/2},red(e){return e},green(e,t){return t},blue(e,t,a){return a},cyan(e,t,a,i){var n=methods.black(e,t,a,i);return(i.maxValue-e-n)/(1-n/i.maxValue)>>0},magenta(e,t,a,i){var n=methods.black(e,t,a,i);return(i.maxValue-t-n)/(1-n/i.maxValue)>>0},yellow(e,t,a,i){var n=methods.black(e,t,a,i);return(i.maxValue-a-n)/(1-n/i.maxValue)>>0},black(e,t,a,i){return _Mathmin(i.maxValue-e,i.maxValue-t,i.maxValue-a)},hue(e,t,a,i){var n=methods.min(e,t,a),o=methods.max(e,t,a);if(o===n)return 0;var s=0,l=o-n;switch(o){case e:s=(t-a)/l+(t<a?6:0);break;case t:s=(a-e)/l+2;break;case a:s=(e-t)/l+4;break;default:throw new Error("unreachable");}return s/6*i.maxValue>>0},saturation(e,t,a,i){var n=methods.min(e,t,a),o=methods.max(e,t,a);return 0===o?0:(o-n)/o*i.maxValue},lightness(e,t,a){var i=methods.min(e,t,a),n=methods.max(e,t,a);return(n+i)/2}};Object.defineProperty(methods,"luminosity",{enumerable:!1,value:methods.lightness}),Object.defineProperty(methods,"luminance",{enumerable:!1,value:methods.lightness}),Object.defineProperty(methods,"min",{enumerable:!1,value:methods.minimum}),Object.defineProperty(methods,"max",{enumerable:!1,value:methods.maximum}),Object.defineProperty(methods,"brightness",{enumerable:!1,value:methods.maximum});var names={};Object.keys(methods).forEach(e=>{names[e]=e});var methods$1={huang,intermodes,isodata,li,maxentropy:maxEntropy,mean:mean$1,minerror:minError,minimum,moments,otsu,percentile,renyientropy:renyiEntropy,shanbhag,triangle,yen},names$1={};Object.keys(methods$1).forEach(e=>{names$1[e]=e});var THRESHOLD="threshold";Matrix$2.prototype.localMin=function(e,t){for(var a=this[e][t],n=[e,t],o=_Mathmax(0,e-1);o<_Mathmin(this.length,e+2);o++)for(var s=_Mathmax(0,t-1);s<_Mathmin(this[0].length,t+2);s++)this[o][s]<a&&(a=this[o][s],n=[o,s]);return{position:n,value:a}},Matrix$2.prototype.localMax=function(e,t){for(var a=this[e][t],n=[e,t],o=_Mathmax(0,e-1);o<_Mathmin(this.length,e+2);o++)for(var s=_Mathmax(0,t-1);s<_Mathmin(this[0].length,t+2);s++)this[o][s]>a&&(a=this[o][s],n=[o,s]);return{position:n,value:a}},Matrix$2.prototype.localSearch=function(e,t,a){for(var n=[],o=_Mathmax(0,e-1);o<_Mathmin(this.length,e+2);o++)for(var s=_Mathmax(0,t-1);s<_Mathmin(this[0].length,t+2);s++)this[o][s]===a&&n.push([o,s]);return n};const defaultOptions$c={lowThreshold:10,highThreshold:30,gaussianBlur:1.1},Gx=[[-1,0,1],[-2,0,2],[-1,0,1]],Gy=[[-1,-2,-1],[0,0,0],[1,2,1]],convOptions={bitDepth:32,mode:"periodic"};var fastList=createCommonjsModule(function(e){(function(){function t(e,t,a){this.next=a,a&&(a.prev=this),this.prev=t,t&&(t.next=this),this.data=e}function a(){return this instanceof a?void(this._head=null,this._tail=null,this.length=0):new a}a.prototype={push:function(e){this._tail=new t(e,this._tail,null),this._head||(this._head=this._tail),this.length++},pop:function(){if(0!==this.length){var e=this._tail;return this._tail=e.prev,e.prev&&(e.prev=this._tail.next=null),this.length--,1===this.length?this._head=this._tail:0===this.length&&(this._head=this._tail=null),e.data}},unshift:function(e){this._head=new t(e,null,this._head),this._tail||(this._tail=this._head),this.length++},shift:function(){if(0!==this.length){var e=this._head;return this._head=e.next,e.next&&(e.next=this._head.prev=null),this.length--,1===this.length?this._tail=this._head:0===this.length&&(this._head=this._tail=null),e.data}},item:function(e){0>e&&(e=this.length+e);for(var t=this._head;0<e--&&t;)t=t.next;return t?t.data:void 0},slice:function(e,t){if(e||(e=0),t||(t=this.length),0>t&&(t=this.length+t),0>e&&(e=this.length+e),t===e)return[];if(t<e)throw new Error("invalid offset: "+e+","+t+" (length="+this.length+")");for(var a=t-e,o=Array(a),s=0,l=this._head;0<e--&&l;)l=l.next;for(;s<a&&l;)o[s++]=l.data,l=l.next;return o},drop:function(){a.call(this)},forEach:function(e,t){for(var a=this._head,n=0,o=this.length;n<o&&a;)e.call(t||this,a.data,n,this),a=a.next,n++},map:function(e,t){var o=new a;return this.forEach(function(a,n,i){o.push(e.call(t||i,a,n,i))}),o},filter:function(e,t){var o=new a;return this.forEach(function(a,n,i){e.call(t||i,a,n,i)&&o.push(a)}),o},reduce:function(e,t,a){var n=0,o=this._head,s=this.length;for(t||(n=1,t=o&&o.data,o=o&&o.next);n<s&&o;)t=e.call(a||this,t,o.data,this),n++,o=o.next;return t}},e.exports=a})()}),colors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},cross=[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],smallCross=[[0,1,0],[1,1,1],[0,1,0]];class Shape{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.kind,a=void 0===t?"cross":t,i=e.shape,n=e.size,o=e.width,s=e.height,l=e.filled,r=void 0===l||l;if(n&&(o=n,s=n),i)switch(i.toLowerCase()){case"square":case"rectangle":this.matrix=rectangle(o,s,{filled:r});break;case"circle":case"ellipse":this.matrix=ellipse(o,s,{filled:r});break;case"triangle":this.matrix=triangle$1(o,s,{filled:r});break;default:throw new Error("Shape: unexpected shape: ".concat(i));}else if(a)switch(a.toLowerCase()){case"cross":this.matrix=cross;break;case"smallcross":this.matrix=smallCross;break;default:throw new Error("Shape: unexpected kind: ".concat(a));}else throw new Error("Shape: expected a kind or a shape option");this.height=this.matrix.length,this.width=this.matrix[0].length,this.halfHeight=this.height/2>>0,this.halfWidth=this.width/2>>0}getPoints(){for(var e=this.matrix,t=[],a=0;a<e.length;a++)for(var i=0;i<e[0].length;i++)e[a][i]&&t.push([i-this.halfWidth,a-this.halfHeight]);return t}getMask(){for(var e=new Image(this.width,this.height,{kind:BINARY}),t=0;t<this.matrix.length;t++)for(var a=0;a<this.matrix[0].length;a++)this.matrix[t][a]&&e.setBitXY(a,t);return e}}class RoiMap{constructor(e,t){this.parent=e,this.width=e.width,this.height=e.height,this.data=t,this.negative=0,this.positive=0}get total(){return this.negative+this.positive}get minMax(){for(var e=Number.MAX_SAFE_INTEGER,t=Number.MIN_SAFE_INTEGER,a=0;a<this.data.length;a++)this.data[a]<e&&(e=this.data[a]),this.data[a]>t&&(t=this.data[a]);return{min:e,max:t}}get commonBorderLength(){return commonBorderLength(this)}mergeRoi(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return mergeRoi.call(this,e)}mergeRois(e){for(var t=e[0],a=e.slice(1),n=0;n<this.data.length;n++)a.includes(this.data[n])&&(this.data[n]=t)}rowsInfo(){for(var e=Array(this.height),t=0,a=0,n;a<this.data.length;a+=this.width){n={row:t,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0},e[t++]=n;for(var o={},s={},l=[],r=this.data[a],d=0,h=a,g;h<a+this.width;h++)g=this.data[h],r!==g&&(r=g,l.push(d),d=0),d++,0<g?(n.positivePixel++,!o[g]&&(o[g]=!0)):0>g?(n.negativePixel++,!s[g]&&(s[g]=!0)):n.zeroPixel++;l.push(d),n.medianChange=l.sort((e,t)=>e-t)[_Mathfloor(l.length/2)],n.positiveRoiIDs=Object.keys(o),n.negativeRoiIDs=Object.keys(s),n.positiveRoi=n.positiveRoiIDs.length,n.negativeRoi=n.negativeRoiIDs.length}return e}colsInfo(){for(var e=Array(this.width),t=0,a=0,n;a<this.width;a++){n={col:t,positivePixel:0,negativePixel:0,zeroPixel:0,positiveRoi:0,negativeRoi:0,medianChange:0},e[t++]=n;for(var o={},s={},l=[],r=this.data[a],d=0,h=a,g;h<a+this.data.length;h+=this.width)g=this.data[h],r!==g&&(r=g,l.push(d),d=0),d++,0<g?(n.positivePixel++,!o[g]&&(o[g]=!0)):0>g?(n.negativePixel++,!s[g]&&(s[g]=!0)):n.zeroPixel++;l.push(d),n.medianChange=l.sort((e,t)=>e-t)[_Mathfloor(l.length/2)],n.positiveRoiIDs=Object.keys(o),n.negativeRoiIDs=Object.keys(s),n.positiveRoi=n.positiveRoiIDs.length,n.negativeRoi=n.negativeRoiIDs.length}return e}}class DisjointSet{constructor(){this.nodes=new Map}add(e){var t=this.nodes.get(e);return t||(t=new DisjointSetNode(e),this.nodes.set(e,t)),t}union(e,t){const a=this.find(e),i=this.find(t);a===i||(a.rank<i.rank?a.parent=i:a.rank>i.rank?i.parent=a:(i.parent=a,a.rank++))}find(e){for(var t=e;null!==t.parent;)t=t.parent;for(var a=e;null!==a.parent;){var i=a;a=a.parent,i.parent=t}return t}connected(e,t){return this.find(e)===this.find(t)}}var DisjointSet_1=DisjointSet,direction4X=[-1,0],direction4Y=[0,-1],neighbours4=[null,null],direction8X=[-1,-1,0,1],direction8Y=[0,-1,-1,-1],neighbours8=[null,null,null,null],priorityQueue=createCommonjsModule(function(e){(function(t){e.exports=t()})(function(){return function d(h,e,t){function a(i,o){if(!e[i]){if(!h[i]){var s="function"==typeof commonjsRequire&&commonjsRequire;if(!o&&s)return s(i,!0);if(n)return n(i,!0);var r=new Error("Cannot find module '"+i+"'");throw r.code="MODULE_NOT_FOUND",r}var g=e[i]={exports:{}};h[i][0].call(g.exports,function(t){var e=h[i][1][t];return a(e?e:t)},g,g.exports,d,h,e,t)}return e[i].exports}for(var n="function"==typeof commonjsRequire&&commonjsRequire,i=0;i<t.length;i++)a(t[i]);return a}({1:[function(e,t){var a=function(e,t){function a(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return a.prototype=t.prototype,e.prototype=new a,e.__super__=t.prototype,e},i={}.hasOwnProperty,n,o,s,l,r;n=e("./PriorityQueue/AbstractPriorityQueue"),o=e("./PriorityQueue/ArrayStrategy"),l=e("./PriorityQueue/BinaryHeapStrategy"),s=e("./PriorityQueue/BHeapStrategy"),r=function(e){function t(e){e||(e={}),e.strategy||(e.strategy=l),e.comparator||(e.comparator=function(e,t){return(e||0)-(t||0)}),t.__super__.constructor.call(this,e)}return a(t,e),t}(n),r.ArrayStrategy=o,r.BinaryHeapStrategy=l,r.BHeapStrategy=s,t.exports=r},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(e,t){var a;t.exports=a=function(){function e(e){var t;if(null==(null==e?void 0:e.strategy))throw"Must pass options.strategy, a strategy";if(null==(null==e?void 0:e.comparator))throw"Must pass options.comparator, a comparator";this.priv=new e.strategy(e),this.length=(null==e||null==(t=e.initialValues)?void 0:t.length)||0}return e.prototype.queue=function(e){return this.length++,void this.priv.queue(e)},e.prototype.dequeue=function(){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},e.prototype.peek=function(){if(!this.length)throw"Empty queue";return this.priv.peek()},e.prototype.clear=function(){return this.length=0,this.priv.clear()},e}()},{}],3:[function(e,t){var a,i;i=function(e,t,a){var i,n,o;for(n=0,i=e.length;n<i;)o=n+i>>>1,0<=a(e[o],t)?n=o+1:i=o;return n},t.exports=a=function(){function e(e){var t;this.options=e,this.comparator=this.options.comparator,this.data=(null==(t=this.options.initialValues)?void 0:t.slice(0))||[],this.data.sort(this.comparator).reverse()}return e.prototype.queue=function(e){var t;return t=i(this.data,e,this.comparator),void this.data.splice(t,0,e)},e.prototype.dequeue=function(){return this.data.pop()},e.prototype.peek=function(){return this.data[this.data.length-1]},e.prototype.clear=function(){this.data.length=0},e}()},{}],4:[function(e,t){var a;t.exports=a=function(){function e(e){var t,a,n,o,s,l,r,d,h;for(this.comparator=(null==e?void 0:e.comparator)||function(e,t){return e-t},this.pageSize=(null==e?void 0:e.pageSize)||512,this.length=0,d=0;1<<d<this.pageSize;)d+=1;if(1<<d!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=d,this._emptyMemoryPageTemplate=t=[],(a=n=0,l=this.pageSize);0<=l?n<l:n>l;a=0<=l?++n:--n)t.push(null);if(this._memory=[],this._mask=this.pageSize-1,e.initialValues)for(r=e.initialValues,o=0,s=r.length;o<s;o++)h=r[o],this.queue(h)}return e.prototype.queue=function(e){return this.length+=1,this._write(this.length,e),void this._bubbleUp(this.length,e)},e.prototype.dequeue=function(){var e,t;return e=this._read(1),t=this._read(this.length),this.length-=1,0<this.length&&(this._write(1,t),this._bubbleDown(1,t)),e},e.prototype.peek=function(){return this._read(1)},e.prototype.clear=function(){return this.length=0,void(this._memory.length=0)},e.prototype._write=function(e,t){var a;for(a=e>>this._shift;a>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[a][e&this._mask]=t},e.prototype._read=function(e){return this._memory[e>>this._shift][e&this._mask]},e.prototype._bubbleUp=function(e,t){var a,i,n,o;for(a=this.comparator;1<e&&(i=e&this._mask,e<this.pageSize||3<i?n=e&~this._mask|i>>1:2>i?(n=e-this.pageSize>>this._shift,n+=n&~(this._mask>>1),n|=this.pageSize>>1):n=e-2,o=this._read(n),!(0>a(o,t)));)this._write(n,t),this._write(e,o),e=n},e.prototype._bubbleDown=function(e,t){var a,i,n,o,s;for(s=this.comparator;e<this.length;)if(e>this._mask&&!(e&this._mask-1)?a=i=e+2:e&this.pageSize>>1?(a=(e&~this._mask)>>1,a|=e&this._mask>>1,a=a+1<<this._shift,i=a+1):(a=e+(e&this._mask),i=a+1),a!=i&&i<=this.length){if(n=this._read(a),o=this._read(i),0>s(n,t)&&0>=s(n,o))this._write(a,t),this._write(e,n),e=a;else if(0>s(o,t))this._write(i,t),this._write(e,o),e=i;else break;}else if(!(a<=this.length))break;else if(n=this._read(a),0>s(n,t))this._write(a,t),this._write(e,n),e=a;else break},e}()},{}],5:[function(e,t){var a;t.exports=a=function(){function e(e){var t;this.comparator=(null==e?void 0:e.comparator)||function(e,t){return e-t},this.length=0,this.data=(null==(t=e.initialValues)?void 0:t.slice(0))||[],this._heapify()}return e.prototype._heapify=function(){var e,t,a;if(0<this.data.length)for(e=t=1,a=this.data.length;1<=a?t<a:t>a;e=1<=a?++t:--t)this._bubbleUp(e)},e.prototype.queue=function(e){return this.data.push(e),void this._bubbleUp(this.data.length-1)},e.prototype.dequeue=function(){var e,t;return t=this.data[0],e=this.data.pop(),0<this.data.length&&(this.data[0]=e,this._bubbleDown(0)),t},e.prototype.peek=function(){return this.data[0]},e.prototype.clear=function(){return this.length=0,void(this.data.length=0)},e.prototype._bubbleUp=function(e){for(var t,a;0<e&&(t=e-1>>>1,0>this.comparator(this.data[e],this.data[t]));)a=this.data[t],this.data[t]=this.data[e],this.data[e]=a,e=t},e.prototype._bubbleDown=function(e){var t,a,i,n,o;for(t=this.data.length-1;a=(e<<1)+1,n=a+1,i=e,a<=t&&0>this.comparator(this.data[a],this.data[i])&&(i=a),n<=t&&0>this.comparator(this.data[n],this.data[i])&&(i=n),i!==e;)o=this.data[i],this.data[i]=this.data[e],this.data[e]=o,e=i},e}()},{}]},{},[1])(1)})}),dxs=[1,0,-1,0,1,1,-1,-1],dys=[0,1,0,-1,1,-1,1,-1],twoProduct_1=twoProduct,SPLITTER=+(_Mathpow(2,27)+1),robustSum=linearExpansionSum,twoSum=fastTwoSum,robustScale=scaleLinearExpansion,robustDiff=robustSubtract,orientation_1=createCommonjsModule(function(e){function t(e,t){for(var a=Array(e.length-1),n=1,o;n<e.length;++n){o=a[n-1]=Array(e.length-1);for(var s=0,l=0;s<e.length;++s)s!==t&&(o[l++]=e[n][s])}return a}function a(e){for(var t=Array(e),a=0;a<e;++a){t[a]=Array(e);for(var n=0;n<e;++n)t[a][n]=["m",n,"[",e-a-1,"]"].join("")}return t}function n(e){return 1&e?"-":""}function o(e){if(1===e.length)return e[0];if(2===e.length)return["sum(",e[0],",",e[1],")"].join("");var t=e.length>>1;return["sum(",o(e.slice(0,t)),",",o(e.slice(t)),")"].join("")}function s(e){if(2===e.length)return[["sum(prod(",e[0][0],",",e[1][1],"),prod(-",e[0][1],",",e[1][0],"))"].join("")];for(var a=[],l=0;l<e.length;++l)a.push(["scale(",o(s(t(e,l))),",",n(l),e[0][l],")"].join(""));return a}function l(e){for(var n=[],l=[],r=a(e),d=[],h=0;h<e;++h)0==(1&h)?n.push.apply(n,s(t(r,h))):l.push.apply(l,s(t(r,h))),d.push("m"+h);var g=o(n),c=o(l),m="orientation"+e+"Exact",p=["function ",m,"(",d.join(),"){var p=",g,",n=",c,",d=sub(p,n);return d[d.length-1];};return ",m].join(""),u=new Function("sum","prod","scale","sub",p);return u(robustSum,twoProduct_1,robustScale,robustDiff)}function r(e){var t=p[e.length];return t||(t=p[e.length]=l(e.length)),t.apply(void 0,e)}function d(){for(;p.length<=5;)p.push(l(p.length));for(var t=[],a=["slow"],n=0;n<=5;++n)t.push("a"+n),a.push("o"+n);for(var o=["function getOrientation(",t.join(),"){switch(arguments.length){case 0:case 1:return 0;"],n=2;n<=5;++n)o.push("case ",n,":return o",n,"(",t.slice(0,n).join(),");");o.push("}var s=new Array(arguments.length);for(var i=0;i<arguments.length;++i){s[i]=arguments[i]};return slow(s);}return getOrientation"),a.push(o.join(""));var s=Function.apply(void 0,a);e.exports=s.apply(void 0,[r].concat(p));for(var n=0;n<=5;++n)e.exports[n]=p[n]}var h=11102230246251565e-32,g=l(3),m=l(4),p=[function(){return 0},function(){return 0},function(e,t){return t[0]-e[0]},function(e,t,a){var i=(e[1]-a[1])*(t[0]-a[0]),n=(e[0]-a[0])*(t[1]-a[1]),o=i-n,l;if(0<i){if(0>=n)return o;l=i+n}else if(0>i){if(0<=n)return o;l=-(i+n)}else return o;var r=(3+16*h)*h*l;return o>=r||o<=-r?o:g(e,t,a)},function(e,t,a,i){var n=e[0]-i[0],o=t[0]-i[0],s=a[0]-i[0],l=e[1]-i[1],r=t[1]-i[1],d=a[1]-i[1],g=e[2]-i[2],c=t[2]-i[2],p=a[2]-i[2],u=o*d,f=s*r,b=s*l,_=n*d,w=n*r,x=o*l,y=g*(u-f)+c*(b-_)+p*(w-x),k=(_Mathabs(u)+_Mathabs(f))*_Mathabs(g)+(_Mathabs(b)+_Mathabs(_))*_Mathabs(c)+(_Mathabs(w)+_Mathabs(x))*_Mathabs(p),v=(7+56*h)*h*k;return y>v||-y>v?y:m(e,t,a,i)}];d()}),robustPnp=robustPointInPolygon;class Roi{constructor(e,t){var a=Number.NEGATIVE_INFINITY;this.map=e,this.id=t,this.minX=_NumberPOSITIVE_INFINITY,this.maxX=a,this.minY=_NumberPOSITIVE_INFINITY,this.maxY=a,this.meanX=0,this.meanY=0,this.surface=0,this.computed={}}getMask(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.scale,a=void 0===t?1:t,i=e.kind,n=void 0===i?"":i,o;return o="contour"===n?this.contourMask:"box"===n?this.boxMask:"filled"===n?this.filledMask:"center"===n?this.centerMask:"hull"===n?this.hullMask:"mbr"===n?this.mbrMask:this.mask,1>a&&(o=o.resize({factor:a}),o.parent=this.mask.parent,o.position[0]+=this.minX,o.position[1]+=this.minY),o}get mean(){throw new Error("Roi mean not implemented yet")}get center(){return this.computed.center||(this.computed.center=[this.width/2>>0,this.height/2>>0]),this.computed.center}get ratio(){return this.width/this.height}get width(){return this.maxX-this.minX+1}get height(){return this.maxY-this.minY+1}_computExternalIDs(){var e=this.borderIDs,t=this.borderLengths;this.computed.externalIDs=[],this.computed.externalLengths=[];for(var a=this.internalIDs,n=0;n<e.length;n++)a.includes(e[n])||(this.computed.externalIDs.push(e[n]),this.computed.externalLengths.push(t[n]))}get externalIDs(){return this.computed.externalIDs?this.computed.externalIDs:(this._computExternalIDs(),this.computed.externalIDs)}get externalLengths(){return this.computed.externalLengths?this.computed.externalLengths:(this._computExternalIDs(),this.computed.externalLengths)}_computeBorderIDs(){var e=getBorders(this);this.computed.borderIDs=e.ids,this.computed.borderLengths=e.lengths}get borderIDs(){return this.computed.borderIDs?this.computed.borderIDs:(this._computeBorderIDs(),this.computed.borderIDs)}get borderLengths(){return this.computed.borderLengths?this.computed.borderLengths:(this._computeBorderIDs(),this.computed.borderLengths)}get boxIDs(){return this.computed.boxIDs||(this.computed.boxIDs=getBoxIDs(this)),this.computed.boxIDs}get internalIDs(){return this.computed.internalIDs||(this.computed.internalIDs=getInternalIDs(this)),this.computed.internalIDs}get box(){return this.computed.box||(this.computed.box=getBox(this)),this.computed.box}get external(){return this.computed.external||(this.computed.external=getExternal(this)),this.computed.external}get border(){return this.computed.border||(this.computed.border=getBorder(this)),this.computed.border}get contourMask(){if(!this.computed.contourMask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=0;t<this.width;t++)for(var a=0;a<this.height;a++)this.map.data[t+this.minX+(a+this.minY)*this.map.width]===this.id&&(0<t&&t<this.width-1&&0<a&&a<this.height-1?(this.map.data[t-1+this.minX+(a+this.minY)*this.map.width]!==this.id||this.map.data[t+1+this.minX+(a+this.minY)*this.map.width]!==this.id||this.map.data[t+this.minX+(a-1+this.minY)*this.map.width]!==this.id||this.map.data[t+this.minX+(a+1+this.minY)*this.map.width]!==this.id)&&e.setBitXY(t,a):e.setBitXY(t,a));this.computed.contourMask=e}return this.computed.contourMask}get boxMask(){if(!this.computed.boxMask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=0;t<this.width;t++)e.setBitXY(t,0),e.setBitXY(t,this.height-1);for(var a=0;a<this.height;a++)e.setBitXY(0,a),e.setBitXY(this.width-1,a);this.computed.boxMask=e}return this.computed.boxMask}get mask(){if(!this.computed.mask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=0;t<this.width;t++)for(var a=0;a<this.height;a++)this.map.data[t+this.minX+(a+this.minY)*this.map.width]===this.id&&e.setBitXY(t,a);this.computed.mask=e}return this.computed.mask}get filledMask(){if(!this.computed.filledMask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=0;t<this.width;t++)for(var a=0,i;a<this.height;a++)i=t+this.minX+(a+this.minY)*this.map.width,this.internalIDs.includes(this.map.data[i])&&e.setBitXY(t,a);this.computed.filledMask=e}return this.computed.filledMask}get centerMask(){if(!this.computed.centerMask){var e=new Shape({kind:"smallCross"}).getMask();e.parent=this.map.parent,e.position=[this.minX+this.center[0]-1,this.minY+this.center[1]-1],this.computed.centerMask=e}return this.computed.centerMask}get hullMask(){if(!this.computed.hullMask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=this.contourMask.monotoneChainConvexHull(),a=0;a<this.width;a++)for(var i=0;i<this.height;i++)1!==robustPnp(t,[a,i])&&e.setBitXY(a,i);this.computed.hullMask=e}return this.computed.hullMask}get mbrMask(){if(!this.computed.mbrMask){for(var e=new Image(this.width,this.height,{kind:BINARY,position:[this.minX,this.minY],parent:this.map.parent}),t=this.mask.minimalBoundingRectangle(),a=0;a<this.width;a++)for(var i=0;i<this.height;i++)1!==robustPnp(t,[a,i])&&e.setBitXY(a,i);this.computed.mbrMask=e}return this.computed.mbrMask}get points(){if(!this.computed.points){for(var e=[],t=0;t<this.height;t++)for(var a=0,i;a<this.width;a++)i=(t+this.minY)*this.map.width+a+this.minX,this.map.data[i]===this.id&&e.push([a,t]);this.computed.points=e}return this.computed.points}get maxLengthPoints(){if(!this.computed.maxLengthPoints){for(var e=0,t=this.points,a=0,n;a<t.length;a++)for(var o=a+1,s;o<t.length;o++)s=_Mathpow(t[a][0]-t[o][0],2)+_Mathpow(t[a][1]-t[o][1],2),s>=e&&(e=s,n=[t[a],t[o]]);this.computed.maxLengthPoints=n}return this.computed.maxLengthPoints}get maxLength(){if(!this.computed.maxLength){var e=_Mathsqrt(_Mathpow(this.maxLengthPoints[0][0]-this.maxLengthPoints[1][0],2)+_Mathpow(this.maxLengthPoints[0][1]-this.maxLengthPoints[1][1],2));this.computed.maxLength=e}return this.computed.maxLength}get angle(){if(!this.computed.angle){var e=this.maxLengthPoints,t=180*-_Mathatan(e[0][1]-e[1][1],e[0][0]-e[1][0])/_MathPI;this.computed.angle=t}return this.computed.angle}toJSON(){return{id:this.id,minX:this.minX,maxX:this.maxX,minY:this.minY,maxY:this.maxY,meanX:this.meanX,meanY:this.meanY,height:this.height,width:this.width,surface:this.surface}}}class RoiLayer{constructor(e,t){this.roiMap=e,this.options=t,this.roi=this.createRoi()}createRoi(){var e=this.roiMap.data,t={};this.roiMap.positive=0,this.roiMap.negative=0;for(var a=0;a<e.length;a++)e[a]&&!t[e[a]]&&(t[e[a]]=!0,0<e[a]?this.roiMap.positive++:this.roiMap.negative++);var n={};for(var o in t)n[o]=new Roi(this.roiMap,1*o);for(var s=this.roiMap.width,l=this.roiMap.height,r=0;r<l;r++)for(var d=0,h;d<s;d++)if(h=r*s+d,0!==e[h]){var g=e[h],c=n[g];d<c.minX&&(c.minX=d),d>c.maxX&&(c.maxX=d),r<c.minY&&(c.minY=r),r>c.maxY&&(c.maxY=r),c.meanX+=d,c.meanY+=r,c.surface++}var m=[];for(var p in t)n[p].meanX/=n[p].surface,n[p].meanY/=n[p].surface,m.push(n[p]);return m}}class RoiManager{constructor(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};this._image=e,this._options=t,this._options.label||(this._options.label="default"),this._layers={},this._painted=null}fromMaxima(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=Object.assign({},this._options,e),a=fromMaxima.call(this._image,e);this._layers[t.label]=new RoiLayer(a,t)}fromPoints(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=Object.assign({},this._options,t),i=fromPoints.call(this._image,e,t);return this._layers[a.label]=new RoiLayer(i,a),this}putMap(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=new RoiMap(this._image,e),i=Object.assign({},this._options,t);return this._layers[i.label]=new RoiLayer(a,i),this}fromWaterShed(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=Object.assign({},this._options,e),a=fromWaterShed.call(this._image,e);this._layers[t.label]=new RoiLayer(a,t)}fromMask(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=Object.assign({},this._options,t),i=fromMask.call(this._image,e,t);return this._layers[a.label]=new RoiLayer(i,a),this}fromMaskConnectedComponentLabelingAlgorithm(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=Object.assign({},this._options,t),i=fromMaskConnectedComponentLabelingAlgorithm.call(this._image,e,t);return this._layers[a.label]=new RoiLayer(i,a),this}getMap(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},this._options,e);return this._assertLayerWithLabel(t.label),this._layers[t.label].roiMap}rowsInfo(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return this.getMap(e).rowsInfo()}colsInfo(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return this.getMap(e).rowsInfo()}getRoiIds(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=this.getRois(e);if(t){for(var a=Array(t.length),n=0;n<t.length;n++)a[n]=t[n].id;return a}throw new Error("ROIs not found")}getRois(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.label,a=void 0===t?this._options.label:t,i=e.positive,n=e.negative,o=e.minSurface,s=void 0===o?0:o,l=e.maxSurface,r=void 0===l?_NumberPOSITIVE_INFINITY:l,d=e.minWidth,h=void 0===d?0:d,g=e.maxWidth,c=void 0===g?_NumberPOSITIVE_INFINITY:g,m=e.minHeight,p=void 0===m?0:m,u=e.maxHeight,f=void 0===u?_NumberPOSITIVE_INFINITY:u,b=e.minRatio,_=void 0===b?0:b,w=e.maxRatio,x=void 0===w?_NumberPOSITIVE_INFINITY:w;if(!this._layers[a])throw new Error("this Roi layer (".concat(a,") does not exist"));var y=this._layers[a].roi,k=[];for(var v of y)(0>v.id&&(!(void 0!==n)||n)||0<v.id&&(!(void 0!==i)||i))&&v.surface>=s&&v.surface<=r&&v.width>=h&&v.width<=c&&v.height>=p&&v.height<=f&&v.ratio>=_&&v.ratio<=x&&k.push(v);return k}getRoi(e){var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=t.label,i=void 0===a?this._options.label:a;if(!this._layers[i])throw new Error("this Roi layer (".concat(i,") does not exist"));var n=this._layers[i].roi.find(t=>t.id===e);if(!n)throw new Error("found no Roi with id ".concat(e));return n}getMasks(){for(var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=this.getRois(e),a=Array(t.length),n=0;n<t.length;n++)a[n]=t[n].getMask(e);return a}getData(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},this._options,e);return this._assertLayerWithLabel(t.label),this._layers[t.label].roiMap.data}paint(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.labelProperty;this._painted||(this._painted=this._image.rgba8());var a=this.getMasks(e);if(t){var i=this.getRois(e);e.labels=i.map(e=>e[t]),e.labelsPosition=i.map(e=>[e.meanX,e.meanY])}return this._painted.paintMasks(a,e),this._painted}getMask(){for(var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=new Image(this._image.width,this._image.height,{kind:"BINARY"}),a=this.getMasks(e),n=0,o;n<a.length;n++){o=a[n];for(var s=0;s<o.width;s++)for(var l=0;l<o.height;l++)o.getBitXY(s,l)&&t.setBitXY(s+o.position[0],l+o.position[1])}return t}resetPainted(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.image;this._painted=t?this.image.rgba8():this._image.rgba8()}mergeRoi(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.getMap(e);return t.mergeRoi(e),this.putMap(t.data,e),this}mergeRois(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(!Array.isArray(e)||e.some(e=>!_NumberisInteger(e)))throw new Error("Roi ids must be an array of integers");if(2>e.length)throw new Error("Roi ids must have at least two elements");if(new Set(e).size!==e.length)throw new Error("Roi ids must be all different");e.forEach(e=>this.getRoi(e));var a=this.getMap(t);return a.mergeRois(e),this.putMap(a.data,t),this}findCorrespondingRoi(e){for(var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},a=this.getRois(t),n=[],o=0;o<a.length;o++){var s=a[o],l=s.minX,r=s.minY,d=s.points,h=_Mathsign(s.id),g=correspondingRoisInformation(l,r,d,e,h);n.push(g)}return n}_assertLayerWithLabel(e){if(!this._layers[e])throw new Error("no layer with label ".concat(e))}}var objectToString=Object.prototype.toString;class Image{constructor(e,t,a,i){if(1===arguments.length){i=e;var n=i;e=n.width,t=n.height,a=n.data}else if(a&&!a.length){i=a;var o=i;a=o.data}if(void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i={}),"object"!=typeof i||null===i)throw new TypeError("options must be an object");if(!_NumberisInteger(e)||0>=e)throw new RangeError("width must be a positive integer");if(!_NumberisInteger(t)||0>=t)throw new RangeError("height must be a positive integer");var s=i,l=s.kind,r=void 0===l?RGBA:l;if("string"!=typeof r)throw new TypeError("kind must be a string");var d=getKind(r),h=Object.assign({},i);for(var g in d)void 0===h[g]&&(h[g]=d[g]);verifyKindDefinition(h);var c=h.components,m=h.bitDepth,p=h.colorModel,u=h.alpha+0,f=e*t,b=c+u,_=32===m?_NumberMAX_VALUE:_Mathpow(2,m)-1;if(void 0===a)a=createPixelArray(f,c,u,b,m,_);else{var w=getTheoreticalPixelArraySize(f,b,m);if(a.length!==w)throw new RangeError("incorrect data size: ".concat(a.length,". Should be ").concat(w))}this.width=e,this.height=t,this.data=a,this.size=f,this.components=c,this.alpha=u,this.bitDepth=m,this.maxValue=_,this.colorModel=p,this.channels=b,this.meta=i.meta||{},Object.defineProperty(this,"parent",{enumerable:!1,writable:!0,configurable:!0,value:i.parent||null}),this.position=i.position||[0,0],this.computed=null,this.sizes=[this.width,this.height],this.multiplierX=this.channels,this.multiplierY=this.channels*this.width,this.isClamped=32>this.bitDepth,this.borderSizes=[0,0]}get[Symbol.toStringTag](){return"IJSImage"}static isImage(e){return"[object IJSImage]"===objectToString.call(e)}static fromCanvas(e){var t=e.getContext("2d"),a=t.getImageData(0,0,e.width,e.height);return new Image(a.width,a.height,a.data)}static createFrom(e,t){var a=getImageParameters(e);return Object.assign(a,{parent:e,position:[0,0]},t),new Image(a)}getRoiManager(e){return new RoiManager(this,e)}clone(){var e=this.data.slice();return new Image(this.width,this.height,e,this)}apply(e){for(var t=0;t<this.height;t++)for(var a=0,i;a<this.width;a++)i=(t*this.width+a)*this.channels,e.call(this,i)}}setValueMethods(Image),setBitMethods(Image),setExportMethods(Image),Image.prototype.checkProcessable=checkProcessable,Image.prototype.getRGBAData=getRGBAData,Image.load=load,Image.extendMethod=extendMethod,Image.extendProperty=extendProperty,extend$1(Image);var kernel$1=Object.freeze({laplacianOfGaussian:laplacianOfGaussian,DISCRETE_LAPLACE_4:DISCRETE_LAPLACE_4,DISCRETE_LAPLACE_8:DISCRETE_LAPLACE_8,SOBEL_X:SOBEL_X,SOBEL_Y:SOBEL_Y,SCHARR_X:SCHARR_X,SCHARR_Y:SCHARR_Y,SECOND_DERIVATIVE:SECOND_DERIVATIVE,SECOND_DERIVATIVE_INV:SECOND_DERIVATIVE_INV}),worker$1=function(){function e(){this._listeners={}}self.window=self;e.prototype.on=function(e,t){if(this._listeners[e])throw new RangeError("there is already a listener for "+e);if("function"!=typeof t)throw new TypeError("callback argument must be a function");this._listeners[e]=t},e.prototype._send=function(e,t,a){a===void 0?a=[]:!Array.isArray(a)&&(a=[a]),self.postMessage({id:e,data:t},a)},e.prototype._trigger=function(e,t){if(!this._listeners[e])throw new Error("event "+e+" is not defined");this._listeners[e].apply(null,t)};var t=new e;self.onmessage=function(e){switch(e.data.action){case"exec":e.data.args.unshift(function(a,i){t._send(e.data.id,a,i)}),t._trigger(e.data.event,e.data.args);break;case"ping":t._send(e.data.id,"pong");break;default:throw new Error("unexpected action: "+e.data.action);}}},workerStr=worker$1.toString().split("\"CODE\";"),newWorkerURL=function(e,t){var a=new Blob(["(",workerStr[0],"importScripts.apply(self, "+JSON.stringify(t)+");\n","(",e,")();",workerStr[1],")();"],{type:"application/javascript"});return URL.createObjectURL(a)},workerTemplate={newWorkerURL:newWorkerURL},CORES=navigator.hardwareConcurrency||1,noop=Function.prototype;WorkerManager.prototype._init=function(e){for(var t=workerTemplate.newWorkerURL(this._workerCode,e),a=0,n;a<this._numWorkers;a++)n=new Worker(t),n.onmessage=this._onmessage.bind(this,n),n.onerror=this._onerror.bind(this,n),n.running=!1,n.id=a,this._workers.set(n,null);URL.revokeObjectURL(t)},WorkerManager.prototype._onerror=function(e,t){if(!this._terminated){this._working--,e.running=!1;var a=this._workers.get(e);a&&a[1](t.message),this._workers.set(e,null),this._terminateOnError?this.terminate():this._exec()}},WorkerManager.prototype._onmessage=function(e,t){if(!this._terminated){this._working--,e.running=!1;var a=this._workers.get(e);a&&a[0](t.data.data),this._workers.set(e,null),this._exec()}},WorkerManager.prototype._exec=function(){for(var e of this._workers.keys()){if(this._working===this._numWorkers||0===this._waiting.length)return;if(!e.running)for(var t=0,a;t<this._waiting.length;t++)if(a=this._waiting[t],"number"!=typeof a[4]||a[4]===e.id){this._waiting.splice(t,1),e.postMessage({action:"exec",event:a[0],args:a[1]},a[2]),e.running=!0,e.time=Date.now(),this._workers.set(e,a[3]),this._working++;break}}},WorkerManager.prototype.terminate=function(){if(!this._terminated){for(var e of this._workers)e[0].terminate(),e[1]&&e[1][1](new Error("Terminated"));this._workers.clear(),this._waiting=[],this._working=0,this._terminated=!0}},WorkerManager.prototype.postAll=function(e,t){if(this._terminated)throw new Error("Cannot post (terminated)");var a=[];for(var i of this._workers.keys())a.push(this.post(e,t,[],i.id));return Promise.all(a)},WorkerManager.prototype.post=function(e,t,a,i){t===void 0&&(t=[]),a===void 0&&(a=[]),Array.isArray(t)||(t=[t]),Array.isArray(a)||(a=[a]);var n=this;return new Promise(function(o,s){if(n._terminated)throw new Error("Cannot post (terminated)");n._waiting.push([e,t,a,[o,s],i]),n._exec()})};var src$4=WorkerManager,defaultOptions$d={regression:{kernelType:"polynomial",kernelOptions:{degree:2,constant:1}},threshold:.02,roi:{minSurface:100,positive:!1},sampling:20,include:[]},background$1={run,work};class Worker$1{constructor(){this._url=null,this._deps=[null]}checkUrl(){if(null===this._url)throw new Error("image worker must be initialized with an URL")}get url(){return this._url}set url(e){if("string"!=typeof e)throw new TypeError("worker URL must be a string");this._url=e,this._deps[0]=e}static extendMethod(e,t){function a(){n||(this.checkUrl(),o=this.url,n=new src$4(t.work,{deps:o}),i.manager=n);for(var e=arguments.length,a=Array(e),s=0;s<e;s++)a[s]=arguments[s];return t.run.call(i,...a)}var i={},n,o;a.reset=function(){n&&(n.terminate(),n=new src$4(t.work,{deps:o}),i.manager=n)},Worker$1.prototype[e]=a}}extend$2(Worker$1);var worker$2=new Worker$1,Static={grey:names,threshold:names$1};exports.Image=Image,exports.Kernel=kernel$1,exports.Shape=Shape,exports.Stack=Stack,exports.Static=Static,exports.Worker=worker$2,exports.default=Image,Object.defineProperty(exports,"__esModule",{value:!0})});

//# sourceMappingURL=image.min.js.map